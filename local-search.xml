<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>æµ…æç¯å¢ƒå˜é‡</title>
    <link href="/2024/05/26/%E6%B5%85%E6%9E%90%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/"/>
    <url>/2024/05/26/%E6%B5%85%E6%9E%90%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒå˜é‡"><a href="#ä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒå˜é‡" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒå˜é‡"></a>ä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒå˜é‡</h2><p>ç°ä»£å‰ç«¯é¡¹ç›®å¾€å¾€æœ‰å¾ˆå¤šç¯å¢ƒï¼Œæ¯”å¦‚å¼€å‘ç¯å¢ƒã€è”è°ƒç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ç°åº¦ç¯å¢ƒã€çº¿ä¸Šç¯å¢ƒï¼Œä¸åŒç¯å¢ƒè¯·æ±‚çš„æ¥å£æœåŠ¡æ˜¯ä¸åŒçš„ï¼Œå¦‚æœäººå·¥ç»´æŠ¤è¯·æ±‚æœåŠ¡çš„åœ°å€ï¼Œä¸€æ—¦è™šå¿ƒå¤§æ„å¿˜è®°åˆ‡æ¢æœåŠ¡åœ°å€ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´çº¿ä¸Šå‡ºç°äº‹æ•…ã€‚</p><p>èƒ½å¦æœ‰ä¸€ä¸ªè‡ªåŠ¨çš„ç¯å¢ƒç®¡ç†æ–¹æ¡ˆä¿è¯æ¥å…¥çš„æœåŠ¡æ— è¯¯å‘¢</p><h2 id="environment-variablesä½¿ç”¨æ–¹å¼"><a href="#environment-variablesä½¿ç”¨æ–¹å¼" class="headerlink" title="environment variablesä½¿ç”¨æ–¹å¼"></a>environment variablesä½¿ç”¨æ–¹å¼</h2><h3 id="å‘½ä»¤è¡Œä¸­æ‰‹åŠ¨æŒ‡å®šç¯å¢ƒå˜é‡"><a href="#å‘½ä»¤è¡Œä¸­æ‰‹åŠ¨æŒ‡å®šç¯å¢ƒå˜é‡" class="headerlink" title="å‘½ä»¤è¡Œä¸­æ‰‹åŠ¨æŒ‡å®šç¯å¢ƒå˜é‡"></a>å‘½ä»¤è¡Œä¸­æ‰‹åŠ¨æŒ‡å®šç¯å¢ƒå˜é‡</h3><p><code>pnpm run dev NODE_ENV=development</code></p><h3 id="envæ–‡ä»¶ç»Ÿä¸€é…ç½®"><a href="#envæ–‡ä»¶ç»Ÿä¸€é…ç½®" class="headerlink" title=".envæ–‡ä»¶ç»Ÿä¸€é…ç½®"></a><code>.env</code>æ–‡ä»¶ç»Ÿä¸€é…ç½®</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">.env</span>                <span class="hljs-comment"># loaded in all cases</span><br><span class="hljs-string">.env.local</span>          <span class="hljs-comment"># loaded in all cases, ignored by git</span><br><span class="hljs-string">.env.</span>[mode]         <span class="hljs-comment"># only loaded in specified mode</span><br><span class="hljs-string">.env.</span>[mode]<span class="hljs-string">.local</span>   <span class="hljs-comment"># only loaded in specified mode, ignored by git</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;dev&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vite --mode=development&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vite --mode=test&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure><p><img src="/img/frontend_engineer/image-20240514182329150.png" alt="envs"></p><h2 id="å¸¸è§é¡¹ç›®ä¸­çš„environment-variables"><a href="#å¸¸è§é¡¹ç›®ä¸­çš„environment-variables" class="headerlink" title="å¸¸è§é¡¹ç›®ä¸­çš„environment variables"></a>å¸¸è§é¡¹ç›®ä¸­çš„environment variables</h2><h3 id="åŸºäºviteæ„å»º"><a href="#åŸºäºviteæ„å»º" class="headerlink" title="åŸºäºviteæ„å»º"></a><a href="https://vitejs.dev/guide/env-and-mode">åŸºäºviteæ„å»º</a></h3><p>å­˜: <code>.env</code>æ–‡ä»¶ä¸­<code>VITE_å˜é‡å=xxx</code></p><p>å–:<code>import.meta.env.VITE_å˜é‡å</code></p><p>æ³¨æ„ï¼Œä¸ä»¥<code>VITE_</code>å¼€å§‹çš„è‡ªå®šä¹‰å˜é‡ä¸ä¼šè¢«å­˜å…¥ç¯å¢ƒå˜é‡ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…æ»¥ç”¨å’Œè¯¯ç”¨</p><h3 id="åˆ©ç”¨create-react-appæˆ–vue-cliç­‰åŸºäºwebpackçš„è„šæ‰‹æ¶æ„å»º"><a href="#åˆ©ç”¨create-react-appæˆ–vue-cliç­‰åŸºäºwebpackçš„è„šæ‰‹æ¶æ„å»º" class="headerlink" title="åˆ©ç”¨create-react-appæˆ–vue-cliç­‰åŸºäºwebpackçš„è„šæ‰‹æ¶æ„å»º"></a><a href="https://create-react-app.dev/docs/adding-custom-environment-variables/">åˆ©ç”¨create-react-appæˆ–vue-cliç­‰åŸºäºwebpackçš„è„šæ‰‹æ¶æ„å»º</a></h3><p>å­˜: <code>*.env</code>æ–‡ä»¶ä¸­<code>REACT_APP_å˜é‡å=xxx</code></p><p>å–:<code>process.env.REACT_APP_å˜é‡å</code></p><p>æ³¨æ„ï¼Œé™¤äº†<code>NODE_ENV</code>ï¼Œä¸ä»¥<code>REACT_APP_</code>æˆ–<code>VUE_APP_</code>å¼€å§‹çš„å˜é‡ä¸ä¼šè¢«å­˜å…¥ç¯å¢ƒå˜é‡ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…æ»¥ç”¨å’Œè¯¯ç”¨</p><h3 id="åŸºäºwebpackæ„å»º"><a href="#åŸºäºwebpackæ„å»º" class="headerlink" title="åŸºäºwebpackæ„å»º"></a>åŸºäºwebpackæ„å»º</h3><p>webpackæ‰“åŒ…åçš„ç»“æœè¿è¡Œåœ¨æµè§ˆå™¨ä¸Šï¼Œæµè§ˆå™¨ä¸Šå¹¶æ²¡æœ‰process.envå¯¹è±¡ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡<strong>definePlugins</strong>è‡ªå·±å®šä¹‰åˆ°å…¨å±€ç¯å¢ƒ</p><p>æ³¨æ„:</p><ol><li>webpackçš„<strong>modeå¹¶ä¸æ˜¯æŒ‡å®šç¯å¢ƒå˜é‡ï¼Œè€Œæ˜¯æŒ‡å®šæ‰“åŒ…æ¨¡å¼</strong></li><li>webpackè¿è¡Œåœ¨nodeç¯å¢ƒï¼Œæ‰“åŒ…ç»“æœè¿è¡Œåœ¨æµè§ˆå™¨ä¸Šï¼Œæµè§ˆå™¨ç¯å¢ƒå¹¶æ²¡æœ‰process.envï¼Œéœ€è¦åœ¨webpackä¸­å¤„ç†ï¼Œä½¿å¾—æµè§ˆå™¨å¯ä»¥è®¿é—®ç¯å¢ƒå˜é‡</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// webpack.config.js</span><br><br><span class="hljs-keyword">const</span> &#123; <span class="hljs-title class_">DefinePlugin</span> &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack&#x27;</span>);<br><br><span class="hljs-comment">// éœ€è¦ç”¨cross-env+dotenvé…ç½®ç¯å¢ƒå˜é‡</span><br><span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;dotenv&#x27;</span>).<span class="hljs-title function_">config</span>();<br><br><span class="hljs-keyword">const</span> envObj = &#123;&#125;;<br><span class="hljs-comment">// å¯¹äºcraï¼Œä»…èƒ½ä»¥REACT_APP_å¼€å¤´</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(process.<span class="hljs-property">env</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;REACT_APP_&#x27;</span>)) &#123;<br>    envObj[key] = process.<span class="hljs-property">env</span>[key];<br>  &#125;<br>&#125;);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(process.<span class="hljs-property">env</span>);<br><br><span class="hljs-comment">// å¯¹äºvue-cliï¼Œä»…èƒ½ä»¥VUE_APP_å¼€å¤´</span><br><span class="hljs-comment">// Object.keys(process.env).forEach((key) =&gt; &#123;</span><br><span class="hljs-comment">//   if (key.startsWith(&#x27;VUE_APP_&#x27;)) &#123;</span><br><span class="hljs-comment">//     envObj[key] = process.env[key];</span><br><span class="hljs-comment">//   &#125;</span><br><span class="hljs-comment">// &#125;);</span><br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;development&#x27;</span>, <span class="hljs-comment">// æŒ‡å®šæ‰“åŒ…æ¨¡å¼è€Œä¸æ˜¯ç¯å¢ƒå˜é‡</span><br>  <span class="hljs-attr">entry</span>: &#123;<br>    <span class="hljs-attr">app</span>: <span class="hljs-string">&#x27;./app.js&#x27;</span>,<br>  &#125;,<br>  <span class="hljs-attr">output</span>: &#123;<br>    <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;./bundle.js&#x27;</span>,<br>  &#125;,<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefinePlugin</span>(&#123;<br>      <span class="hljs-string">&#x27;process.env&#x27;</span>: envObj,<br>    &#125;),<br>  ],<br>&#125;;<br><br></code></pre></td></tr></table></figure><h2 id="æ·±å…¥è§£æ"><a href="#æ·±å…¥è§£æ" class="headerlink" title="æ·±å…¥è§£æ"></a>æ·±å…¥è§£æ</h2><h3 id="process-envåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#process-envåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="process.envåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ"></a>process.envåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p><code>process.env</code> æ˜¯ Node.js ä¸­çš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œç”¨äºè®¿é—®å½“å‰è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚ç¯å¢ƒå˜é‡æ˜¯åœ¨æ“ä½œç³»ç»Ÿæˆ–è¿è¡Œ Node.js è¿›ç¨‹çš„ç¯å¢ƒä¸­å®šä¹‰çš„é”®å€¼å¯¹ã€‚</p><h3 id="ç®¡ç†process-envâ€”â€”cross-env"><a href="#ç®¡ç†process-envâ€”â€”cross-env" class="headerlink" title="ç®¡ç†process.envâ€”â€”cross-env"></a>ç®¡ç†process.envâ€”â€”cross-env</h3><p>æ— è®ºæ˜¯webpackè¿˜æ˜¯viteéƒ½æ˜¯è¿è¡Œåœ¨nodejsç¯å¢ƒä¸Šï¼Œè€Œnodeç¯å¢ƒä¸‹process.envåŸæœ¬æ˜¯æ²¡æœ‰NODE_ENVå±æ€§çš„ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å‘½ä»¤è¡Œä¿®æ”¹ç¯å¢ƒå˜é‡</p><p>ä¸åŒæ“ä½œç³»ç»Ÿçš„nodeå‘½ä»¤å·®åˆ«æ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚æƒ³è¦æ·»åŠ ä¸€ä¸ªNODE_ENVå˜é‡ï¼š</p><ul><li>Windowså†™æ³•ï¼š<code>&quot;dev&quot;: &quot;set NODE_ENV=test &amp;&amp; node test.js&quot;</code></li><li>Macå†™æ³•ï¼š<code>&quot;dev&quot;: &quot;export NODE_ENV=test &amp;&amp; node test.js&quot;</code></li></ul><p>ä¸ºäº†è§£å†³<strong>åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šè®¾ç½®ç¯å¢ƒå˜é‡çš„å·®å¼‚æ€§</strong>ï¼Œå¼•å…¥ç¬¬ä¸‰æ–¹åº“cross-envï¼Œå®ƒæ˜¯ä¸€ä¸ªåœ¨<strong>è·¨å¹³å°ç¯å¢ƒä¸‹è®¾ç½®ç¯å¢ƒå˜é‡çš„å‘½ä»¤è¡Œå·¥å…·å’ŒnodejsåŒ…</strong>ï¼Œæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ–¹å¼æ¥è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ— è®ºåœ¨å“ªä¸ªæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œï¼Œéƒ½å¯ä»¥æ­£å¸¸å·¥ä½œ</p><p><code>&quot;dev&quot;: &quot;cross-env NODE_ENV=test node test.js&quot;</code></p><h3 id="è¯»å–-envæ–‡ä»¶å¹¶æ³¨å…¥process-envâ€”â€”dotenv"><a href="#è¯»å–-envæ–‡ä»¶å¹¶æ³¨å…¥process-envâ€”â€”dotenv" class="headerlink" title="è¯»å–.envæ–‡ä»¶å¹¶æ³¨å…¥process.envâ€”â€”dotenv"></a>è¯»å–.envæ–‡ä»¶å¹¶æ³¨å…¥process.envâ€”â€”dotenv</h3><p>nodeä¸ä¼šè‡ªåŠ¨è¯»å–.envæ–‡ä»¶ï¼Œå¯ä»¥å€ŸåŠ©ç¬¬ä¸‰æ–¹åº“dotenvï¼Œè‡ªåŠ¨è§£ææ ¹ç›®å½•ä¸‹æ‰€æœ‰.envçš„æ–‡ä»¶</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;dotenv&#x27;</span>).<span class="hljs-built_in">config</span>();<br>console.<span class="hljs-built_in">log</span>(process.env.NODE_ENV);<br></code></pre></td></tr></table></figure><h2 id="import-meta-env-VS-process-env"><a href="#import-meta-env-VS-process-env" class="headerlink" title="import.meta.env VS process.env"></a>import.meta.env VS process.env</h2><p><strong>process.envæ˜¯ä¸€ä¸ªnodeç¯å¢ƒä¸­çš„å…¨å±€å˜é‡ï¼Œæµè§ˆå™¨ç«¯å¹¶ä¸èƒ½è®¿é—®</strong></p><p>å› æ­¤è™½ç„¶è¿è¡Œåœ¨nodeç¯å¢ƒä¸‹çš„æ‰“åŒ…å·¥å…·å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯è¿è¡Œåœ¨æµè§ˆå™¨ä¸Šçš„æ‰“åŒ…ç»“æœå¹¶ä¸èƒ½è®¿é—®process.env</p><p>å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œwebpackç»™å‡ºäº†è§£å†³æ–¹æ¡ˆï¼Œç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡definePluginså°†process.envå®šä¹‰åˆ°å…¨å±€</p><p><strong>éšç€ESMçš„å‘å±•ï¼Œ<a href="https://tc39.es/ecma262/2020/#prod-ImportMeta">tc39ç»ˆäºåœ¨ES2020ä¸­æ–°å¢äº†import.metaä½œä¸ºæ¨¡å—çš„å…ƒå±æ€§</a>ï¼Œå¯ä»¥åœ¨æ”¯æŒESMçš„æµè§ˆå™¨ä¸­è·å–ç¯å¢ƒå˜é‡ï¼Œä½†ä¸èƒ½åœ¨æ—§ç‰ˆæœ¬æµè§ˆå™¨å’Œnodeç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œviteç›®å‰å·²ç»æ”¯æŒè¿™ç§æ›´åŸç”Ÿçš„æ–¹å¼</strong></p><h2 id="æµç¨‹æ€»ç»“"><a href="#æµç¨‹æ€»ç»“" class="headerlink" title="æµç¨‹æ€»ç»“"></a>æµç¨‹æ€»ç»“</h2><ol><li>é€šè¿‡å‘½ä»¤è¡Œï¼ˆä¸€èˆ¬ç”¨cross-envä¿è¯è·¨æ“ä½œç³»ç»Ÿçš„å…¼å®¹æ€§ï¼‰èµ‹äºˆä»£ç è¿è¡Œæ—¶çš„NODE_ENVå˜é‡</li><li>é€šè¿‡dovenvè¯»å–å½“å‰ç¯å¢ƒä¸‹çš„.envæ–‡ä»¶</li><li>æŠŠdotenvè¯»å–åˆ°çš„æ•°æ®æ³¨å…¥åˆ°ä»£ç å…¨å±€ç¯å¢ƒ</li></ol><h2 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h2><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-comment">// src/config/index.ts</span><br><span class="hljs-keyword">const</span> env = <span class="hljs-keyword">import</span><span class="hljs-variable">.meta</span><span class="hljs-variable">.env</span>;<br><br><span class="hljs-keyword">interface</span> EnvConfig &#123;<br>  baseURL: <span class="hljs-keyword">string</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-keyword">config</span>: Record&lt;<span class="hljs-keyword">string</span>, EnvConfig&gt; = &#123;<br>  development: &#123;<br>    baseURL: &#x27;http:<span class="hljs-comment">//localhost:5001&#x27;,</span><br>  &#125;,<br>  production: &#123;<br>    baseURL: &#x27;http:<span class="hljs-comment">//localhost:5001&#x27;,</span><br>  &#125;,<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  baseURL: <span class="hljs-keyword">config</span>[env<span class="hljs-variable">.MODE</span>]<span class="hljs-variable">.baseURL</span>,<br>&#125;;<br><br></code></pre></td></tr></table></figure><p>åç»­å‘é€è¯·æ±‚çš„æ—¶å€™å¯ä»¥åœ¨axiosé‡Œé¢è®¾ç½®request interceptorï¼Œå°†config.baseURLä½œä¸ºåŸºæœ¬è·¯å¾„ï¼Œåç»­å†æ‹¼æ¥é™†è·¯ç”±</p>]]></content>
    
    
    <categories>
      
      <category>å·¥ç¨‹åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å·¥ç¨‹åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¤šäººé¡¹ç›®gitååŒå®è·µ</title>
    <link href="/2024/05/18/%E5%A4%9A%E4%BA%BA%E9%A1%B9%E7%9B%AEgit%E5%8D%8F%E5%90%8C%E5%AE%9E%E8%B7%B5/"/>
    <url>/2024/05/18/%E5%A4%9A%E4%BA%BA%E9%A1%B9%E7%9B%AEgit%E5%8D%8F%E5%90%8C%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="å¤šäººå¼€å‘çš„æ­£ç¡®å·¥ä½œæµç¨‹"><a href="#å¤šäººå¼€å‘çš„æ­£ç¡®å·¥ä½œæµç¨‹" class="headerlink" title="å¤šäººå¼€å‘çš„æ­£ç¡®å·¥ä½œæµç¨‹"></a>å¤šäººå¼€å‘çš„æ­£ç¡®å·¥ä½œæµç¨‹</h1><p>åœ¨dev1åˆ†æ”¯ä¸‹æˆ‘ä»¬å¼€å‘ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œå¹¶ä¸”åœ¨å¼€å‘çš„æ—¶å€™åˆ†æˆ3ä¸ªstageæäº¤ï¼ˆæ–¹ä¾¿æ”¹bugï¼‰ï¼Œä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬æœ€ç»ˆåªéœ€è¦æäº¤ä¸€ä¸ªä»£è¡¨è¯¥æ–°åŠŸèƒ½çš„commitåˆ°è¿œç«¯ï¼Œå¹¶åˆå…¥mainåˆ†æ”¯ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p><h2 id="dev"><a href="#dev" class="headerlink" title="dev"></a>dev</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment"># dev stage 1</span><br>âœ  learn-git git:(dev1) git <span class="hljs-keyword">add </span>.<br>âœ  learn-git git:(dev1) âœ— git commit -m <span class="hljs-string">&quot;feat: feature 1&quot;</span><br>[dev1 <span class="hljs-number">53</span>adc27] feat: feature <span class="hljs-number">1</span><br> <span class="hljs-number">1</span> file changed, <span class="hljs-number">2</span> <span class="hljs-keyword">insertions(+), </span><span class="hljs-number">1</span> deletion(-)<br><span class="hljs-comment"># dev stage 2</span><br>âœ  learn-git git:(dev1) git <span class="hljs-keyword">add </span>.<br>âœ  learn-git git:(dev1) âœ— git commit -m <span class="hljs-string">&quot;feat: lunch time&quot;</span><br>[dev1 <span class="hljs-number">3874836</span>] feat: lunch time<br> <span class="hljs-number">1</span> file changed, <span class="hljs-number">2</span> <span class="hljs-keyword">insertions(+), </span><span class="hljs-number">1</span> deletion(-)<br><span class="hljs-comment"># dev stage 3</span><br>âœ  learn-git git:(dev1) âœ— git <span class="hljs-keyword">add </span>.<br>âœ  learn-git git:(dev1) âœ— git commit -m <span class="hljs-string">&quot;fix: brunch time&quot;</span><br>[dev1 <span class="hljs-number">94</span>a90c2] fix: <span class="hljs-keyword">brunch </span>time<br> <span class="hljs-number">1</span> file changed, <span class="hljs-number">1</span> <span class="hljs-keyword">insertion(+), </span><span class="hljs-number">1</span> deletion(-)<br><span class="hljs-comment"># finish dev</span><br></code></pre></td></tr></table></figure><h2 id="local-cleanup"><a href="#local-cleanup" class="headerlink" title="local cleanup"></a>local cleanup</h2><p>æŸ¥çœ‹æäº¤è®°å½•ï¼Œæ‰¾åˆ°å¯¹äºè¯¥åŠŸèƒ½ä¸€å…±æäº¤äº†å¤šå°‘æ¬¡ï¼Œè¿™é‡Œæ˜¯3æ¬¡</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">âœ  learn-git git:(dev1) git <span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">commit</span> <span class="hljs-number">94</span>a90c28d614326dcbd3a4df2739c5775c60eb78 (HEAD -&gt; dev1)<br><span class="hljs-attribute">Author</span>: mmy &lt;<span class="hljs-number">15224924822</span>@<span class="hljs-number">163</span>.com&gt;<br><span class="hljs-attribute">Date</span>:   Sat May <span class="hljs-number">18</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">41</span> <span class="hljs-number">2024</span> +<span class="hljs-number">0800</span><br><br>    <span class="hljs-attribute">fix</span>: brunch time<br><br><span class="hljs-attribute">commit</span> <span class="hljs-number">38748366091</span>e3dbd30a1ce4ab995ece8671720ad<br><span class="hljs-attribute">Author</span>: mmy &lt;<span class="hljs-number">15224924822</span>@<span class="hljs-number">163</span>.com&gt;<br><span class="hljs-attribute">Date</span>:   Sat May <span class="hljs-number">18</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">06</span> <span class="hljs-number">2024</span> +<span class="hljs-number">0800</span><br><br>    <span class="hljs-attribute">feat</span>: lunch time<br><br><span class="hljs-attribute">commit</span> <span class="hljs-number">53</span>adc276bae51c26f0bc5c7ca503d017027fe1c4<br><span class="hljs-attribute">Author</span>: mmy &lt;<span class="hljs-number">15224924822</span>@<span class="hljs-number">163</span>.com&gt;<br><span class="hljs-attribute">Date</span>:   Sat May <span class="hljs-number">18</span> <span class="hljs-number">12</span>:<span class="hljs-number">36</span>:<span class="hljs-number">42</span> <span class="hljs-number">2024</span> +<span class="hljs-number">0800</span><br><br>    <span class="hljs-attribute">feat</span>: feature <span class="hljs-number">1</span><br><br><span class="hljs-attribute">commit</span> db9cfb80676bb88506a7bfcbb08101ad7df594de (origin/dev1)<br><span class="hljs-attribute">Author</span>: mmy &lt;<span class="hljs-number">15224924822</span>@<span class="hljs-number">163</span>.com&gt;<br><span class="hljs-attribute">Date</span>:   Thu May <span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">49</span>:<span class="hljs-number">13</span> <span class="hljs-number">2024</span> +<span class="hljs-number">0800</span><br><br>    <span class="hljs-attribute">fix</span>: description<br></code></pre></td></tr></table></figure><p>éœ€è¦å°†è¿™3æ¬¡æäº¤squashæˆ1æ¬¡ï¼Œå¹¶ä¸”ä¿®æ”¹æäº¤ä¿¡æ¯</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs smali">âœ  learn-git git:(dev1) git rebase -i HEAD~3<br><br></code></pre></td></tr></table></figure><p><img src="/img/git/workflow/1.svg" alt="Rebasing into Head-3"></p><p>rebaseä¿¡æ¯ä¿®æ”¹å‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">pick 53adc27 feat: feature 1<br>pick 3874836 feat: lunch time<br>pick 94a90c2 fix: brunch time<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å˜åŸº db9cfb8..94a90c2 åˆ° db9cfb8ï¼ˆ3 ä¸ªæäº¤ï¼‰</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># å‘½ä»¤:</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">p, pick &lt;æäº¤&gt; = ä½¿ç”¨æäº¤</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">r, reword &lt;æäº¤&gt; = ä½¿ç”¨æäº¤ï¼Œä½†ç¼–è¾‘æäº¤è¯´æ˜</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">e, edit &lt;æäº¤&gt; = ä½¿ç”¨æäº¤ï¼Œä½†åœæ­¢ä»¥ä¾¿ä¿®è¡¥æäº¤</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">s, squash &lt;æäº¤&gt; = ä½¿ç”¨æäº¤ï¼Œä½†æŒ¤å‹åˆ°å‰ä¸€ä¸ªæäº¤</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">f, fixup [-C | -c] &lt;æäº¤&gt; = ç±»ä¼¼äº <span class="hljs-string">&quot;squash&quot;</span>ï¼Œä½†åªä¿ç•™å‰ä¸€ä¸ªæäº¤</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">                   çš„æäº¤è¯´æ˜ï¼Œé™¤éä½¿ç”¨äº† -C å‚æ•°ï¼Œæ­¤æƒ…å†µä¸‹åˆ™åª</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">                   ä¿ç•™æœ¬æäº¤è¯´æ˜ã€‚ä½¿ç”¨ -c å’Œ -C ç±»ä¼¼ï¼Œä½†ä¼šæ‰“å¼€</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">                   ç¼–è¾‘å™¨ä¿®æ”¹æäº¤è¯´æ˜</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">x, <span class="hljs-built_in">exec</span> &lt;å‘½ä»¤&gt; = ä½¿ç”¨ shell è¿è¡Œå‘½ä»¤ï¼ˆæ­¤è¡Œå‰©ä½™éƒ¨åˆ†ï¼‰</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">b, <span class="hljs-built_in">break</span> = åœ¨æ­¤å¤„åœæ­¢ï¼ˆä½¿ç”¨ <span class="hljs-string">&#x27;git rebase --continue&#x27;</span> ç»§ç»­å˜åŸºï¼‰</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">d, drop &lt;æäº¤&gt; = åˆ é™¤æäº¤</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">l, label &lt;label&gt; = ä¸ºå½“å‰ HEAD æ‰“ä¸Šæ ‡è®°</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">t, reset &lt;label&gt; = é‡ç½® HEAD åˆ°è¯¥æ ‡è®°</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [<span class="hljs-comment"># &lt;oneline&gt;]</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">.       åˆ›å»ºä¸€ä¸ªåˆå¹¶æäº¤ï¼Œå¹¶ä½¿ç”¨åŸå§‹çš„åˆå¹¶æäº¤è¯´æ˜ï¼ˆå¦‚æœæ²¡æœ‰æŒ‡å®š</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">.       åŸå§‹æäº¤ï¼Œä½¿ç”¨æ³¨é‡Šéƒ¨åˆ†çš„ oneline ä½œä¸ºæäº¤è¯´æ˜ï¼‰ã€‚ä½¿ç”¨</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">.       -c &lt;æäº¤&gt; å¯ä»¥ç¼–è¾‘æäº¤è¯´æ˜ã€‚</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">u, update-ref &lt;å¼•ç”¨&gt; = ä¸ºå¼•ç”¨ &lt;ref&gt; è®¾ç½®ä¸€ä¸ªå ä½ç¬¦ï¼Œä»¥å°†è¯¥å¼•ç”¨æ›´æ–°ä¸ºæ­¤å¤„çš„æ–°æäº¤ã€‚</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">                      æ­¤ &lt;å¼•ç”¨&gt; åœ¨å˜åŸºç»“æŸåæ›´æ–°ã€‚</span><br>-- INSERT --<br></code></pre></td></tr></table></figure><p>rebaseä¿¡æ¯ä¿®æ”¹åï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">pick 53adc27 feat: feature 1<br>s 3874836 feat: lunch time<br>s 94a90c2 fix: brunch time<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å˜åŸº db9cfb8..94a90c2 åˆ° db9cfb8ï¼ˆ3 ä¸ªæäº¤ï¼‰</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># å‘½ä»¤:</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">p, pick &lt;æäº¤&gt; = ä½¿ç”¨æäº¤</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">r, reword &lt;æäº¤&gt; = ä½¿ç”¨æäº¤ï¼Œä½†ç¼–è¾‘æäº¤è¯´æ˜</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">e, edit &lt;æäº¤&gt; = ä½¿ç”¨æäº¤ï¼Œä½†åœæ­¢ä»¥ä¾¿ä¿®è¡¥æäº¤</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">s, squash &lt;æäº¤&gt; = ä½¿ç”¨æäº¤ï¼Œä½†æŒ¤å‹åˆ°å‰ä¸€ä¸ªæäº¤</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">f, fixup [-C | -c] &lt;æäº¤&gt; = ç±»ä¼¼äº <span class="hljs-string">&quot;squash&quot;</span>ï¼Œä½†åªä¿ç•™å‰ä¸€ä¸ªæäº¤</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">                   çš„æäº¤è¯´æ˜ï¼Œé™¤éä½¿ç”¨äº† -C å‚æ•°ï¼Œæ­¤æƒ…å†µä¸‹åˆ™åª</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">                   ä¿ç•™æœ¬æäº¤è¯´æ˜ã€‚ä½¿ç”¨ -c å’Œ -C ç±»ä¼¼ï¼Œä½†ä¼šæ‰“å¼€</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">                   ç¼–è¾‘å™¨ä¿®æ”¹æäº¤è¯´æ˜</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">x, <span class="hljs-built_in">exec</span> &lt;å‘½ä»¤&gt; = ä½¿ç”¨ shell è¿è¡Œå‘½ä»¤ï¼ˆæ­¤è¡Œå‰©ä½™éƒ¨åˆ†ï¼‰</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">b, <span class="hljs-built_in">break</span> = åœ¨æ­¤å¤„åœæ­¢ï¼ˆä½¿ç”¨ <span class="hljs-string">&#x27;git rebase --continue&#x27;</span> ç»§ç»­å˜åŸºï¼‰</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">d, drop &lt;æäº¤&gt; = åˆ é™¤æäº¤</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">l, label &lt;label&gt; = ä¸ºå½“å‰ HEAD æ‰“ä¸Šæ ‡è®°</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">t, reset &lt;label&gt; = é‡ç½® HEAD åˆ°è¯¥æ ‡è®°</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [<span class="hljs-comment"># &lt;oneline&gt;]</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">.       åˆ›å»ºä¸€ä¸ªåˆå¹¶æäº¤ï¼Œå¹¶ä½¿ç”¨åŸå§‹çš„åˆå¹¶æäº¤è¯´æ˜ï¼ˆå¦‚æœæ²¡æœ‰æŒ‡å®š</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">.       åŸå§‹æäº¤ï¼Œä½¿ç”¨æ³¨é‡Šéƒ¨åˆ†çš„ oneline ä½œä¸ºæäº¤è¯´æ˜ï¼‰ã€‚ä½¿ç”¨</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">.       -c &lt;æäº¤&gt; å¯ä»¥ç¼–è¾‘æäº¤è¯´æ˜ã€‚</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">u, update-ref &lt;å¼•ç”¨&gt; = ä¸ºå¼•ç”¨ &lt;ref&gt; è®¾ç½®ä¸€ä¸ªå ä½ç¬¦ï¼Œä»¥å°†è¯¥å¼•ç”¨æ›´æ–°ä¸ºæ­¤å¤„çš„æ–°æäº¤ã€‚</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">                      æ­¤ &lt;å¼•ç”¨&gt; åœ¨å˜åŸºç»“æŸåæ›´æ–°ã€‚</span><br>:wq<br></code></pre></td></tr></table></figure><p>commitä¿¡æ¯ä¿®æ”¹å‰ï¼š</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs clean"># è¿™æ˜¯ä¸€ä¸ª <span class="hljs-number">3</span> ä¸ªæäº¤çš„ç»„åˆã€‚<br># è¿™æ˜¯ç¬¬ä¸€ä¸ªæäº¤è¯´æ˜ï¼š<br><br>feat: feature <span class="hljs-number">1</span><br><br># è¿™æ˜¯æäº¤è¯´æ˜ #<span class="hljs-number">2</span>ï¼š<br><br>feat: lunch time<br><br># è¿™æ˜¯æäº¤è¯´æ˜ #<span class="hljs-number">3</span>ï¼š<br><br>fix: brunch time<br><br># è¯·ä¸ºæ‚¨çš„å˜æ›´è¾“å…¥æäº¤è¯´æ˜ã€‚ä»¥ <span class="hljs-string">&#x27;#&#x27;</span> å¼€å§‹çš„è¡Œå°†è¢«å¿½ç•¥ï¼Œè€Œä¸€ä¸ªç©ºçš„æäº¤<br># è¯´æ˜å°†ä¼šç»ˆæ­¢æäº¤ã€‚<br>#<br># æ—¥æœŸï¼š  Sat May <span class="hljs-number">18</span> <span class="hljs-number">12</span>:<span class="hljs-number">36</span>:<span class="hljs-number">42</span> <span class="hljs-number">2024</span> +<span class="hljs-number">0800</span><br>#<br># äº¤äº’å¼å˜åŸºæ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼›è‡³ db9cfb8<br># æœ€åå®Œæˆçš„å‘½ä»¤ï¼ˆ<span class="hljs-number">3</span> æ¡å‘½ä»¤è¢«æ‰§è¡Œï¼‰ï¼š<br>#    squash <span class="hljs-number">3874836</span> feat: lunch time<br>#    squash <span class="hljs-number">94</span>a90c2 fix: brunch time<br># æœªå‰©ä¸‹ä»»ä½•å‘½ä»¤ã€‚<br># æ‚¨åœ¨æ‰§è¡Œå°†åˆ†æ”¯ <span class="hljs-string">&#x27;dev1&#x27;</span> å˜åŸºåˆ° <span class="hljs-string">&#x27;db9cfb8&#x27;</span> çš„æ“ä½œã€‚<br>#<br># è¦æäº¤çš„å˜æ›´ï¼š<br><span class="hljs-string">&quot;~/develop/codes/learn-git/.git/COMMIT_EDITMSG&quot;</span> <span class="hljs-number">28</span>L, <span class="hljs-number">683</span>B<br></code></pre></td></tr></table></figure><p>commitä¿¡æ¯ä¿®æ”¹åï¼š</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs autoit">feat: feature <span class="hljs-number">1</span><br><br><span class="hljs-meta"># è¯·ä¸ºæ‚¨çš„å˜æ›´è¾“å…¥æäº¤è¯´æ˜ã€‚ä»¥ <span class="hljs-string">&#x27;#&#x27;</span> å¼€å§‹çš„è¡Œå°†è¢«å¿½ç•¥ï¼Œè€Œä¸€ä¸ªç©ºçš„æäº¤</span><br><span class="hljs-meta"># è¯´æ˜å°†ä¼šç»ˆæ­¢æäº¤ã€‚</span><br><span class="hljs-meta">#</span><br><span class="hljs-meta"># æ—¥æœŸï¼š  Sat May 18 12:36:42 2024 +0800</span><br><span class="hljs-meta">#</span><br><span class="hljs-meta"># äº¤äº’å¼å˜åŸºæ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼›è‡³ db9cfb8</span><br><span class="hljs-meta"># æœ€åå®Œæˆçš„å‘½ä»¤ï¼ˆ3 æ¡å‘½ä»¤è¢«æ‰§è¡Œï¼‰ï¼š</span><br><span class="hljs-meta">#    squash 3874836 feat: lunch time</span><br><span class="hljs-meta">#    squash 94a90c2 fix: brunch time</span><br><span class="hljs-meta"># æœªå‰©ä¸‹ä»»ä½•å‘½ä»¤ã€‚</span><br><span class="hljs-meta"># æ‚¨åœ¨æ‰§è¡Œå°†åˆ†æ”¯ <span class="hljs-string">&#x27;dev1&#x27;</span> å˜åŸºåˆ° <span class="hljs-string">&#x27;db9cfb8&#x27;</span> çš„æ“ä½œã€‚</span><br><span class="hljs-meta">#</span><br><span class="hljs-meta"># è¦æäº¤çš„å˜æ›´ï¼š</span><br><span class="hljs-meta">#       ä¿®æ”¹ï¼š     README.md                                     </span><br>:wq<br></code></pre></td></tr></table></figure><p>å†æ¬¡git logå‘ç°å°±åªå‰©ä¸€æ¡</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">commit</span> <span class="hljs-number">6188</span>a860fc471e7f364a0d5348c78293df547a2a (HEAD <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> dev1)<br>Author: mmy <span class="hljs-operator">&lt;</span><span class="hljs-number">15224924822</span><span class="hljs-variable">@163</span>.com<span class="hljs-operator">&gt;</span><br><span class="hljs-type">Date</span>:   Sat May <span class="hljs-number">18</span> <span class="hljs-number">12</span>:<span class="hljs-number">36</span>:<span class="hljs-number">42</span> <span class="hljs-number">2024</span> <span class="hljs-operator">+</span><span class="hljs-number">0800</span><br><br>    feat: feature <span class="hljs-number">1</span><br><br><span class="hljs-keyword">commit</span> db9cfb80676bb88506a7bfcbb08101ad7df594de (origin<span class="hljs-operator">/</span>dev1)<br>Author: mmy <span class="hljs-operator">&lt;</span><span class="hljs-number">15224924822</span><span class="hljs-variable">@163</span>.com<span class="hljs-operator">&gt;</span><br><span class="hljs-type">Date</span>:   Thu May <span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">49</span>:<span class="hljs-number">13</span> <span class="hljs-number">2024</span> <span class="hljs-operator">+</span><span class="hljs-number">0800</span><br><br>    fix: description<br><br><span class="hljs-keyword">commit</span> <span class="hljs-number">38</span>f1ba6768ee74dcdc6dbaf04def41844474deda<br>Author: mmy <span class="hljs-operator">&lt;</span><span class="hljs-number">15224924822</span><span class="hljs-variable">@163</span>.com<span class="hljs-operator">&gt;</span><br><span class="hljs-type">Date</span>:   Thu May <span class="hljs-number">16</span> <span class="hljs-number">14</span>:<span class="hljs-number">46</span>:<span class="hljs-number">29</span> <span class="hljs-number">2024</span> <span class="hljs-operator">+</span><span class="hljs-number">0800</span><br><br>    <span class="hljs-keyword">first</span> <span class="hljs-keyword">commit</span><br>(<span class="hljs-keyword">END</span>)<br></code></pre></td></tr></table></figure><h2 id="rebase-to-main"><a href="#rebase-to-main" class="headerlink" title="rebase to main"></a>rebase to main</h2><p>æˆ‘ä»¬ç›®å‰å·²ç»å¤„ç†å¥½æœ¬æ¬¡æäº¤çš„ç›¸å…³ä¿¡æ¯äº†ï¼Œèƒ½ä¸èƒ½ç›´æ¥æ¨è¿œç«¯å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯<strong>ä¸èƒ½</strong></p><p>å› ä¸ºåœ¨æˆ‘ä»¬å¼€å‘çš„æ—¶å€™ä¹Ÿæœ‰å…¶ä»–åŒå­¦åœ¨å¼€å‘æ–°çš„åŠŸèƒ½ï¼Œå¦‚æœåˆ«äººæ¯”æˆ‘ä»¬å¼€å‘å¾—æ—©ï¼Œé‚£æˆ‘ä»¬è¿™ä¸ªfeatureè‚¯å®šæœ‰å†²çª</p><ul><li><p>å¦‚æœä»æœ¬åœ°ç‰¹æ€§åˆ†æ”¯ç›´æ¥æ¨åˆ°è¿œç¨‹ä¸»åˆ†æ”¯ï¼Œæ§åˆ¶å°ä¼šæŠ¥é”™</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus">âœ  learn-git git:(dev1) git push origin <span class="hljs-selector-tag">main</span><br>Enter passphrase <span class="hljs-keyword">for</span> key <span class="hljs-string">&#x27;/Users/mmy/.ssh/id_rsa&#x27;</span>: <br>To github<span class="hljs-selector-class">.com</span>:hugtyftg/learn-git<span class="hljs-selector-class">.git</span><br> ! <span class="hljs-selector-attr">[rejected]</span>        <span class="hljs-selector-tag">main</span> -&gt; <span class="hljs-selector-tag">main</span> (fetch first)<br>é”™è¯¯ï¼šæ— æ³•æ¨é€ä¸€äº›å¼•ç”¨åˆ° <span class="hljs-string">&#x27;github.com:hugtyftg/learn-git.git&#x27;</span><br>æç¤ºï¼šæ›´æ–°è¢«æ‹’ç»ï¼Œå› ä¸ºè¿œç¨‹ä»“åº“åŒ…å«æ‚¨æœ¬åœ°å°šä¸å­˜åœ¨çš„æäº¤ã€‚è¿™é€šå¸¸æ˜¯å› ä¸ºå¦å¤–<br>æç¤ºï¼šä¸€ä¸ªä»“åº“å·²å‘è¯¥å¼•ç”¨è¿›è¡Œäº†æ¨é€ã€‚å¦‚æœæ‚¨å¸Œæœ›å…ˆä¸è¿œç¨‹å˜æ›´åˆå¹¶ï¼Œè¯·åœ¨æ¨é€<br>æç¤ºï¼šå‰æ‰§è¡Œ <span class="hljs-string">&#x27;git pull&#x27;</span>ã€‚<br>æç¤ºï¼šè¯¦è§ <span class="hljs-string">&#x27;git push --help&#x27;</span> ä¸­çš„ <span class="hljs-string">&#x27;Note about fast-forwards&#x27;</span> å°èŠ‚ã€‚<br></code></pre></td></tr></table></figure></li><li><p>å¦‚æœæœ¬åœ°ç‰¹æ€§åˆ†æ”¯æ¨åˆ°è¿œç¨‹ç‰¹æ€§åˆ†æ”¯ï¼Œç„¶åç»™è¿œç¨‹ä¸»åˆ†æ”¯æmrï¼Œ<strong>pipeline automatic mergeä¹Ÿä¼šæç¤ºæˆ‘ä»¬å­˜åœ¨conflicts</strong>ã€‚</p><p><img src="/img/git/workflow/3.png" alt="æœªrebaseæmr"></p></li></ul><p>æ— è®ºå¦‚ä½•éƒ½è¦è§£å†³å†²çªï¼</p><p>è¦æƒ³è§£å†³å†²çªï¼Œä¸€å®šè¦<strong>åœ¨ç‰¹æ€§åˆ†æ”¯ä¸Šrebaseä¿è¯çº¿æ€§æäº¤å†å²</strong></p><p><img src="/img/git/workflow/2.svg" alt="Merge VS Rebase"></p><h3 id="æœ¬åœ°mainåˆ†æ”¯åŒæ­¥è¿œç¨‹repo"><a href="#æœ¬åœ°mainåˆ†æ”¯åŒæ­¥è¿œç¨‹repo" class="headerlink" title="æœ¬åœ°mainåˆ†æ”¯åŒæ­¥è¿œç¨‹repo"></a>æœ¬åœ°mainåˆ†æ”¯åŒæ­¥è¿œç¨‹repo</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs tap">âœ  learn-git git:(dev1) git checkout main<br>åˆ‡æ¢åˆ°åˆ†æ”¯ &#x27;main&#x27;<br>æ‚¨çš„åˆ†æ”¯ä¸ä¸Šæ¸¸åˆ†æ”¯ &#x27;origin/main&#x27; ä¸€è‡´ã€‚<br>âœ  learn-git git:(main) git pull origin main<br>Enter passphrase for key &#x27;/Users/mmy/.ssh/id_rsa&#x27;: <br>remote: Enumerating objects: 1, done.<br>remote: Counting objects: 100% (1/1), done.<br>remote: Total<span class="hljs-number"> 1 </span>(delta 0), reused<span class="hljs-number"> 0 </span>(delta 0), pack-reused 0<br>å±•å¼€å¯¹è±¡ä¸­: 100% (1/1),<span class="hljs-number"> 879 </span>å­—èŠ‚ | 879.00 KiB/s, å®Œæˆ.<br>æ¥è‡ª github.com:hugtyftg/learn-git<br> * branch            main       -&gt; FETCH_HEAD<br>   839752c..707c9cf  main       -&gt; origin/main<br>æ›´æ–° 839752c..707c9cf<br>Fast-forward<br><span class="hljs-number"> 07 </span>Rebasing into Head-3.svg |<span class="hljs-number"> 161 </span>++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br><span class="hljs-number"> 09 </span>Rebase vs Merge.svg      |  <span class="hljs-number"> 1 </span>+<br> README.md                   | <span class="hljs-number"> 47 </span>++++++++++++++++++++++++++--<br><span class="hljs-number"> 3 </span>files changed,<span class="hljs-number"> 206 </span>insertions(+),<span class="hljs-number"> 3 </span>deletions(-)<br> create mode<span class="hljs-number"> 100644 </span>07 Rebasing into Head-3.svg<br> create mode<span class="hljs-number"> 100644 </span>09 Rebase vs Merge.svg<br></code></pre></td></tr></table></figure><h3 id="ç‰¹æ€§åˆ†æ”¯rebase-main"><a href="#ç‰¹æ€§åˆ†æ”¯rebase-main" class="headerlink" title="ç‰¹æ€§åˆ†æ”¯rebase main"></a>ç‰¹æ€§åˆ†æ”¯rebase main</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs routeros">âœ  learn-git git:(main) git checkout dev1<br>åˆ‡æ¢åˆ°åˆ†æ”¯ <span class="hljs-string">&#x27;dev1&#x27;</span><br>æ‚¨çš„åˆ†æ”¯ä¸ä¸Šæ¸¸åˆ†æ”¯ <span class="hljs-string">&#x27;origin/dev1&#x27;</span> ä¸€è‡´ã€‚<br>âœ  learn-git git:(dev1) git rebase main<br>è‡ªåŠ¨åˆå¹¶ README.md<br>å†²çªï¼ˆå†…å®¹ï¼‰ï¼šåˆå¹¶å†²çªäº README.md<br>é”™è¯¯ï¼šä¸èƒ½åº”ç”¨ 6188a86<span class="hljs-built_in">..</span>. feat: feature 1<br>æç¤ºï¼šResolve all conflicts manually, mark them as resolved with<br>æç¤ºï¼š<span class="hljs-string">&quot;git add/rm &lt;conflicted_files&gt;&quot;</span>, then <span class="hljs-built_in">run</span> <span class="hljs-string">&quot;git rebase --continue&quot;</span>.<br>æç¤ºï¼šYou can instead skip this commit: <span class="hljs-built_in">run</span> <span class="hljs-string">&quot;git rebase --skip&quot;</span>.<br>æç¤ºï¼š<span class="hljs-keyword">To</span> abort <span class="hljs-keyword">and</span> <span class="hljs-built_in">get</span> back <span class="hljs-keyword">to</span> the state before <span class="hljs-string">&quot;git rebase&quot;</span>, <span class="hljs-built_in">run</span> <span class="hljs-string">&quot;git rebase --abort&quot;</span>.<br>ä¸èƒ½åº”ç”¨ 6188a86<span class="hljs-built_in">..</span>. feat: feature 1<br></code></pre></td></tr></table></figure><h3 id="æœ‰å†²çªçš„è¯éœ€è¦è§£å†³å†²çª"><a href="#æœ‰å†²çªçš„è¯éœ€è¦è§£å†³å†²çª" class="headerlink" title="æœ‰å†²çªçš„è¯éœ€è¦è§£å†³å†²çª"></a>æœ‰å†²çªçš„è¯éœ€è¦è§£å†³å†²çª</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs autoit">feat: feature <span class="hljs-number">1</span><br><br><span class="hljs-meta"># è¯·ä¸ºæ‚¨çš„å˜æ›´è¾“å…¥æäº¤è¯´æ˜ã€‚ä»¥ <span class="hljs-string">&#x27;#&#x27;</span> å¼€å§‹çš„è¡Œå°†è¢«å¿½ç•¥ï¼Œè€Œä¸€ä¸ªç©ºçš„æäº¤</span><br><span class="hljs-meta"># è¯´æ˜å°†ä¼šç»ˆæ­¢æäº¤ã€‚</span><br><span class="hljs-meta">#</span><br><span class="hljs-meta"># äº¤äº’å¼å˜åŸºæ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼›è‡³ 707c9cf</span><br><span class="hljs-meta"># æœ€åå®Œæˆçš„å‘½ä»¤ï¼ˆ1 æ¡å‘½ä»¤è¢«æ‰§è¡Œï¼‰ï¼š</span><br><span class="hljs-meta">#    pick 6188a86 feat: feature 1</span><br><span class="hljs-meta"># æœªå‰©ä¸‹ä»»ä½•å‘½ä»¤ã€‚</span><br><span class="hljs-meta"># æ‚¨åœ¨æ‰§è¡Œå°†åˆ†æ”¯ <span class="hljs-string">&#x27;dev1&#x27;</span> å˜åŸºåˆ° <span class="hljs-string">&#x27;707c9cf&#x27;</span> çš„æ“ä½œã€‚</span><br><span class="hljs-meta">#</span><br><span class="hljs-meta"># è¦æäº¤çš„å˜æ›´ï¼š</span><br><span class="hljs-meta">#       ä¿®æ”¹ï¼š     README.md</span><br></code></pre></td></tr></table></figure><h3 id="å†²çªè§£å†³ä¹‹åä¿å­˜æ›´æ”¹ã€ç»§ç»­rebase"><a href="#å†²çªè§£å†³ä¹‹åä¿å­˜æ›´æ”¹ã€ç»§ç»­rebase" class="headerlink" title="å†²çªè§£å†³ä¹‹åä¿å­˜æ›´æ”¹ã€ç»§ç»­rebase"></a>å†²çªè§£å†³ä¹‹åä¿å­˜æ›´æ”¹ã€ç»§ç»­rebase</h3><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs llvm">âœ  learn-git git:(<span class="hljs-number">707</span><span class="hljs-keyword">c</span><span class="hljs-number">9</span>cf) âœ— git <span class="hljs-keyword">add</span> .<br>âœ  learn-git git:(<span class="hljs-number">707</span><span class="hljs-keyword">c</span><span class="hljs-number">9</span>cf) âœ— git rebase --continue<br>[åˆ†ç¦»å¤´æŒ‡é’ˆ <span class="hljs-number">5</span>bca<span class="hljs-number">03</span><span class="hljs-keyword">c</span>] feat: feature <span class="hljs-number">1</span><br> <span class="hljs-number">1</span> file changed<span class="hljs-punctuation">,</span> <span class="hljs-number">4</span> insertions(+)<span class="hljs-punctuation">,</span> <span class="hljs-number">1</span> deletion(-)<br>æˆåŠŸå˜åŸºå¹¶æ›´æ–° refs/heads/dev<span class="hljs-number">1</span>ã€‚<br></code></pre></td></tr></table></figure><h3 id="æ¨é€åˆå…¥ï¼"><a href="#æ¨é€åˆå…¥ï¼" class="headerlink" title="æ¨é€åˆå…¥ï¼"></a>æ¨é€åˆå…¥ï¼</h3><p>ç”±äºåˆšæ‰å·²ç»ç»™è¿œç¨‹ä»“åº“pushè¿‡ä¸€æ¬¡äº†ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å¼ºåˆ¶æ¨é€è¦†ç›–è¿œç¨‹dev1åˆ†æ”¯ï¼ˆ<strong>ä¸‡åˆ†æ³¨æ„-f</strong>ï¼‰</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">âœ  learn-git git:(dev1) git <span class="hljs-built_in">push</span> <span class="hljs-built_in">origin</span> dev1 -f<br></code></pre></td></tr></table></figure><p>æ¨å®Œä¹‹åå¯ä»¥å‘ç°pipelineåˆè·‘äº†ä¸€éï¼Œå¹¶ä¸”è¿™æ¬¡æ²¡æœ‰conflictsäº†ï¼Œå¯ä»¥å‡†è®¸åˆå…¥ã€‚ä¸è¿‡å®é™…å·¥ä½œé¡¹ç›®ä¸­è¿˜ä¼šæœ‰+1ç»™ä½ crï¼Œapä¹‹åæ‰ä¼šåˆå…¥â€¦â€¦ï¼ˆps: å®ä¹ é˜¶æ®µcré—®é¢˜å¤šåƒä¸‡è¦ç¨³ä½å¿ƒæ€ï¼Œæˆ‘æ›¾ç»ä¸€ä¸ªfeat cräº†6æ¬¡æ‰åˆå…¥ğŸ˜­ï¼‰</p><p><img src="/img/git/workflow/4.png" alt="rebaseåæmr"></p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>merge vs rebase</title>
    <link href="/2024/05/16/merge%20vs%20rebase/"/>
    <url>/2024/05/16/merge%20vs%20rebase/</url>
    
    <content type="html"><![CDATA[<h1 id="gitè§„èŒƒæ€§"><a href="#gitè§„èŒƒæ€§" class="headerlink" title="gitè§„èŒƒæ€§"></a>gitè§„èŒƒæ€§</h1><h2 id="1-æ•´ç†æœ¬åœ°æäº¤å†å²"><a href="#1-æ•´ç†æœ¬åœ°æäº¤å†å²" class="headerlink" title="1.æ•´ç†æœ¬åœ°æäº¤å†å²"></a>1.æ•´ç†æœ¬åœ°æäº¤å†å²</h2><p>æœ¬åœ°å¼€å‘çš„æ—¶å€™ï¼Œæ¯å¼€å‘äº†ä¸€ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬æœ€å¥½commitä¸€æ¬¡ï¼Œä½†æ˜¯è¿™å°±é€ æˆäº†å¼€å‘ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œä¼šæœ‰å¤šä¸ªcommitçš„æƒ…å†µï¼Œå½±å“æäº¤å†å²çš„æ•´æ´æ€§ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œå…ˆæŸ¥çœ‹æˆ‘ä»¬åœ¨è¯¥åŠŸèƒ½ä¸Šä¸€å…±æäº¤äº†å¤šå°‘commitï¼Œç„¶åå°†è¿™äº›åˆå¹¶æˆä¸€ä¸ªcommitï¼Œä½œä¸ºæ–°åŠŸèƒ½çš„æœ€ç»ˆcommit</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">git <span class="hljs-built_in">log</span> <span class="hljs-comment"># æŸ¥çœ‹commitæ¬¡æ•°</span><br>git rebase -i HEAD~[<span class="hljs-built_in">num</span>]<br></code></pre></td></tr></table></figure><p><img src="/img/git/merge_vs_rebase1.svg" alt="Rebasing into Head-3"></p><h2 id="2-çº¿æ€§çš„æ•´æ´æäº¤å†å²"><a href="#2-çº¿æ€§çš„æ•´æ´æäº¤å†å²" class="headerlink" title="2.çº¿æ€§çš„æ•´æ´æäº¤å†å²"></a>2.çº¿æ€§çš„æ•´æ´æäº¤å†å²</h2><p>åœ¨æŸä¸ªæ—¶é—´ç‚¹ï¼Œä½ æ‰“ç®—å¼€å‘ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œä»å½“æ—¶çš„masterï¼ˆå¼€å‘è¿›åº¦Aï¼‰è¿å‡ºäº†ç‰¹æ€§åˆ†æ”¯ï¼Œå¼€å‘ä¸€æ®µæ—¶é—´åå°†devï¼ˆå¼€å‘è¿›åº¦Cï¼‰æ¨åˆ°è¿œç«¯å‡†å¤‡æmrï¼Œä½†æ˜¯æ­¤æ—¶githubæ˜¾ç¤ºå­˜åœ¨å†²çªã€æ— æ³•è‡ªåŠ¨åˆå¹¶ï¼Œè¿™æ˜¯å› ä¸ºåˆ«äººåŸºäºmasterï¼ˆAï¼‰å¼€å‘çš„æ–°åŠŸèƒ½æ—©äºä½ åˆå…¥ï¼Œæ‰€ä»¥å­˜åœ¨å†²çªã€‚ è¿™é‡Œæœ‰ä¸¤ç§é€‰æ‹©è§£å†³å†²çª</p><ul><li>merge ä¸å»ºè®® squashç­–ç•¥ä¼šæ‰¾åˆ°è¿™ä¸¤ä¸ªåˆ†æ”¯çš„æœ€è¿‘å…±åŒç¥–å…ˆï¼Œç„¶åæŠŠä¸¤ä¸ªåˆ†æ”¯æ‰€æœ‰çš„commitå…¨éƒ¨å‹ç¼©æˆä¸€ä¸ªcommitï¼Œè¿™ä¸¤ä¸ªç‰¹æ€§åˆ†æ”¯ä¸Šçš„å†å²è®°å½•éƒ½æ²¡äº†</li><li>rebase å»ºè®® ä¿ç•™è¿™äº›æäº¤å†å²ï¼Œå¹¶ä¸”æ˜¯çº¿æ€§çš„ã€‚</li></ul><p>æ³¨æ„ï¼Œæ°¸è¿œåªåœ¨ä½ è‡ªå·±çš„ç‰¹æ€§åˆ†æ”¯ä¸Šrebaseï¼Œåœ¨å…¬å…±åˆ†æ”¯é€šè¿‡æmr mergeï¼Œä¸è¦åœ¨å…¬å…±åˆ†æ”¯rebaseï¼</p><p><img src="/img/git/merge_vs_rebase/02.svg" alt="Merge VS Rebase"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs zsh"># åŒæ­¥æ›´æ–°æœ¬åœ°master<br>git checkout master<br>git pull origin master<br><br># å¼€å§‹å˜åŸº<br>git rebase master<br># å¤§æ¦‚ç‡ä¼šæœ‰å†²çªï¼Œè¿™äº›å†²çªæ˜¯åˆ«äººæ–°å¼€å‘çš„åŠŸèƒ½ï¼Œæ—©äºä½ æäº¤<br># è§£å†³å†²çª<br>git add .<br>git rebase --continue<br># å®Œæˆå˜åŸº<br><br>git push<br># å¦‚æœå˜åŸºä¹‹å‰å·²ç»pushè¿‡ä¸€æ¬¡ï¼Œdevopsä¸Šä¹Ÿä¼šæ˜¾ç¤ºæœ‰conflictsæ— æ³•automatic mergeï¼Œæ‰€ä»¥éœ€è¦git push -få¼ºåˆ¶æ¨é€ã€è¦†ç›–è¿œç¨‹å·²æœ‰çš„æ¨é€<br></code></pre></td></tr></table></figure><p>å…³äºrebaseå’Œmergeï¼Œå¼ºçƒˆå»ºè®®é˜…è¯»<a href="https://www.atlassian.com/git/tutorials/merging-vs-rebasing">https://www.atlassian.com/git/tutorials/merging-vs-rebasing</a></p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MongoDBåˆæ¢</title>
    <link href="/2024/05/08/MongoDB%E5%88%9D%E6%8E%A2/"/>
    <url>/2024/05/08/MongoDB%E5%88%9D%E6%8E%A2/</url>
    
    <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>MongoDBæ˜¯ä¸€ä¸ªæµè¡Œçš„å¼€æºNoSQLæ–‡æ¡£å‹æ•°æ®åº“ï¼Œç”±è‹¥å¹²JSONæ ¼å¼ä¸”å…·å¤‡schemaçš„documentç»„æˆï¼Œå¯ä»¥åœ¨MongoDB Atlasäº‘å¹³å°ä½¿ç”¨ï¼Œå¹¶ä¸”å†…ç½®æœåŠ¡æ€§èƒ½åˆ†ææ¨¡å—ç­‰ï¼Œéå¸¸å¼ºå¤§ã€‚</p><p>æœ¬æ–‡åˆ†ä¸ºmongoDBæ ¸å¿ƒæ¦‚å¿µä»‹ç»ã€mongooseä»‹ç»å’Œexpresså®æˆ˜ä¸‰ä¸ªæ–¹é¢ã€‚</p><h1 id="mongoDBæ ¸å¿ƒæ¦‚å¿µ"><a href="#mongoDBæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="mongoDBæ ¸å¿ƒæ¦‚å¿µ"></a>mongoDBæ ¸å¿ƒæ¦‚å¿µ</h1><h2 id="æ•°æ®åº“å¸¸è§„æ¦‚å¿µå›é¡¾"><a href="#æ•°æ®åº“å¸¸è§„æ¦‚å¿µå›é¡¾" class="headerlink" title="æ•°æ®åº“å¸¸è§„æ¦‚å¿µå›é¡¾"></a>æ•°æ®åº“å¸¸è§„æ¦‚å¿µå›é¡¾</h2><p>æ¯ä¸ªdatabaseç”±å¤šå¼ tableç»„æˆï¼Œæ¯å¼ tableçš„æ„æˆå¦‚ä¸‹ï¼š</p><p><img src="/img/database/mongoDB/image-20240508171015259.png" alt="image-20240508171015259"></p><h2 id="mongoDB-architecture"><a href="#mongoDB-architecture" class="headerlink" title="mongoDB architecture"></a>mongoDB architecture</h2><p><img src="/img/database/mongoDB/document-store-100893897-large.jpg" alt="document store"></p><h2 id="Mongo-Instance"><a href="#Mongo-Instance" class="headerlink" title="Mongo Instance"></a>Mongo Instance</h2><p>å¯ä»¥ç†è§£æˆä¸€ä¸ªserverï¼Œç®¡ç†å¤šä¸ªdatabase</p><h2 id="database"><a href="#database" class="headerlink" title="database"></a>database</h2><p>MongoDBä¸­çš„databaseæŒ‡çš„æ˜¯æ•°æ®çš„ç‰©ç†å®¹å™¨ï¼Œä¸€ä¸ªMongoDBæœåŠ¡å™¨åŒ…å«å¤šä¸ªæ•°æ®åº“ï¼Œæ¯ä¸ªæ•°æ®åº“å†…éƒ½æœ‰ä¸€å¥—ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿ</p><p><img src="/img/database/mongoDB/mongodb-collection-vs-document.jpg" alt="Relational and non relational databases"></p><h2 id="collection"><a href="#collection" class="headerlink" title="collection"></a>collection</h2><p>collectionæ˜¯ä¸€ç»„documentçš„é›†åˆï¼Œé€šå¸¸å¯ä»¥è¢«ç±»æ¯”æˆå…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ï¼Œä¸åŒçš„æ˜¯collectionæ²¡æœ‰schemaçº¦æŸï¼Œè€Œdocumentæœ‰schemaã€‚</p><p><img src="/img/database/mongoDB/crud-annotated-collection.bakedsvg.svg" alt="Databases and Collections - MongoDB Manual v7.0"></p><h2 id="document"><a href="#document" class="headerlink" title="document"></a>document</h2><p>documentæ˜¯Field-Valueé”®å€¼å¯¹çš„é›†åˆï¼ˆå¿…é¡»æ˜¯JSONæ ¼å¼ï¼‰ã€‚æ¯ä¸ªdocumentéƒ½æœ‰<strong>åŠ¨æ€schemaç»“æ„</strong>ï¼Œè¿™æ„å‘³ç€collectionä¸­æ¯ä¸ªdocumentå¯èƒ½æœ‰æˆªç„¶ä¸åŒçš„ç»“æ„æˆ–fieldsï¼Œå¯èƒ½æœ‰ç›¸åŒçš„filedä¹Ÿå¯èƒ½æ²¡æœ‰</p><p>db.usersæ˜¯ä¸€ä¸ªcollectionï¼Œé€šè¿‡è°ƒç”¨insertæ–¹æ³•å‘å…¶ä¸­æ’å…¥ä¸€ä¸ªcollectionï¼Œæˆ–è€…é€šè¿‡insertManyæ’å…¥å¤šä¸ªcollection</p><p>å¤‡æ³¨ï¼šä¸€èˆ¬æ¥è¯´ä¸ç›´æ¥è¿™æ ·ä½¿ç”¨dbï¼Œæ¨èä½¿ç”¨mongooseè¿æ¥å’Œç®¡ç†æ•°æ®åº“ï¼Œé€šè¿‡schemaå»ºç«‹modelï¼Œé€šè¿‡modelæ“ä½œå¯¹åº”æ•°æ®</p><p><img src="/img/database/mongoDB/mongodb-data-structure.png" alt="MongoDB Data Types &amp; Field-Value Pairs | Studio 3T"></p><h2 id="Field-Value-Pair"><a href="#Field-Value-Pair" class="headerlink" title="Field-Value Pair"></a>Field-Value Pair</h2><p><img src="/img/database/mongoDB/JSON_Example_Python_MongoDB-mzqqz0keng.png" alt="MongoDB Data Types &amp; Field-Value Pairs | Studio 3T"></p><h1 id="mongooseä»‹ç»"><a href="#mongooseä»‹ç»" class="headerlink" title="mongooseä»‹ç»"></a>mongooseä»‹ç»</h1><p>mongooseæ˜¯nodeJSç¯å¢ƒä¸‹è¿æ¥mongoDBçš„ç¬¬ä¸‰æ–¹åº“ï¼Œæ˜¯å¯¹æ•°æ®åº“æ“ä½œè¿›è¡Œå°è£…çš„å¯¹è±¡æ¨¡å‹å·¥å…·ï¼Œå°†æ•°æ®åº“ä¸­çš„æ•°æ®è½¬æ¢æˆjavascriptå¯¹è±¡æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ï¼Œæ ¸å¿ƒæ¦‚å¿µæ˜¯schemaå’Œmodels</p><h2 id="schema"><a href="#schema" class="headerlink" title="schema"></a>schema</h2><p>mongooseä¸­çš„ä¸€åˆ‡éƒ½èµ·æºäºä¸€ä¸ªschemaï¼Œæ¯ä¸ªschemaæ˜ å°„åˆ°MongoDBå†…collectionä¸­çš„documentæ ¼å¼ã€‚</p><p>schemaä¸ä»…å®šä¹‰äº†documentçš„fieldå’Œstructureï¼Œè¿˜å®šä¹‰äº†<strong>æ–‡æ¡£å®ä¾‹æ–¹æ³•ã€æ¨¡å‹é™æ€æ–¹æ³•ã€å¤åˆç´¢å¼•</strong></p><p>schemaæ˜¯åŠ¨æ€çš„</p><p>schemaç”šè‡³å¯ä»¥çº¦æŸ<strong>æšä¸¾</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserSchema</span> = mongoose.<span class="hljs-title class_">Schema</span>(<br>  &#123;<br>    <span class="hljs-attr">name</span>: &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;String&#x27;</span>,<br>      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">min</span>: <span class="hljs-number">2</span>,<br>      <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>,<br>    &#125;,<br>...<br>  &#125;,<br>);<br></code></pre></td></tr></table></figure><h2 id="models"><a href="#models" class="headerlink" title="models"></a>models</h2><p>ä½¿ç”¨schemaå®šä¹‰å¯ä»¥åˆ›å»ºæˆ‘ä»¬éœ€è¦çš„æ•°æ®æ¨¡å‹modelï¼Œä¾¿äºåœ¨controllerå±‚æ“ä½œä½¿ç”¨</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// server/models/User.js</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">User</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;User&#x27;</span>, <span class="hljs-title class_">UserSchema</span>);<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// server/controller/general.js</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">User</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../models/User.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUser</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">req, res</span>) =&gt; &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; id &#125; = req.<span class="hljs-property">params</span>;<br>    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findById</span>(id);<br>    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>(user);<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">json</span>(&#123;<br>      <span class="hljs-attr">code</span>: -<span class="hljs-number">1</span>,<br>      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,<br>    &#125;);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="æ¨¡å‹é™æ€æ–¹æ³•"><a href="#æ¨¡å‹é™æ€æ–¹æ³•" class="headerlink" title="æ¨¡å‹é™æ€æ–¹æ³•"></a>æ¨¡å‹é™æ€æ–¹æ³•</h2><p>å¯ä»¥å¯¹é€šè¿‡schemaåˆ›å»ºçš„modelè¿›è¡Œæ“ä½œï¼Œå¦‚findByIdã€insertManyç­‰æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findById</span>(id);<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">User</span>.<span class="hljs-title function_">insertMany</span>(dataUser); <span class="hljs-comment">// dataUseræ˜¯ä¸€ä¸ªæ»¡è¶³schemaçš„å¯¹è±¡æ•°ç»„</span><br></code></pre></td></tr></table></figure><h1 id="express-MongoDB-mongooseå®æˆ˜"><a href="#express-MongoDB-mongooseå®æˆ˜" class="headerlink" title="express+MongoDB+mongooseå®æˆ˜"></a>express+MongoDB+mongooseå®æˆ˜</h1><h2 id="0-é¢„å¤‡å·¥ä½œ"><a href="#0-é¢„å¤‡å·¥ä½œ" class="headerlink" title="0.é¢„å¤‡å·¥ä½œ"></a>0.é¢„å¤‡å·¥ä½œ</h2><p>ç™»å½•<a href="https://cloud.mongodb.com/%E5%BB%BA%E7%AB%8Bdatabase%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8azure%E6%88%96%E8%80%85aws%E7%9A%84%E5%85%8D%E8%B4%B9%E8%B5%84%E6%BA%90%E5%BB%BA%E7%AB%8Bcluster">https://cloud.mongodb.com/å»ºç«‹databaseï¼Œå¯ä»¥ä½¿ç”¨azureæˆ–è€…awsçš„å…è´¹èµ„æºå»ºç«‹cluster</a></p><p>è®¾ç½®IPå’ŒUser accessç™½åå•ä¿è¯äº‘ç«¯æ•°æ®åº“çš„å®‰å…¨æ€§</p><h2 id="1-mongooseè¿æ¥æ•°æ®åº“"><a href="#1-mongooseè¿æ¥æ•°æ®åº“" class="headerlink" title="1.mongooseè¿æ¥æ•°æ®åº“"></a>1.mongooseè¿æ¥æ•°æ®åº“</h2><p>åœ¨æ ¹ç›®å½•ä¸‹æ–°å»º<code>.env</code>æ–‡ä»¶å­˜æ”¾ç¯å¢ƒå˜é‡å¦‚MONGO_URLã€PORTï¼Œé€šè¿‡dotenvè¯»å–ä¿¡æ¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">dotenv.<span class="hljs-title function_">config</span>(); <span class="hljs-comment">// å°†.envæ•æ„Ÿä¿¡æ¯æ³¨å…¥åˆ°ç¯å¢ƒä¸­ã€èƒ½è¢«process.envè®¿é—®</span><br><span class="hljs-comment">/* MONGOOSE SETUP */</span><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">9000</span>;<br>mongoose<br>  .<span class="hljs-title function_">connect</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">MONGO_URL</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`server is running at http://localhost:<span class="hljs-subst">$&#123;PORT&#125;</span>`</span>);<br>    &#125;);<br>  &#125;)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);<br>  &#125;);<br></code></pre></td></tr></table></figure><h2 id="2-modelå±‚å»ºç«‹schemaå’Œcollection"><a href="#2-modelå±‚å»ºç«‹schemaå’Œcollection" class="headerlink" title="2.modelå±‚å»ºç«‹schemaå’Œcollection"></a>2.modelå±‚å»ºç«‹schemaå’Œcollection</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> mongoose <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;mongoose&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserSchema</span> = mongoose.<span class="hljs-title class_">Schema</span>(<br>  &#123;<br>    <span class="hljs-attr">name</span>: &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;String&#x27;</span>,<br>      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">min</span>: <span class="hljs-number">2</span>,<br>      <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>,<br>    &#125;,<br>    <span class="hljs-attr">email</span>: &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;String&#x27;</span>,<br>      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">max</span>: <span class="hljs-number">50</span>,<br>    &#125;,<br>    <span class="hljs-attr">password</span>: &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;String&#x27;</span>,<br>      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">min</span>: <span class="hljs-number">5</span>,<br>    &#125;,<br>    <span class="hljs-attr">city</span>: <span class="hljs-title class_">String</span>,<br>    <span class="hljs-attr">state</span>: <span class="hljs-title class_">String</span>,<br>    <span class="hljs-attr">country</span>: <span class="hljs-title class_">String</span>,<br>    <span class="hljs-attr">occupation</span>: <span class="hljs-title class_">String</span>,<br>    <span class="hljs-attr">phoneNumber</span>: <span class="hljs-title class_">String</span>,<br>    <span class="hljs-attr">transactions</span>: <span class="hljs-title class_">Array</span>,<br>    <span class="hljs-attr">role</span>: &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;String&#x27;</span>,<br>      <span class="hljs-attr">enum</span>: [<span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-string">&#x27;superadmin&#x27;</span>],<br>      <span class="hljs-attr">default</span>: <span class="hljs-string">&#x27;admin&#x27;</span>,<br>    &#125;,<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">timestamps</span>: <span class="hljs-literal">true</span>,<br>  &#125;<br>);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">User</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;User&#x27;</span>, <span class="hljs-title class_">UserSchema</span>);<br></code></pre></td></tr></table></figure><h2 id="3-controllerå±‚å°è£…æ“ä½œ"><a href="#3-controllerå±‚å°è£…æ“ä½œ" class="headerlink" title="3.controllerå±‚å°è£…æ“ä½œ"></a>3.controllerå±‚å°è£…æ“ä½œ</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">User</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../models/User.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUser</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">req, res</span>) =&gt; &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; id &#125; = req.<span class="hljs-property">params</span>;<br>    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findById</span>(id);<br>    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>(user);<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">json</span>(&#123;<br>      <span class="hljs-attr">code</span>: -<span class="hljs-number">1</span>,<br>      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,<br>    &#125;);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="4-æš´éœ²åç«¯APIå¹¶æµ‹è¯•"><a href="#4-æš´éœ²åç«¯APIå¹¶æµ‹è¯•" class="headerlink" title="4.æš´éœ²åç«¯APIå¹¶æµ‹è¯•"></a>4.æš´éœ²åç«¯APIå¹¶æµ‹è¯•</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"># server/routes/general.<span class="hljs-property">js</span><br><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; getUser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../controller/general.js&#x27;</span>;<br><br><span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();<br><br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/user/:id&#x27;</span>, getUser);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"># server/index.<span class="hljs-property">js</span><br><span class="hljs-keyword">import</span> generaRoutes <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./routes/general.js&#x27;</span>;<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/general&#x27;</span>, generaRoutes);<br></code></pre></td></tr></table></figure><p>è®¿é—®<a href="http://localhost:5001/general/user/63701cc1f03239b7f700000e%E5%8F%AF%E4%BB%A5%E6%AD%A3%E7%A1%AE%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE">http://localhost:5001/general/user/63701cc1f03239b7f700000eå¯ä»¥æ­£ç¡®è·å–æ•°æ®</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;63701cc1f03239b7f700000e&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Shelly&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;swelbeck12@ycombinator.com&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;RSjzmAjnq&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;city&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Sangoleng&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;state&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;country&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ID&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;occupation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Pharmacist&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;phoneNumber&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;7036619983&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;transactions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-string">&quot;63701d74f03239d81e000027&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;63701d74f032396b8e00002c&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;63701d74f032396b8e000037&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;63701d74f03239d81e00002a&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;63701d74f03239c72c0001ba&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;63701d74f032399c00000151&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;63701d74f03239c72c0001a1&quot;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;role&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;superadmin&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;__v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;createdAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-05-08T07:06:12.736Z&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;updatedAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-05-08T07:06:12.736Z&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>database</category>
      
      <category>NoSQL</category>
      
      <category>MongoDB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MongoDB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TCPå®ç°HTTPæœåŠ¡</title>
    <link href="/2024/02/02/TCP%E5%AE%9E%E7%8E%B0HTTP%E6%9C%8D%E5%8A%A1/"/>
    <url>/2024/02/02/TCP%E5%AE%9E%E7%8E%B0HTTP%E6%9C%8D%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<p>TCP åè®®æ˜¯ä¼ è¾“å±‚åè®®ï¼Œæœ‰ç«¯å£æ¦‚å¿µï¼Œå¯ä»¥åŸºäºæ­¤å®ç°åº”ç”¨å±‚ HTTP æŠ¥æ–‡æ”¶å‘</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// åŸºäºä¼ è¾“å±‚çš„TCPåè®®å®ç°åº”ç”¨å±‚HTTP</span><br><span class="hljs-keyword">import</span> net <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;net&#x27;</span>;<br><span class="hljs-keyword">const</span> statusLine = <span class="hljs-string">&#x27;HTTP/1.1 200 OK&#x27;</span>;<br><span class="hljs-keyword">const</span> resBody = <span class="hljs-string">&#x27;&lt;h1&gt;20240202&lt;/h1&gt;&#x27;</span>;<br><span class="hljs-keyword">const</span> resHeader = [<br>  <span class="hljs-string">&#x27;Content-Type: text/html&#x27;</span>,<br>  <span class="hljs-string">`Content-Length: <span class="hljs-subst">$&#123;resBody.length&#125;</span>`</span>,<br>  <span class="hljs-string">`Date: <span class="hljs-subst">$&#123;<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toUTCString()&#125;</span>`</span>,<br>];<br><span class="hljs-comment">// HTTPå“åº”æŠ¥æ–‡ç»“æ„</span><br><span class="hljs-comment">// çŠ¶æ€è¡Œ å“åº”å¤´ ç©ºè¡Œ å“åº”ä½“</span><br><span class="hljs-keyword">const</span> res = [statusLine, ...resHeader, <span class="hljs-string">&#x27;&#x27;</span>, resBody].<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;\r\n&#x27;</span>);<br><span class="hljs-keyword">const</span> tcp = net.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">socket</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// æ¥æ”¶åˆ°æ•°æ®çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨</span><br>  socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/GET/</span>.<span class="hljs-title function_">test</span>(data.<span class="hljs-title function_">toString</span>())) &#123;<br>      socket.<span class="hljs-title function_">write</span>(res);<br>    &#125;<br>  &#125;);<br>&#125;);<br><br>tcp.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;server is running at http://localhost:3000&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>ç½‘ç»œåè®®</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç½‘ç»œåè®®</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XSSè·¨ç«™è„šæœ¬æ”»å‡»</title>
    <link href="/2024/02/02/XSS%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB/"/>
    <url>/2024/02/02/XSS%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<p>ç½‘ç»œåº”ç”¨ç¨‹åºçš„å®‰å…¨æ¼æ´æ”»å‡»â€”â€”XSS æ”»å‡»</p><p>Cross-Site scripting è·¨ç«™è„šæœ¬</p><h2 id="XSS-ä¸‰ç§ç±»å‹"><a href="#XSS-ä¸‰ç§ç±»å‹" class="headerlink" title="XSS ä¸‰ç§ç±»å‹"></a>XSS ä¸‰ç§ç±»å‹</h2><h3 id="åå°„å‹-XSS"><a href="#åå°„å‹-XSS" class="headerlink" title="åå°„å‹ XSS"></a>åå°„å‹ XSS</h3><p>åå°„å‹ XSS åªæ˜¯ç®€å•åœ°æŠŠç”¨æˆ·è¾“å…¥çš„æ•°æ®<strong>ä»æœåŠ¡å™¨åå°„ç»™ç”¨æˆ·æµè§ˆå™¨</strong>ï¼Œé»‘å®¢è®¾è®¡ä¸€ä¸ª URL å¼•å¯¼ç”¨æˆ·è®¿é—®æ‰èƒ½å¼€å±•æ”»å‡»</p><p>url ä¸­åŒ…å«ä¿¡æ¯ç”šè‡³ script è„šæœ¬ï¼Œä¸€æ—¦ç‚¹å‡»è¿™ä¸ªé“¾æ¥ï¼Œscript å°±ä¼šæ‰§è¡Œï¼Œé»‘å®¢å¯èƒ½ä¼šåœ¨ script ä¸­å†™å…¥æœ¨é©¬</p><p>æ¯”å¦‚ <code>http://localhost:/index.html?a=&lt;script&gt;alter(1)&lt;/script&gt;</code></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">const params = <span class="hljs-built_in">new</span> URLSearchParams(<span class="hljs-keyword">location</span>.<span class="hljs-keyword">search</span>)<br>const <span class="hljs-type">name</span> = params.<span class="hljs-keyword">get</span>(<span class="hljs-string">&#x27;a&#x27;</span>);<br>console.log(<span class="hljs-type">name</span>);<br>document.<span class="hljs-keyword">write</span>(<span class="hljs-type">name</span>);<br></code></pre></td></tr></table></figure><h3 id="å­˜å‚¨å‹-XSSï¼ˆæœ€ä¸¥é‡ï¼‰"><a href="#å­˜å‚¨å‹-XSSï¼ˆæœ€ä¸¥é‡ï¼‰" class="headerlink" title="å­˜å‚¨å‹ XSSï¼ˆæœ€ä¸¥é‡ï¼‰"></a>å­˜å‚¨å‹ XSSï¼ˆæœ€ä¸¥é‡ï¼‰</h3><p>åœ¨çº¿èŠå¤©å®¤æˆ–è€…è¯„è®ºåŒºæ¯”è¾ƒå¸¸è§ï¼Œä¸éœ€è¦ç‰¹å®šçš„é“¾æ¥ URLï¼Œé»‘å®¢ä»…ä»…éœ€è¦åœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥ä¸€æ®µ script è„šæœ¬ï¼Œå¦‚æœå‰åç«¯éƒ½æ²¡æœ‰è¿‡æ»¤ï¼Œé‚£ä¹ˆè¿™æ®µè„šæœ¬ä¼šè¢«å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œä»¥åæ‰€æœ‰æµè§ˆè¿™ä¸ªè¢«æ„ŸæŸ“é¡µé¢çš„äººéƒ½ä¼šè¢«è¿™ä¸ªè„šæœ¬æ”»å‡»ï¼Œè„šæœ¬ä¸­å¯èƒ½ä¼šçªƒå– cookie ç­‰ä¿¡æ¯ï¼Œä¿¡æ¯èµ„æºç›—åˆ·</p><h3 id="DOM-å‹-XSS"><a href="#DOM-å‹-XSS" class="headerlink" title="DOM å‹ XSS"></a>DOM å‹ XSS</h3><p>ä¹Ÿè¢«ç§°ä¸ºå®¢æˆ·ç«¯ XSSï¼Œåˆ©ç”¨ JS ä¸ HTML çš„äº¤äº’æ€§è´¨å’Œ DOM å®ç°ã€‚</p><p>ç”¨æˆ·è®¿é—®æŸä¸ª URL æ—¶ï¼Œæµè§ˆå™¨è‡ªåŠ¨æ‰§è¡Œ JS ä»£ç ï¼Œæ¶æœ‰ä»£ç ä¼šè¢«æ³¨å…¥åˆ°å½“å‰é¡µé¢ï¼Œç¯¡æ”¹å†…å®¹æˆ–è€…ç›—å–ç”¨æˆ·ä¸ªäººæ•æ„Ÿä¿¡æ¯</p><p><strong>ä¸ä¼šè§¦å‘ HTTP è¯·æ±‚å’Œå“åº”è¿‡ç¨‹ï¼Œæ”»å‡»ä¸ä¼šä¼ é€’åˆ°æœåŠ¡ç«¯ï¼Œä»…ä»…åœ¨å®¢æˆ·ç«¯</strong></p><h2 id="é¢„é˜²-XSS"><a href="#é¢„é˜²-XSS" class="headerlink" title="é¢„é˜² XSS"></a>é¢„é˜² XSS</h2><p>CSPï¼ˆContent Security Policyï¼‰ï¼šé€šè¿‡è®¾ç½®å“åº”æŠ¥æ–‡å¤´ä¸­çš„ CSP ç­–ç•¥ï¼Œé™åˆ¶é¡µé¢ä¸­å¯æ‰§è¡Œçš„è„šæœ¬æ¥æºã€æ ·å¼è¡¨ã€å›¾åƒã€å­—ä½“ç­‰ï¼Œä»¥æ­¤å‡å°‘æ¶æ„ä»£ç ç­‰æ‰§è¡Œå¯èƒ½æ€§</p><p>é…ç½® CSP è§„åˆ™</p><p>åœ¨æœåŠ¡ç«¯ç”Ÿæˆ CSP è§„åˆ™ï¼Œä»¥ HTTP response header çš„æ–¹å¼å‘é€ç»™æµè§ˆå™¨å¦‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span></span><br><span class="hljs-tag">  <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Content-Security-Policy&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;default-scr &#x27;self&#x27;; script-src &#x27;self&#x27; cdn.example.com; style-src &#x27;self&#x27; fonts.googleapis.com&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br></code></pre></td></tr></table></figure><ul><li>default-src åªèƒ½ä»å½“å‰æºåŠ è½½èµ„æºï¼Œä¾‹å¦‚ HTML é¡µé¢ã€å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ç­‰</li><li>script-src</li><li>style-src</li></ul><h2 id="CSP-ç­–ç•¥"><a href="#CSP-ç­–ç•¥" class="headerlink" title="CSP ç­–ç•¥"></a>CSP ç­–ç•¥</h2><h3 id="é˜²æ­¢-XSS-æ”»å‡»"><a href="#é˜²æ­¢-XSS-æ”»å‡»" class="headerlink" title="é˜²æ­¢ XSS æ”»å‡»"></a>é˜²æ­¢ XSS æ”»å‡»</h3><p>é€šè¿‡ç¦æ­¢å¤–éƒ¨è„šæœ¬ï¼Œä¾‹å¦‚ç¬¬ä¸‰æ–¹å¹¿å‘Šã€æ¶æ„è„šæœ¬ç­‰æ‰§è¡Œï¼Œé˜²æ­¢ XSS æ”»å‡»</p><h3 id="é˜²æ­¢æ•°æ®æ³„éœ²"><a href="#é˜²æ­¢æ•°æ®æ³„éœ²" class="headerlink" title="é˜²æ­¢æ•°æ®æ³„éœ²"></a>é˜²æ­¢æ•°æ®æ³„éœ²</h3><p>é€šè¿‡ç¦æ­¢å¤–éƒ¨èµ„æºåŠ è½½ï¼Œé˜²æ­¢æ•æ„Ÿæ•°æ®è¢«çªƒå–æˆ–è€…ç¯¡æ”¹</p><h3 id="é˜²æ­¢ç‚¹å‡»åŠ«æŒ"><a href="#é˜²æ­¢ç‚¹å‡»åŠ«æŒ" class="headerlink" title="é˜²æ­¢ç‚¹å‡»åŠ«æŒ"></a>é˜²æ­¢ç‚¹å‡»åŠ«æŒ</h3><p>é€šè¿‡ç¦æ­¢é¡µé¢åµŒå…¥å¼ IFRAMEï¼Œé˜²æ­¢è¢«é’“é±¼ç½‘ç«™åˆ©ç”¨</p><h2 id="è§£å†³æ–¹æ³•ï¼š"><a href="#è§£å†³æ–¹æ³•ï¼š" class="headerlink" title="è§£å†³æ–¹æ³•ï¼š"></a>è§£å†³æ–¹æ³•ï¼š</h2><h3 id="ç®€å•â€”â€”åˆ©ç”¨æ­£åˆ™å°†"><a href="#ç®€å•â€”â€”åˆ©ç”¨æ­£åˆ™å°†" class="headerlink" title="ç®€å•â€”â€”åˆ©ç”¨æ­£åˆ™å°†&gt; &lt;è§£ææˆæ–‡æœ¬å®ä½“ï¼Œå°±ä¸ä¼šå°†å…¶è§£ææˆ script æ ‡ç­¾äº†ï¼Œå‰åç«¯éƒ½è¦å¤„ç†"></a>ç®€å•â€”â€”åˆ©ç”¨æ­£åˆ™å°†<code>&gt;</code> <code>&lt;</code>è§£ææˆæ–‡æœ¬å®ä½“ï¼Œå°±ä¸ä¼šå°†å…¶è§£ææˆ script æ ‡ç­¾äº†ï¼Œå‰åç«¯éƒ½è¦å¤„ç†</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> textArea = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;textarea&#x27;</span>);<br><span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;div&#x27;</span>);<br><span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">append</span>(textArea, content);<br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;keydown&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">keyCode</span> === <span class="hljs-number">13</span>) &#123;<br>    <span class="hljs-comment">// content.innerHTML = textArea.value;</span><br>    <span class="hljs-comment">// å°†&lt;&gt;å˜æˆå­—ç¬¦å®ä½“ï¼Œé¿å…é”™è¯¯åœ°æ‰§è¡Œé»‘å®¢è¾“å…¥çš„è„šæœ¬å†…å®¹</span><br>    content.<span class="hljs-property">innerHTML</span> = textArea.<span class="hljs-property">value</span><br>      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">&#x27;&amp;lt;&#x27;</span>)<br>      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">&#x27;&amp;gt;&#x27;</span>);<br>    textArea.<span class="hljs-property">value</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="æˆç†Ÿâ€”â€”ä½¿ç”¨ç¬¬ä¸‰æ–¹-xss-åº“"><a href="#æˆç†Ÿâ€”â€”ä½¿ç”¨ç¬¬ä¸‰æ–¹-xss-åº“" class="headerlink" title="æˆç†Ÿâ€”â€”ä½¿ç”¨ç¬¬ä¸‰æ–¹ xss åº“"></a>æˆç†Ÿâ€”â€”ä½¿ç”¨ç¬¬ä¸‰æ–¹ xss åº“</h2>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>ç½‘ç»œå®‰å…¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç½‘ç»œå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç½‘ç»œçŠ¶æ€ å¼ºç½‘å¼±ç½‘ç¯å¢ƒ</title>
    <link href="/2024/02/01/%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81&amp;%E5%BC%BA%E7%BD%91%E5%BC%B1%E7%BD%91%E7%8E%AF%E5%A2%83/"/>
    <url>/2024/02/01/%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81&amp;%E5%BC%BA%E7%BD%91%E5%BC%B1%E7%BD%91%E7%8E%AF%E5%A2%83/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰ç«¯è·å–ç½‘ç»œçŠ¶æ€"><a href="#å‰ç«¯è·å–ç½‘ç»œçŠ¶æ€" class="headerlink" title="å‰ç«¯è·å–ç½‘ç»œçŠ¶æ€"></a>å‰ç«¯è·å–ç½‘ç»œçŠ¶æ€</h1><h2 id="navigator-onLine-è·å–ç½‘ç»œç¯å¢ƒçŠ¶æ€"><a href="#navigator-onLine-è·å–ç½‘ç»œç¯å¢ƒçŠ¶æ€" class="headerlink" title="navigator.onLine è·å–ç½‘ç»œç¯å¢ƒçŠ¶æ€"></a><code>navigator.onLine</code> è·å–ç½‘ç»œç¯å¢ƒçŠ¶æ€</h2><p>é™¤äº†ä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨ä¹‹å¤–ï¼ŒJavaScript è¿˜æä¾›äº†å¦ä¸€ç§æ–¹å¼æ¥æ£€æµ‹æµè§ˆå™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€ï¼Œå³ä½¿ç”¨ <code>navigator.onLine</code> å±æ€§ã€‚è¯¥å±æ€§<strong>è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæµè§ˆå™¨æ˜¯å¦å¤„äºè”ç½‘çŠ¶æ€</strong>ã€‚</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(navigator.onLine);<br></code></pre></td></tr></table></figure><h2 id="online-å’Œ-offline-äº‹ä»¶åŠå…¶å¤„ç†å‡½æ•°"><a href="#online-å’Œ-offline-äº‹ä»¶åŠå…¶å¤„ç†å‡½æ•°" class="headerlink" title="online å’Œ offline äº‹ä»¶åŠå…¶å¤„ç†å‡½æ•°"></a>online å’Œ offline äº‹ä»¶åŠå…¶å¤„ç†å‡½æ•°</h2><p><strong><code>online</code> å’Œ <code>offline</code> äº‹ä»¶æ˜¯æµè§ˆå™¨è‡ªå¸¦çš„ä¸¤ä¸ªäº‹ä»¶ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ äº‹ä»¶ç›‘å¬å™¨æ¥æ£€æµ‹å½“å‰ç½‘ç»œè¿æ¥çŠ¶æ€</strong>ã€‚å½“æµè§ˆå™¨çš„ç½‘ç»œè¿æ¥å‘ç”Ÿå˜åŒ–ï¼Œæ¯”å¦‚ä»åœ¨çº¿çŠ¶æ€åˆ‡æ¢åˆ°ç¦»çº¿çŠ¶æ€ï¼Œæˆ–è€…ä»ç¦»çº¿çŠ¶æ€åˆ‡æ¢åˆ°åœ¨çº¿çŠ¶æ€æ—¶ï¼Œè¿™ä¸¤ä¸ªäº‹ä»¶å°±ä¼šè¢«è§¦å‘ã€‚</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">window.addEventListener(<span class="hljs-string">&#x27;online&#x27;</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  console.log(<span class="hljs-string">&#x27;online&#x27;</span>);<br>&#125;);<br>window.addEventListener(<span class="hljs-string">&#x27;offline&#x27;</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  console.log(<span class="hljs-string">&#x27;offline&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="navigator-connection"><a href="#navigator-connection" class="headerlink" title="navigator.connection"></a><code>navigator.connection</code></h2><p><code>navigator.connection</code> æ˜¯ Web API ä¸­æä¾›çš„ä¸€ç§è·å–ç½‘ç»œè¿æ¥ç›¸å…³ä¿¡æ¯çš„æ¥å£ã€‚</p><p>è¯¥æ¥å£è¿”å›çš„æ˜¯ä¸€ä¸ª <code>NetworkInformation</code> å¯¹è±¡ï¼ˆåªè¯»ï¼‰ï¼ŒåŒ…å«äº†å¤šä¸ªå…³äºç”¨æˆ·è®¾å¤‡ç½‘ç»œè¿æ¥çŠ¶å†µçš„å±æ€§ï¼Œå¦‚ç½‘ç»œç±»å‹ã€å¸¦å®½ã€å¾€è¿”æ—¶é—´ç­‰ã€‚</p><p>é€šè¿‡ <code>navigator.connection</code> API èƒ½å¤Ÿè·å–çš„ä¸»è¦ç½‘ç»œè¿æ¥å±æ€§å¦‚ä¸‹ï¼š</p><ul><li><code>downlink</code>: å½“å‰ç½‘ç»œè¿æ¥çš„ä¼°è®¡ä¸‹è¡Œé€Ÿåº¦ï¼ˆå•ä½ä¸º Mbpsï¼‰</li><li><code>downlinkMax</code>: è®¾å¤‡ç½‘ç»œè¿æ¥æœ€å¤§å¯èƒ½ä¸‹è¡Œé€Ÿåº¦ï¼ˆå•ä½ä¸º Mbpsï¼‰</li><li><strong><code>effectiveType</code>: å½“å‰ç½‘ç»œè¿æ¥çš„ä¼°è®¡é€Ÿåº¦ç±»å‹ï¼ˆå¦‚ slow-2gã€2gã€3gã€4g ç­‰ï¼‰å’Œè®¾å¤‡æ²¡æœ‰å…³ç³»</strong></li><li><code>rtt</code>: å½“å‰ç½‘ç»œè¿æ¥çš„ä¼°è®¡å¾€è¿”æ—¶é—´ï¼ˆå•ä½ä¸ºæ¯«ç§’ï¼‰</li><li><code>saveData</code>: æ˜¯å¦å¤„äºæ•°æ®èŠ‚çœæ¨¡å¼</li></ul><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–è¯¸å¦‚ <code>type</code>ã€<code>onchange</code> ç­‰å±æ€§ï¼Œç”¨äºè·å–è®¾å¤‡ç½‘ç»œè¿æ¥çš„ç±»å‹å’Œæ³¨å†Œç½‘ç»œè¿æ¥çŠ¶æ€å˜åŒ–äº‹ä»¶ç­‰åŠŸèƒ½ã€‚</p><h3 id="ä½¿ç”¨å‰æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ"><a href="#ä½¿ç”¨å‰æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ" class="headerlink" title="ä½¿ç”¨å‰æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ"></a>ä½¿ç”¨å‰æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;connection&#x27;</span> in navigator) &#123;<br>  <span class="hljs-comment">// æ”¯æŒ navigator.connection API</span><br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(navigator.connection);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// ä¸æ”¯æŒ navigator.connection API</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>ç½‘ç»œçŠ¶æ€</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç½‘ç»œçŠ¶æ€</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JWTï¼ˆé‰´æƒï¼‰</title>
    <link href="/2024/02/01/JWT/"/>
    <url>/2024/02/01/JWT/</url>
    
    <content type="html"><![CDATA[<h2 id="jwt-json-web-token"><a href="#jwt-json-web-token" class="headerlink" title="jwt(json web token)"></a>jwt(json web token)</h2><p><strong>ç”¨äºé‰´æƒï¼Œç™»å½•ä¹‹åå­˜å‚¨ç”¨æˆ·ä¿¡æ¯</strong></p><h3 id="ç”Ÿæˆçš„-token-ä»¤ç‰Œ-æ ¼å¼"><a href="#ç”Ÿæˆçš„-token-ä»¤ç‰Œ-æ ¼å¼" class="headerlink" title="ç”Ÿæˆçš„ token(ä»¤ç‰Œ) æ ¼å¼"></a>ç”Ÿæˆçš„ token(ä»¤ç‰Œ) æ ¼å¼</h3><p>ä¸‰æ®µï¼Œæ¯æ®µç”±<code>.</code>è¿æ¥</p><p>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiaWF0IjoxNjg3Njc0NDkyLCJleHAiOjE2ODc3NjA4OTJ9.Y6eFGv4KXqUhlRHglGCESvcJEnyMkMwM1WfICt8xYC4</p><h2 id="ç»„æˆ"><a href="#ç»„æˆ" class="headerlink" title="ç»„æˆ"></a>ç»„æˆ</h2><h3 id="header-å¤´éƒ¨"><a href="#header-å¤´éƒ¨" class="headerlink" title="header å¤´éƒ¨"></a>header å¤´éƒ¨</h3><p>header é€šå¸¸ç”¨ json å¯¹è±¡è¡¨ç¤ºï¼Œå¹¶è¿›è¡Œ Base64 URL ç¼–ç </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;alg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HS256&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;typ&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JWT&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>algï¼šä»£è¡¨æ‰€ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼Œä¾‹å¦‚ HMAC SHA256ï¼ˆHS256ï¼‰æˆ– RSA ç­‰</p><p>typï¼šä»£è¡¨ä»¤ç‰Œçš„ç±»å‹ï¼Œä¸€èˆ¬ä¸º â€œJWTâ€ã€‚</p><h3 id="payload-è½½è·"><a href="#payload-è½½è·" class="headerlink" title="payload è½½è·"></a>payload è½½è·</h3><p>payload ä¹Ÿæ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒåŒæ ·è¿›è¡Œ Base64 URL ç¼–ç ã€‚</p><p>è´Ÿè½½åŒ…å«æ‰€è¦ä¼ è¾“çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨æˆ·çš„èº«ä»½ã€æƒé™ç­‰ï¼Œä½†ä¸æ˜¯å¯†ç è¿™ç§å…³é”®ä¿¡æ¯ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;iss&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;example.com&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;exp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1624645200</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;sub&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1234567890&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;johndoe&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>issï¼šä»¤ç‰Œé¢å‘è€…ï¼ˆIssuerï¼‰ï¼Œä»£è¡¨è¯¥ JWT çš„ç­¾å‘è€…ã€‚</p><p>expï¼šè¿‡æœŸæ—¶é—´ï¼ˆExpiration Timeï¼‰ï¼Œä»£è¡¨è¯¥ JWT çš„è¿‡æœŸæ—¶é—´ï¼Œä»¥ Unix æ—¶é—´æˆ³è¡¨ç¤ºã€‚</p><p>subï¼šä¸»é¢˜ï¼ˆSubjectï¼‰ï¼Œä»£è¡¨è¯¥ JWT æ‰€é¢å‘çš„ç”¨æˆ·ï¼ˆä¸€èˆ¬æ˜¯ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼‰ã€‚</p><p>è‡ªå®šä¹‰å£°æ˜ï¼šå¯ä»¥æ·»åŠ é™¤äº†é¢„å®šä¹‰å£°æ˜ä¹‹å¤–çš„ä»»æ„å…¶ä»–å£°æ˜ã€‚</p><h3 id="signature-ç­¾å"><a href="#signature-ç­¾å" class="headerlink" title="signature ç­¾å"></a>signature ç­¾å</h3><p><strong>ç­¾åæ˜¯ä½¿ç”¨ç§é’¥å¯¹å¤´éƒ¨å’Œè´Ÿè½½è¿›è¡ŒåŠ å¯†çš„ç»“æœ</strong></p><p><strong>ç”¨äºéªŒè¯ä»¤ç‰Œçš„å®Œæ•´æ€§å’ŒçœŸå®æ€§</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-built_in">HMACSHA256</span>(<br><span class="hljs-function"><span class="hljs-title">base64UrlEncode</span><span class="hljs-params">(header)</span></span> + <span class="hljs-string">&quot;.&quot;</span> +<br><span class="hljs-function"><span class="hljs-title">base64UrlEncode</span><span class="hljs-params">(payload)</span></span>,<br>secretKey<br>)<br></code></pre></td></tr></table></figure><h2 id="æœåŠ¡ç«¯-Express-å®ç°-JWT"><a href="#æœåŠ¡ç«¯-Express-å®ç°-JWT" class="headerlink" title="æœåŠ¡ç«¯ Express å®ç° JWT"></a>æœåŠ¡ç«¯ Express å®ç° JWT</h2><p>ä½¿ç”¨ jsonwebtoken.sign(infoObj, private_key_str, {expiresIn: â€˜1hâ€™})æ¥ç”Ÿæˆ token</p><p>ä½¿ç”¨ const token &#x3D; req.headers.authorization || â€˜â€™;ä»è¯·æ±‚å¤´ä¸­è¯» token</p><p>å¦‚æœæ— æ³•é€šè¿‡ token éªŒè¯ï¼Œè¿”å›çŠ¶æ€ç  401</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">pnpm</span> i express cors jsonwebtoken <span class="hljs-variable">@types</span>/express <span class="hljs-variable">@types</span>/cors <span class="hljs-variable">@types</span>/jsonwebtoken<br></code></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express&#x27;</span>;<br><span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;cors&#x27;</span>;<br><span class="hljs-keyword">import</span> jsonwebtoken <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;jsonwebtoken&#x27;</span>;<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-comment">// ä¸€èˆ¬æ¥è¯´private keyæ˜¯åœ¨ç¯å¢ƒå˜é‡ä¸­é…ç½®ï¼Œæˆ–è€…åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­</span><br><span class="hljs-keyword">const</span> private_key = <span class="hljs-string">&#x27;123456&#x27;</span>;<br><br><span class="hljs-comment">// æ”¯æŒè§£æjson</span><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());<br><span class="hljs-comment">// è§£å†³è·¨åŸŸ</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>());<br><span class="hljs-comment">// ä¸æ”¯æŒè§£æurlencoded</span><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>(&#123; <span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span> &#125;));<br><span class="hljs-keyword">let</span> user = &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;admin&#x27;</span>,<br>  <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>&#125;;<br><span class="hljs-comment">// 1.ç™»é™†è¿”å›å‰ç«¯tokenç”¨äºæˆæƒ</span><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">body</span>.<span class="hljs-property">name</span> === user.<span class="hljs-property">name</span> &amp;&amp; req.<span class="hljs-property">body</span>.<span class="hljs-property">password</span> === user.<span class="hljs-property">password</span>) &#123;<br>    res.<span class="hljs-title function_">json</span>(&#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">token</span>: jsonwebtoken.<span class="hljs-title function_">sign</span>(&#123; <span class="hljs-attr">id</span>: user.<span class="hljs-property">id</span> &#125;, private_key, &#123;<br>        <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&#x27;1h&#x27;</span>,<br>      &#125;), <span class="hljs-comment">// tokenè¿‡æœŸæ—¶é—´ä¸º1hï¼Œåç»­å¯ä»¥ä¿®æ”¹ä¸ºé…ç½®æ–‡ä»¶è¯»å–ï¼Œå¤±æ•ˆä¹‹åè¦é‡æ–°ç™»é™†æˆæƒ</span><br>    &#125;);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">json</span>(&#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">1</span>,<br>      <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&#x27;</span>,<br>    &#125;);<br>  &#125;<br>&#125;);<br><span class="hljs-comment">// 2.åªæœ‰tokené€šè¿‡è®¤è¯æ‰èƒ½è®¿é—®listï¼Œå¦åˆ™403</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/list&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// å‰ç«¯ä¼šæŠŠtokenæ”¾åœ¨è¯·æ±‚å¤´ä¸­ è¿™æ˜¯ä¸€ä¸ªè§„èŒƒ</span><br>  <span class="hljs-keyword">const</span> token = req.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span> || <span class="hljs-string">&#x27;&#x27;</span>;<br>  jsonwebtoken.<span class="hljs-title function_">verify</span>(token, private_key, <span class="hljs-function">(<span class="hljs-params">err, decoded</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) &#123;<br>      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">json</span>(&#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;tokenè¿‡æœŸæˆ–æ— æ•ˆ&#x27;</span>,<br>      &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      res.<span class="hljs-title function_">json</span>(&#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-attr">data</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],<br>      &#125;);<br>    &#125;<br>  &#125;);<br>&#125;);<br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;server is running at http://localhost:3000&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="ç”¨æˆ·ç«¯-fetch"><a href="#ç”¨æˆ·ç«¯-fetch" class="headerlink" title="ç”¨æˆ·ç«¯ fetch"></a>ç”¨æˆ·ç«¯ fetch</h2><p>å°† token ä¿å­˜åœ¨ localStorage ä¸­ï¼ŒåŒåŸŸçš„æ‰€æœ‰çª—å£éƒ½å¯ä»¥è·å–ï¼Œæµè§ˆå™¨å…³é—­å item ä¾ç„¶å­˜åœ¨</p><p>location.href &#x3D; â€˜.&#x2F;list.htmlâ€™;å®ç°åŸç”Ÿé¡µé¢è·³è½¬</p><p>ä¸€èˆ¬æ¥è¯´ token å‰é¢ä¼šåŠ ä¸Šâ€™Bearer â€˜å‰ç¼€ï¼Œè¿™æ˜¯ä¸€ä¸ª w3c çº¦å®šçš„è§„èŒƒï¼Œå…·ä½“å®æ–½èµ·æ¥è¦å‰åå°åå•†</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs ts">loginBtn?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://localhost:3000/login&#x27;</span>, &#123;<br>    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>    <span class="hljs-attr">headers</span>: &#123;<br>      <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,<br>    &#125;,<br>    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123;<br>      <span class="hljs-attr">name</span>: (nameInput <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLInputElement</span>).<span class="hljs-property">value</span>,<br>      <span class="hljs-attr">password</span>: (pwdInput <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLInputElement</span>).<span class="hljs-property">value</span>,<br>    &#125;),<br>  &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">d</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (d.<span class="hljs-property">code</span> === <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-variable language_">sessionStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;tk&#x27;</span>, d.<span class="hljs-property">token</span>);<br>        (nameInput <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLInputElement</span>).<span class="hljs-property">value</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        (pwdInput <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLInputElement</span>).<span class="hljs-property">value</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-comment">// åŸç”Ÿé¡µé¢è·³è½¬</span><br>        <span class="hljs-comment">// localStorageæ”¯æŒåŒåŸŸè®¿é—®</span><br>        location.<span class="hljs-property">href</span> = <span class="hljs-string">&#x27;./list.html&#x27;</span>;<br>      &#125;<br>    &#125;)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e);<br>    &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>èº«ä»½éªŒè¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>èº«ä»½éªŒè¯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SSL TLS HTTPS</title>
    <link href="/2024/01/31/SSL%20TLS%20HTTPS/"/>
    <url>/2024/01/31/SSL%20TLS%20HTTPS/</url>
    
    <content type="html"><![CDATA[<h2 id="HTTPS-http-TLS-SSL"><a href="#HTTPS-http-TLS-SSL" class="headerlink" title="HTTPS &#x3D; http + TLS&#x2F;SSL"></a>HTTPS &#x3D; http + TLS&#x2F;SSL</h2><p><strong>HTTPSï¼Œå…¨ç§°ä¸º Hypertext Transfer Protocol Secure</strong>ï¼Œæ˜¯ä¸€ç§é€šè¿‡åŠ å¯†é€šé“ä¼ è¾“æ•°æ®çš„å®‰å…¨åè®®ã€‚å®ƒæ˜¯ <strong>HTTP åè®®çš„å®‰å…¨ç‰ˆæœ¬ï¼Œç”¨äºåœ¨ Web æµè§ˆå™¨å’Œ Web æœåŠ¡å™¨ä¹‹é—´è¿›è¡Œå®‰å…¨çš„æ•°æ®ä¼ è¾“</strong>ã€‚HTTPS åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä½¿ç”¨äº† SSLï¼ˆSecure Sockets Layerï¼‰æˆ– TLSï¼ˆTransport Layer Securityï¼‰åè®®æ¥åŠ å¯†æ•°æ®ï¼Œç¡®ä¿æ•æ„Ÿä¿¡æ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸ä¼šè¢«çªƒå–æˆ–ç¯¡æ”¹ã€‚</p><p><strong>æ³¨æ„ï¼šhttps é»˜è®¤ç›‘å¬ç«¯å£ 443 http é»˜è®¤ç›‘å¬ç«¯å£ 80</strong></p><h3 id="http-ç¼ºç‚¹"><a href="#http-ç¼ºç‚¹" class="headerlink" title="http ç¼ºç‚¹"></a>http ç¼ºç‚¹</h3><ol><li><strong>ä¿¡æ¯ä¸åŠ å¯†ï¼šé€šä¿¡ä½¿ç”¨æ˜æ–‡(ä¸åŠ å¯†)ï¼Œå†…å®¹å¯èƒ½ä¼šè¢«ç›—ç”¨</strong></li><li><strong>æ— èº«ä»½æ ¡éªŒï¼šä¸éªŒè¯é€šä¿¡æ–¹çš„èº«ä»½ï¼Œå› æ­¤æœ‰å¯èƒ½é­é‡ä¼ªè£…</strong></li><li><strong>æ— å®Œæ•´æ€§éªŒè¯ï¼šæ— æ³•è¯æ˜æŠ¥æ–‡çš„å®Œæ•´æ€§ï¼Œæ‰€ä»¥æœ‰å¯èƒ½å·²é­ç¯¡æ”¹</strong></li></ol><h3 id="https-ä¼˜ç‚¹"><a href="#https-ä¼˜ç‚¹" class="headerlink" title="https ä¼˜ç‚¹"></a>https ä¼˜ç‚¹</h3><ol><li><p><strong>ä¿¡æ¯åŠ å¯†</strong></p></li><li><p><strong>èº«ä»½éªŒè¯</strong></p></li><li><p><strong>å®Œæ•´æ€§æ ¡éªŒ</strong></p></li></ol><h2 id="TLS-SSL"><a href="#TLS-SSL" class="headerlink" title="TLS SSL"></a>TLS SSL</h2><p>TLSï¼ˆTransport Layer Securityï¼‰å’Œ SSLï¼ˆSecure Sockets Layerï¼‰æ˜¯ç”¨äºä¿æŠ¤ç½‘ç»œé€šä¿¡çš„å®‰å…¨åè®®ã€‚å®ƒä»¬éƒ½æä¾›äº†<strong>åŠ å¯†å’Œè®¤è¯æœºåˆ¶</strong>ï¼Œç”¨äºç¡®ä¿æ•°æ®ä¼ è¾“çš„æœºå¯†æ€§å’Œå®Œæ•´æ€§ã€‚</p><p><strong>SSL æ˜¯æœ€æ—©çš„å®‰å…¨åè®®ï¼Œè€Œ TLS æ˜¯åœ¨ SSL çš„åŸºç¡€ä¸Šå‘å±•èµ·æ¥çš„ã€‚</strong>ç›®å‰å¹¿æ³›ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ TLS 1.2 å’Œ TLS 1.3ã€‚TLS 1.3 æ˜¯æœ€æ–°çš„åè®®ç‰ˆæœ¬ï¼Œåœ¨å®‰å…¨æ€§ã€æ€§èƒ½å’ŒåŠŸèƒ½æ–¹é¢æœ‰ä¸€äº›æ”¹è¿›ã€‚</p><p>TLS å’Œ SSL ä¸»è¦ç”¨äºä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š</p><ol><li><strong>åŠ å¯†é€šä¿¡</strong>ï¼šTLS&#x2F;SSL ä½¿ç”¨åŠ å¯†ç®—æ³•æ¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œé˜²æ­¢ç¬¬ä¸‰æ–¹æˆªè·å’Œçªƒå¬é€šä¿¡å†…å®¹ã€‚å®ƒå¯ä»¥ç¡®ä¿æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„éšç§æ€§ã€‚</li><li><strong>èº«ä»½è®¤è¯</strong>ï¼šTLS&#x2F;SSL è¿˜æä¾›äº†èº«ä»½éªŒè¯æœºåˆ¶ï¼Œç”¨äºç¡®è®¤é€šä¿¡åŒæ–¹çš„èº«ä»½ï¼Œå¹¶ç¡®ä¿æ•°æ®åªå‘é€åˆ°æ­£ç¡®çš„æ¥æ”¶æ–¹ã€‚è¿™å¯ä»¥é˜²æ­¢æ¶æ„ç”¨æˆ·å†’å……å…¶ä»–ç”¨æˆ·æˆ–æœåŠ¡å™¨ã€‚</li></ol><p><strong>SSL æ˜¯æœ€æ—©çš„ç”¨æ¥åš https çš„ï¼ŒTLS æ˜¯ SSL å‡çº§ç‰ˆã€‚äºŒè€…å·¥ä½œåŸç†ç±»ä¼¼ï¼Œä½† TLS æé«˜äº†å®‰å…¨æ€§ï¼Œå¹¶è§£å†³äº† SSL å­˜åœ¨çš„ä¸€äº›å®‰å…¨æ€§é—®é¢˜å’Œæ€§èƒ½é—®é¢˜ã€‚</strong></p><h2 id="åœ¨-TCP-IP-å››å±‚æ¨¡å‹ä¸­ï¼ŒTLS-SSL-åœ¨å“ªä¸€å±‚åŠ å¯†ï¼Ÿ"><a href="#åœ¨-TCP-IP-å››å±‚æ¨¡å‹ä¸­ï¼ŒTLS-SSL-åœ¨å“ªä¸€å±‚åŠ å¯†ï¼Ÿ" class="headerlink" title="åœ¨ TCP&#x2F;IP å››å±‚æ¨¡å‹ä¸­ï¼ŒTLS SSL åœ¨å“ªä¸€å±‚åŠ å¯†ï¼Ÿ"></a>åœ¨ TCP&#x2F;IP å››å±‚æ¨¡å‹ä¸­ï¼ŒTLS SSL åœ¨å“ªä¸€å±‚åŠ å¯†ï¼Ÿ</h2><p>åœ¨åº”ç”¨å±‚ä¸‹ã€åœ¨ä¼ è¾“å±‚ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºâ€œå®‰å…¨å±‚â€</p><h2 id="åŠ å¯†ç®—æ³•"><a href="#åŠ å¯†ç®—æ³•" class="headerlink" title="åŠ å¯†ç®—æ³•"></a>åŠ å¯†ç®—æ³•</h2><h3 id="å¯¹ç§°åŠ å¯†-å…±æœ‰å¯†é’¥"><a href="#å¯¹ç§°åŠ å¯†-å…±æœ‰å¯†é’¥" class="headerlink" title="å¯¹ç§°åŠ å¯† å…±æœ‰å¯†é’¥"></a>å¯¹ç§°åŠ å¯† å…±æœ‰å¯†é’¥</h3><p>å¸¸è§çš„ç®—æ³•æœ‰ AES DES åŠ å¯†</p><p>ä¸¾ä¾‹ <code>éº’éºŸ</code>-&gt;<code>æ˜Ÿæœˆ</code>å‘æ¶ˆæ¯ ä½†æ˜¯ä»–ä»¬çš„æ¶ˆæ¯ä¸æƒ³è¢«åˆ«äººçŸ¥é“ï¼Œé‡‡ç”¨äº†å¯¹ç§°åŠ å¯†ï¼Œäºæ˜¯ä»–ä»¬ä¸¤ä¸ªåå•†äº†ä¸€æ®µå¯†é’¥ï¼Œ<code>ä»Šç”Ÿæ°¸ç›¸éš</code></p><p>éº’éºŸï¼š<code>AESç®—æ³• + å¯†é’¥ï¼ˆä»Šç”Ÿæ°¸ç›¸éšï¼‰+æ˜æ–‡ï¼ˆåƒé¢ï¼‰ = XMZSXMZS==</code></p><p>æ˜Ÿæœˆï¼š<code>ä½¿ç”¨AES + å¯†é’¥ï¼ˆä»Šç”Ÿæ°¸ç›¸éšï¼‰+å¯†æ–‡ï¼ˆ XMZSXMZS==ï¼‰ = åƒé¢</code></p><h3 id="éå¯¹ç§°åŠ å¯†-ä¸€äººåˆ†åˆ«ä¸€ä¸ªå…¬ç§é’¥"><a href="#éå¯¹ç§°åŠ å¯†-ä¸€äººåˆ†åˆ«ä¸€ä¸ªå…¬ç§é’¥" class="headerlink" title="éå¯¹ç§°åŠ å¯† ä¸€äººåˆ†åˆ«ä¸€ä¸ªå…¬ç§é’¥"></a>éå¯¹ç§°åŠ å¯† ä¸€äººåˆ†åˆ«ä¸€ä¸ªå…¬ç§é’¥</h3><p>å¸¸è§ç®—æ³•æœ‰ RSA DSA åŠ å¯†</p><p>ä¸¾ä¾‹ <code>éº’éºŸ</code>-&gt;<code>æ˜Ÿæœˆ</code>å‘æ¶ˆæ¯ï¼Œè¿™æ¬¡ä½¿ç”¨çš„æ˜¯éå¯¹ç§°åŠ å¯†ï¼Œç”Ÿæˆäº†å…¬é’¥å’Œç§é’¥ï¼Œå…¬é’¥å¯ä»¥å¯¹å¤–å…¬å¼€ï¼Œç§é’¥å¿…é¡»åªèƒ½<code>éº’éºŸ</code>çŸ¥é“ä¸èƒ½æ³„éœ²ã€‚</p><p>æ˜Ÿæœˆï¼šRSA + å…¬é’¥ + æ˜æ–‡ï¼ˆåƒé¢ï¼‰ &#x3D; XMZS&#x3D;&#x3D;</p><p>éº’éºŸï¼šRSA + ç§é’¥ + å¯†æ–‡ï¼ˆXMZS&#x3D;&#x3D;ï¼‰ &#x3D; åƒé¢</p><h3 id="æ•£åˆ—å‡½æ•°"><a href="#æ•£åˆ—å‡½æ•°" class="headerlink" title="æ•£åˆ—å‡½æ•°"></a>æ•£åˆ—å‡½æ•°</h3><h2 id="TLS-èåˆäº†å¯¹ç§°åŠ å¯†ã€éå¯¹ç§°åŠ å¯†ä»¥åŠæ•£åˆ—å‡½æ•°å®ç°åŠ å¯†ï¼Œä¿è¯å®‰å…¨æ€§"><a href="#TLS-èåˆäº†å¯¹ç§°åŠ å¯†ã€éå¯¹ç§°åŠ å¯†ä»¥åŠæ•£åˆ—å‡½æ•°å®ç°åŠ å¯†ï¼Œä¿è¯å®‰å…¨æ€§" class="headerlink" title="TLS èåˆäº†å¯¹ç§°åŠ å¯†ã€éå¯¹ç§°åŠ å¯†ä»¥åŠæ•£åˆ—å‡½æ•°å®ç°åŠ å¯†ï¼Œä¿è¯å®‰å…¨æ€§"></a>TLS èåˆäº†å¯¹ç§°åŠ å¯†ã€éå¯¹ç§°åŠ å¯†ä»¥åŠæ•£åˆ—å‡½æ•°å®ç°åŠ å¯†ï¼Œä¿è¯å®‰å…¨æ€§</h2><h2 id="TLS-è¯ä¹¦"><a href="#TLS-è¯ä¹¦" class="headerlink" title="TLS è¯ä¹¦"></a>TLS è¯ä¹¦</h2><p>åœ¨ SSL&#x2F;TLS åŠ å¯†é€šä¿¡ä¸­ï¼Œä¸€èˆ¬éœ€è¦ä½¿ç”¨ä¸‰ä¸ªæ–‡ä»¶æ¥å®Œæˆè¯ä¹¦ç›¸å…³æ“ä½œï¼Œå³ï¼š</p><ol><li><strong>ç§é’¥æ–‡ä»¶ï¼ˆä¾‹å¦‚ â€œprivate-key.pemâ€ï¼‰</strong>ï¼Œç”¨äºå¯¹åŠ å¯†æ•°æ®è¿›è¡Œè§£å¯†æ“ä½œã€‚</li><li><strong>è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ï¼ˆä¾‹å¦‚ â€œcertificate.csrâ€ï¼‰</strong>ï¼Œç”¨äºå‘ CA ç”³è¯· SSL&#x2F;TLS è¯ä¹¦ç­¾åã€‚</li><li><strong>SSL&#x2F;TLS è¯ä¹¦æ–‡ä»¶ï¼ˆä¾‹å¦‚ â€œcertificate.pemâ€ï¼‰</strong>ï¼Œç”¨äºå¯¹å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚è¿›è¡ŒéªŒè¯ï¼Œä»¥ç¡®ä¿é€šä¿¡å®‰å…¨å¯é ã€‚</li></ol><p>ç§é’¥æ–‡ä»¶ç”¨äºå¯¹æ•°æ®è¿›è¡Œè§£å¯†æ“ä½œï¼Œä¿è¯äº†é€šä¿¡çš„æœºå¯†æ€§ï¼›è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶åŒ…å«äº†è¯·æ±‚è€…çš„èº«ä»½ä¿¡æ¯å’Œå…¬é’¥ç­‰ä¿¡æ¯ï¼Œéœ€è¦è¢«å‘é€ç»™ CA è¿›è¡Œç­¾åï¼Œä»è€Œè·å–æœ‰æ•ˆçš„ SSL&#x2F;TLS è¯ä¹¦ï¼›SSL&#x2F;TLS è¯ä¹¦æ–‡ä»¶åˆ™åŒ…å«äº†ç­¾ååçš„è¯ä¹¦ä¿¡æ¯ï¼Œè¢«ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„èº«ä»½éªŒè¯ï¼Œä»¥ç¡®ä¿é€šä¿¡çš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚</p><p>é€šè¿‡ä½¿ç”¨è¿™ä¸‰ä¸ªæ–‡ä»¶è¿›è¡Œå¯†é’¥äº¤æ¢å’Œèº«ä»½éªŒè¯ï¼ŒSSL&#x2F;TLS å¯ä»¥å®ç°åŠ å¯†é€šä¿¡ä»¥åŠæŠµå¾¡å¯èƒ½çš„ä¸­é—´äººæ”»å‡»ï¼Œæé«˜äº†é€šä¿¡çš„å®‰å…¨æ€§å’Œä¿å¯†æ€§ã€‚</p><h2 id="openssl-ç”ŸæˆåŠ å¯†è¯ä¹¦"><a href="#openssl-ç”ŸæˆåŠ å¯†è¯ä¹¦" class="headerlink" title="openssl ç”ŸæˆåŠ å¯†è¯ä¹¦"></a>openssl ç”ŸæˆåŠ å¯†è¯ä¹¦</h2><h3 id="ç”Ÿæˆ-private-key-pem-æ–‡ä»¶"><a href="#ç”Ÿæˆ-private-key-pem-æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆ private-key.pem æ–‡ä»¶"></a>ç”Ÿæˆ private-key.pem æ–‡ä»¶</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">openssl genpkey -algorithm RSA -<span class="hljs-keyword">out</span> <span class="hljs-keyword">private</span>-key.pem -aes256<br></code></pre></td></tr></table></figure><p>openssl: OpenSSL å‘½ä»¤è¡Œå·¥å…·çš„åç§°ã€‚</p><p>genpkey: ç”Ÿæˆç§é’¥çš„å‘½ä»¤ã€‚</p><p>-algorithm RSA: æŒ‡å®šç”Ÿæˆ RSA ç§é’¥ã€‚</p><p>-out private-key.pem: å°†ç”Ÿæˆçš„ç§é’¥ä¿å­˜ä¸º private-key.pem æ–‡ä»¶ã€‚</p><p>-aes256: ä¸ºç§é’¥æ·»åŠ  AES 256 ä½åŠ å¯†ï¼Œä»¥ä¿æŠ¤ç§é’¥æ–‡ä»¶ä¸è¢«æœªç»æˆæƒçš„äººè®¿é—®ã€‚</p><p>Enter PEM pass phrase å¯†ç çŸ­è¯­ç”Ÿæˆ pem æ–‡ä»¶çš„æ—¶å€™éœ€è¦ 123123</p><h3 id="ç”Ÿæˆ-certificate-csr-æ–‡ä»¶"><a href="#ç”Ÿæˆ-certificate-csr-æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆ certificate.csr æ–‡ä»¶"></a>ç”Ÿæˆ certificate.csr æ–‡ä»¶</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs processing">openssl req -<span class="hljs-keyword">new</span> -<span class="hljs-built_in">key</span> <span class="hljs-keyword">private</span>-<span class="hljs-built_in">key</span>.<span class="hljs-property">pem</span> -out certificate.<span class="hljs-property">csr</span><br></code></pre></td></tr></table></figure><ol><li>â€œreqâ€: è¡¨ç¤ºä½¿ç”¨ X.509 è¯ä¹¦è¯·æ±‚ç®¡ç†å™¨ (Certificate Request Management) åŠŸèƒ½æ¨¡å—ã€‚</li><li>â€œ-newâ€: è¡¨ç¤ºç”Ÿæˆæ–°çš„è¯ä¹¦ç­¾åè¯·æ±‚ã€‚</li><li>â€œ-key private-key.pemâ€: è¡¨ç¤ºä½¿ç”¨æŒ‡å®šçš„ç§é’¥æ–‡ä»¶ â€œprivate-key.pemâ€ æ¥åŠ å¯†è¯ä¹¦ç­¾åè¯·æ±‚ä¸­çš„å¯†é’¥å¯¹ã€‚</li><li>â€œ-out certificate.csrâ€: è¡¨ç¤ºè¾“å‡ºç”Ÿæˆçš„è¯ä¹¦ç­¾åè¯·æ±‚åˆ°æ–‡ä»¶ â€œcertificate.csrâ€ ä¸­ã€‚è¯¥æ–‡ä»¶ä¸­åŒ…å«äº†ç”³è¯·è€…æä¾›çš„ä¸€äº›è¯ä¹¦è¯·æ±‚ä¿¡æ¯ï¼Œä¾‹å¦‚å…¬é’¥ã€æˆæƒä¸»ä½“çš„èº«ä»½ä¿¡æ¯ç­‰ã€‚</li></ol><p>Country Name (2 letter code) []:CN å›½å®¶</p><p>State or Province Name (full name) []:BJ çœä»½</p><p>Locality Name (eg, city) []:BJ åŸå¸‚</p><p>Organization Name (eg, company)ZMY ç»„ç»‡æˆ–è€…æ˜¯ä¸ªäºº</p><p>Organizational Unit Name (eg, section) []:XMKJ æœºæ„åç§°</p><p>Common Name (eg, fully qualified host name) []:localhost åŸŸå</p><p>Email Address []: é‚®ç®±åœ°å€</p><p>Please enter the following â€˜extraâ€™ attributes</p><p>to be sent with your certificate request</p><p>A challenge password []: å¯†ç åŠ ä¸¥ mmymmy</p><h3 id="ç”Ÿæˆ-certificate-pem-æ–‡ä»¶"><a href="#ç”Ÿæˆ-certificate-pem-æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆ certificate.pem æ–‡ä»¶"></a>ç”Ÿæˆ certificate.pem æ–‡ä»¶</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">openssl x509 -req -<span class="hljs-keyword">in</span> certificate.csr -signkey <span class="hljs-keyword">private</span>-key.pem -<span class="hljs-keyword">out</span> certificate.pem<br></code></pre></td></tr></table></figure><p>â€œx509â€: è¡¨ç¤ºä½¿ç”¨ X.509 è¯ä¹¦ç®¡ç†å™¨åŠŸèƒ½æ¨¡å—ã€‚</p><p>â€œ-reqâ€: è¡¨ç¤ºä»è¾“å…¥æ–‡ä»¶ï¼ˆè¿™é‡Œä¸º â€œcertificate.csrâ€ï¼‰ä¸­è¯»å–è¯ä¹¦ç­¾åè¯·æ±‚æ•°æ®ã€‚</p><p>â€œ-in certificate.csrâ€: æŒ‡å®šè¦è¯»å–çš„è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶åã€‚</p><p>â€œ-signkey private-key.pemâ€: æŒ‡å®šä½¿ç”¨æŒ‡å®šçš„ç§é’¥æ–‡ä»¶ â€œprivate-key.pemâ€ æ¥è¿›è¡Œç­¾åæ“ä½œã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç­¾åè¯ä¹¦çš„ç§é’¥åº”è¯¥æ˜¯å’Œä¹‹å‰ç”Ÿæˆ CSR çš„ç§é’¥å¯¹åº”çš„ã€‚</p><p>â€œ-out certificate.pemâ€: è¡¨ç¤ºå°†ç­¾ååçš„è¯ä¹¦è¾“å‡ºåˆ°æ–‡ä»¶ â€œcertificate.pemâ€ ä¸­ã€‚è¯¥æ–‡ä»¶ä¸­åŒ…å«äº†ç­¾ååçš„è¯ä¹¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç­¾åç®—æ³•ã€æœ‰æ•ˆæœŸã€å…¬é’¥ã€æˆæƒä¸»ä½“çš„èº«ä»½ä¿¡æ¯ç­‰ã€‚</p><p>Enter pass phrase for private-key.pem: å¯†ç çŸ­è¯­</p><h3 id="nodejs-æ¥å£æµ‹è¯•-https"><a href="#nodejs-æ¥å£æµ‹è¯•-https" class="headerlink" title="nodejs æ¥å£æµ‹è¯• https"></a>nodejs æ¥å£æµ‹è¯• https</h3><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-keyword">import</span> https <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;node:https&#x27;</span>;<br><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;fs&#x27;</span>;<br><span class="hljs-regexp">//</span> httpsé»˜è®¤ç›‘å¬ç«¯å£<span class="hljs-number">443</span> httpé»˜è®¤ç›‘å¬ç«¯å£<span class="hljs-number">80</span><br>https<br>  .createServer(<br>    &#123;<br>      key: fs.readFileSync(<span class="hljs-string">&#x27;./private-key.pem&#x27;</span>),<br>      cert: fs.readFileSync(<span class="hljs-string">&#x27;./certificate.pem&#x27;</span>),<br>      passphrase: <span class="hljs-string">&#x27;123456&#x27;</span>,<br>    &#125;,<br>    <span class="hljs-function"><span class="hljs-params">(req, res)</span> =&gt;</span> &#123;<br>      res.writeHead(<span class="hljs-number">200</span>);<br>      res.end(<span class="hljs-string">&#x27;success&#x27;</span>);<br>    &#125;<br>  )<br>  .listen(<span class="hljs-number">443</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    console.log(<span class="hljs-string">&#x27;server is runnig&#x27;</span>);<br>  &#125;);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>ç½‘ç»œåè®®</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç½‘ç»œåè®®</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>navigator.sendBeacon</title>
    <link href="/2024/01/30/navigator.sendBeacon/"/>
    <url>/2024/01/30/navigator.sendBeacon/</url>
    
    <content type="html"><![CDATA[<h2 id="å‘é€ç½‘ç»œè¯·æ±‚çš„æ–¹å¼"><a href="#å‘é€ç½‘ç»œè¯·æ±‚çš„æ–¹å¼" class="headerlink" title="å‘é€ç½‘ç»œè¯·æ±‚çš„æ–¹å¼"></a>å‘é€ç½‘ç»œè¯·æ±‚çš„æ–¹å¼</h2><ol><li>AJAXï¼ˆxml æ˜¯ä»£è¡¨ï¼‰</li><li>fetch</li><li>sse</li><li>websocket</li><li>jsonp</li><li>image çš„ src</li><li>navigator.sendBeacon</li></ol><h2 id="ä½¿ç”¨-navigator-sendBeacon-å®ç°é«˜æ•ˆçš„æ•°æ®ä¸ŠæŠ¥"><a href="#ä½¿ç”¨-navigator-sendBeacon-å®ç°é«˜æ•ˆçš„æ•°æ®ä¸ŠæŠ¥" class="headerlink" title="ä½¿ç”¨ navigator.sendBeacon å®ç°é«˜æ•ˆçš„æ•°æ®ä¸ŠæŠ¥"></a>ä½¿ç”¨ <code>navigator.sendBeacon</code> å®ç°é«˜æ•ˆçš„æ•°æ®ä¸ŠæŠ¥</h2><p>åœ¨ web å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°†ç”¨æˆ·è¡Œä¸ºæˆ–æ€§èƒ½æ•°æ®ä¸ŠæŠ¥åˆ°æœåŠ¡å™¨ã€‚ä¸ºäº†ä¸å½±å“ç”¨æˆ·ä½“éªŒï¼Œå¼€å‘è€…é€šå¸¸ä¼šåœ¨é¡µé¢å¸è½½æ—¶è¿›è¡Œæ•°æ®ä¸ŠæŠ¥ã€‚ç„¶è€Œï¼Œä¼ ç»Ÿçš„æ•°æ®ä¸ŠæŠ¥æ–¹å¼ï¼Œå¦‚ <code>XMLHttpRequest</code> æˆ– <code>Fetch API</code>ï¼Œå®¹æ˜“å—åˆ°é¡µé¢å¸è½½è¿‡ç¨‹ä¸­çš„é˜»å¡ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>navigator.sendBeacon</code> API è¢«å¼•å…¥ï¼Œå®ƒå¯ä»¥åœ¨é¡µé¢å¸è½½æ—¶å®‰å…¨ã€å¯é åœ°å‘é€æ•°æ®ã€‚</p><p><strong>navigator.sendBeacon åŸºäº ping è¯·æ±‚ æ˜¯ html5 æ–°å¢çš„ å¹¶ä¸”æ˜¯ sendBeacon ç‰¹æœ‰çš„ ping è¯·æ±‚ åªèƒ½æºå¸¦å°‘é‡æ•°æ®ï¼Œå¹¶ä¸”ä¸éœ€è¦ç­‰å¾…æœåŠ¡ç«¯å“åº”ï¼Œå› æ­¤éå¸¸é€‚åˆåšåŸ‹ç‚¹ç»Ÿè®¡ï¼Œä»¥åŠæ—¥å¿—ç»Ÿè®¡ç›¸å…³åŠŸèƒ½ã€‚</strong></p><h2 id="å¯¹æ¯”-ajax-fetch-çš„ä¼˜ç‚¹"><a href="#å¯¹æ¯”-ajax-fetch-çš„ä¼˜ç‚¹" class="headerlink" title="å¯¹æ¯” ajax fetch çš„ä¼˜ç‚¹"></a>å¯¹æ¯” ajax fetch çš„ä¼˜ç‚¹</h2><ol><li>fetch å’Œ ajax å—é¡µé¢å¸è½½è¿‡ç¨‹çš„å½±å“ï¼Œè€Œ sendBeacon ä¸å—</li><li>å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡é¡µé¢å…³é—­æˆ–è·³è½¬</li><li>åŸç”Ÿæ”¯æŒå‘é€è·¨åŸŸè¯·æ±‚</li></ol><h2 id="å¯¹æ¯”-ajax-fetch-çš„ç¼ºç‚¹"><a href="#å¯¹æ¯”-ajax-fetch-çš„ç¼ºç‚¹" class="headerlink" title="å¯¹æ¯” ajax fetch çš„ç¼ºç‚¹"></a>å¯¹æ¯” ajax fetch çš„ç¼ºç‚¹</h2><ol><li><p>fetch å’Œ ajax éƒ½å¯ä»¥å‘é€ä»»æ„è¯·æ±‚ è€Œ sendBeacon <strong>åªèƒ½å‘é€ POSTã€‚</strong></p></li><li><p>fetch å’Œ ajax å¯ä»¥ä¼ è¾“ä»»æ„å­—èŠ‚æ•°æ® è€Œ sendBeacon <strong>åªèƒ½ä¼ é€å°‘é‡æ•°æ®ï¼ˆ64KB ä»¥å†…ï¼‰</strong>ï¼Œå› ä¸º ping è¯·æ±‚åªèƒ½å‘é€å°‘é‡æ•°æ®</p></li><li><p>fetch å’Œ ajax å¯ä»¥å®šä¹‰ä»»æ„è¯·æ±‚å¤´ è€Œ sendBeacon <strong>æ— æ³•è‡ªå®šä¹‰è¯·æ±‚å¤´</strong>ï¼Œéš¾ä»¥æºå¸¦ token ç­‰ä¿¡æ¯</p></li><li><p>sendBeacon åªèƒ½ä¼ è¾“ <a href="https://link.juejin.cn/?target=https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><code>ArrayBuffer</code></a>ã€<a href="https://link.juejin.cn/?target=https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/TypedArray"><code>ArrayBufferView</code></a>ã€<a href="https://link.juejin.cn/?target=https://developer.mozilla.org/zh-CN/docs/Web/API/Blob"><code>Blob</code></a>ã€<a href="https://link.juejin.cn/?target=https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String"><code>DOMString</code></a>ã€<a href="https://link.juejin.cn/?target=https://developer.mozilla.org/zh-CN/docs/Web/API/FormData"><code>FormData</code></a> æˆ– <a href="https://link.juejin.cn/?target=https://developer.mozilla.org/zh-CN/docs/Web/API/URLSearchParams"><code>URLSearchParams</code></a> ç±»å‹çš„æ•°æ®ï¼Œ<strong>ä¸èƒ½ç›´æ¥ä¼  JSON æ•°æ®</strong></p></li><li><p><strong>å¦‚æœå¤„äºå±é™©çš„ç½‘ç»œç¯å¢ƒæ¯”å¦‚å…¬å…±ç½‘ç»œï¼Œæˆ–è€…å¼€å¯äº†å¹¿å‘Šå±è”½æ’ä»¶ æ­¤è¯·æ±‚å°†æ— æ•ˆ</strong></p></li></ol><h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><ol><li>å‘é€å¿ƒè·³åŒ…ï¼šå¯ä»¥ä½¿ç”¨ <code>navigator.sendBeacon</code> å‘é€å¿ƒè·³åŒ…ï¼Œä»¥ä¿æŒä¸æœåŠ¡å™¨çš„é•¿è¿æ¥ï¼Œé¿å…å› ä¸ºé•¿æ—¶é—´æ²¡æœ‰ç½‘ç»œè¯·æ±‚è€Œå¯¼è‡´è¿æ¥è¢«å…³é—­ã€‚</li><li><strong>æ•°æ®åŸ‹ç‚¹ï¼šå¯ä»¥ä½¿ç”¨ <code>navigator.sendBeacon</code> åœ¨é¡µé¢å…³é—­æˆ–å¸è½½æ—¶è®°å½•ç”¨æˆ·åœ¨çº¿æ—¶é—´ï¼Œpv uvï¼Œä»¥åŠé”™è¯¯æ—¥å¿—ä¸ŠæŠ¥ æŒ‰é’®ç‚¹å‡»æ¬¡æ•°ã€‚</strong></li><li>å‘é€ç”¨æˆ·åé¦ˆï¼šå¯ä»¥ä½¿ç”¨ <code>navigator.sendBeacon</code> å‘é€ç”¨æˆ·åé¦ˆä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·æ„è§ã€bug æŠ¥å‘Šç­‰ï¼Œä»¥ä¾¿è¿›è¡Œäº§å“ä¼˜åŒ–å’Œæ”¹è¿›</li></ol><h2 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> sendBeaconBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;button&#x27;</span>);<br>sendBeaconBtn.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&#x27;send beacon&#x27;</span>;<br><span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(sendBeaconBtn);<br>sendBeaconBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// navigator.sendBeacon(&#x27;/api/sendBeacon/sendBeacon&#x27;);</span><br><br>  <span class="hljs-comment">// ä¼ é€’jsonæ ¼å¼å‚æ•°</span><br>  <span class="hljs-comment">// åªæ¥å—formdata blob arrayBufferç­‰æ•°æ®æ ¼å¼ï¼Œä¸æ”¯æŒjson</span><br>  <span class="hljs-comment">// æ‰€ä»¥éœ€è¦æ‰‹åŠ¨è½¬æ¢ä¸€ä¸‹æ•°æ®æ ¼å¼</span><br>  <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;mmy&#x27;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">23</span> &#125;);<br>  <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([json], &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;application/json&#x27;</span> &#125;);<br>  navigator.<span class="hljs-title function_">sendBeacon</span>(<span class="hljs-string">&#x27;/api/sendBeacon/sendBeacon&#x27;</span>, blob);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express&#x27;</span>;<br><span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();<br><span class="hljs-comment">// sendbeaconåªèƒ½æ¥å—post</span><br>router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/sendBeacon&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">body</span>);<br>  <span class="hljs-comment">// sendBeaconåŸºäºpingï¼Œæœ‰æ•°æ®å¤§å°é™åˆ¶ï¼Œè¿”å›æ•°æ®åº”è¯¥ä¿æŒè½»é‡çº§</span><br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>&#125;);<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šè®¯æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šè®¯æŠ€æœ¯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WebSocket</title>
    <link href="/2024/01/30/WebSocket/"/>
    <url>/2024/01/30/WebSocket/</url>
    
    <content type="html"><![CDATA[<h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><p>websocket æ˜¯ä¸€ç§å»ºç«‹åœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹<strong>é•¿æ—¶é—´ç¨³å®šè¿æ¥</strong>çš„æŠ€æœ¯ï¼Œåœ¨å•ä¸ª tcp è¿æ¥ä¸Šè¿›è¡Œ<strong>å…¨åŒå·¥é€šä¿¡</strong>çš„ç½‘ç»œåè®®ï¼Œå¯ä»¥å®ç°æœåŠ¡å™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰å’ŒæœåŠ¡å™¨ä¹‹é—´çš„åŒå‘æ•°æ®åŒ…ä¼ é€’ï¼Œä¸”<strong>ä¸å—è·¨åŸŸé™åˆ¶</strong></p><h2 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><p>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿ç»­é•¿æ—¶é—´äº’ç›¸é€šä¿¡å¦‚</p><ol><li>å®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„åº”ç”¨ï¼Œå¦‚ç½‘ç»œæ¸¸æˆã€æ•°æ®å¯è§†åŒ–å¤§å±ã€åœ¨çº¿èŠå¤©ç­‰</li><li>éœ€è¦é¢‘ç¹äº¤æ¢æ•°æ®çš„åº”ç”¨ï¼Œæ¯”å¦‚åœ¨çº¿ç¼–è¾‘å™¨ã€æ–‡ä»¶ç®¡ç†å™¨ç­‰</li><li>éœ€è¦æ¨é€æœåŠ¡çš„åº”ç”¨ï¼Œæ¯”å¦‚å®æ—¶æ•°æ®ç›‘æ§ã€é€šçŸ¥ç³»ç»Ÿç­‰</li><li>è·¨å¹³å°åº”ç”¨ï¼Œæ¯”å¦‚æ¡Œé¢åº”ç”¨ç¨‹åºã€ç§»åŠ¨åº”ç”¨ç¨‹åº</li></ol><h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><h3 id="å…¨åŒå·¥é€šè®¯"><a href="#å…¨åŒå·¥é€šè®¯" class="headerlink" title="å…¨åŒå·¥é€šè®¯"></a>å…¨åŒå·¥é€šè®¯</h3><p>é•¿è¿æ¥ï¼Œserver å’Œæµè§ˆå™¨å¯ä»¥äº’ç›¸æŒç»­å‘é€æ–°æ•°æ®</p><h3 id="æŠ€æœ¯å®ç°â€”â€”websocket-åè®®"><a href="#æŠ€æœ¯å®ç°â€”â€”websocket-åè®®" class="headerlink" title="æŠ€æœ¯å®ç°â€”â€”websocket åè®®"></a>æŠ€æœ¯å®ç°â€”â€”websocket åè®®</h3><p>åŸºäºç‰¹æ®Šçš„å‡çº§åè®®ï¼ˆHTTP&#x2F;1.1 Upgrade æˆ– HTTP&#x2F;2ï¼‰å»ºç«‹ TCP è¿æ¥ã€‚å¯ä»¥ä¸€ä¸ª server å¯¹å¤šä¸ª client é€šè®¯</p><h3 id="æ•°æ®æ ¼å¼"><a href="#æ•°æ®æ ¼å¼" class="headerlink" title="æ•°æ®æ ¼å¼"></a>æ•°æ®æ ¼å¼</h3><p>æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®</p><h3 id="è·¨åŸŸ"><a href="#è·¨åŸŸ" class="headerlink" title="è·¨åŸŸ"></a>è·¨åŸŸ</h3><p>websocket å¯¹è±¡åŸç”Ÿæ”¯æŒè·¨åŸŸ</p><h3 id="WebSocket-äº‹ä»¶"><a href="#WebSocket-äº‹ä»¶" class="headerlink" title="WebSocket äº‹ä»¶"></a>WebSocket äº‹ä»¶</h3><ul><li><code>open</code>ï¼Œ</li><li><code>message</code>ï¼Œ</li><li><code>error</code>ï¼Œ</li><li><code>close</code>ã€‚</li></ul><h2 id="æœåŠ¡ç«¯ä½¿ç”¨"><a href="#æœåŠ¡ç«¯ä½¿ç”¨" class="headerlink" title="æœåŠ¡ç«¯ä½¿ç”¨"></a>æœåŠ¡ç«¯ä½¿ç”¨</h2><ol><li><p>åˆ›å»º socket æœåŠ¡å®ä¾‹ã€æœåŠ¡ç«¯å£ const wsServer &#x3D; new ws.Server({ port: 8080 },cb);</p></li><li><p>ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ wsServer.on(â€˜connectionâ€™, cb)</p></li><li><p>å¹¿æ’­å‘é€æ¶ˆæ¯å®ç°ç¾¤èŠ wsServer.clients</p></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// ç¬¬ä¸€æ­¥ï¼Œå®‰è£…wså’Œwsçš„å£°æ˜æ–‡ä»¶</span><br><span class="hljs-keyword">import</span> ws <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;ws&#x27;</span>;<br><span class="hljs-comment">// åˆ›å»ºsocketæœåŠ¡ 8080ç«¯å£</span><br><span class="hljs-keyword">const</span> wsServer = <span class="hljs-keyword">new</span> ws.<span class="hljs-title class_">Server</span>(&#123; <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span> &#125;, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;socket service is running at ws://localhost:8080&#x27;</span>);<br>&#125;);<br><span class="hljs-comment">// ç›‘å¬å®¢æˆ·ç«¯/æµè§ˆå™¨è¿æ¥</span><br>wsServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;connection&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">socket</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// ç›‘å¬å®¢æˆ·ç«¯çš„æ¶ˆæ¯</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;client connection&#x27;</span>);<br>  socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// æ¶ˆæ¯å¹¿æ’­å®ç°ç¾¤èŠ</span><br>    wsServer.<span class="hljs-property">clients</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">serverForClient</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// å®¢æˆ·ç«¯ä¼ æ¥çš„æ¶ˆæ¯æ˜¯bufferæ ¼å¼</span><br>      serverForClient.<span class="hljs-title function_">send</span>(e.<span class="hljs-title function_">toString</span>());<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-title function_">toString</span>());<br>    &#125;);<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="å®¢æˆ·ç«¯ä½¿ç”¨"><a href="#å®¢æˆ·ç«¯ä½¿ç”¨" class="headerlink" title="å®¢æˆ·ç«¯ä½¿ç”¨"></a>å®¢æˆ·ç«¯ä½¿ç”¨</h2><ol><li><p>åˆ›å»º websocket å®ä¾‹ new WebSocket(â€˜ws:&#x2F;&#x2F;xxxxâ€™)</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// websocket åè®® ws wss</span><br><span class="hljs-keyword">const</span> wsClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&#x27;ws://localhost:8080&#x27;</span>);<br></code></pre></td></tr></table></figure></li><li><p>ç›‘å¬æ˜¯å¦è¿æ¥æˆåŠŸ socket.addEventListener(â€˜openâ€™, cb)</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts">wsClient.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;open&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;ws connection&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure></li><li><p>å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ socket.send</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ts">btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">msg</span>: <span class="hljs-built_in">string</span> = input.<span class="hljs-property">value</span>;<br>  <span class="hljs-keyword">if</span> (input.<span class="hljs-property">value</span>) &#123;<br>    wsClient.<span class="hljs-title function_">send</span>(msg);<br>    input.<span class="hljs-property">value</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure></li><li><p>ç›‘å¬æœåŠ¡ç«¯è¿”å›çš„æ¶ˆæ¯ socket.addEventListener(â€˜messageâ€™, cb)</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ts">wsClient.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e);<br>  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === state.<span class="hljs-property">MSG</span>) &#123;<br>    <span class="hljs-keyword">const</span> li = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;li&#x27;</span>);<br>    li.<span class="hljs-property">innerHTML</span> = e.<span class="hljs-property">data</span>;<br>    ul.<span class="hljs-title function_">appendChild</span>(li);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;heart check&#x27;</span>);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure></li></ol><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><h3 id="æ¶ˆæ¯å¹¿æ’­ï¼ˆç¾¤èŠï¼‰"><a href="#æ¶ˆæ¯å¹¿æ’­ï¼ˆç¾¤èŠï¼‰" class="headerlink" title="æ¶ˆæ¯å¹¿æ’­ï¼ˆç¾¤èŠï¼‰"></a>æ¶ˆæ¯å¹¿æ’­ï¼ˆç¾¤èŠï¼‰</h3><p>æœåŠ¡ç«¯ wsServer.clients ä»¥ set å½¢å¼å­˜å‚¨æ¯ä¸ªè¿æ¥ ws çš„ clientï¼Œéå†å‘é€ä¿¡æ¯å³å¯å®ç°ç¾¤èŠ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">wsServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;connection&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">socket</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// ç›‘å¬å®¢æˆ·ç«¯çš„æ¶ˆæ¯</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;client connection&#x27;</span>);<br>  socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// æ¶ˆæ¯å¹¿æ’­å®ç°ç¾¤èŠ</span><br>    wsServer.<span class="hljs-property">clients</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">serverForClient</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// å®¢æˆ·ç«¯ä¼ æ¥çš„æ¶ˆæ¯æ˜¯bufferæ ¼å¼</span><br>      serverForClient.<span class="hljs-title function_">send</span>(e.<span class="hljs-title function_">toString</span>());<br>    &#125;);<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="å¿ƒè·³æ£€æµ‹"><a href="#å¿ƒè·³æ£€æµ‹" class="headerlink" title="å¿ƒè·³æ£€æµ‹"></a>å¿ƒè·³æ£€æµ‹</h3><ol><li>åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œç”±äºç½‘ç»œæ³¢åŠ¨ã€å¼±ä¿¡å·ç­‰åŸå› ï¼Œå¯èƒ½ä¼šå¯¼è‡´ websocket è¿æ¥æ–­å¼€ã€‚</li><li>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œå¯ä»¥ä½¿ç”¨å¿ƒè·³æœºåˆ¶æ¥æ£€æµ‹ websocket æ˜¯å¦æ­£å¸¸è¿æ¥</li><li>å½“å‘ç°è¿æ¥æ–­å¼€æ—¶ï¼Œå¯ä»¥å°è¯•é‡æ–°å»ºç«‹è¿æ¥ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†</li></ol><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs pf">// socketé•¿æ—¶é—´ä¸ä½¿ç”¨ ç½‘ç»œæ³¢åŠ¨å’Œå¼±ç½‘ç¯å¢ƒéƒ½ä¼šå¯¼è‡´è¿æ¥æ–­å¼€<br>// å¿ƒè·³æ£€æµ‹ è¿›è¡Œä¿æ´» ä¿æŒè¿æ¥<br><span class="hljs-keyword">const</span> <span class="hljs-keyword">state</span> = &#123;<br>  HEART: <span class="hljs-number">1</span>,<br>  MSG: <span class="hljs-number">2</span>,<br>&#125;;<br>let heartInterval = <span class="hljs-built_in">set</span>Interval(heartCheck, <span class="hljs-number">3000</span>);<br>function heartCheck() &#123;<br>  // ws <span class="hljs-keyword">state</span> ä¸ºopenæ‰å‘é€å¿ƒè·³ï¼Œå¦åˆ™ç»“æŸå¾ªç¯æ£€æµ‹<br>  if (wsClient.readyState === wsClient.OPEN) &#123;<br>    wsClient.send(<br>      JSON.stringify(&#123;<br>        type: <span class="hljs-keyword">state</span>.HEART,<br>        message: &#x27;heart check&#x27;,<br>      &#125;)<br>    );<br>  &#125; else &#123;<br>    clearInterval(heartInterval);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šè®¯æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šè®¯æŠ€æœ¯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SSEï¼ˆServer-Sent Eventï¼‰</title>
    <link href="/2024/01/29/SSE/"/>
    <url>/2024/01/29/SSE/</url>
    
    <content type="html"><![CDATA[<h2 id="SSE-ç®€ä»‹"><a href="#SSE-ç®€ä»‹" class="headerlink" title="SSE ç®€ä»‹"></a>SSE ç®€ä»‹</h2><p>Server-Sent Eventï¼Œæ˜¯ä¸€ç§åŸºäº HTTP åè®®å»ºç«‹çš„æœåŠ¡ç«¯ä¸æµè§ˆå™¨ä¹‹é—´çš„é•¿è¿æ¥ï¼Œæ˜¯ä¸€ç§å•å·¥é€šä¿¡æ–¹å¼ï¼Œä»…æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯</p><h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><h3 id="å•å·¥é€šè®¯"><a href="#å•å·¥é€šè®¯" class="headerlink" title="å•å·¥é€šè®¯"></a>å•å·¥é€šè®¯</h3><p>é•¿è¿æ¥ï¼Œserver å‘æµè§ˆå™¨æŒç»­å‘é€æ–°æ•°æ®</p><h3 id="æŠ€æœ¯å®ç°"><a href="#æŠ€æœ¯å®ç°" class="headerlink" title="æŠ€æœ¯å®ç°"></a>æŠ€æœ¯å®ç°</h3><p>åŸºäº HTTP åè®®</p><h3 id="æ•°æ®æ ¼å¼"><a href="#æ•°æ®æ ¼å¼" class="headerlink" title="æ•°æ®æ ¼å¼"></a>æ•°æ®æ ¼å¼</h3><p>æ–‡æœ¬æ•°æ®</p><h3 id="è·¨åŸŸ"><a href="#è·¨åŸŸ" class="headerlink" title="è·¨åŸŸ"></a>è·¨åŸŸ</h3><p>æµè§ˆå™¨è·¨åŸŸé™åˆ¶</p><h2 id="çŠ¶æ€"><a href="#çŠ¶æ€" class="headerlink" title="çŠ¶æ€"></a>çŠ¶æ€</h2><p>open</p><p>message</p><p>Error</p><h2 id="æœåŠ¡ç«¯ä½¿ç”¨"><a href="#æœåŠ¡ç«¯ä½¿ç”¨" class="headerlink" title="æœåŠ¡ç«¯ä½¿ç”¨"></a>æœåŠ¡ç«¯ä½¿ç”¨</h2><ol><li><p>å»ºç«‹ SSE è¿æ¥</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ada">res.writeHead(<span class="hljs-number">200</span>, &#123;<br>  <span class="hljs-symbol">&#x27;Content</span>-<span class="hljs-keyword">Type</span>&#x27;: <span class="hljs-symbol">&#x27;text</span>/event-stream&#x27;,<br>&#125;);<br></code></pre></td></tr></table></figure></li><li><p>è‡ªå®šä¹‰ SSE äº‹ä»¶åç§°ï¼Œé»˜è®¤ä¸º message</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">res.<span class="hljs-keyword">write</span>(<span class="hljs-string">&#x27;event:lyrics\n&#x27;</span>);<br></code></pre></td></tr></table></figure></li><li><p>è¿”å›æ•°æ®</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">res</span>.write(`<span class="hljs-class"><span class="hljs-keyword">data</span>: $&#123;<span class="hljs-title">mockData</span>[<span class="hljs-title">current</span>]&#125;\n\n`);</span><br></code></pre></td></tr></table></figure></li></ol><h2 id="å®¢æˆ·ç«¯ä½¿ç”¨"><a href="#å®¢æˆ·ç«¯ä½¿ç”¨" class="headerlink" title="å®¢æˆ·ç«¯ä½¿ç”¨"></a>å®¢æˆ·ç«¯ä½¿ç”¨</h2><ol><li><p>å»ºç«‹ SSE è¿æ¥</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">const</span> sse = <span class="hljs-keyword">new</span> EventSource(<span class="hljs-string">&#x27;/api/sse/sse&#x27;</span>);<br></code></pre></td></tr></table></figure></li><li><p>ç›‘å¬æ¶ˆæ¯ã€‚å¦‚æœåç«¯æ²¡æœ‰è‡ªå®šä¹‰äº‹ä»¶åç§°ï¼Œé»˜è®¤ä¸º message</p><p>é€šè¿‡ e.data è·å–æ¶ˆæ¯</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">sse.addEventListener(<span class="hljs-string">&#x27;lyrics&#x27;</span>, <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span> &#123;<br>  content += e.data;<br>  divDOM.innerHTML = content<br>&#125;)<br></code></pre></td></tr></table></figure></li><li><p>å…³é—­è¿æ¥</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cos">sse.<span class="hljs-keyword">close</span>()<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šè®¯æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šè®¯æŠ€æœ¯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ajax xml fetch</title>
    <link href="/2024/01/29/ajax%20xml%20fetch/"/>
    <url>/2024/01/29/ajax%20xml%20fetch/</url>
    
    <content type="html"><![CDATA[<h1 id="AJAX-æŠ€æœ¯"><a href="#AJAX-æŠ€æœ¯" class="headerlink" title="AJAX æŠ€æœ¯"></a>AJAX æŠ€æœ¯</h1><p>ajax, Asynchronous Javascript and XMLï¼Œå¼‚æ­¥ javascript å’Œ XML æŠ€æœ¯ï¼Œæ˜¯ä¸€ç§æ—©æœŸçš„ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¼‚æ­¥æ•°æ®äº¤äº’çš„æŠ€æœ¯</p><h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><p><strong>åœ¨ä¸åˆ·æ–°é¡µé¢çš„æƒ…å†µä¸‹ä»æœåŠ¡å™¨è·å–æ•°æ®æˆ–æäº¤è¡¨å•ï¼Œå¼‚æ­¥å¢é‡å¼æ›´æ–°é¡µé¢å†…å®¹</strong></p><p><strong>Ajax é€šä¿¡ä¸æ•°æ®æ ¼å¼æ— å…³ï¼Œæ•°æ®æ ¼å¼å¹¶ä¸ä¸€å®šæ˜¯ XML</strong></p><h2 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h2><h3 id="æé«˜ç”¨æˆ·ä½“éªŒ"><a href="#æé«˜ç”¨æˆ·ä½“éªŒ" class="headerlink" title="æé«˜ç”¨æˆ·ä½“éªŒ"></a>æé«˜ç”¨æˆ·ä½“éªŒ</h3><p>é€šè¿‡å‡å°‘é¡µé¢çš„é‡è½½å’Œåˆ·æ–°ï¼Œä½¿å¾—ç½‘ç«™å˜å¾—æ›´åŠ çµæ´»å’ŒåŠ¨æ€ã€‚</p><h3 id="å‡è½»æœåŠ¡å™¨è´Ÿè½½"><a href="#å‡è½»æœåŠ¡å™¨è´Ÿè½½" class="headerlink" title="å‡è½»æœåŠ¡å™¨è´Ÿè½½"></a>å‡è½»æœåŠ¡å™¨è´Ÿè½½</h3><p>é€šè¿‡ä½¿ç”¨ Ajaxï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘æœåŠ¡å™¨æ¥æ”¶åˆ°çš„è¯·æ±‚æ¬¡æ•°å’Œéœ€è¦å“åº”çš„æ•°æ®é‡ï¼ˆç›¸æ¯” SSRï¼‰ï¼Œä»è€Œå‡è½»æœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚</p><h3 id="æé«˜å“åº”é€Ÿåº¦"><a href="#æé«˜å“åº”é€Ÿåº¦" class="headerlink" title="æé«˜å“åº”é€Ÿåº¦"></a>æé«˜å“åº”é€Ÿåº¦</h3><p>ä½¿ç”¨ Ajax å¯ä»¥å¼‚æ­¥è·å–æ•°æ®å¹¶æ›´æ–°é¡µé¢ï¼Œä»è€Œæé«˜å“åº”é€Ÿåº¦ã€‚</p><h3 id="å¢åŠ äº¤äº’æ€§"><a href="#å¢åŠ äº¤äº’æ€§" class="headerlink" title="å¢åŠ äº¤äº’æ€§"></a>å¢åŠ äº¤äº’æ€§</h3><p>é€šè¿‡ä½¿ç”¨ Ajaxï¼Œå¯ä»¥ä½¿å¾—é¡µé¢å˜å¾—æ›´åŠ åŠ¨æ€å’Œäº¤äº’æ€§ã€‚</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><h3 id="ä¸åˆ©äº-SEO"><a href="#ä¸åˆ©äº-SEO" class="headerlink" title="ä¸åˆ©äº SEO"></a>ä¸åˆ©äº SEO</h3><p>åŠ¨æ€ç”Ÿæˆç½‘ç«™å†…å®¹ã€ä¾èµ–ç”¨æˆ·çš„äº¤äº’ï¼Œè€Œ SEO ä¸»è¦æ£€æµ‹é™æ€å†…å®¹</p><h3 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h3><p>åœ¨ä½¿ç”¨ Ajax æ—¶ï¼Œéœ€è¦è€ƒè™‘æ•°æ®å®‰å…¨æ€§å’Œç½‘ç»œå®‰å…¨æ€§é—®é¢˜ï¼Œå¹¶é‡‡å–ç›¸åº”çš„æªæ–½åŠ ä»¥é˜²èŒƒã€‚</p><h1 id="XMLHttpRequest-å¯¹è±¡"><a href="#XMLHttpRequest-å¯¹è±¡" class="headerlink" title="XMLHttpRequest å¯¹è±¡"></a>XMLHttpRequest å¯¹è±¡</h1><p><code>XMLHttpRequest</code> æ˜¯ä¸€ä¸ªå†…å»ºçš„æµè§ˆå™¨å¯¹è±¡</p><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><h3 id="1-åˆ›å»º-XML-å¯¹è±¡"><a href="#1-åˆ›å»º-XML-å¯¹è±¡" class="headerlink" title="1.åˆ›å»º XML å¯¹è±¡"></a>1.åˆ›å»º XML å¯¹è±¡</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br></code></pre></td></tr></table></figure><h3 id="2-xhr-open-åˆå§‹åŒ–"><a href="#2-xhr-open-åˆå§‹åŒ–" class="headerlink" title="2.xhr.open()åˆå§‹åŒ–"></a>2.xhr.open()åˆå§‹åŒ–</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">xhr.<span class="hljs-title function_">open</span>(method, <span class="hljs-variable constant_">URL</span>, [<span class="hljs-keyword">async</span>, user, password]);<br></code></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•æŒ‡å®šè¯·æ±‚çš„ä¸»è¦å‚æ•°ï¼š</p><ul><li><code>method</code> â€”â€” HTTP æ–¹æ³•ã€‚é€šå¸¸æ˜¯ <code>&quot;GET&quot;</code> æˆ– <code>&quot;POST&quot;</code>ã€‚</li><li><code>URL</code> â€”â€” è¦è¯·æ±‚çš„ URLï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ <a href="https://zh.javascript.info/url">URL</a> å¯¹è±¡ã€‚</li><li><code>async</code> â€”â€” å¦‚æœæ˜¾å¼åœ°è®¾ç½®ä¸º <code>false</code>ï¼Œé‚£ä¹ˆè¯·æ±‚å°†ä¼šä»¥åŒæ­¥çš„æ–¹å¼å¤„ç†ï¼Œæˆ‘ä»¬ç¨åä¼šè®²åˆ°å®ƒã€‚</li><li><code>user</code>ï¼Œ<code>password</code> â€”â€” HTTP åŸºæœ¬èº«ä»½éªŒè¯ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰çš„ç™»å½•åå’Œå¯†ç ã€‚</li></ul><p>è¯·æ³¨æ„ï¼Œ<code>open</code> è°ƒç”¨ä¸å…¶åç§°ç›¸åï¼Œä¸ä¼šå»ºç«‹è¿æ¥ã€‚å®ƒä»…é…ç½®è¯·æ±‚ï¼Œè€Œç½‘ç»œæ´»åŠ¨ä»…ä»¥ <code>send</code> è°ƒç”¨å¼€å¯ã€‚</p><h3 id="3-xhr-send-å‘é€è¯·æ±‚"><a href="#3-xhr-send-å‘é€è¯·æ±‚" class="headerlink" title="3.xhr.send()å‘é€è¯·æ±‚"></a>3.xhr.send()å‘é€è¯·æ±‚</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">xhr.<span class="hljs-title function_">send</span>([body]);<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¼šå»ºç«‹è¿æ¥ï¼Œå¹¶å°†è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨ã€‚å¯é€‰å‚æ•° <code>body</code> åŒ…å«äº† request bodyã€‚</p><p>ä¸€äº›è¯·æ±‚æ–¹æ³•ï¼Œåƒ <code>GET</code> æ²¡æœ‰ request bodyã€‚è¿˜æœ‰ä¸€äº›è¯·æ±‚æ–¹æ³•ï¼Œåƒ <code>POST</code> ä½¿ç”¨ <code>body</code> å°†æ•°æ®å‘é€åˆ°æœåŠ¡å™¨ã€‚</p><h3 id="4-ç›‘å¬çŠ¶æ€å˜åŒ–"><a href="#4-ç›‘å¬çŠ¶æ€å˜åŒ–" class="headerlink" title="4.ç›‘å¬çŠ¶æ€å˜åŒ–"></a>4.ç›‘å¬çŠ¶æ€å˜åŒ–</h3><h4 id="onreadystatechange"><a href="#onreadystatechange" class="headerlink" title="onreadystatechange"></a>onreadystatechange</h4><p>ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨æ¯æ¬¡çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è¢«è°ƒç”¨ã€‚</p><ul><li>readyState 0ï¼šæœªåˆå§‹åŒ–ï¼ŒXMLHttpRequest å¯¹è±¡å·²ç»åˆ›å»ºï¼Œä½†æœªè°ƒç”¨ open æ–¹æ³•ã€‚</li><li>readyState 1ï¼šå·²æ‰“å¼€ï¼Œopen æ–¹æ³•å·²ç»è¢«è°ƒç”¨ï¼Œä½† send æ–¹æ³•æœªè¢«è°ƒç”¨ã€‚</li><li>readyState 2ï¼šå·²å‘é€ï¼Œsend æ–¹æ³•å·²ç»è¢«è°ƒç”¨ï¼Œè¯·æ±‚å·²ç»è¢«æœåŠ¡å™¨æ¥æ”¶ã€‚</li><li>readyState 3ï¼šæ­£åœ¨æ¥æ”¶ï¼ŒæœåŠ¡å™¨æ­£åœ¨å¤„ç†è¯·æ±‚å¹¶è¿”å›æ•°æ®ã€‚</li><li>readyState 4ï¼šå®Œæˆï¼ŒæœåŠ¡å™¨å·²ç»å®Œæˆäº†æ•°æ®ä¼ è¾“ã€‚</li></ul><p>æ³¨æ„è¿˜éœ€è¦æ£€æµ‹ HTTP response statusï¼Œå³ HTTP å“åº”ç æ˜¯å¦ä¸º 200</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arcade">xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (xhr.readyState === XMLHttpRequest.DONE &amp;&amp; xhr.status === <span class="hljs-number">200</span>) &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(JSON.parse(xhr.response));<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="onLoad-onError-onProgress"><a href="#onLoad-onError-onProgress" class="headerlink" title="onLoad onError onProgress"></a>onLoad onError onProgress</h4><h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><h3 id="1-GET"><a href="#1-GET" class="headerlink" title="1.GET"></a>1.GET</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// get txt</span><br><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br>xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;/api/txt&#x27;</span>, <span class="hljs-literal">true</span>);<br>xhr.<span class="hljs-title function_">send</span>();<br>xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) &#123;<br>    <span class="hljs-keyword">const</span> divDOM = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;div&#x27;</span>);<br>    divDOM.<span class="hljs-property">innerHTML</span> = xhr.<span class="hljs-property">responseText</span>;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(divDOM);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;success&#x27;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;failed&#x27;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-POST-application-json-æ ¼å¼å‚æ•°"><a href="#2-POST-application-json-æ ¼å¼å‚æ•°" class="headerlink" title="2.POST application&#x2F;json æ ¼å¼å‚æ•°"></a>2.POST application&#x2F;json æ ¼å¼å‚æ•°</h3><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">const xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();<br>xhr.open(<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;/api/post&#x27;</span>);<br>xhr.send(<span class="hljs-built_in">JSON</span>.stringify(&#123;<br>  name: <span class="hljs-string">&#x27;mmy&#x27;</span><br>&#125;))<br>xhr.onload = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (xhr.status === <span class="hljs-number">200</span>) &#123;<br>    console.log(<span class="hljs-built_in">JSON</span>.parse(xhr.response));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-POST-application-x-www-form-urlencoded-æ ¼å¼å‚æ•°"><a href="#3-POST-application-x-www-form-urlencoded-æ ¼å¼å‚æ•°" class="headerlink" title="3.POST application&#x2F;x-www-form-urlencoded æ ¼å¼å‚æ•°"></a>3.POST application&#x2F;x-www-form-urlencoded æ ¼å¼å‚æ•°</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arcade">const xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();<br>xhr.open(<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;/api/post&#x27;</span>);<br>xhr.send(<span class="hljs-string">&#x27;name=mmy&#x27;</span>)<br>xhr.onload = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (xhr.status === <span class="hljs-number">200</span>) &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(JSON.parse(xhr.response));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-ä¸­æ–­è¯·æ±‚"><a href="#4-ä¸­æ–­è¯·æ±‚" class="headerlink" title="4.ä¸­æ–­è¯·æ±‚"></a>4.ä¸­æ–­è¯·æ±‚</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arcade">xhr.abort();<br>xhr.addEventListener(<span class="hljs-string">&#x27;abort&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;æˆ‘è¢«ä¸­æ–­äº†&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="5-è®¾ç½®è¶…æ—¶"><a href="#5-è®¾ç½®è¶…æ—¶" class="headerlink" title="5.è®¾ç½®è¶…æ—¶"></a>5.è®¾ç½®è¶…æ—¶</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arcade">xhr.timeout = <span class="hljs-number">3000</span>;<br>xhr.addEventListener(<span class="hljs-string">&#x27;timeout&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;å“åº”è¶…æ—¶&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="6-ç›‘å¬è¿›åº¦"><a href="#6-ç›‘å¬è¿›åº¦" class="headerlink" title="6.ç›‘å¬è¿›åº¦"></a>6.ç›‘å¬è¿›åº¦</h3><p>ç›‘å¬ progress äº‹ä»¶ï¼Œé€šè¿‡ event.loaded å’Œ event.total å±æ€§è·å–å·²ä¸Šä¼ æ•°æ®é‡å’Œæ€»æ•°æ®é‡ï¼Œå¹¶è®¡ç®—ä¸Šä¼ è¿›åº¦ï¼Œæœ€åå°†è¿›åº¦æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">xhr.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;progress&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) &#123;<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;#progress&#x27;</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">`<span class="hljs-subst">$&#123;(event.loaded / event.total * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)&#125;</span>%`</span>;<br>&#125;);<br></code></pre></td></tr></table></figure><h1 id="Fetch-API"><a href="#Fetch-API" class="headerlink" title="Fetch API"></a>Fetch API</h1><h2 id="ä½¿ç”¨-1"><a href="#ä½¿ç”¨-1" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">let promise = <span class="hljs-keyword">fetch</span>(url, [<span class="hljs-keyword">options</span>])<br></code></pre></td></tr></table></figure><ul><li><strong><code>url</code></strong> â€”â€” è¦è®¿é—®çš„ URLã€‚</li><li><strong><code>options</code></strong> â€”â€” å¯é€‰å‚æ•°ï¼šmethodï¼Œheader ç­‰<ul><li>method</li><li>headers<ul><li>Content-Type</li><li>â€¦</li></ul></li><li>body</li><li>singal</li><li>credentials</li><li>â€¦</li></ul></li></ul><p><strong>ç¬¬ä¸€é˜¶æ®µï¼Œå½“æœåŠ¡å™¨å‘é€äº†å“åº”å¤´ï¼ˆresponse headerï¼‰ï¼Œ<code>fetch</code> è¿”å›çš„ <code>promise</code> å°±ä½¿ç”¨å†…å»ºçš„ <a href="https://fetch.spec.whatwg.org/#response-class">Response</a> class å¯¹è±¡æ¥å¯¹å“åº”å¤´è¿›è¡Œè§£æã€‚</strong>åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ status æ£€æŸ¥å“åº”å¤´çš„ HTTP çŠ¶æ€ç ï¼Œæ¥æ£€æŸ¥ HTTP çŠ¶æ€ä»¥ç¡®å®šè¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œå½“å‰è¿˜æ²¡æœ‰å“åº”ä½“ï¼ˆresponse bodyï¼‰ã€‚</p><p><strong>ç¬¬äºŒé˜¶æ®µï¼Œä¸ºäº†è·å– response bodyï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªå…¶ä»–çš„æ–¹æ³•è°ƒç”¨ã€‚</strong>è¿”å›æ•°æ®çš„æ ¼å¼æœ‰äº”ç§</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">text</span><span class="hljs-params">()</span></span> å°†å“åº”ä½“è§£æä¸ºçº¯æ–‡æœ¬å­—ç¬¦ä¸²å¹¶è¿”å›<br><span class="hljs-function"><span class="hljs-title">json</span><span class="hljs-params">()</span></span> å°†å“åº”ä½“è§£æä¸ºJSONæ ¼å¼å¹¶è¿”å›ä¸€ä¸ªJavascriptå¯¹è±¡<br><span class="hljs-function"><span class="hljs-title">blob</span><span class="hljs-params">()</span></span> å°†å“åº”ä½“è§£æä¸ºäºŒè¿›åˆ¶æ•°æ®å¹¶è¿”å›ä¸€ä¸ªBlobå¯¹è±¡<br><span class="hljs-function"><span class="hljs-title">arrayBuffer</span><span class="hljs-params">()</span></span> å°†å“åº”ä½“è§£æä¸ºäºŒè¿›åˆ¶æ•°æ®å¹¶è¿”å›ä¸€ä¸ªArrayBufferå¯¹è±¡<br><span class="hljs-function"><span class="hljs-title">formData</span><span class="hljs-params">()</span></span> å°†å“åº”ä½“è§£æä¸ºFormDataå¯¹è±¡<br></code></pre></td></tr></table></figure><h2 id="ä¾‹å­-1"><a href="#ä¾‹å­-1" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><h3 id="1-GETï¼ˆé»˜è®¤ï¼‰"><a href="#1-GETï¼ˆé»˜è®¤ï¼‰" class="headerlink" title="1.GETï¼ˆé»˜è®¤ï¼‰"></a>1.GETï¼ˆé»˜è®¤ï¼‰</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// GET</span><br><span class="hljs-comment">// ç¬¬ä¸€æ¬¡è¿”å›çš„æ˜¯response headerï¼Œæ­¤æ—¶è¿˜æ²¡æœ‰response body</span><br><span class="hljs-comment">// ç¬¬äºŒæ¬¡æ ¹æ®æ•°æ®è§£ææ–¹æ³•è¿”å›response body</span><br>fetch(<span class="hljs-string">&#x27;http://localhost:5173/api/txt&#x27;</span>)<br>.then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(res);<br>  <span class="hljs-keyword">return</span> res.<span class="hljs-built_in">text</span>()<br>&#125;)<br>.then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(data);<br>&#125;)<br></code></pre></td></tr></table></figure><h3 id="2-POST-application-json"><a href="#2-POST-application-json" class="headerlink" title="2.POST application&#x2F;json"></a>2.POST application&#x2F;json</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// POST application/json</span><br><span class="hljs-built_in">fetch</span>(<span class="hljs-string">&#x27;/api/post&#x27;</span>, &#123;<br>  method: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>  headers: &#123;<br>    <span class="hljs-string">&#x27;Content-type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span><br>  &#125;,<br>  <span class="hljs-selector-tag">body</span>: JSON<span class="hljs-selector-class">.stringify</span>(&#123;<br>    name: <span class="hljs-string">&#x27;mmy&#x27;</span>,<br>    age: <span class="hljs-number">23</span><br>  &#125;)<br>&#125;)<span class="hljs-selector-class">.then</span>((res) =&gt; res<span class="hljs-selector-class">.json</span>())<br>  <span class="hljs-selector-class">.then</span>(data =&gt; console<span class="hljs-selector-class">.log</span>(data))<br></code></pre></td></tr></table></figure><h3 id="3-POST-application-x-www-form-urlencoded"><a href="#3-POST-application-x-www-form-urlencoded" class="headerlink" title="3.POST application&#x2F;x-www-form-urlencoded"></a>3.POST application&#x2F;x-www-form-urlencoded</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// POST application/x-www-form-urlencoded</span><br>fetch(<span class="hljs-string">&#x27;http://localhost:5173/api/post&#x27;</span>, &#123;<br>  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>  <span class="hljs-attr">headers</span>: &#123;<br>    <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/x-www-form-urlencoded&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">body</span>: <span class="hljs-string">&#x27;name=mmy&amp;age=23&#x27;</span><br>&#125;).then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.json())<br>  .then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(data);<br>  &#125;)<br></code></pre></td></tr></table></figure><h3 id="4-ä¸Šä¼ è¿›åº¦"><a href="#4-ä¸Šä¼ è¿›åº¦" class="headerlink" title="4.ä¸Šä¼ è¿›åº¦"></a>4.ä¸Šä¼ è¿›åº¦</h3><p>é€šè¿‡è¯·æ±‚å¤´çš„ header.get(â€˜Content-Typeâ€™)è·å–æ€»æ•°æ®å­—èŠ‚æ•°ã€‚</p><p>é€šè¿‡è¯·æ±‚å¤´çš„ body.getReader()è·å–ä¸€ä¸ªæµæ•°æ®è¯»å–å™¨ï¼Œå¾ªç¯ç´¯è®¡å½“å‰è¯»å–çš„å­—èŠ‚æ•°ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/txt&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (res) =&gt; &#123;<br>  <span class="hljs-comment">// ç”±äºå½“å‰çš„reså·²ç»è¢«ç”¨äºæµå¼è¿”å›æ•°æ®äº†ï¼Œå› æ­¤è¦å¤åˆ¶å‡ºæ¥ä¸€ä»½response headerç”¨äºè¿”å›response body</span><br>  <span class="hljs-keyword">const</span> response = res.<span class="hljs-title function_">clone</span>();<br>  <span class="hljs-comment">// æµå¼æ•°æ®å¤„ç†ï¼Œè¿”å›ä¸€ä¸ªæµ</span><br>  <span class="hljs-keyword">const</span> reader = res.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();<br>  <span class="hljs-comment">// æ€»é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚</span><br>  <span class="hljs-keyword">const</span> total = res.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;Content-Length&#x27;</span>);<br>  <span class="hljs-comment">// å½“å‰é•¿åº¦</span><br>  <span class="hljs-keyword">let</span> loaded = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-comment">// å’Œiterator generatorè¿”å›æ ¼å¼ä¸€æ ·</span><br>    <span class="hljs-comment">// å¦‚æœdoneæ˜¯trueè¡¨ç¤ºæ•°æ®è¿”å›å®Œæ¯•</span><br>    <span class="hljs-comment">// valueè¿”å›ä¸€ä¸ªunit8Array</span><br>    <span class="hljs-keyword">const</span> &#123; done, value &#125; = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();<br>    <span class="hljs-keyword">if</span> (done) &#123;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    loaded += value.<span class="hljs-property">length</span> || <span class="hljs-number">0</span>;<br>    progressDOM.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`current progress: <span class="hljs-subst">$&#123;(loaded / total * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)&#125;</span>%`</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">text</span>()<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">length</span>);<br>&#125;)<br>  <span class="hljs-comment">// ç»ˆæ­¢ Promiseè¿”å›reject</span><br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e);<br>  &#125;)<br></code></pre></td></tr></table></figure><h3 id="5-ä¸­æ–­è¯·æ±‚"><a href="#5-ä¸­æ–­è¯·æ±‚" class="headerlink" title="5.ä¸­æ–­è¯·æ±‚"></a>5.ä¸­æ–­è¯·æ±‚</h3><ol><li>åˆå§‹åŒ–ä¸€ä¸ªç»ˆæ­¢å™¨ abort</li><li>å‘èµ· fetch æ—¶æ ‡è®° signal ä¸º abort.signal</li><li>åˆé€‚çš„æ—¶å€™è°ƒç”¨ abort.abort()</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> btnDOM = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;button&#x27;</span>);<br>btnDOM.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&#x27;abort post request&#x27;</span><br>btnDOM.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;abort&#x27;</span>);<br>  <span class="hljs-comment">// ç»ˆæ­¢</span><br>  abort.<span class="hljs-title function_">abort</span>();<br>&#125;)<br><span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(btnDOM)<br><span class="hljs-comment">// å£°æ˜å˜é‡</span><br><span class="hljs-keyword">const</span> abort = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();<br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://localhost:5173/api/post&#x27;</span>, &#123;<br>  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>  <span class="hljs-attr">headers</span>: &#123;<br>    <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/x-www-form-urlencoded&#x27;</span><br>  &#125;,<br>  <span class="hljs-comment">// æ‰“æ ‡è®°</span><br>  <span class="hljs-attr">signal</span>: abort.<span class="hljs-property">signal</span>,<br>  <span class="hljs-attr">body</span>: <span class="hljs-string">&#x27;name=mmy&amp;age=23&#x27;</span><br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);<br>  &#125;)<br></code></pre></td></tr></table></figure><h3 id="6-è¶…æ—¶ç»ˆæ­¢ï¼ˆæ‰‹åŠ¨å®ç°ï¼‰"><a href="#6-è¶…æ—¶ç»ˆæ­¢ï¼ˆæ‰‹åŠ¨å®ç°ï¼‰" class="headerlink" title="6.è¶…æ—¶ç»ˆæ­¢ï¼ˆæ‰‹åŠ¨å®ç°ï¼‰"></a>6.è¶…æ—¶ç»ˆæ­¢ï¼ˆæ‰‹åŠ¨å®ç°ï¼‰</h3><p>è¶…æ—¶â€”â€”æ‰‹åŠ¨å°è£…ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œtimeout æ—¶ç»ˆæ­¢</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">const timeoutFn = <span class="hljs-function"><span class="hljs-params">(time = <span class="hljs-number">1000</span>)</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    abort.abort()<br>  &#125;, time);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="7-æºå¸¦-cookie-å’Œ-HTTP-Authorization-header"><a href="#7-æºå¸¦-cookie-å’Œ-HTTP-Authorization-header" class="headerlink" title="7.æºå¸¦ cookie å’Œ HTTP-Authorization header"></a>7.æºå¸¦ cookie å’Œ HTTP-Authorization header</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs 1c">fetch(&#x27;/api/txt&#x27;, &#123;<br>  headers: &#123;<br>    &#x27;Cookie&#x27;: &#x27;cookie_name=<span class="hljs-number">22471226</span>6&#x27;<br>  &#125;,<br>  <span class="hljs-comment">// cookie</span><br>  credentials: &#x27;include&#x27;<br>&#125;)<br></code></pre></td></tr></table></figure><h1 id="AJAX-XML-Axios-Fetch-ç»¼åˆæ¯”è¾ƒ"><a href="#AJAX-XML-Axios-Fetch-ç»¼åˆæ¯”è¾ƒ" class="headerlink" title="AJAX XML Axios Fetch ç»¼åˆæ¯”è¾ƒ"></a>AJAX XML Axios Fetch ç»¼åˆæ¯”è¾ƒ</h1><p>Ajax æ˜¯ä¸€ç§æ—©æœŸçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¼‚æ­¥æ•°æ®äº¤äº’æŠ€æœ¯ï¼Œæœ€é‡è¦çš„å®ç°ä¹‹ä¸€å°±æ˜¯ XMLHttpRequest å¯¹è±¡ï¼Œå› æ­¤ Ajax ä¹Ÿå¯ä»¥ç†è§£æˆæ˜¯ä¸€ç§ä½¿ç”¨ XML é€šä¿¡ã€è·å–ç½‘ç»œèµ„æºçš„æŠ€æœ¯ã€‚</p><p>Axios æ˜¯ä¸€ç§åŸºäº XML è¿›è¡ŒäºŒæ¬¡å°è£…çš„ç±»åº“ï¼Œåœ¨ XML åŸºç¡€ä¸Šå®ç°äº†æ–°çš„åŠŸèƒ½ï¼Œæ¯”å¦‚è¯·æ±‚æ‹¦æˆªå™¨ã€å“åº”æ‹¦æˆªå™¨ã€‚XML æœ¬èº«å¼‚æ­¥é€»è¾‘æ˜¯é€šè¿‡å›è°ƒå‡½æ•°å®ç°çš„ï¼Œaxios åŸºäº Promise å¯¹ XML å°è£…ï¼Œä½¿å¾—å†™æ³•æ›´åŠ ç®€æ´æ˜“ç”¨</p><p>Fetch API æ˜¯ä¸€ç§æ›´ç°ä»£çš„ç½‘ç»œè¯·æ±‚æŠ€æœ¯ï¼Œæ˜¯ä¸€ç§ä¸åŒäº Ajax çš„æŠ€æœ¯ï¼Œæœ‰å¦‚ä¸‹ä¼˜ç‚¹</p><ol><li>åŸç”Ÿæ”¯æŒ Promise å’Œé“¾å¼è°ƒç”¨ï¼ˆXML æ˜¯å›è°ƒå‡½æ•°å®ç°çš„å¼‚æ­¥é€»è¾‘ï¼‰</li><li>å…³æ³¨ç‚¹åˆ†ç¦»çš„è®¾è®¡åŸåˆ™ï¼ŒAPI æ›´ç®€æ´ã€ä¸åŒé˜¶æ®µçš„åŠŸèƒ½ä¸è¿‡åˆ†è€¦åˆï¼Œå†™æ³•ç®€å•ï¼ˆXML éœ€è¦è¿›è¡Œå¤šä¸ªå‚æ•°å’Œå›è°ƒå‡½æ•°çš„é…ç½®ï¼‰</li><li>ä¸°å¯Œçš„è¯·æ±‚å’Œå“åº”çš„æ•°æ®ç±»å‹æ”¯æŒï¼ŒåŒ…æ‹¬ JSONã€FormDataã€Blobã€ArrayBuffer ç­‰ï¼Œæ”¯æŒæµå¼æ•°æ®å¤„ç†ï¼ˆXML åªæ”¯æŒæ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®ï¼‰</li><li>å¯ä»¥å’Œå…¶ä»–ç°ä»£ Javascript API é…åˆä½¿ç”¨å¦‚ Service Worker ç­‰</li><li>è·¨åŸŸè¯·æ±‚ï¼š<code>fetch</code> API æä¾›äº†ä¸€ç§ç®€å•è€Œå¼ºå¤§çš„è§£å†³æ–¹æ¡ˆâ€”â€”ä½¿ç”¨ CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰å¤´éƒ¨å®ç°è·¨åŸŸè¯·æ±‚ï¼Œè€Œ XHR åˆ™ä½¿ç”¨äº†ä¸€ä¸ªå«åš <code>XMLHttpRequest Level 2</code> çš„è§„èŒƒï¼Œåœ¨ä»£ç ç¼–å†™ä¸Šç›¸å¯¹è¾ƒä¸ºç¹çã€‚</li></ol><p>ç¼ºç‚¹</p><ol><li><p>æ²¡æœ‰åŸç”Ÿæ”¯æŒ timeout äº‹ä»¶ï¼Œéœ€è¦è‡ªå·±å®ç°</p></li><li><p>å–æ¶ˆè¯·æ±‚ä¸æ–¹ä¾¿ï¼Œéœ€è¦åŸºäºä¸€ä¸ªæ„é€ å‡½æ•°</p></li><li><p>ç›¸æ¯”äº Axios ç¬¬ä¸‰æ–¹åº“ä½¿ç”¨æ¯”è¾ƒç¹çï¼Œæ¯”å¦‚ request interceptor å’Œ response interceptor éœ€è¦è‡ªå·±å®ç°</p></li><li><p><code>fetch</code> API é»˜è®¤åªæ”¯æŒ GET å’Œ POST è¯·æ±‚æ–¹æ³•ï¼Œè€Œ XHR åˆ™æ”¯æŒæ‰€æœ‰æ ‡å‡†çš„ HTTP è¯·æ±‚æ–¹æ³•ã€‚</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šè®¯æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šè®¯æŠ€æœ¯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è§£å†³è·¨åŸŸâ€”â€”è¿ç»´ç«¯nginx</title>
    <link href="/2024/01/28/%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E2%80%94%E2%80%94%E8%BF%90%E7%BB%B4%E7%AB%AFnginx/"/>
    <url>/2024/01/28/%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E2%80%94%E2%80%94%E8%BF%90%E7%BB%B4%E7%AB%AFnginx/</url>
    
    <content type="html"><![CDATA[<p>ubuntu</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arduino">apt-get nginx<br>cd etc/nginx/sites-available/<span class="hljs-keyword">default</span><br></code></pre></td></tr></table></figure><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">location</span> <span class="hljs-title">/api</span> &#123;<br>proxy_pass http://server_ip:server_port;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>CORS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>computer network</tag>
      
      <tag>CORS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è§£å†³è·¨åŸŸâ€”â€”å‰åç«¯åå•†jsonp</title>
    <link href="/2024/01/28/%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E2%80%94%E2%80%94%E5%89%8D%E5%90%8E%E7%AB%AF%E5%8D%8F%E5%95%86jsonp/"/>
    <url>/2024/01/28/%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E2%80%94%E2%80%94%E5%89%8D%E5%90%8E%E7%AB%AF%E5%8D%8F%E5%95%86jsonp/</url>
    
    <content type="html"><![CDATA[<h1 id="JSONP-åŸç†"><a href="#JSONP-åŸç†" class="headerlink" title="JSONP åŸç†"></a>JSONP åŸç†</h1><h2 id="1-ä»€ä¹ˆæ˜¯-JSONP"><a href="#1-ä»€ä¹ˆæ˜¯-JSONP" class="headerlink" title="1.ä»€ä¹ˆæ˜¯ JSONP"></a>1.ä»€ä¹ˆæ˜¯ JSONP</h2><p>JSONPï¼ˆJavaScript with paddingï¼‰æ˜¯ JSON çš„ä¸€ç§â€œä½¿ç”¨æ–¹å¼â€ï¼Œå¯ç”¨äºè§£å†³ä¸»æµæµè§ˆå™¨çš„è·¨åŸŸæ•°æ®è®¿é—®é—®é¢˜ã€‚</p><h2 id="2-JSONP-åŸç†"><a href="#2-JSONP-åŸç†" class="headerlink" title="2.JSONP åŸç†"></a>2.JSONP åŸç†</h2><p>ç”±äºæµè§ˆå™¨åŒæºç­–ç•¥çš„é™åˆ¶ï¼Œç½‘é¡µä¸­æ— æ³•é€šè¿‡ Ajax è¯·æ±‚éåŒæºçš„æ¥å£æ•°æ®ã€‚ä½†æ˜¯<code>&lt;script&gt;</code>æ ‡ç­¾ä¸å—æµè§ˆå™¨åŒæºç­–ç•¥çš„å½±å“ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ src å±æ€§ï¼Œè¯·æ±‚éåŒæºçš„ js è„šæœ¬ã€‚</p><p>å› æ­¤ï¼ŒJSONP çš„å®ç°åŸç†æ˜¯ï¼Œé€šè¿‡<code>&lt;script&gt;</code>æ ‡ç­¾çš„ src å±æ€§ï¼Œè¯·æ±‚è·¨åŸŸçš„æ•°æ®æ¥å£ï¼Œå¹¶é€šè¿‡<strong>å‡½æ•°è°ƒç”¨</strong>çš„å½¢å¼ï¼Œæ¥æ”¶è·¨åŸŸæ¥å£å“åº”å›æ¥çš„</p><p>æ•°æ®</p><h2 id="3-æ‰§è¡Œè¿‡ç¨‹"><a href="#3-æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="3.æ‰§è¡Œè¿‡ç¨‹"></a>3.æ‰§è¡Œè¿‡ç¨‹</h2><p>1.å®¢æˆ·ç«¯å®šä¹‰ä¸€ä¸ªè§£æå‡½æ•°,å¦‚ jsonpCallback &#x3D; function(res){}</p><p>2.é€šè¿‡ params çš„å½¢å¼(d)åŒ…è£… script æ ‡ç­¾çš„è¯·æ±‚å‚æ•°,å¹¶ä¸”å£°æ˜æ‰§è¡Œå‡½æ•°(å¦‚ cbj&#x3D;jsonpCallback)</p><p>3.åç«¯è·å–åˆ°å‰ç«¯å£°æ˜çš„æ‰§è¡Œå‡½æ•°(jsonpCallback)ï¼Œå¹¶ä»¥å¸¦ä¸Šå‚æ•°ä¸”è°ƒç”¨æ‰§è¡Œå‡½æ•°çš„æ–¹å¼ä¼ é€’ç»™å‰ç«¯</p><p>4.å‰ç«¯åœ¨ script æ ‡ç­¾è¿”å›èµ„æºçš„æ—¶å€™å°±ä¼šå»æ‰§è¡Œ jsonpCallback å¹¶é€šè¿‡å›è°ƒå‡½æ•°çš„æ–¹å¼æ‹¿åˆ°æ•°æ®äº†ã€‚</p><h2 id="4-ç¼ºç‚¹"><a href="#4-ç¼ºç‚¹" class="headerlink" title="4.ç¼ºç‚¹"></a>4.ç¼ºç‚¹</h2><p>ç”±äº JSONP æ˜¯é€šè¿‡<code>&lt;script&gt;</code>æ ‡ç­¾çš„ src å±æ€§+å›è°ƒå‡½æ•°å®ç°çš„è·¨åŸŸæ•°æ®è¯·æ±‚ï¼Œæ‰€ä»¥ JSONP<strong>åªæ”¯æŒ GET æ•°æ®è¯·æ±‚ï¼Œè€Œä¸æ”¯æŒ POST è¯·æ±‚</strong>ã€‚</p><h2 id="JSONP-å’Œ-AJAX-åŒºåˆ«"><a href="#JSONP-å’Œ-AJAX-åŒºåˆ«" class="headerlink" title="JSONP å’Œ AJAX åŒºåˆ«"></a>JSONP å’Œ AJAX åŒºåˆ«</h2><p>jsonp å’Œ Ajax æ²¡æœ‰ä»»ä½•å…³ç³»,å› ä¸º jsonp æ²¡æœ‰ç”¨åˆ° XMLHttpRequest è¿™ä¸ªå¯¹è±¡</p><p>jsonp ä¹‹æ‰€ä»¥èƒ½è·¨åŸŸï¼Œæ˜¯å› ä¸ºä»–å¹¶ä¸æ˜¯å‘é€ ajax è¯·æ±‚ï¼Œå¹¶ä¸æ˜¯åˆ©ç”¨ XMLHTTPRequest å¯¹è±¡å’ŒæœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ï¼Œä»–å…¶å®æ˜¯åˆ©ç”¨åŠ¨æ€åˆ›å»ºçš„ script æ ‡ç­¾ï¼Œè€Œ script æ ‡ç­¾æ˜¯æ²¡æœ‰<a href="https://so.csdn.net/so/search?q=%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5&spm=1001.2101.3001.7020">åŒæºç­–ç•¥</a>é™åˆ¶çš„ï¼Œå¯ä»¥è·¨åŸŸçš„</p><h1 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h1><h2 id="å‰ç«¯-5500-ç«¯å£"><a href="#å‰ç«¯-5500-ç«¯å£" class="headerlink" title="å‰ç«¯ 5500 ç«¯å£"></a>å‰ç«¯ 5500 ç«¯å£</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>è·¨åŸŸçš„å››ç§è§£å†³åŠæ³•<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">      <span class="hljs-comment">// 1.jsonp åŸç†æ˜¯é€šè¿‡ä¸å—æµè§ˆå™¨è·¨åŸŸé™åˆ¶çš„scriptæ ‡ç­¾çš„srcå±æ€§è·¨åŸŸè¯·æ±‚æ•°æ®</span></span><br><span class="language-javascript">      <span class="hljs-comment">// ç¼ºç‚¹ï¼šåªèƒ½å‘é€GETè¯·æ±‚ï¼Œä¸å®‰å…¨å¹¶ä¸”éš¾ä»¥ç»´æŠ¤</span></span><br><span class="language-javascript">      <span class="hljs-comment">// åç«¯è¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°æ˜¯åœ¨å‰ç«¯å®šä¹‰çš„ï¼ŒæŠŠå€¼æ³¨å…¥åˆ°å‡½æ•°å‚æ•°ä¸­</span></span><br><span class="language-javascript">      <span class="hljs-keyword">const</span> <span class="hljs-title function_">jsonp</span> = (<span class="hljs-params">name</span>) =&gt; &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">let</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;script&#x27;</span>);</span><br><span class="language-javascript">        script.<span class="hljs-property">src</span> = <span class="hljs-string">&#x27;http://localhost:3000/api/jsonp?callback=&#x27;</span> + name;</span><br><span class="language-javascript">        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);</span><br><span class="language-javascript">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">          <span class="hljs-variable language_">window</span>[name] = <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">            <span class="hljs-title function_">resolve</span>(data);</span><br><span class="language-javascript">          &#125;;</span><br><span class="language-javascript">        &#125;);</span><br><span class="language-javascript">      &#125;;</span><br><span class="language-javascript">      <span class="hljs-title function_">jsonp</span>(<span class="hljs-string">`callback<span class="hljs-subst">$&#123;<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()&#125;</span>`</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);</span><br><span class="language-javascript">      &#125;);</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="åç«¯-3000-ç«¯å£"><a href="#åç«¯-3000-ç«¯å£" class="headerlink" title="åç«¯ 3000 ç«¯å£"></a>åç«¯ 3000 ç«¯å£</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express&#x27;</span>;<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;<br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/api/jsonp&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; callback &#125; = req.<span class="hljs-property">query</span>;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;callback&#125;</span>(&#x27;jsonp data from backend&#x27;)`</span>);<br>&#125;);<br>app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;server is running&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">pnpm <span class="hljs-keyword">init</span><br>pnpm i express <span class="hljs-meta">@types</span>/express <span class="hljs-meta">@types</span>/node<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>CORS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>computer network</tag>
      
      <tag>CORS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è§£å†³è·¨åŸŸâ€”â€”åç«¯CORS</title>
    <link href="/2024/01/28/%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E2%80%94%E2%80%94%E5%90%8E%E7%AB%AFCORS/"/>
    <url>/2024/01/28/%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E2%80%94%E2%80%94%E5%90%8E%E7%AB%AFCORS/</url>
    
    <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯-CORS"><a href="#ä»€ä¹ˆæ˜¯-CORS" class="headerlink" title="ä»€ä¹ˆæ˜¯ CORS"></a>ä»€ä¹ˆæ˜¯ CORS</h1><p>Cross origin resource sharingï¼Œè·¨åŸŸèµ„æºå…±äº«ï¼Œä¸»è¦å‡ºç°åœ¨ä¸¤ç§æƒ…å†µä¸‹ï¼š</p><ol><li><p>å‰åç«¯åˆ†ç¦»çš„å¼€å‘æ¨¡å¼ä¸‹ï¼ˆseparation of front and back stageï¼‰ï¼Œå‰åç«¯æœåŠ¡è¿è¡Œåœ¨ä¸åŒçš„ domainï¼Œå‰ç«¯è¯·æ±‚åç«¯æ•°æ®å±äº CORS</p></li><li><p>å‰ç«¯è¯·æ±‚ç¬¬ä¸‰æ–¹ä¸åŒ domain çš„æ•°æ®èµ„æº</p></li></ol><h1 id="CORS-åˆ†ç±»"><a href="#CORS-åˆ†ç±»" class="headerlink" title="CORS åˆ†ç±»"></a>CORS åˆ†ç±»</h1><p>é»˜è®¤æƒ…å†µä¸‹çš„è·¨åŸŸè¯·æ±‚è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šç¬¬ä¸€ç±»æ˜¯<strong>å®‰å…¨è¯·æ±‚</strong>ï¼Œæµè§ˆå™¨ç›´æ¥å‘é€å®é™…è¯·æ±‚ï¼›ç¬¬äºŒç±»æ˜¯<strong>éå®‰å…¨è¯·æ±‚</strong>ï¼Œæµè§ˆå™¨éœ€è¦å…ˆå‘é€<strong>é¢„æ£€è¯·æ±‚ preflight</strong>ï¼Œåœ¨æ ¹æ® preflight response å†³å®šæ˜¯å¦å‘é€å®é™…è¯·æ±‚ã€‚</p><p><strong>é™„å¸¦å‡­æ®çš„è·¨åŸŸè¯·æ±‚</strong>æ›´åŠ ä¸¥æ ¼ï¼Œå› ä¸ºå®ƒæºå¸¦äº† cookies æˆ–è€… HTTP è®¤è¯ï¼ˆHTTP authenticationï¼‰ç­‰æ•æ„Ÿæ•°æ®</p><p>æ¯ç§è¯·æ±‚çš„åœºæ™¯å’Œå…·ä½“è¿‡ç¨‹å¯å‚è€ƒä»¥ä¸‹èµ„æº</p><p><a href="https://zh.javascript.info/fetch-crossorigin#ping-ju-credentials">https://zh.javascript.info/fetch-crossorigin#ping-ju-credentials</a></p><p><a href="https://www.bilibili.com/video/BV1T5411v7to/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=d72819370cfa974d3b9e47dee41c7878">https://www.bilibili.com/video/BV1T5411v7to/?spm_id_from=333.1007.top_right_bar_window_history.content.click&amp;vd_source=d72819370cfa974d3b9e47dee41c7878</a></p><p><a href="https://www.bilibili.com/video/BV1rL411a7UN?p=6&vd_source=d72819370cfa974d3b9e47dee41c7878">https://www.bilibili.com/video/BV1rL411a7UN?p=6&amp;vd_source=d72819370cfa974d3b9e47dee41c7878</a></p><h1 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h1><p>å‰ç«¯ <a href="http://localhost:5173/">http://localhost:5173/</a></p><p>åç«¯ <a href="http://localhost:3000/">http://localhost:3000/</a></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express&#x27;</span>;<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;<br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/api/json&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// 3.åç«¯æ·»åŠ CORS request header</span><br>  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>);<br>  res.<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;mameiyu&#x27;</span> &#125;);<br>&#125;);<br>app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;server is running&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>è·¨åŸŸçš„å››ç§è§£å†³åŠæ³•<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">      <span class="hljs-comment">// 3.CORS</span></span><br><span class="language-javascript">      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://localhost:3000/api/json&#x27;</span>)</span><br><span class="language-javascript">        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())</span><br><span class="language-javascript">        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);</span><br><span class="language-javascript">        &#125;);</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>CORS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>computer network</tag>
      
      <tag>CORS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è§£å†³è·¨åŸŸâ€”â€”å‰ç«¯ä»£ç†</title>
    <link href="/2024/01/28/%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E2%80%94%E2%80%94%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%90%86/"/>
    <url>/2024/01/28/%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E2%80%94%E2%80%94%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<p>ä»…èƒ½åœ¨å¼€å‘ç¯å¢ƒä¸‹é…åˆ webpackã€viteã€rollup ç­‰å‰ç«¯æ„å»ºæ‰“åŒ…å·¥å…·ä½¿ç”¨ã€‚</p><p>æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒéœ€è¦é…åˆ nginx ä»£ç†</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">å‰ç«¯</span> <span class="hljs-number">5173</span><span class="hljs-string">ç«¯å£</span><br><span class="hljs-string">åç«¯</span> <span class="hljs-number">3000</span><span class="hljs-string">ç«¯å£</span><br></code></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>è·¨åŸŸçš„å››ç§è§£å†³åŠæ³•<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">      <span class="hljs-comment">// 2.build-up tools proxy</span></span><br><span class="language-javascript">      <span class="hljs-comment">// fetch(&#x27;http://localhost:5173/api/json&#x27;)</span></span><br><span class="language-javascript">      <span class="hljs-comment">// æœ¬åœ°</span></span><br><span class="language-javascript">      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/json&#x27;</span>)</span><br><span class="language-javascript">        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())</span><br><span class="language-javascript">        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);</span><br><span class="language-javascript">        &#125;);</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// vite.config.ts</span><br><span class="hljs-keyword">import</span> &#123; defineConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">server</span>: &#123;<br>    <span class="hljs-attr">proxy</span>: &#123;<br>      <span class="hljs-string">&#x27;/api&#x27;</span>: &#123;<br>        <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://localhost:3000/api&#x27;</span>,<br>        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\/api/</span>, <span class="hljs-string">&#x27;&#x27;</span>),<br>      &#125;,<br>    &#125;,<br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>CORS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>computer network</tag>
      
      <tag>CORS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æµè§ˆå™¨åŒæºç­–ç•¥å’Œè·¨åŸŸé™åˆ¶</title>
    <link href="/2024/01/27/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%A8%E5%9F%9F%E9%99%90%E5%88%B6/"/>
    <url>/2024/01/27/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E5%92%8C%E8%B7%A8%E5%9F%9F%E9%99%90%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="URL-ç®€ä»‹"><a href="#URL-ç®€ä»‹" class="headerlink" title="URL ç®€ä»‹"></a>URL ç®€ä»‹</h1><p><a href="https://developer.mozilla.org/zh-CN/docs/Learn/Common_questions/Web_mechanics/What_is_a_URL">https://developer.mozilla.org/zh-CN/docs/Learn/Common_questions/Web_mechanics/What_is_a_URL</a></p><p>URL ç”±<strong>åè®®ï¼ˆé€šå¸¸éƒ½æ˜¯ HTTP åè®®æˆ–æ˜¯ HTTP åè®®çš„å®‰å…¨ç‰ˆï¼Œå³ HTTPSï¼‰ã€æœåŠ¡å™¨åœ°å€ï¼ˆå¯ä»¥æ˜¯ IPv4 IPv6 åœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯åŸŸåï¼‰å’Œç«¯å£</strong>ä¸‰ä¸ªå¿…é¡»éƒ¨åˆ†ï¼Œä»¥åŠä¸€äº›éå¿…éœ€é€‰é¡¹å…±åŒç»„æˆã€‚</p><p><img src="/img/computer_network/CORS/mdn-url-all.png" alt="mdn-url-all"></p><h1 id="åŒæº"><a href="#åŒæº" class="headerlink" title="åŒæº"></a>åŒæº</h1><p>å¦‚æœä¸¤ä¸ªé¡µé¢çš„<strong>åè®®ï¼ŒåŸŸåå’Œç«¯å£</strong>éƒ½ç›¸åŒï¼Œåˆ™ä¸¤ä¸ªé¡µé¢å…·æœ‰ç›¸åŒçš„æºã€‚</p><h1 id="æµè§ˆå™¨çš„åŒæºç­–ç•¥ï¼ˆæ¡Œé¢ç«¯é€šä¿¡æ²¡æœ‰åŒæºç­–ç•¥é™åˆ¶ï¼‰"><a href="#æµè§ˆå™¨çš„åŒæºç­–ç•¥ï¼ˆæ¡Œé¢ç«¯é€šä¿¡æ²¡æœ‰åŒæºç­–ç•¥é™åˆ¶ï¼‰" class="headerlink" title="æµè§ˆå™¨çš„åŒæºç­–ç•¥ï¼ˆæ¡Œé¢ç«¯é€šä¿¡æ²¡æœ‰åŒæºç­–ç•¥é™åˆ¶ï¼‰"></a>æµè§ˆå™¨çš„åŒæºç­–ç•¥ï¼ˆæ¡Œé¢ç«¯é€šä¿¡æ²¡æœ‰åŒæºç­–ç•¥é™åˆ¶ï¼‰</h1><p><strong>åŒæºç­–ç•¥ï¼ˆè‹±æ–‡å…¨ç§° Same origin policyï¼‰æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ä¸ªå®‰å…¨åŠŸèƒ½</strong>ã€‚</p><p>MDN å®˜æ–¹ç»™å®šçš„æ¦‚å¿µï¼šåŒæºç­–ç•¥é™åˆ¶äº†ä»åŒä¸€ä¸ªæºåŠ è½½çš„æ–‡æ¡£æˆ–è„šæœ¬å¦‚ä½•ä¸æ¥è‡ªå¦ä¸€ä¸ªæºçš„èµ„æºè¿›è¡Œäº¤äº’ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºéš”ç¦»æ½œåœ¨æ¶æ„æ–‡ä»¶çš„é‡è¦å®‰å…¨æœºåˆ¶ã€‚ é€šä¿—çš„ç†è§£ï¼šæµè§ˆå™¨è§„å®šï¼ŒA ç½‘ç«™çš„ JavaScriptï¼Œä¸å…è®¸å’ŒéåŒæºçš„ç½‘ç«™ C ä¹‹é—´ï¼Œè¿›è¡Œèµ„æºçš„äº¤äº’ï¼Œä¾‹å¦‚ï¼š</p><p>â‘  æ— æ³•è¯»å–éåŒæºç½‘é¡µçš„æµè§ˆå™¨ç¼“å­˜å¦‚ Cookieã€LocalStorage å’Œ IndexedDB</p><p>â‘¡ æ— æ³•æ¥è§¦éåŒæºç½‘é¡µçš„ DOM</p><p>â‘¢ æ— æ³•å‘éåŒæºåœ°å€å‘é€ Ajax è¯·æ±‚</p><h1 id="è·¨åŸŸ"><a href="#è·¨åŸŸ" class="headerlink" title="è·¨åŸŸ"></a>è·¨åŸŸ</h1><p>åŒæºæŒ‡çš„æ˜¯ä¸¤ä¸ª URL çš„åè®®ã€åŸŸåã€ç«¯å£ä¸€è‡´ï¼Œåä¹‹ï¼Œåˆ™æ˜¯è·¨åŸŸã€‚</p><p>å‡ºç°è·¨åŸŸçš„æ ¹æœ¬åŸå› ï¼šæµè§ˆå™¨çš„åŒæºç­–ç•¥ä¸å…è®¸éåŒæºçš„ URL ä¹‹é—´è¿›è¡Œèµ„æºçš„äº¤äº’ã€‚</p><p>ç½‘é¡µï¼š<a href="http://www.test.com/index.html">http://www.test.com/index.html</a></p><p>æ¥å£ï¼š<a href="http://www.api.com/userlist">http://www.api.com/userlist</a></p><p><strong>æµè§ˆå™¨å…è®¸å‘èµ·è·¨åŸŸè¯·æ±‚ï¼Œä½†æ˜¯ï¼Œè·¨åŸŸè¯·æ±‚å›æ¥çš„æ•°æ®ï¼Œä¼šè¢«æµè§ˆå™¨çš„ Ajax å¼•æ“æ‹¦æˆªï¼Œæ— æ³•è¢«é¡µé¢è·å–åˆ°ï¼</strong></p><p><img src="/img/computer_network/CORS/browser-origin-strategy.png" alt="browser-origin-strategy"></p><h1 id="æµè§ˆå™¨è·¨åŸŸé™åˆ¶çš„è§£å†³æ–¹å¼"><a href="#æµè§ˆå™¨è·¨åŸŸé™åˆ¶çš„è§£å†³æ–¹å¼" class="headerlink" title="æµè§ˆå™¨è·¨åŸŸé™åˆ¶çš„è§£å†³æ–¹å¼"></a>æµè§ˆå™¨è·¨åŸŸé™åˆ¶çš„è§£å†³æ–¹å¼</h1><p>ç°å¦‚ä»Šï¼Œå®ç°è·¨åŸŸæ•°æ®è¯·æ±‚ï¼Œæœ‰å››ç§è§£å†³æ–¹æ¡ˆï¼Œåˆ†åˆ«æ˜¯ JSONPã€Proxyã€CORS å’Œ nginx ä»£ç†ã€‚</p><h3 id="å‰åç«¯åå•†-JSONP"><a href="#å‰åç«¯åå•†-JSONP" class="headerlink" title="å‰åç«¯åå•† JSONP"></a>å‰åç«¯åå•† JSONP</h3><p>å‡ºç°çš„æ—©ï¼Œå…¼å®¹æ€§å¥½ï¼ˆå…¼å®¹ä½ç‰ˆæœ¬ IEï¼‰ã€‚æ˜¯å‰ç«¯ç¨‹åºå‘˜ä¸ºäº†è§£å†³è·¨åŸŸé—®é¢˜ï¼Œè¢«è¿«æƒ³å‡ºæ¥çš„ä¸€ç§ä¸´æ—¶è§£å†³æ–¹æ¡ˆã€‚ ç¼ºç‚¹æ˜¯<strong>åªæ”¯æŒ GET è¯·æ±‚</strong>ï¼Œä¸æ”¯æŒ POST è¯·æ±‚ã€‚</p><h3 id="å‰ç«¯è§£å†³â€”â€”å‰ç«¯ä»£ç†"><a href="#å‰ç«¯è§£å†³â€”â€”å‰ç«¯ä»£ç†" class="headerlink" title="å‰ç«¯è§£å†³â€”â€”å‰ç«¯ä»£ç†"></a>å‰ç«¯è§£å†³â€”â€”å‰ç«¯ä»£ç†</h3><p>ä»…èƒ½åœ¨å¼€å‘ç¯å¢ƒä¸‹é…åˆ webpackã€viteã€rollup ç­‰å‰ç«¯æ„å»ºæ‰“åŒ…å·¥å…·ä½¿ç”¨ã€‚æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒéœ€è¦é…åˆ nginx ä»£ç†</p><h3 id="åç«¯è§£å†³â€”â€”CORS"><a href="#åç«¯è§£å†³â€”â€”CORS" class="headerlink" title="åç«¯è§£å†³â€”â€”CORS"></a>åç«¯è§£å†³â€”â€”CORS</h3><p>å‡ºç°çš„è¾ƒæ™šï¼Œå®ƒæ˜¯ W3C æ ‡å‡†ï¼Œ<strong>å±äºè·¨åŸŸ Ajax è¯·æ±‚çš„æ ¹æœ¬è§£å†³æ–¹æ¡ˆã€‚æ”¯æŒ GET å’Œ POST è¯·æ±‚ã€‚ç¼ºç‚¹æ˜¯ä¸å…¼å®¹ æŸäº›ä½ç‰ˆæœ¬çš„æµè§ˆå™¨</strong>ã€‚æœ‰å®‰å…¨è¯·æ±‚ã€éå®‰å…¨è¯·æ±‚å’Œæºå¸¦å‡­æ®çš„è¯·æ±‚ä¸‰ç§</p><h3 id="è¿ç»´ç«¯è§£å†³â€”â€”ngnix-ä»£ç†"><a href="#è¿ç»´ç«¯è§£å†³â€”â€”ngnix-ä»£ç†" class="headerlink" title="è¿ç»´ç«¯è§£å†³â€”â€”ngnix ä»£ç†"></a>è¿ç»´ç«¯è§£å†³â€”â€”ngnix ä»£ç†</h3><p>åœ¨ config æ–‡ä»¶ä¸­é…ç½® location</p>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>CORS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>computer network</tag>
      
      <tag>CORS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CDNå†…å®¹åˆ†å‘ç½‘ç»œç®€ä»‹</title>
    <link href="/2024/01/26/CDN/"/>
    <url>/2024/01/26/CDN/</url>
    
    <content type="html"><![CDATA[<h1 id="CDN-Content-Delivery-Network"><a href="#CDN-Content-Delivery-Network" class="headerlink" title="CDN Content Delivery Network"></a>CDN Content Delivery Network</h1><p>CDN æ˜¯ç”¨æ¥ä¼˜åŒ–ç½‘ç»œèµ„æºè¯·æ±‚çš„æ—¶é—´çš„</p><h2 id="ä¼˜åŒ–èµ„æºè®¿é—®é€Ÿåº¦"><a href="#ä¼˜åŒ–èµ„æºè®¿é—®é€Ÿåº¦" class="headerlink" title="ä¼˜åŒ–èµ„æºè®¿é—®é€Ÿåº¦"></a>ä¼˜åŒ–èµ„æºè®¿é—®é€Ÿåº¦</h2><p>è¯·æ±‚èµ„æºçš„é€Ÿåº¦å’Œèµ„æºæ‰€åœ¨çš„æœåŠ¡å™¨ä¸æˆ‘ä»¬çš„åœ°ç†è·ç¦»æœ‰å…³ï¼Œå¦‚æœè·ç¦»è¿‡è¿œï¼Œèµ„æºä»æœåŠ¡å™¨å‘é€åˆ°æˆ‘ä»¬è¿™é‡Œæ‰€éœ€æ—¶é—´å°±ä¼šå¾ˆä¹…ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œå¯ä»¥æ„å»ºä¸€ä¸ªå†…å®¹åˆ†å‘ç½‘ç»œ CDNï¼Œè¯·æ±‚èµ„æºçš„æ—¶å€™ä¼šä¼˜å…ˆè¯¢é—®è·ç¦»æˆ‘ä»¬è¾ƒè¿‘çš„æœåŠ¡å™¨æœ‰æ²¡æœ‰è¯¥èµ„æºï¼Œå¦‚æœæ²¡æœ‰ï¼Œè¾ƒè¿‘çš„æœåŠ¡å™¨å†å‘ä¸Šå±‚å±‚æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æˆ‘ä»¬è¦è®¿é—®çš„èµ„æºæ‰€åœ¨çš„åŸæœåŠ¡å™¨ï¼Œè·å–è¯¥èµ„æºï¼Œç¼“å­˜åˆ°è¾ƒè¿‘çš„æœåŠ¡å™¨æœ€åå†å‘é€ç»™æˆ‘ä»¬ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œç­‰åˆ°ä¸‹æ¬¡å†è¯·æ±‚è¯¥èµ„æºçš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡ CDN ç›´æ¥ä»å·²ç»ç¼“å­˜è¿‡èµ„æºã€å¹¶ä¸”è·ç¦»éå¸¸è¿‘çš„æœåŠ¡å™¨ä¸Šè·å–èµ„æºï¼Œå¤§å¤§å‡å°‘äº†ç½‘ç»œè¯·æ±‚æ—¶é—´</p><h2 id="å¼‚åœ°å®¹ç¾"><a href="#å¼‚åœ°å®¹ç¾" class="headerlink" title="å¼‚åœ°å®¹ç¾"></a>å¼‚åœ°å®¹ç¾</h2><p>ä½¿ç”¨äº† CDN åï¼Œæµè§ˆå™¨è¾“å…¥ url é€šè¿‡ DNS å°†åŸŸåè§£æä¸º IP çš„è¿‡ç¨‹ä¼šå‘ç”Ÿå˜åŒ–ï¼Œç¬¬ä¸‰æ­¥ä¸å†æ˜¯æŸ¥æ‰¾æƒå¨åŸŸåæœåŠ¡å™¨ï¼Œè€Œå˜æˆäº†æ™ºèƒ½ DNS</p><p><img src="/img/computer_network/CDN/image-20240128190751726.png" alt="image-20240128190751726"></p><h2 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h2><p>ç›‘æ§æ•´ä¸ªç½‘ç»œä¸­æµè§ˆå™¨çš„æµé‡ï¼Œè°ƒåº¦åˆ†é…æ¯ä¸ªæœåŠ¡å™¨çš„ä»»åŠ¡ï¼Œä½¿å¾— CPU å ç”¨ç‡ã€è´Ÿè½½åŸºæœ¬å‡è¡¡</p><p><img src="/img/computer_network/CDN/image-20240128191142254.png" alt="image-20240128191142254"></p>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>CDN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CDN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æµè§ˆå™¨è¾“å…¥urlåå‘ç”Ÿäº†ä»€ä¹ˆ</title>
    <link href="/2024/01/26/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BE%93%E5%85%A5url%E5%90%8E%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/"/>
    <url>/2024/01/26/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BE%93%E5%85%A5url%E5%90%8E%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/</url>
    
    <content type="html"><![CDATA[<h1 id="1-DNS-åŸŸåè§£æ"><a href="#1-DNS-åŸŸåè§£æ" class="headerlink" title="1.DNS åŸŸåè§£æ"></a>1.DNS åŸŸåè§£æ</h1><p><img src="/img/computer_network/after_type_url/DNS.png" alt="DNS"></p><p><img src="/img/computer_network/after_type_url/query-domain-name-server.png" alt="query-domain-name-server"></p><h2 id="2-å‘é€ç½‘ç»œè¯·æ±‚ï¼Œä¸‰æ¬¡æ¡æ‰‹å»ºç«‹-TCP-è¿æ¥"><a href="#2-å‘é€ç½‘ç»œè¯·æ±‚ï¼Œä¸‰æ¬¡æ¡æ‰‹å»ºç«‹-TCP-è¿æ¥" class="headerlink" title="2.å‘é€ç½‘ç»œè¯·æ±‚ï¼Œä¸‰æ¬¡æ¡æ‰‹å»ºç«‹ TCP è¿æ¥"></a>2.å‘é€ç½‘ç»œè¯·æ±‚ï¼Œä¸‰æ¬¡æ¡æ‰‹å»ºç«‹ TCP è¿æ¥</h2><p>å†ç» OSI ä¸ƒå±‚ç½‘ç»œæ¨¡å‹é€æ­¥å‘é€ç½‘ç»œè¯·æ±‚ï¼Œæœ€é‡è¦çš„æ˜¯åœ¨ä¼ è¾“å±‚ç»è¿‡ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹å¯é çš„ TCP è¿æ¥ï¼Œæœ€ååœ¨åº”ç”¨å±‚å‘é€ HTTP è¯·æ±‚ã€‚</p><p>è¯·æ±‚ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š<strong>method headers body</strong></p><p>method æ–¹æ³•é™¤äº†ç®€å•çš„ get post ä¹‹å¤–è¿˜æœ‰éµä» restful è§„èŒƒçš„ put delete patch ç­‰æ–¹æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ optionsï¼Œæ˜¯å‘é€ preflight</p><p>é¢„æ£€è¯·æ±‚çš„æ–¹æ³•ï¼Œå¦‚æœä¸€ä¸ª HTTP Request ä¸å­˜ä»ä»¥ä¸‹ä¸¤ç‚¹å®‰å…¨æ€§è¦æ±‚ï¼š</p><ol><li><p>å®‰å…¨çš„æ–¹æ³•ï¼šGET POST HEAD</p></li><li><p>å®‰å…¨çš„ headersï¼šä»…å…è®¸è‡ªå®šä¹‰ä¸‹åˆ— headerï¼š</p><ul><li>Accept</li><li>Accept- Language</li><li>Content-Language</li><li>Content-Type çš„å€¼ä¸º application&#x2F;x-www-form-urlencodedï¼Œmultipart&#x2F;form-data æˆ– text&#x2F;plainã€‚</li></ul></li></ol><p>æµè§ˆå™¨åŸºäºå®‰å…¨æ€§è€ƒè™‘å°±ä¼šå‘é€ preflightï¼ˆé¢„æ£€è¯·æ±‚ï¼Œæ–¹æ³•ä¸æ˜¯ POST&#x2F;GET ç­‰ï¼Œè€Œæ˜¯ OPTIONSï¼‰ï¼Œé€šè¿‡ä¹‹åæ‰ä¼šå‘é€çœŸæ­£çš„è¯·æ±‚</p><p><img src="/img/computer_network/after_type_url/image-20240202191157031.png" alt="image-20240202191157031"></p><h2 id="3-æµè§ˆå™¨çš„å¼ºç¼“å­˜å’Œåå•†ç¼“å­˜"><a href="#3-æµè§ˆå™¨çš„å¼ºç¼“å­˜å’Œåå•†ç¼“å­˜" class="headerlink" title="3.æµè§ˆå™¨çš„å¼ºç¼“å­˜å’Œåå•†ç¼“å­˜"></a>3.æµè§ˆå™¨çš„å¼ºç¼“å­˜å’Œåå•†ç¼“å­˜</h2><h3 id="å¼ºç¼“å­˜"><a href="#å¼ºç¼“å­˜" class="headerlink" title="å¼ºç¼“å­˜"></a>å¼ºç¼“å­˜</h3><p><strong>ç¬¬ä¸€æ¬¡æˆåŠŸå‘é€è¯·æ±‚å¹¶ä¸”æˆåŠŸè·å–å“åº”ä¹‹åï¼Œå¦‚æœåå°è®¾ç½®äº†å¼ºç¼“å­˜ï¼Œä¼šå¼ºåˆ¶æµè§ˆå™¨å°†æœåŠ¡ç«¯æä¾›çš„èµ„æºç¼“å­˜åœ¨ç¡¬ç›˜æˆ–è€…å†…å­˜ä¸­ã€‚</strong></p><p>ä¸‹æ¬¡åˆ·æ–°æµè§ˆå™¨å‘é€åŒæ ·çš„è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰è¶…å‡ºæµè§ˆå™¨ç¼“å­˜çš„æ—¶é—´é™åˆ¶ï¼Œæµè§ˆå™¨ä¼šç›´æ¥è¿”å›è¯·æ±‚å†…å®¹ï¼Œä¸ä¼šå†é€šçŸ¥æœåŠ¡ç«¯ã€è¯·æ±‚æœåŠ¡ç«¯ã€‚</p><p>å¦‚æœè¶…å‡ºäº† max-age æˆ– expires è§„å®šçš„æ—¶é—´ï¼ŒæœåŠ¡å™¨å¼ºç¼“å­˜çš„èµ„æºå°±è¿‡æœŸäº†ã€‚</p><p>max-age çš„ä¼˜å…ˆçº§é«˜äº expiresï¼Œå‰è€…æ˜¯ HTTP1.1 æ”¯æŒï¼Œåè€… HTTP1.0 æ”¯æŒã€‚</p><p><img src="/img/computer_network/after_type_url/strong-cache.png" alt="strong-cache"></p><h3 id="åå•†ç¼“å­˜"><a href="#åå•†ç¼“å­˜" class="headerlink" title="åå•†ç¼“å­˜"></a>åå•†ç¼“å­˜</h3><p>å½“æœåŠ¡ç«¯å‘ç°èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´ Last-Modified å’Œ If-Modified-Since å€¼ç›¸ç­‰ï¼Œä»£è¡¨èµ„æºä»è¯¥æ—¶é—´ä¹‹åä»æœªæ”¹å˜è¿‡ï¼Œè¿”å›<strong>304 çŠ¶æ€ç å’Œç©ºå“åº”ä½“</strong>ï¼Œæµè§ˆå™¨æ‹¿åˆ°åçŸ¥é“åŸæœ¬å¯èƒ½è¿‡æœŸçš„å¼ºç¼“å­˜å†…å®¹è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨ã€‚</p><p>å¦‚æœå€¼ä¸ç›¸ç­‰ï¼Œè¯´æ˜èµ„æºæ”¹å˜äº†ï¼Œå°±ä¼šè¿”å› 200 çŠ¶æ€ç ï¼Œå“åº”ä½“å†…ä¸ºæœ€æ–°èµ„æº</p><h2 id="4-å››æ¬¡æŒ¥æ‰‹æ–­å¼€-TCP-è¿æ¥"><a href="#4-å››æ¬¡æŒ¥æ‰‹æ–­å¼€-TCP-è¿æ¥" class="headerlink" title="4.å››æ¬¡æŒ¥æ‰‹æ–­å¼€ TCP è¿æ¥"></a>4.å››æ¬¡æŒ¥æ‰‹æ–­å¼€ TCP è¿æ¥</h2><p><img src="/img/computer_network/after_type_url/image-20240202191126170.png" alt="image-20240202191126170"></p><h2 id="5-HTML-é¡µé¢å¼€å§‹æ¸²æŸ“"><a href="#5-HTML-é¡µé¢å¼€å§‹æ¸²æŸ“" class="headerlink" title="5.HTML é¡µé¢å¼€å§‹æ¸²æŸ“"></a>5.HTML é¡µé¢å¼€å§‹æ¸²æŸ“</h2><h3 id="ç»˜åˆ¶-DOM-æ ‘"><a href="#ç»˜åˆ¶-DOM-æ ‘" class="headerlink" title="ç»˜åˆ¶ DOM æ ‘"></a>ç»˜åˆ¶ DOM æ ‘</h3><p>HTML è§£æå™¨å°†è¶…æ–‡æœ¬å’Œæ ‡ç­¾è§£ææˆ DOM æ ‘ï¼Œç»˜åˆ¶æˆä¸€æ£µ<strong>æŠ½è±¡è¯­æ³•æ ‘ AST</strong></p><h3 id="æ ·å¼è®¡ç®—"><a href="#æ ·å¼è®¡ç®—" class="headerlink" title="æ ·å¼è®¡ç®—"></a>æ ·å¼è®¡ç®—</h3><p>æ¸²æŸ“å¼•æ“å°† CSS æ ·å¼è¡¨è½¬æ¢æˆæµè§ˆå™¨å¯ä»¥ç†è§£çš„ style sheetsï¼Œè®¡ç®—å‡º DOM èŠ‚ç‚¹çš„æ ·å¼</p><p>CSS æ ·å¼æ¥æºä¸»è¦æœ‰ä¸‰ç§ï¼šå†…åµŒã€å†…è”ã€å¤–è”</p><p>CSS æ–‡æœ¬ä¸­è¯¸å¦‚ 2emã€blue ç­‰æ— æ³•ç›´æ¥è¢«æ¸²æŸ“å¼•æ“ç†è§£çš„å†…å®¹ä¼šå…ˆç»è¿‡å±æ€§å€¼æ ‡å‡†åŒ–çš„è¿‡ç¨‹ï¼Œè½¬åŒ–ä¸ºèƒ½è¢«ç†è§£çš„æ ‡å‡†å€¼</p><p>ç„¶åå†å¤„ç†æ ·å¼çš„ç»§æ‰¿å’Œå±‚å ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åš CSSOM çš„æ„å»ºè¿‡ç¨‹</p><h3 id="å›æµï¼ˆReflowï¼‰å’Œå¤§å°ã€å®½é«˜ç›¸å…³çš„ä¸€å®šæ˜¯å›æµ"><a href="#å›æµï¼ˆReflowï¼‰å’Œå¤§å°ã€å®½é«˜ç›¸å…³çš„ä¸€å®šæ˜¯å›æµ" class="headerlink" title="å›æµï¼ˆReflowï¼‰å’Œå¤§å°ã€å®½é«˜ç›¸å…³çš„ä¸€å®šæ˜¯å›æµ"></a>å›æµï¼ˆReflowï¼‰å’Œå¤§å°ã€å®½é«˜ç›¸å…³çš„ä¸€å®šæ˜¯å›æµ</h3><p>å½“ render tree ä¸­éƒ¨åˆ†æˆ–å…¨éƒ¨å…ƒç´ çš„<strong>å°ºå¯¸ã€ç»“æ„æˆ–è€…æŸäº›å±æ€§</strong>å‘ç”Ÿæ”¹å˜æ—¶ï¼Œ<strong>æµè§ˆå™¨é‡æ–°æ¸²æŸ“éƒ¨åˆ†æˆ–å…¨éƒ¨æ–‡æ¡£çš„è¿‡ç¨‹è¢«ç§°ä¸ºå›æµã€‚</strong></p><p>ä¼šå¯¼è‡´å›æµçš„æ“ä½œï¼š</p><ul><li>é¡µé¢é¦–æ¬¡æ¸²æŸ“</li><li>æµè§ˆå™¨çª—å£å¤§å°æ”¹å˜</li><li>å…ƒç´ å°ºå¯¸æˆ–ä½ç½®æ”¹å˜</li><li>å…ƒç´ å­—ä½“å¤§å°æ”¹å˜</li><li>DOM å…ƒç´ å¢åˆ </li><li>æ¿€æ´» CSS ä¼ªç±»</li></ul><p>ä¸€äº›å¸¸ç”¨ä¸”ä¼šå¯¼è‡´å›æµçš„å±æ€§å’Œæ–¹æ³•ï¼š</p><ul><li>clientWidth clientHeight clientTop clientLeft</li><li>offsetWdith offsetHeight offsetTop offsetLeft</li><li>scrollWidth scrollHeight scrollTop scrollLeft</li><li>getBoundingClientRect</li></ul><h3 id="é‡ç»˜ï¼ˆRepaintï¼‰ç»˜è‰²"><a href="#é‡ç»˜ï¼ˆRepaintï¼‰ç»˜è‰²" class="headerlink" title="é‡ç»˜ï¼ˆRepaintï¼‰ç»˜è‰²"></a>é‡ç»˜ï¼ˆRepaintï¼‰ç»˜è‰²</h3><p>å…ƒç´ çš„ colorã€background color ç­‰å±æ€§å˜åŒ–æ—¶ï¼Œæµè§ˆå™¨ä¼šé‡æ–°ç»˜åˆ¶</p><h3 id="V8-è§£æ-javascript"><a href="#V8-è§£æ-javascript" class="headerlink" title="V8 è§£æ javascript"></a>V8 è§£æ javascript</h3><p>V8 è§£é‡Šå™¨åŸºäº JITï¼ˆJustin Runtimeï¼‰å®ç°</p><p><img src="/img/computer_network/after_type_url/image-20240202191101874.png" alt="image-20240202191101874"></p><h4 id="ä¸ºä»€ä¹ˆä¸æŠŠ-js-ä»£ç ç›´æ¥ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯æœ‰ä¸­é—´çš„å­—èŠ‚ç ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¸æŠŠ-js-ä»£ç ç›´æ¥ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯æœ‰ä¸­é—´çš„å­—èŠ‚ç ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¸æŠŠ js ä»£ç ç›´æ¥ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯æœ‰ä¸­é—´çš„å­—èŠ‚ç ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¸æŠŠ js ä»£ç ç›´æ¥ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯æœ‰ä¸­é—´çš„å­—èŠ‚ç ï¼Ÿ</h4><p>å› ä¸ºæµè§ˆå™¨çš„è¿è¡Œç¯å¢ƒå¯èƒ½ä¸åŒï¼Œæ¯”å¦‚æ“ä½œç³»ç»Ÿã€CPU ç¡¬ä»¶èµ„æºå¯èƒ½ä¸åŒï¼Œä¸ºäº†å®ç°è·¨å¹³å°çš„å…¼å®¹é€šç”¨ï¼ŒJS ä»£ç ç»Ÿä¸€è§£ææˆå­—èŠ‚ç ï¼Œå­—èŠ‚ç çš„è§£é‡Šå™¨å’Œç¼–è¯‘å™¨é€‚é…å„ä¸ªå¹³å°ï¼Œæœ€ç»ˆç¼–è¯‘æˆæœºå™¨ç ï¼Œç”±æµè§ˆå™¨è°ƒåº¦ç¡¬ä»¶èµ„æºæ‰§è¡ŒæŒ‡ä»¤</p>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>browser</category>
      
    </categories>
    
    
    <tags>
      
      <tag>browser</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TCPä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹</title>
    <link href="/2024/01/25/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E4%B8%8E%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/"/>
    <url>/2024/01/25/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E4%B8%8E%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="TCP-åŸºç¡€çŸ¥è¯†"><a href="#TCP-åŸºç¡€çŸ¥è¯†" class="headerlink" title="TCP åŸºç¡€çŸ¥è¯†"></a>TCP åŸºç¡€çŸ¥è¯†</h1><p>TCP æ˜¯<strong>é¢å‘è¿æ¥çš„ã€å¯é çš„ã€åŸºäºå­—èŠ‚æµ</strong>çš„<strong>ä¼ è¾“å±‚é€šä¿¡åè®®</strong>ã€‚</p><p>TCP è¿æ¥æ˜¯ç”¨äºä¿è¯å¯é æ€§å’Œæµé‡æ§åˆ¶ç»´æŠ¤çš„æŸäº›çŠ¶æ€ä¿¡æ¯çš„ç»„åˆï¼ŒåŒ…æ‹¬ Socketã€åºåˆ— å·å’Œçª—å£å¤§å°</p><p>TCP å››å…ƒç»„å¯ä»¥å”¯ä¸€çš„ç¡®å®šä¸€ä¸ªè¿æ¥ï¼šæºåœ°å€ã€æºç«¯å£ã€ç›®çš„åœ°å€ã€ç›®çš„ç«¯å£</p><h1 id="ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥"><a href="#ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥" class="headerlink" title="ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥"></a>ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥</h1><h2 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h2><p>seqï¼ˆsequence numberï¼‰ï¼Œé€šè¿‡ sequence initial algorithm éšæœºç”Ÿæˆçš„<br>ackï¼ˆacknowledgement numberï¼‰ï¼Œç¡®è®¤å· ack&#x3D;seq+1<br>ACKï¼ˆacknowledgementï¼‰ç¡®å®šç¡®è®¤å·æœ‰æ•ˆ<br>SYNï¼ˆsynchronousï¼‰å‘èµ·æ–°è¿æ¥</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><p><img src="/img/computer_network/browser-origin/image-20240202191157031.png" alt="image-20240202191157031"></p><p><img src="/img/computer_network/browser-origin/image-20240202191822606.png" alt="image-20240202191822606"></p><h1 id="å››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥"><a href="#å››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥" class="headerlink" title="å››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥"></a>å››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥</h1><h2 id="æœ¯è¯­-1"><a href="#æœ¯è¯­-1" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h2><p>seqï¼ˆsequence numberï¼‰ï¼Œé€šè¿‡ sequence initial algorithm éšæœºç”Ÿæˆçš„<br>ackï¼ˆacknowledgement numberï¼‰ï¼Œç¡®è®¤å· ack&#x3D;seq+1<br>ACKï¼ˆacknowledgementï¼‰ç¡®å®šç¡®è®¤å·æœ‰æ•ˆ<br>SYNï¼ˆsynchronousï¼‰å‘èµ·æ–°è¿æ¥<br>FINï¼ˆFINISHï¼‰å®Œæˆ</p><h2 id="è¿‡ç¨‹-1"><a href="#è¿‡ç¨‹-1" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><p><img src="/img/computer_network/browser-origin/image-20240202191126170.png" alt="image-20240202191126170"></p><p><img src="/img/computer_network/browser-origin/image-20240202191750514.png" alt="image-20240202191750514"></p><h3 id="ç­‰å¾…é˜¶æ®µ-2"><a href="#ç­‰å¾…é˜¶æ®µ-2" class="headerlink" title="ç­‰å¾…é˜¶æ®µ 2"></a>ç­‰å¾…é˜¶æ®µ 2</h3><p>FIN_WAIT_2 ä¼šå¤„ç†è¿˜æ²¡æœ‰å®Œæˆçš„ä»»åŠ¡ï¼Œç›´åˆ°æ‰€æœ‰çš„ä»»åŠ¡å¤„ç†å®Œæ¯•ï¼Œæ‰ä¼šå‘é€ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹</p><h3 id="è¶…æ—¶ç­‰å¾…çŠ¶æ€æŒç»­-1-ï½-4-åˆ†é’Ÿï¼Œå­˜åœ¨çš„åŸå› ï¼Ÿ"><a href="#è¶…æ—¶ç­‰å¾…çŠ¶æ€æŒç»­-1-ï½-4-åˆ†é’Ÿï¼Œå­˜åœ¨çš„åŸå› ï¼Ÿ" class="headerlink" title="è¶…æ—¶ç­‰å¾…çŠ¶æ€æŒç»­ 1 ï½ 4 åˆ†é’Ÿï¼Œå­˜åœ¨çš„åŸå› ï¼Ÿ"></a>è¶…æ—¶ç­‰å¾…çŠ¶æ€æŒç»­ 1 ï½ 4 åˆ†é’Ÿï¼Œå­˜åœ¨çš„åŸå› ï¼Ÿ</h3><p>è¿™æ˜¯ä¸ºäº†ä¿è¯æœåŠ¡ç«¯æ”¶åˆ° ACK åŒ…ã€‚</p><p>å‡è®¾å¦‚æœæ²¡æœ‰ 2MSL çš„ç­‰å¾…æ—¶é—´ï¼ŒACK åŒ…ä¸¢å¤±äº†ï¼Œé‚£æœåŠ¡ç«¯å°†æ°¸è¿œä¸ä¼šæ–­å¼€è¿æ¥ã€‚</p><p>æœ‰äº† 2MSLï¼Œå¦‚æœä¸€æ—¦å‘ç”Ÿä¸¢åŒ…å°†ä¼šè¿›è¡Œè¶…æ—¶é‡ä¼ ï¼Œå®ç°å¯é è¿æ¥ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>computer network</category>
      
      <category>ç½‘ç»œåè®®</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç½‘ç»œåè®®</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mini-reactå­¦ä¹ æ€»ç»“</title>
    <link href="/2024/01/21/mini-react%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/"/>
    <url>/2024/01/21/mini-react%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬æ–‡æ˜¯æˆ‘å‚ä¸<a href="https://github.com/cuixiaorui">å´”å¤§</a>å‘èµ·çš„â€œmini-react æ¸¸æˆå‰¯æœ¬â€å®Œæ•´è¯¾ç¨‹åçš„æ€è·¯æ€»ç»“ã€æŠ€å·§æ”¶è·æ€»ç»“ä»¥åŠå¿ƒå¾—æ„Ÿæ‚Ÿã€‚</p><p>æ€è·¯æ€»ç»“é‡åœ¨é˜è¿°è§£å†³çš„é—®é¢˜å’Œå®ç°çš„å¤§è‡´æ€è·¯ï¼Œå…·ä½“ä»£ç å’Œè¯¦ç»†çš„å·¥ä½œæµç¨‹è§£é‡Šå¯è§<a href="https://github.com/hugtyftg/mini-react%E3%80%82">https://github.com/hugtyftg/mini-reactã€‚</a></p><p>æŠ€å·§æ”¶è·é‡åœ¨åˆ†äº«ä»¤æˆ‘é†é†çŒé¡¶çš„æ–¹æ³•å’ŒæŠ€å·§ã€‚</p><p>å¿ƒå¾—æ„Ÿæ‚Ÿé‡åœ¨è®°å½•æˆ‘åœ¨æ•´ä¸ªå­¦ä¹ è¿‡ç¨‹ä¸­çš„æ„Ÿå—å’Œè‡ªæˆ‘å®¡è§†ã€‚</p><h1 id="mini-react-å®ç°æ€è·¯æ€»ç»“"><a href="#mini-react-å®ç°æ€è·¯æ€»ç»“" class="headerlink" title="mini-react å®ç°æ€è·¯æ€»ç»“"></a>mini-react å®ç°æ€è·¯æ€»ç»“</h1><h2 id="jsx-åˆ°-vdom-çš„è½¬æ¢"><a href="#jsx-åˆ°-vdom-çš„è½¬æ¢" class="headerlink" title="jsx åˆ° vdom çš„è½¬æ¢"></a>jsx åˆ° vdom çš„è½¬æ¢</h2><p>react ä¸­çš„ jsx è¯­æ³•æœ¬è´¨ä¸Šæ˜¯ createElement çš„è¯­æ³•ç³–ï¼Œåœ¨ vite ä¸­ï¼Œesbuild è‡ªåŠ¨å¯»æ‰¾å½“å‰å¼•å…¥çš„ React æ¨¡å—ä¸­çš„ createElement å‡½æ•°ï¼Œå°† jsx è¯­æ³•ç”¨è¯¥å‡½æ•°è§£æä¸º vdomã€‚</p><p>react å°†é™¤äº†æ ‡ç­¾æœ¬èº«çš„æ‰€æœ‰å†…å®¹éƒ½çœ‹ä½œ propsï¼Œå› æ­¤ï¼Œvdom çš„åŸºæœ¬ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">VirtualDOM</span> &#123;<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;string&#x27;</span>;<br>  <span class="hljs-attr">props</span>: &#123;<br>    <span class="hljs-attr">children</span>: <span class="hljs-title class_">VirtualDOM</span>[] | [];<br>    [<span class="hljs-attr">prop</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>vdom æŒ‰ç…§å†…å®¹å¯ä»¥ç²—æµ…åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç§æ˜¯æ²¡æœ‰å®é™…æ–‡æœ¬å†…å®¹æ ‡ç­¾æ„æˆçš„å…ƒç´ èŠ‚ç‚¹ï¼Œå¦ä¸€ç±»æ˜¯ç°å®æ–‡æœ¬å†…å®¹çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œå› æ­¤ createElement å‡½æ•°è¦å…¼å®¹è¿™ä¸¤ç§æƒ…å†µã€‚</p><h2 id="vdom-æ¸²æŸ“ä¸ºçœŸå®-DOM"><a href="#vdom-æ¸²æŸ“ä¸ºçœŸå®-DOM" class="headerlink" title="vdom æ¸²æŸ“ä¸ºçœŸå® DOM"></a>vdom æ¸²æŸ“ä¸ºçœŸå® DOM</h2><p>æ¸²æŸ“è¿‡ç¨‹å¯ä»¥æŠ½è±¡æˆ 3 ä¸ªæ­¥éª¤</p><ol><li>åˆ›å»º dom</li><li>è®¾ç½® props</li><li>æ·»åŠ  dom</li></ol><p>åœ¨æ¯ä¸€æ­¥å†…å…·ä½“è€ƒè™‘å®ç°ç»†èŠ‚ï¼Œæ¯”å¦‚ dom åˆ›å»ºæ—¶å€™è¦æ ¹æ® vdom çš„ typeï¼Œprops è¦åˆ†æˆ childrenã€style å’Œå‰©ä½™ props è¿™ä¸‰ç§æƒ…å†µå¤„ç†</p><h2 id="å¾®ä»»åŠ¡æ‹†åˆ†è°ƒåº¦"><a href="#å¾®ä»»åŠ¡æ‹†åˆ†è°ƒåº¦" class="headerlink" title="å¾®ä»»åŠ¡æ‹†åˆ†è°ƒåº¦"></a>å¾®ä»»åŠ¡æ‹†åˆ†è°ƒåº¦</h2><p>å¯¹äºæµè§ˆå™¨ä¸­ JS å•çº¿ç¨‹æ‰§è¡Œçš„å·¥ä½œæ–¹å¼è€Œè¨€ï¼Œä¸€æ—¦ DOM æ ‘è¿‡äºå¤æ‚ï¼Œå°±ä¼šå‡ºç°ä¸¥é‡çš„ç•Œé¢æ¸²æŸ“å¡é¡¿ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ¸²æŸ“æ•´æ£µæ ‘è¿™æ ·çš„å®è§‚åºå¤§ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªä»¥æ¸²æŸ“å• DOM ä¸ºç›®æ ‡çš„å¾®ä»»åŠ¡ï¼Œå°†å¾®ä»»åŠ¡å¡åˆ°æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´å†…ä¾æ¬¡æ‰§è¡Œï¼Œå……åˆ†åˆ©ç”¨è®¡ç®—èµ„æºã€‚è¿™å°±æ„å‘³ç€è¦å°†éçº¿å½¢çš„ DOM æ ‘å½¢ç»“æ„è½¬æ¢æˆä¸€ä¸ªçº¿æ€§çš„å¾®ä»»åŠ¡æ‰§è¡Œé˜Ÿåˆ—ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ä¹‹åè¿”å›ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚å› æ­¤é€‰ç”¨é“¾è¡¨ï¼ŒåŸºäºæ¯ä¸ª vdom èŠ‚ç‚¹åˆ›å»ºå¾®ä»»åŠ¡çš„æ‰§è¡Œå•å…ƒâ€”â€”fiberï¼Œé‡‡ç”¨ child -&gt; sibling -uncle è¿™ç§ç±»ä¼¼æ ‘çš„æ·±åº¦ä¼˜å…ˆå‰åºéå†çš„é¡ºåºå°† DOM æ ‘è½¬æ¢æˆä¸€ä¸ª fiber é˜Ÿåˆ—ï¼Œåœ¨æµè§ˆå™¨ç©ºä½™æ—¶é—´å†…ä¸æ–­åœ°æ‰§è¡Œä»»åŠ¡ã€è¿”å›ä¸‹ä¸€ä¸ªä»»åŠ¡ç›´è‡³ç»ˆç»“ã€‚</p><h2 id="ç»Ÿä¸€æäº¤"><a href="#ç»Ÿä¸€æäº¤" class="headerlink" title="ç»Ÿä¸€æäº¤"></a>ç»Ÿä¸€æäº¤</h2><p>æˆ‘ä»¬æ‹†åˆ†å‡ºæ¥çš„å¾®ä»»åŠ¡ä¼šåœ¨æµè§ˆå™¨çš„æ¯ä¸ªç©ºé—²æ—¶é—´ç‰‡å†…æ‰§è¡Œï¼Œä½†å¦‚æœåœ¨ä¸€ä¸ªç©ºé—²æ—¶é—´ç‰‡å†…ï¼Œå½“å‰ä»»åŠ¡æ²¡æœ‰å®Œå…¨å®Œæˆã€dom èŠ‚ç‚¹æ²¡æœ‰å½»åº•åˆ›å»ºå®Œæ¯•çš„æ—¶å€™ï¼Œç©ºé—²æ—¶é—´å°±å·²ç»ä½¿ç”¨æ®†å°½ï¼Œä»»åŠ¡å°±æ­¤ä¸­æ–­ã€‚åªæœ‰è¿‡äº†ä¸€æ®µæ—¶é—´ã€åˆ°äº†ä¸‹ä¸€æ¬¡å‡ºç°ç©ºé—²æ—¶é—´ç‰‡çš„æ—¶å€™ï¼Œæ‰ä¼šå†æ¬¡æ‰§è¡Œä¸Šæ¬¡çš„é—ç•™ä»»åŠ¡ã€‚è¿™æ ·ä¸€æ¥ï¼Œç”¨æˆ·åªä¼šçœ‹åˆ°ç•Œé¢åªå‡ºç°ä¸€éƒ¨åˆ† DOM è€Œä¸æ˜¯å®Œæ•´çš„ DOMï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´åæ‰ä¼šé™†ç»­å‡ºç°å…¶ä»– DOMï¼Œä¹Ÿå°±æ˜¯å‰ç«¯è§†è§‰å¡é¡¿ã€‚</p><p>è¯¥é—®é¢˜çš„æœ¬è´¨æ˜¯æµè§ˆå™¨å†…æ ¸åœ¨æ‰§è¡Œä»»åŠ¡çš„è¿‡ç¨‹ä¸­å…·æœ‰å¼‚æ­¥æ€§ï¼Œä»¥ä¸€ç§ä¸å¯é¢„çŸ¥çš„é€Ÿåº¦æ‰§è¡Œæ¯ä¸€ä¸ªä»»åŠ¡ï¼Œå› æ­¤ç©ºé—²æ—¶é—´çš„å‡ºç°ä»¥åŠå¯¹åº” callback çš„è°ƒç”¨ä¹Ÿæ˜¯ä¸å¯é¢„ä¼°ã€æ—¶æœ‰æ—¶æ— çš„ã€‚å¦‚æœåœ¨è¿™æ ·çš„æ—¶é—´å†…å®‰æ’è§†è§‰å‘ˆç°çš„å·¥ä½œï¼Œéš¾å…ä¼šå‡ºç°æ–­æ–­ç»­ç»­çš„å¡é¡¿æ¸²æŸ“ï¼Œæ­£å¦‚ MDN å®˜æ–¹æ–‡æ¡£å¯¹è¯¥ api çš„æ³¨è§£ä¸€æ ·ï¼š</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Background_Tasks_API#%E5%85%85%E5%88%86%E5%88%A9%E7%94%A8%E7%A9%BA%E9%97%B2%E5%9B%9E%E8%B0%83"><strong>é¿å…åœ¨ç©ºé—²å›è°ƒä¸­æ”¹å˜ DOM</strong>ã€‚ç©ºé—²å›è°ƒæ‰§è¡Œçš„æ—¶å€™ï¼Œå½“å‰å¸§å·²ç»ç»“æŸç»˜åˆ¶äº†ï¼Œæ‰€æœ‰å¸ƒå±€çš„æ›´æ–°å’Œè®¡ç®—ä¹Ÿå·²ç»å®Œæˆã€‚å¦‚æœä½ åšçš„æ”¹å˜å½±å“äº†å¸ƒå±€ï¼Œä½ å¯èƒ½ä¼šå¼ºåˆ¶åœæ­¢æµè§ˆå™¨å¹¶é‡æ–°è®¡ç®—ï¼Œè€Œä»å¦ä¸€æ–¹é¢æ¥çœ‹ï¼Œè¿™æ˜¯ä¸å¿…è¦çš„ã€‚å¦‚æœä½ çš„å›è°ƒéœ€è¦æ”¹å˜ DOMï¼Œå®ƒåº”è¯¥ä½¿ç”¨ Window.requestAnimationFrame() æ¥è°ƒåº¦å®ƒã€‚</a></p><p>å› æ­¤åªéœ€è¦åœ¨è¿™äº›æ—¶é—´ç‰‡å†…è¿›è¡Œè®¡ç®—å·¥ä½œï¼Œåœ¨é“¾è¡¨è®¡ç®—å¤„ç†ç»“æŸçš„æ—¶å€™ç»Ÿä¸€æäº¤ã€æ‰§è¡ŒçœŸå® dom çš„æŒ‚è½½å³å¯ã€‚</p><h2 id="å‡½æ•°ç»„ä»¶çš„è§£æå’Œå¤„ç†"><a href="#å‡½æ•°ç»„ä»¶çš„è§£æå’Œå¤„ç†" class="headerlink" title="å‡½æ•°ç»„ä»¶çš„è§£æå’Œå¤„ç†"></a>å‡½æ•°ç»„ä»¶çš„è§£æå’Œå¤„ç†</h2><p>å‡½æ•°ç»„ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œå‡½æ•°ç»„ä»¶çš„è¿‡ç¨‹å°±æ˜¯æ‰§è¡Œè¯¥å‡½æ•°çš„è¿‡ç¨‹ã€‚å‡½æ•°ç»„ä»¶æ²¡æœ‰å…·ä½“æ„ä¹‰ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªéœ€è¦â€œæ‰“å¼€çš„ç›’å­â€ï¼Œåªæœ‰è¿è¡Œå‡½æ•°ã€æ‰“å¼€ç›’å­ä¹‹åï¼Œæˆ‘ä»¬æ‰èƒ½å¾—åˆ°æƒ³è¦çš„ dom å…ƒç´ ï¼Œæ‰€ä»¥å¯¹äºæ²¡æœ‰ç›’å­åŒ…è£¹çš„æ™®é€šç»„ä»¶å’Œæœ‰ç›’å­åŒ…è£¹çš„å‡½æ•°ç»„ä»¶åœ¨å¤„ç†æ—¶å¹¶ä¸ç›¸åŒï¼š</p><p>å‰è€…åœ¨æ²¡æœ‰ dom æ—¶å€™å¯ä»¥åˆ›å»º domã€è®¾ç½®é props çš„å±æ€§ã€å¯¹ children é€’å½’å¤„ç†ï¼Œè€Œåè€…å› ä¸ºè‡ªèº«æ— å®æ„ï¼Œåªèƒ½é€’å½’å¤„ç† childrenï¼Œå¹¶ä¸”éœ€è¦é€šè¿‡<code>[fiber.type(props)]</code>æ‰èƒ½å¾—åˆ° children æ•°ç»„ã€‚</p><p>FC fiber æ²¡æœ‰åˆ›å»º dom è¿™ä¸€ç‚¹ä¸º fiber ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ç»Ÿä¸€æäº¤æ—¶æŒ‚è½½ DOM çš„é€»è¾‘åŸ‹ä¸‹éšæ‚£ï¼š</p><ol><li>æ²¡æœ‰ dom æ— æ³•æŒ‚è½½</li><li>æ²¡æœ‰ domï¼Œä¸èƒ½ä½œä¸º parent è¢«å…¶ä»– dom æŒ‚è½½</li></ol><p>å¤„ç†æ–¹å¼ä¸ºï¼š</p><ol><li>æœ‰ dom çš„ fiber æ‰ä¼šæŒ‚è½½åˆ° parent.dom ä¸Š</li><li>parent.dom ä¸ºç©ºæ—¶ä¸€ç›´å‘ä¸Šå¯»æ‰¾ï¼Œç›´åˆ°æœ‰ dom ä¸ºæ­¢</li></ol><h2 id="æ›´æ–°-props"><a href="#æ›´æ–°-props" class="headerlink" title="æ›´æ–° props"></a>æ›´æ–° props</h2><p>æ›´æ–° props æ„å‘³ç€åˆ›å»ºä¸€æ£µæ–°çš„ vdom æ ‘ï¼Œå°†æ–°æ—§èŠ‚ç‚¹ä¸€ä¸€å¯¹æ¯”ï¼Œå†å¤„ç†æ–°æ—§ä¸åŒçš„æƒ…å†µï¼ˆä»…ä»…è€ƒè™‘ dom æ ‘çš„å±æ€§å˜åŒ–ï¼‰ã€‚</p><h3 id="å¦‚ä½•åœ¨ä¸å†æ¬¡ä¼ å…¥-el-å’Œ-container-çš„å‰æä¸‹é‡å»º-vdom-æ ‘å‘¢ï¼Ÿ"><a href="#å¦‚ä½•åœ¨ä¸å†æ¬¡ä¼ å…¥-el-å’Œ-container-çš„å‰æä¸‹é‡å»º-vdom-æ ‘å‘¢ï¼Ÿ" class="headerlink" title="å¦‚ä½•åœ¨ä¸å†æ¬¡ä¼ å…¥ el å’Œ container çš„å‰æä¸‹é‡å»º vdom æ ‘å‘¢ï¼Ÿ"></a>å¦‚ä½•åœ¨ä¸å†æ¬¡ä¼ å…¥ el å’Œ container çš„å‰æä¸‹é‡å»º vdom æ ‘å‘¢ï¼Ÿ</h3><p>æ˜¾è€Œæ˜“è§ï¼Œåœ¨ render çš„ç»Ÿä¸€æäº¤é˜¶æ®µç»“æŸä¹‹åä¿å­˜ root å³å¯ã€‚</p><h3 id="å¦‚ä½•å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹ï¼Ÿ"><a href="#å¦‚ä½•å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹ï¼Ÿ" class="headerlink" title="å¦‚ä½•å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹ï¼Ÿ"></a>å¦‚ä½•å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹ï¼Ÿ</h3><p>ä¹‹å‰ä¿å­˜çš„ root å®é™…ä¸Šä¹Ÿæ˜¯æ—§ DOM çš„ rootï¼Œå› æ­¤åœ¨æ„å»ºæ–° vdom æ ‘ã€æ„å»ºæ–° fiber å¾®ä»»åŠ¡é˜Ÿåˆ—çš„æ—¶å€™ï¼ŒåŒæ ·é€’å½’éå†æ—§çš„ vdom æ ‘ã€æ—§çš„ fiber ä»»åŠ¡é˜Ÿåˆ—ï¼Œé€šè¿‡ alternate æŒ‡é’ˆå°†æ–°æ—§èŠ‚ç‚¹è”ç³»èµ·æ¥å³å¯ï¼ˆè¿™é‡Œè€ƒè™‘çš„æ–°æ—§ vdom æ ‘æ²¡æœ‰èŠ‚ç‚¹çš„å˜åŒ–ï¼Œä»…ä»…æ˜¯å±æ€§çš„å˜åŒ–ï¼‰ã€‚</p><p>å¹¶ä¸”å¯ä»¥åœ¨é€’å½’å¤„ç† children çš„æ—¶å€™ï¼Œæ ¹æ® fiber.alternate.child æ˜¯å¦ä¸ºç©ºåˆ¤æ–­å½“å‰æ˜¯åˆå§‹åŒ–æ¸²æŸ“é˜¶æ®µè¿˜æ˜¯æ›´æ–°é˜¶æ®µï¼Œå¹¶åˆ†åˆ«ç»™åˆ›å»ºå‡ºæ¥çš„ fiber æ·»åŠ  placement æˆ– update çš„ effectTag æ ‡è®°ï¼Œæ–¹ä¾¿ diff props å¤„ç†ã€‚</p><p><img src="/img/react/mini-react/09-alternate-vdom-tree.png" alt="Alt text"></p><p><img src="/img/react/mini-react/09-alternate-linkedlist.png" alt="Alt text"></p><h3 id="diff-props"><a href="#diff-props" class="headerlink" title="diff props"></a>diff props</h3><p>åœ¨è¾¹åˆ›å»ºæ–° fiber è¾¹æ„å»º alternate çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹æ¯” props ä¼šå‡ºç°ä¸‰ç§æƒ…å†µï¼š</p><ol><li>old æœ‰ new æ²¡æœ‰ åˆ é™¤</li><li>new æœ‰ old æ²¡æœ‰ æ·»åŠ </li><li>new æœ‰ old æœ‰ å€¼ä¸åŒ æ›´æ–°</li></ol><p>åä¸¤ç§æƒ…å†µå¯ä»¥ä½•å¿…ä¸ºä¸€ç§ï¼šnew æœ‰ old æœ‰ï¼Œå€¼ä¸åŒï¼Œæ›´æ–°ï¼ˆold æ²¡æœ‰æ”¹ prop çš„è¯ï¼Œå–å€¼ç»“æœæ˜¯ undefinedï¼‰ã€‚è¿™ä¸‰ç§æƒ…å†µé€šè¿‡åˆ†åˆ«éå†ä¸€æ¬¡æ–°æ—§ props å³å¯å®Œæˆ</p><p>åœ¨ç»Ÿä¸€æäº¤é˜¶æ®µå·²ç»æ‰§è¡Œäº† dom çš„æŒ‚è½½ï¼ŒåŒç†ï¼Œdiff props ä¹Ÿåº”è¯¥åœ¨ commit é˜¶æ®µæ‰§è¡Œã€‚æ ¹æ® fiber.effectTagï¼Œå¦‚æœ placement åˆ™è¯´æ˜æ˜¯åˆå§‹åŒ–æ¸²æŸ“é˜¶æ®µï¼Œåº”è¯¥æ‰§è¡ŒæŒ‚è½½ dom çš„ä»»åŠ¡ï¼›å¦‚æœæ˜¯ update è¯´æ˜æ˜¯æ›´æ–°é˜¶æ®µï¼Œæ›´æ–° props å³å¯ã€‚</p><h2 id="æ€§èƒ½ä¼˜åŒ–â€”â€”æ›´æ–°-props-åº”è¯¥â€œæŒ‡å“ªæ‰“å“ªâ€è€Œéâ€œä»å¤´å†æ¥â€"><a href="#æ€§èƒ½ä¼˜åŒ–â€”â€”æ›´æ–°-props-åº”è¯¥â€œæŒ‡å“ªæ‰“å“ªâ€è€Œéâ€œä»å¤´å†æ¥â€" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–â€”â€”æ›´æ–° props åº”è¯¥â€œæŒ‡å“ªæ‰“å“ªâ€è€Œéâ€œä»å¤´å†æ¥â€"></a>æ€§èƒ½ä¼˜åŒ–â€”â€”æ›´æ–° props åº”è¯¥â€œæŒ‡å“ªæ‰“å“ªâ€è€Œéâ€œä»å¤´å†æ¥â€</h2><p>å½“å‰çš„æ›´æ–°é€»è¾‘æ˜¯æ ¹æ®ä¿å­˜çš„ root å†é‡æ–°åˆ›å»ºä¸€æ¬¡æ ‘ï¼Œä½†æ˜¯å°±ç®—æŸä¸€ä¸ªå­ç»„ä»¶æ²¡æœ‰æ›´æ–°ï¼ˆæ²¡æœ‰ä½¿ç”¨å…¶ä»–ç»„ä»¶ä¼ æ¥çš„ã€ä¼šå‘ç”Ÿå˜åŒ–çš„ propï¼Œå¹¶ä¸”è‡ªèº«ç¡®å®ä¹Ÿæ²¡æœ‰æ›´æ–°ï¼‰ï¼Œå¯¹åº”çš„å­æ ‘è¿˜æ˜¯ä¼šé‡æ–°åˆ›å»ºã€‚æœ€ç»ˆæŸä¸ªå­ç»„ä»¶çš„æ›´æ–°å¼•èµ·äº†æ•´ä¸ª app çš„é‡æ–°æ‰§è¡Œï¼Œé€ æˆå·¨å¤§çš„è®¡ç®—èµ„æºæµªè´¹ã€‚</p><p>å› æ­¤åœ¨æ›´æ–°æ—¶åº”è¯¥é‡æ–°æ„å»ºçš„ä»…ä»…æ˜¯å‘ç”Ÿå˜åŒ–çš„å‡½æ•°ç»„ä»¶æ‰€å¯¹åº”çš„å­æ ‘ï¼Œ<strong>èµ·ç‚¹ä¸º FC fiberï¼Œç»ˆç‚¹ä¸º FC çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ FC fiber çš„ sibling</strong>ã€‚</p><h3 id="èµ·ç‚¹æ˜¯é€šè¿‡é—­åŒ…ä¿å­˜çš„-FC-fiber"><a href="#èµ·ç‚¹æ˜¯é€šè¿‡é—­åŒ…ä¿å­˜çš„-FC-fiber" class="headerlink" title="èµ·ç‚¹æ˜¯é€šè¿‡é—­åŒ…ä¿å­˜çš„ FC fiber"></a>èµ·ç‚¹æ˜¯é€šè¿‡é—­åŒ…ä¿å­˜çš„ FC fiber</h3><p>æ­£æ˜¯ç”±äºå‡½æ•°ç»„ä»¶å…·æœ‰éœ€è¦æ‰§è¡Œçš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ›´æ–°çš„ç²’åº¦ç¼©å°åˆ°æ¯ä¸ª FCï¼Œåœ¨ fiber å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œåˆ°å½“å‰ FC æ‰€åœ¨çš„ fiber æ—¶ï¼ˆè¿›å…¥ handleFunctionComponent æ—¶ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨é—­åŒ…è·å–å½“å‰ç»„ä»¶çš„ fiberï¼Œä»¥ä¾¿ä½œä¸ºä¸‹ä¸€æ¬¡ä½¿ç”¨ï¼ˆä¹Ÿå°±æ˜¯æ›´æ–°æ—¶ï¼‰çš„èµ·ç‚¹ã€‚</p><h3 id="ç»“æŸç‚¹æ— ç–‘æ˜¯æ›´æ–°èµ·ç‚¹-FC-fiber-sibling"><a href="#ç»“æŸç‚¹æ— ç–‘æ˜¯æ›´æ–°èµ·ç‚¹-FC-fiber-sibling" class="headerlink" title="ç»“æŸç‚¹æ— ç–‘æ˜¯æ›´æ–°èµ·ç‚¹ FC fiber.sibling"></a>ç»“æŸç‚¹æ— ç–‘æ˜¯æ›´æ–°èµ·ç‚¹ FC fiber.sibling</h3><p>åœ¨å…„å¼Ÿå­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„ fiber å°±æ˜¯å…„å¼Ÿï¼Œé‚£ä¹ˆåº”è¯¥ç«‹å³åœæ­¢æ›´æ–°ï¼Œå°† nextWorkOfUnit è®¾ç½®ä¸º undefined å³å¯ç»ˆæ­¢ï¼›å¦‚æœå…„å¼Ÿä¸å­˜åœ¨ï¼ŒnextWorkOfUnit ä¹Ÿä¼šæ˜¯ undefinedï¼Œä¹Ÿä¼šç»ˆæ­¢ã€‚</p><h2 id="æ›´æ–°-children"><a href="#æ›´æ–°-children" class="headerlink" title="æ›´æ–° children"></a>æ›´æ–° children</h2><p>ä¸Šé¢çš„æ›´æ–°åªè€ƒè™‘äº†æ–°æ—§ dom æ ‘æ²¡æœ‰ dom å¢åˆ å˜åŒ–ã€åªæœ‰é™¤ children å¤–çš„ props çš„å˜åŒ–çš„æƒ…å†µï¼Œæ¶‰åŠåˆ° children çš„å˜åŒ–å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ol><li>children èŠ‚ç‚¹æ€»æ•°æ²¡æœ‰å˜åŒ–ï¼Œæ–°æ—§ fiber é˜Ÿåˆ—ç­‰é•¿ï¼ˆæ¯”å¦‚å°‘äº†ä¸€ä¸ª divï¼Œå¤šäº†ä¸€ä¸ª pï¼‰</li><li>children èŠ‚ç‚¹æ€»æ•°å‘ç”Ÿå˜åŒ–ï¼Œæ–°æ—§ fiber é˜Ÿåˆ—ä¸ç­‰é•¿ï¼ˆæœ€å¸¸è§ï¼‰</li></ol><h3 id="æ–°æ—§-fiber-é˜Ÿåˆ—ç­‰é•¿åº¦"><a href="#æ–°æ—§-fiber-é˜Ÿåˆ—ç­‰é•¿åº¦" class="headerlink" title="æ–°æ—§ fiber é˜Ÿåˆ—ç­‰é•¿åº¦"></a>æ–°æ—§ fiber é˜Ÿåˆ—ç­‰é•¿åº¦</h3><p><img src="/img/react/mini-react/equal-length-children.png" alt="Alt text"></p><p>æŒ‰ç…§åŸå…ˆçš„é€»è¾‘ï¼Œå¦‚æœç›‘æµ‹åˆ°æ–°æ—§èŠ‚ç‚¹ type ä¸åŒçš„æ—¶å€™ï¼Œè®¤ä¸ºå½“å‰å¤„åœ¨åˆå§‹æ›´æ–°é˜¶æ®µï¼Œå› æ­¤æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œè€Œæ²¡æœ‰åˆ é™¤æ—§èŠ‚ç‚¹ã€‚è¿™æ ·æ½¦è‰çš„åˆ¤æ–­åœ¨å“ªé‡Œè‡ªç›¸çŸ›ç›¾å‘¢ï¼Ÿ</p><p>å¯¹äº†ï¼Œå¦‚æœçœŸçš„è®¤ä¸ºæ˜¯åˆå§‹åŒ–æ›´æ–°ï¼ŒoldFiberChild å°±åº”è¯¥ä¸ºç©ºå€¼ï¼Œä½†æ˜¯æ˜¾ç„¶å¹¶ä¸ä¸ºç©ºå€¼ã€‚æ‰€ä»¥å¯ä»¥åœ¨æ–°æ—§èŠ‚ç‚¹ä¸åŒå†…å†æ ¹æ® oldFiberChild æ˜¯å¦ä¸ºç©ºï¼Œåˆ¤æ–­å½“å‰æ˜¯çœŸçš„ placementï¼Œè¿˜æ˜¯æœ‰ dom å˜åŒ–çš„ updateã€‚å¯¹äºå‰è€…ï¼Œç°åœ¨çš„ç»Ÿä¸€æäº¤å¤„ç†å·²ç»è¶³å¤Ÿäº†ï¼Œå¯¹äºåè€…ï¼Œç»Ÿä¸€æäº¤å‰è¿˜éœ€è¦åˆ é™¤æ—§èŠ‚ç‚¹ã€‚</p><p>è¿™ä¸ªåŠŸèƒ½çš„å®ç°è¿‡ç¨‹æ˜¯èºæ—‹ä¸Šå‡çš„ï¼Œå…·ä½“å¯è§<a href="#å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹ä¸€æŒ‰å›¾ç´¢éª¥å®ç°åŸºç¡€åŠŸèƒ½">å¼€å‘ä¸‰é©¾é©¬è½¦</a>ä¸­çš„å™è¿°</p><h3 id="æ–°æ—§-fiber-é˜Ÿåˆ—ä¸ç­‰é•¿åº¦"><a href="#æ–°æ—§-fiber-é˜Ÿåˆ—ä¸ç­‰é•¿åº¦" class="headerlink" title="æ–°æ—§ fiber é˜Ÿåˆ—ä¸ç­‰é•¿åº¦"></a>æ–°æ—§ fiber é˜Ÿåˆ—ä¸ç­‰é•¿åº¦</h3><p><img src="/img/react/mini-react/unequal-children.png" alt="Alt text"></p><p><img src="/img/react/mini-react/unequal-length-linked-list.png" alt="Alt text"></p><p>forEach éå†æ–° vdom æ ‘çš„æ—¶å€™ oldFiberChild ä¹Ÿä¼šæ›´æ–°ï¼ˆé‡æ–°æŒ‡å‘ oldFiberChild.siblingï¼‰</p><p>å¦‚æœæ–°æ—§å­æ ‘ç›¸åŒï¼ŒforEach ç»“æŸæ—¶ï¼ŒoldFiberChild.sibling ä¸º undefinedï¼ŒoldFiberChild è¢«æ›´æ”¹ä¸º undefinedã€‚</p><p>ä½†æ˜¯å¦‚æœ oldFiberChild ä»ä¸ä¸º undefinedï¼Œè¯´æ˜æ–°æ—§å­æ ‘å¹¶ä¸ç›¸åŒï¼Œå¤šä½™çš„å­æ ‘éœ€è¦åœ¨ç»Ÿä¸€æäº¤é˜¶æ®µè¢«åˆ é™¤ã€‚</p><h2 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h2><h3 id="åŸºæœ¬å®ç°"><a href="#åŸºæœ¬å®ç°" class="headerlink" title="åŸºæœ¬å®ç°"></a>åŸºæœ¬å®ç°</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initial</span>) &#123;<br>  <span class="hljs-comment">// state</span><br>  <span class="hljs-keyword">let</span> stateHook = &#123;<br>    <span class="hljs-attr">state</span>: initial,<br>  &#125;;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setState</span>(<span class="hljs-params">action</span>) &#123;<br>    <span class="hljs-comment">// ä¿®æ”¹state</span><br>    stateHook.<span class="hljs-property">state</span> = <span class="hljs-title function_">action</span>(stateHook.<span class="hljs-property">state</span>);<br>    <span class="hljs-comment">// ç»™wipRooté‡æ–°èµ‹å€¼ï¼Œæ¨åŠ¨requestIdleCallback(workLoop)é‡æ–°ç”Ÿæˆä¸€æ£µDOMæ ‘ï¼Œä»è€Œæ›´æ–°è§†å›¾</span><br>    <span class="hljs-comment">// currentFiberä¸ºå¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œåˆ°è¿™ä¸ªFC fiberæ—¶é€šè¿‡wipFiberè·å–åˆ°çš„é—­åŒ…</span><br>    wipRoot = &#123;<br>      ...currentFiber,<br>      <span class="hljs-attr">alternate</span>: currentFiber,<br>    &#125;;<br>    nextWorkOfUnit = wipRoot;<br>  &#125;<br>  <span class="hljs-keyword">return</span> [stateHook.<span class="hljs-property">state</span>, setState];<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å®ç°-action-ä¸ºå‡½æ•°çš„-useState"><a href="#å®ç°-action-ä¸ºå‡½æ•°çš„-useState" class="headerlink" title="å®ç° action ä¸ºå‡½æ•°çš„ useState"></a>å®ç° action ä¸ºå‡½æ•°çš„ useState</h3><p>ä½†æ˜¯è¿™æ ·åšæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨åˆå§‹æ¸²æŸ“çš„æ—¶å€™è°ƒç”¨äº†ä¸€æ¬¡ useStateï¼Œæ­¤æ—¶çš„ stateHook å€¼æ˜¯ initialï¼ŒsetState é€šè¿‡é—­åŒ…æ‹¿åˆ°çš„ state ä¹Ÿæ˜¯ initialã€‚</p><p>åœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨ setStateã€requestIdleCallback å¼€å§‹å·¥ä½œã€æ›´æ–°è§†å›¾çš„æ—¶å€™ï¼Œä¼šå†æ¬¡æ‰§è¡Œå½“å‰çš„ FC ç»„ä»¶ï¼Œåœ¨å†æ¬¡è°ƒç”¨ useStateï¼Œä½†æ˜¯ state çš„å€¼è¿˜æ˜¯ initialï¼Œå› æ­¤è§†å›¾æ— æ³•æ›´æ–°ã€‚</p><p>å¦‚æœæƒ³è¦è§†å›¾æ›´æ–°ï¼Œéœ€è¦è·å–åˆ°å½“å‰ FC çš„ fiber åœ¨ä¸Šä¸€ä¸ªæ—¶é—´ç‰‡ä¸­çš„ state å€¼ï¼Œæ®æ­¤æ›´æ–°è§†å›¾</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initial</span>) &#123;<br>  <span class="hljs-comment">// ä½¿ç”¨é—­åŒ…æš‚æ—¶å­˜å‚¨è¿™ä¸ªuseStateæ‰€åœ¨çš„FCçš„fiber</span><br>  <span class="hljs-keyword">let</span> currentFiber = wipFiber;<br>  <span class="hljs-comment">// é€šè¿‡alternateæŒ‡é’ˆå°†ä¸¤ä¸ªé—­åŒ…é‡Œé¢çš„fiberè”ç³»èµ·æ¥ã€‚</span><br>  <span class="hljs-keyword">let</span> oldFiberHook = currentFiber.<span class="hljs-property">alternate</span>?.<span class="hljs-property">stateHook</span>;<br>  <span class="hljs-keyword">const</span> stateHook = &#123;<br>    <span class="hljs-attr">state</span>: oldFiberHook ? oldFiberHook.<span class="hljs-property">state</span> : initial,<br>  &#125;;<br>  currentFiber.<span class="hljs-property">stateHook</span> = stateHook;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setState</span>(<span class="hljs-params">action</span>) &#123;<br>    <span class="hljs-comment">// ç»™wipRootèµ‹å€¼ï¼Œå¼€å¯åˆ›å»ºæ–°fiberçš„æµç¨‹</span><br>    stateHook.<span class="hljs-property">state</span> = <span class="hljs-title function_">action</span>(stateHook.<span class="hljs-property">state</span>);<br>    wipRoot = &#123;<br>      ...currentFiber,<br>      <span class="hljs-attr">alternate</span>: currentFiber,<br>    &#125;;<br>    nextWorkOfUnit = wipRoot;<br>  &#125;<br>  <span class="hljs-keyword">return</span> [stateHook.<span class="hljs-property">state</span>, setState];<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºåˆå§‹åŒ–é˜¶æ®µï¼Œå½“ work æ‰§è¡Œåˆ° FC å¯¹åº”çš„ fiber çš„æ—¶å€™ï¼Œæ‰§è¡Œ fiber.type(fiber.props)ï¼Œä¹Ÿå°±æ˜¯è‡ªä¸Šè€Œä¸‹åœ°æ‰§è¡Œäº†è¿™ä¸ª FC å¯¹åº”çš„å‡½æ•°ã€‚useState ç¬¬ä¸€æ¬¡è¢«æ‰§è¡Œï¼Œæ­¤æ—¶æ‰€æœ‰ fiber éƒ½æ²¡æœ‰ alternateï¼Œå› æ­¤ oldFiberHook ä¸º undefinedï¼ŒstateHook èµ‹å€¼çš„æ—¶å€™é‡‡ç”¨åˆå§‹å€¼ï¼Œå½“å‰ FC æ‰€å¯¹åº”çš„è€çš„ fiber æ·»åŠ äº† stateHook å±æ€§ï¼Œæ­¤æ—¶çš„é—­åŒ…ï¼ˆå‡½æ•°æ‰§è¡ŒæœŸä¸Šä¸‹æ–‡ï¼‰è®°ä½œ EC1ï¼Œäº§ç”Ÿçš„ setState å¼•ç”¨çš„å˜é‡ä¹Ÿæ˜¯åœ¨ EC1 å†…</p><p>åœ¨æŸä¸ªæ—¶åˆ»è°ƒç”¨ setState ä¹‹åï¼ŒEC1 é—­åŒ…ä¸­çš„ state å€¼è¢«æ›´æ–°ï¼ŒwipRoot è¢«èµ‹å€¼ï¼ŒworkLoop è‡ªåŠ¨å¼€å§‹æ‰§è¡Œã€‚å½“å†æ¬¡æ‰§è¡Œåˆ°è¿™ä¸ª FC æ—¶ï¼Œé€šè¿‡ fiber.type(fiber.props)åˆè¿è¡Œäº†ä¸€æ¬¡ useStateï¼Œè¿™ä¸ªæ—¶å€™åˆ›å»ºå‡ºæ¥äº† EC2ï¼Œstate é€šè¿‡ alternate è¢«æ›´æ–°ä¸º FC fiber çš„ EC1 ä¸­çš„å€¼ï¼Œä¹Ÿå°±æ˜¯åˆšåˆšè§¦å‘çš„ action çš„å¯¹ state çš„æ›´æ–°ç»“æœï¼Œå¹¶å°† EC2 ä¸­çš„ state è¿”å›ç»™ FCï¼ŒFC ä¸­ jsx å¼•ç”¨çš„ state ä¹Ÿæ›´æ–°ä¸º EC2 ä¸­çš„å€¼ã€‚</p><p>EC2 è¿”å›çš„ setState å‡½æ•°ç­‰å¾…ä¸‹ä¸€æ¬¡è°ƒç”¨å®ƒçš„æ—¶åˆ»ï¼Œé‡å¤ç€ä¿®æ”¹ EC2 state -&gt; é‡æ–°æ„å»º fiber é“¾è¡¨ -&gt; å¤„ç† FC -&gt; fiber.type(fiber.props) -&gt; æ‰§è¡Œ useState -&gt; è¿”å› EC3 çš„ set -&gt; â€¦ å¾ªç¯å¾€å¤</p><h3 id="ä¸€ä¸ª-FC-å­˜å‚¨å¤šä¸ª-state"><a href="#ä¸€ä¸ª-FC-å­˜å‚¨å¤šä¸ª-state" class="headerlink" title="ä¸€ä¸ª FC å­˜å‚¨å¤šä¸ª state"></a>ä¸€ä¸ª FC å­˜å‚¨å¤šä¸ª state</h3><p>å¦‚æœåªæ˜¯ç”¨ä¸€ä¸ªå˜é‡ä¿å­˜çš„è¯ï¼Œå‰é¢çš„ state ä¼šè¢«åé¢çš„ state è¦†ç›–ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨æ•°ç»„å­˜å‚¨ä¸€ä¸ª FC å†…çš„æ‰€æœ‰ stateã€‚ç”±äºä¸€ä¸ªåº”ç”¨é‡Œé¢æœ‰å¾ˆå¤šä¸ª FCï¼Œæ¯ä¸ª FC æœ‰å¾ˆå¤šä¸ª stateï¼Œç¬¬ä¸€ååº”æ˜¯ç›´æ¥åœ¨å…¨å±€ä½¿ç”¨ä¸€ä¸ªäºŒç»´æ•°ç»„ä¿å­˜æ¯ä¸ª n FC * m stateï¼Œä½†æ˜¯ï¼Œæ¯ä¸ª FC æƒ³çŸ¥é“çš„ä»…ä»…æ˜¯å®ƒè‡ªèº«åœ¨ä¹‹å‰çš„ stateï¼Œè€Œä¸å…³å¿ƒå…¶ä»– FCï¼Œå¹¶ä¸”æˆ‘ä»¬å·²ç»é€šè¿‡äº†ä¸Šé¢çš„æœºåˆ¶æ‹¿åˆ°äº†æ¯ä¸ª FC å¯¹åº”çš„é—­åŒ…ï¼Œæ‰€ä»¥ä½¿ç”¨åºå¤§çš„äºŒç»´è¡¨æ˜¯å®Œå…¨æ²¡æœ‰å¿…è¦çš„ï¼Œåº”è¯¥åœ¨å…¨å±€å£°æ˜ stateHooks å’Œ stateHookIndex ä¸¤ä¸ªå˜é‡ï¼Œåœ¨æ¯ä¸ª FC å¯¹åº”çš„ fiber é—­åŒ…ä¸­åˆå§‹åŒ–èµ‹å€¼ä¸º[]å’Œ 0</p><h3 id="æ‰¹å¤„ç†æ›´æ–°"><a href="#æ‰¹å¤„ç†æ›´æ–°" class="headerlink" title="æ‰¹å¤„ç†æ›´æ–°"></a>æ‰¹å¤„ç†æ›´æ–°</h3><p>ä¸Šé¢çš„é€»è¾‘å…¶å®æœ‰ä¸€ä¸ªå¾ˆæ€ªçš„ç‚¹â€”â€”setState çš„æ—¶å€™ï¼Œæ‹¿åˆ°äº†è€ EC é—­åŒ…ä¸­çš„å€¼ï¼Œç›´æ¥åŒæ­¥æ›´æ–°è€çš„å€¼ï¼Œç„¶åå¼€å§‹é‡æ–°æ„å»º DOM æ ‘å’Œ fiber é“¾è¡¨ï¼Œå†æ¬¡è¿›å…¥ FC å‡½æ•°ï¼Œåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ FC äº§ç”Ÿçš„é—­åŒ…é‡Œé¢å†æ¬¡æ‰§è¡Œ useState çš„æ—¶å€™ï¼Œä»è€ EC é‡Œé¢æ‹¿æ–°å€¼ï¼Œè¿™æ ·éå¸¸ä¸åˆç†ï¼Œä¸ºä»€ä¹ˆä¸èƒ½åœ¨æ–° EC é‡Œé¢é€šè¿‡è€ EC çš„æ—§å€¼ç®—å‡ºæ–°å€¼å‘¢ï¼Œå¹¶ä¸”è¿™æ ·çš„åŒæ­¥ä¿®æ”¹æ–¹å¼åœ¨å¤§é‡ setState çš„æ—¶å€™ï¼Œæ˜æ˜åªéœ€è¦æœ€ç»ˆæ›´æ–°ä¸€æ¬¡è§†å›¾ï¼Œå´å› ä¸ºä¸­é—´äº§ç”Ÿäº†è‹¥å¹²ä¸­é—´å€¼è€Œè¿›è¡Œäº†å¤šæ¬¡ä¸å¿…è¦çš„æ›´æ–°ã€‚</p><p>è§£å†³æ–¹æ³•ï¼šä¸åŒæ­¥æ›´æ–°ï¼Œå°†æ‰€æœ‰ action æ”¶é›†èµ·æ¥æ”¾åˆ° updaterQueue é‡Œé¢ï¼Œåœ¨è°ƒç”¨ setState åå†æ¬¡è¿›å…¥ FC çš„ useState é—­åŒ…æ—¶æ‰¹é‡è°ƒç”¨ï¼Œè°ƒç”¨å®Œæˆä¹‹åæ‰æ›´æ–°è§†å›¾ã€‚è§†å›¾åªæ›´æ–°ä¸€æ¬¡ï¼Œæé«˜æ›´æ–°æ•ˆç‡</p><h2 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h2><h3 id="å®ç°åŸºæœ¬çš„-init-ä¹‹åè°ƒç”¨-effect"><a href="#å®ç°åŸºæœ¬çš„-init-ä¹‹åè°ƒç”¨-effect" class="headerlink" title="å®ç°åŸºæœ¬çš„ init ä¹‹åè°ƒç”¨ effect"></a>å®ç°åŸºæœ¬çš„ init ä¹‹åè°ƒç”¨ effect</h3><p>useEffect è°ƒç”¨æ—¶æœºæ˜¯ React æ¸²æŸ“çœŸå® DOM ä¹‹åï¼Œå¹¶ä¸”æµè§ˆå™¨å®Œæˆé‡æ–°ç»˜åˆ¶ä¹‹å‰</p><p>å’Œ useState ç±»ä¼¼ï¼Œç»™æ¯ä¸ª wipFiber æŒ‚è½½ effectHookï¼Œç”¨ä»¥ä¿å­˜å‰¯ä½œç”¨</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useEffect</span>(<span class="hljs-params">callback, deps</span>) &#123;<br>  <span class="hljs-keyword">let</span> effectHook = &#123;<br>    callback,<br>    deps,<br>  &#125;;<br>  wipFiber.<span class="hljs-property">effectHook</span> = effectHook;<br>&#125;<br></code></pre></td></tr></table></figure><p>react æ¸²æŸ“å®Œæ¯•çœŸå® DOM çš„æ—¶æœºï¼Œå³ commitRoot ç»Ÿä¸€æäº¤ä¸­ commitWork æ‰§è¡Œå®Œæ¯•çš„æ—¶å€™ï¼Œé€’å½’éå†æ‰€æœ‰ fiberï¼Œè°ƒç”¨ç»‘å®šåœ¨å®ƒä»¬èº«ä¸Šçš„å‰¯ä½œç”¨æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params"></span>) &#123;<br>  deletions.<span class="hljs-title function_">forEach</span>(commitDeletion);<br>  <span class="hljs-title function_">commitWork</span>(wipRoot.<span class="hljs-property">child</span>);<br>  <span class="hljs-comment">// ç»Ÿä¸€æäº¤ä¹‹åå¼€å¯å‰¯ä½œç”¨</span><br>  <span class="hljs-title function_">commitEffect</span>();<br>  currentRoot = wipRoot;<br>  <span class="hljs-comment">// é‡ç½®å½“å‰æ´»åŠ¨çš„fiber</span><br>  wipRoot = <span class="hljs-literal">null</span>;<br>  <span class="hljs-comment">// é‡ç½®éœ€è¦åˆ é™¤çš„fiber</span><br>  deletions = [];<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç›‘å¬-depsï¼Œåˆå§‹åŒ–å’Œæ›´æ–°çš„æ—¶å€™æ‰§è¡Œå‰¯ä½œç”¨"><a href="#ç›‘å¬-depsï¼Œåˆå§‹åŒ–å’Œæ›´æ–°çš„æ—¶å€™æ‰§è¡Œå‰¯ä½œç”¨" class="headerlink" title="ç›‘å¬ depsï¼Œåˆå§‹åŒ–å’Œæ›´æ–°çš„æ—¶å€™æ‰§è¡Œå‰¯ä½œç”¨"></a>ç›‘å¬ depsï¼Œåˆå§‹åŒ–å’Œæ›´æ–°çš„æ—¶å€™æ‰§è¡Œå‰¯ä½œç”¨</h3><p>åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œæ‰€æœ‰çš„ effectï¼Œæ›´æ–°çš„æ—¶å€™éœ€è¦åˆ¤æ–­ deps æ˜¯å¦æ”¹å˜ï¼Œå†ç¡®å®šæ‰§è¡Œä»€ä¹ˆ effectï¼Œæ¶‰åŠåˆ°ä¸¤ä¸ªé—®é¢˜</p><ol><li>å¦‚ä½•åŒºåˆ†åˆå§‹åŒ–å’Œæ›´æ–°é˜¶æ®µï¼šwipFiber.alternate æ˜¯å¦æœ‰å€¼</li><li>æ›´æ–°é˜¶æ®µå¦‚ä½•åˆ¤æ–­ deps æ˜¯å¦æ”¹å˜ï¼šsome æ¯”è¾ƒæ–°æ—§ deps ç¡®å®šæ˜¯å¦æœ‰ä¾èµ–é¡¹å˜åŒ–ï¼Œè‹¥å˜åŒ–åˆ™è°ƒç”¨ callback</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitEffect</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">fiber</span>) &#123;<br>    <span class="hljs-comment">// å‡ºå£</span><br>    <span class="hljs-keyword">if</span> (!fiber) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// æ ¹æ®æ˜¯å¦æœ‰alternateåˆ¤æ–­å½“å‰é˜¶æ®µæ˜¯åˆå§‹åŒ–è¿˜æ˜¯update</span><br>    <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">alternate</span>) &#123;<br>      <span class="hljs-comment">// initï¼Œç›´æ¥æ‰§è¡Œæ‰€æœ‰çš„å‰¯ä½œç”¨</span><br>      fiber.<span class="hljs-property">effectHook</span>?.<span class="hljs-title function_">callback</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// updateï¼Œdepså‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ‰æ‰§è¡Œå‰¯ä½œç”¨</span><br>      <span class="hljs-comment">// æœ‰çš„fiberå¯èƒ½æ²¡æœ‰ä½¿ç”¨useEffectï¼Œæ²¡æœ‰effectHookå±æ€§ï¼Œæ‰€ä»¥ç”¨å¯é€‰é“¾</span><br>      <span class="hljs-keyword">const</span> oldEffectHook = fiber.<span class="hljs-property">alternate</span>?.<span class="hljs-property">effectHook</span>;<br>      <span class="hljs-keyword">const</span> curEffectHook = fiber?.<span class="hljs-property">effectHook</span>;<br>      <span class="hljs-comment">// depsæ•°ç»„å†…çš„itemåªè¦æœ‰ä¸€é¡¹å‘ç”Ÿå˜åŒ–ï¼Œåˆ™å¼€å¯å‰¯ä½œç”¨</span><br>      <span class="hljs-keyword">const</span> needUpdate = oldEffectHook?.<span class="hljs-property">deps</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">oldDep, index</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">return</span> oldDep !== curEffectHook?.<span class="hljs-property">deps</span>[index];<br>      &#125;);<br>      <span class="hljs-keyword">if</span> (needUpdate) &#123;<br>        curEffectHook.<span class="hljs-title function_">callback</span>();<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-title function_">run</span>(fiber.<span class="hljs-property">child</span>);<br>    <span class="hljs-title function_">run</span>(fiber.<span class="hljs-property">sibling</span>);<br>  &#125;<br>  <span class="hljs-title function_">run</span>(wipFiber);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å¤šä¸ªå‰¯ä½œç”¨"><a href="#å¤šä¸ªå‰¯ä½œç”¨" class="headerlink" title="å¤šä¸ªå‰¯ä½œç”¨"></a>å¤šä¸ªå‰¯ä½œç”¨</h3><p>å’Œ useState çš„å¤„ç†æ–¹å¼ç›¸åŒï¼Œä¹Ÿéœ€è¦åœ¨å…¨å±€å®šä¹‰ä¸€ä¸ªæ”¶é›†æ‰€æœ‰ effect çš„å˜é‡ effectHooksã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> effectHooks;<br></code></pre></td></tr></table></figure><p>åœ¨è¿›å…¥ FC çš„æ—¶å€™ effectHooks åˆå§‹åŒ–ä¸ºæ•°ç»„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// å¤„ç†å‡½æ•°ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFunctionComponent</span>(<span class="hljs-params">fiber</span>) &#123;<br>  <span class="hljs-comment">// å­˜å‚¨å°†æ¥è¦æ›´æ–°çš„FC fiber</span><br>  wipFiber = fiber;<br>  <span class="hljs-comment">// åˆå§‹åŒ–å½“å‰fiberåœ¨å½“å‰é—­åŒ…ä¸­çš„stateHookså’Œå¯¹åº”çš„index</span><br>  stateHookIndex = <span class="hljs-number">0</span>;<br>  stateHooks = [];<br>  <span class="hljs-comment">// åˆå§‹åŒ–å‰¯ä½œç”¨</span><br>  effectHooks = [];<br>  <span class="hljs-keyword">const</span> children = [fiber.<span class="hljs-title function_">type</span>(fiber.<span class="hljs-property">props</span>)];<br>  <span class="hljs-title function_">reconcileChildren</span>(fiber, children);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨ useEffect çš„æ—¶å€™æŠŠæ‰€æœ‰çš„ callback å’Œ deps æ”¶é›†åˆ° wipFiber.effectHooks é‡Œé¢ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useEffect</span>(<span class="hljs-params">callback, deps</span>) &#123;<br>  <span class="hljs-keyword">let</span> effectHook = &#123;<br>    callback,<br>    deps,<br>  &#125;;<br>  effectHooks.<span class="hljs-title function_">push</span>(effectHook);<br>  wipFiber.<span class="hljs-property">effectHooks</span> = effectHooks;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ç»Ÿä¸€å¤„ç† effectHooks çš„æ—¶å€™åˆ†æƒ…å†µï¼ˆinit updateï¼‰éå†å¤„ç†æ‰€æœ‰çš„ effectHookã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// æ ¹æ®æ˜¯å¦æœ‰alternateåˆ¤æ–­å½“å‰é˜¶æ®µæ˜¯åˆå§‹åŒ–è¿˜æ˜¯update</span><br><span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">alternate</span>) &#123;<br>  <span class="hljs-comment">// initï¼Œç›´æ¥æ‰§è¡Œæ‰€æœ‰çš„å‰¯ä½œç”¨</span><br>  fiber.<span class="hljs-property">effectHooks</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">effectHook</span>) =&gt;</span> &#123;<br>    effectHook?.<span class="hljs-title function_">callback</span>();<br>  &#125;);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// updateï¼Œdepså‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ‰æ‰§è¡Œå‰¯ä½œç”¨</span><br>  fiber.<span class="hljs-property">effectHooks</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">hook, index</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// æœ‰çš„fiberå¯èƒ½æ²¡æœ‰ä½¿ç”¨useEffectï¼Œæ²¡æœ‰effectHookå±æ€§ï¼Œæ‰€ä»¥ç”¨å¯é€‰é“¾</span><br>    <span class="hljs-keyword">const</span> oldEffectHook = fiber.<span class="hljs-property">alternate</span>?.<span class="hljs-property">effectHooks</span>[index];<br>    <span class="hljs-keyword">const</span> curEffectHook = hook;<br>    <span class="hljs-comment">// depsæ•°ç»„å†…çš„itemåªè¦æœ‰ä¸€é¡¹å‘ç”Ÿå˜åŒ–ï¼Œåˆ™å¼€å¯å‰¯ä½œç”¨</span><br>    <span class="hljs-keyword">const</span> needUpdate = oldEffectHook?.<span class="hljs-property">deps</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">oldDep, i</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> oldDep !== curEffectHook?.<span class="hljs-property">deps</span>[i];<br>    &#125;);<br>    <span class="hljs-keyword">if</span> (needUpdate) &#123;<br>      curEffectHook.<span class="hljs-title function_">callback</span>();<br>    &#125;<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="cleanup"><a href="#cleanup" class="headerlink" title="cleanup"></a>cleanup</h3><h4 id="å­˜å‚¨"><a href="#å­˜å‚¨" class="headerlink" title="å­˜å‚¨"></a>å­˜å‚¨</h4><p>ä¸€ä¸ª FC fiber åº”è¯¥ä½¿ç”¨æ•°ç»„å­˜å‚¨å†…å«çš„å¤šä¸ª useEffect itemï¼Œè€Œä¸€ä¸ª useEffect item åº”è¯¥å­˜å‚¨å…¶ callback deps å’Œ cleanup</p><h4 id="èµ‹å€¼"><a href="#èµ‹å€¼" class="headerlink" title="èµ‹å€¼"></a>èµ‹å€¼</h4><p>effect çš„è°ƒç”¨ç»“æœ</p><h4 id="è°ƒç”¨æ—¶æœº"><a href="#è°ƒç”¨æ—¶æœº" class="headerlink" title="è°ƒç”¨æ—¶æœº"></a>è°ƒç”¨æ—¶æœº</h4><p>åœ¨ç»„ä»¶æ›´æ–°ã€åˆ›å»ºå®Œæ–°çš„ä¹‹åä¼šå…ˆè°ƒç”¨ä¸Šä¸€æ¬¡è°ƒç”¨ effect äº§ç”Ÿçš„æ—§çš„ cleanupï¼ˆminireact é™åˆ¶ï¼Œä¸è°ƒç”¨ deps ä¸ºç©ºçš„ cleanupï¼‰ï¼Œå†è°ƒç”¨ effect äº§ç”Ÿæ–°çš„ cleanup ä¾›ä¸‹æ¬¡è°ƒç”¨</p><h1 id="ä¹ å¾—çš„ç¥æŠ€"><a href="#ä¹ å¾—çš„ç¥æŠ€" class="headerlink" title="ä¹ å¾—çš„ç¥æŠ€"></a>ä¹ å¾—çš„ç¥æŠ€</h1><h2 id="ç”»å›¾-debugger-äº‹åŠåŠŸå€"><a href="#ç”»å›¾-debugger-äº‹åŠåŠŸå€" class="headerlink" title="ç”»å›¾+debugger äº‹åŠåŠŸå€"></a>ç”»å›¾+debugger äº‹åŠåŠŸå€</h2><p>ä»¥å¾€é‡åˆ° bug çš„æ—¶å€™ï¼Œæˆ‘é€šå¸¸é‡‡ç”¨çš„æ–¹å¼æ˜¯ç›´æ¥æ‰“æ–­ç‚¹è°ƒè¯•ï¼Œè¿™æ˜¯é€šè§£ä¹Ÿæ˜¯æœ€æ…¢çš„è§£æ³•ï¼Œä½†æ˜¯å¾€å¾€å¯ä»¥å‘ç°ä¸€äº›è®©äººæ¶èƒ¸é¡¿è¶³ã€å“­ç¬‘ä¸å¾—çš„éç®—æ³•é”™è¯¯ã€‚</p><p>å¦‚æœæœ‰åè¶³çš„æŠŠæ¡åˆ¤æ–­ bug å‡ºç°çš„åŸå› å’Œå½“å‰çš„æ•°æ®ç»“æ„ä¸ç®—æ³•æœ‰å…³ï¼Œä¸å¦¨åœ¨è°ƒè¯•ä¹‹å‰å…ˆç”»å›¾æ¢³ç†ä¸€éé€»è¾‘ã€‚</p><p>æ¯”å¦‚åœ¨è¿”å›ä¸‹ä¸€ä¸ª fiber çš„æ—¶å€™ï¼Œä»…ä»…æŒ‰ç…§èµ·åˆçš„ child -&gt; sibling -uncle ç­–ç•¥åœ¨ dom æ ‘å±‚çº§è¾ƒæ·±çš„æ—¶å€™ä¼šåœ¨æŸä¸€æ£µå­æ ‘æœ«å°¾æŠ¥é”™ï¼Œç”»å›¾åœ¨è„‘æµ·ä¸­æ¨¡æ‹Ÿä¸€éå¾ˆå¿«å°±èƒ½å‘ç°åŸå› â€”â€”å­æ ‘å±‚çº§å¤ªæ·±ä¸”å‘ä¸Šçš„å¾ˆå¤šå±‚ parent.sibling éƒ½ä¸ºç©ºã€‚ä¸€æ—¦é”å®šçœŸæ­£çš„é—®é¢˜æ ¹å› ï¼Œå†éš¾çš„é—®é¢˜ä¹Ÿè¿åˆƒè€Œè§£ã€‚</p><p><img src="/img/react/mini-react/parent-find-process.png" alt="Alt text"></p><h2 id="è¿ç§»æ‰©å±•çŸ¥è¯†ï¼Œâ€œä»¥ä¸å˜åº”ä¸‡å˜â€"><a href="#è¿ç§»æ‰©å±•çŸ¥è¯†ï¼Œâ€œä»¥ä¸å˜åº”ä¸‡å˜â€" class="headerlink" title="è¿ç§»æ‰©å±•çŸ¥è¯†ï¼Œâ€œä»¥ä¸å˜åº”ä¸‡å˜â€"></a>è¿ç§»æ‰©å±•çŸ¥è¯†ï¼Œâ€œä»¥ä¸å˜åº”ä¸‡å˜â€</h2><p>çŸ¥è¯†å’Œè§£å†³é—®é¢˜çš„æ€è·¯æ˜¯å¯ä»¥è¿ç§»æ‰©å±•çš„ï¼Œæˆ‘ä»¬åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­éœ€è¦åˆ»æ„å¤´è„‘é£æš´ï¼Œè®¾æƒ³ä¸€äº›å½“å‰å¤„ç†çš„é—®é¢˜è¿˜å¯èƒ½å‘ç”Ÿçš„åœºæ™¯ï¼Œæˆ–è€…å½“å‰çš„æ–¹æ¡ˆè¿˜å¯ä»¥è¿ç§»åˆ°å“ªé‡Œã€‚</p><p>æ¯”å¦‚æˆ‘åœ¨è¯¥ç³»åˆ—è¯¾ç¨‹ä¸­æœ€é‡è¦çš„æ”¶è·æœ‰ä¸¤ç‚¹ï¼š</p><ol><li>éçº¿å½¢çš„ DOM æ ‘çš„æ¸²æŸ“ä»»åŠ¡æ‹†åˆ†æˆå•ä¸ª fiber æ„æˆçš„çº¿æ€§é“¾è¡¨ã€åˆ©ç”¨æµè§ˆå™¨ç©ºä½™æ—¶é—´æ‰§è¡Œå¾®ä»»åŠ¡</li><li>åœ¨æ•´ä¸ªä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåˆ©ç”¨é—­åŒ…ç¼“å­˜æ¯ä¸ª FC çš„ fiberï¼ŒuseStateã€useEffect å‡ä½¿ç”¨åˆ°äº†è¯¥æŠ€å·§</li></ol><p>è¿ç§»æ‰©å±•ï¼š</p><ol><li>DOM æ ‘çš„æ¸²æŸ“å’Œ svg å›¾å…ƒçš„æ¸²æŸ“åˆ«æ— äºŒè‡´ï¼Œéƒ½å¯ä»¥ä½¿ç”¨è¿™ç§å¾®ä»»åŠ¡æ€æƒ³æ¥è§£å†³ã€‚æ›´æ¨å¹¿çš„åœºæ™¯æ˜¯å¯¹äºè¿è¡Œåœ¨æµè§ˆå™¨ä¸Šçš„ CPU è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œéƒ½å¯ä»¥æ‹†åˆ†ä»»åŠ¡ï¼Œåˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´é€ä¸ªå‡»ç ´</li><li>ä»»åŠ¡æ‰§è¡ŒæœŸçš„é—­åŒ…ç¼“å­˜ç›¸å½“äºåœ¨è¯¥é˜¶æ®µæ‰“æ–­ç‚¹ï¼Œå¦‚æœè¿è¡Œè¿‡ç¨‹ä¸­æŸäº›å˜é‡çš„ä¸­é—´å€¼æ˜¯æˆ‘ä»¬åœ¨è¿è¡Œç»“æŸåä»ç„¶éœ€è¦çš„ï¼Œå°±å¯ä»¥ä½¿ç”¨é—­åŒ…æ–¹å¼æŠŠè¿™äº›å€¼â€œç´§æ¡ä¸æ”¾â€ï¼Œæœ‰éœ€è¦çš„æ—¶å€™å†éšç”¨éšå–</li></ol><h2 id="å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹ä¸€â€”â€”æŒ‰å›¾ç´¢éª¥å®ç°åŸºç¡€åŠŸèƒ½"><a href="#å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹ä¸€â€”â€”æŒ‰å›¾ç´¢éª¥å®ç°åŸºç¡€åŠŸèƒ½" class="headerlink" title="å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹ä¸€â€”â€”æŒ‰å›¾ç´¢éª¥å®ç°åŸºç¡€åŠŸèƒ½"></a>å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹ä¸€â€”â€”æŒ‰å›¾ç´¢éª¥å®ç°åŸºç¡€åŠŸèƒ½</h2><p>å¼€å‘æ—¶é€šå¸¸æ¶‰åŠåˆ°ä¸‰ä¸ªé—®é¢˜ï¼šåŸºç¡€çš„åŠŸèƒ½éœ€æ±‚å®ç°ã€å‡½æ•°è®¾è®¡å’Œé‡æ„ã€‚å¦‚æœè¿™ä¸‰é©¾é©¬è½¦å¹¶é©¾é½é©±ï¼Œæ— ç–‘ä¼šæŠŠç®€å•çš„é—®é¢˜å¤æ‚åŒ–ã€‚æˆ‘ä»¬åº”è¯¥å°†è¿™ä¸‰ä»¶ä»»åŠ¡æ‹†åˆ†ç„¶åé€ä¸€æ‰§è¡Œï¼Œå‡å°ä»»åŠ¡çš„å¤æ‚åº¦ã€‚</p><p>é¢å¯¹ä¸€ä¸ªæ–°éœ€æ±‚ï¼Œé¦–å…ˆæ€è€ƒçš„ä»…ä»…æ˜¯å¦‚ä½•åœ¨ç°æœ‰åŸºç¡€ä¸Šå®ç°æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œå…¶ä½™çš„å˜é‡å‘½åé£æ ¼ã€é€»è¾‘æŠ½è±¡å°è£…ç­‰å¯ä»¥å…ˆä¸è€ƒè™‘ï¼Œç”šè‡³å¯ä»¥å…ˆå®ç°ä¸€ç§æœ€å®¹æ˜“æƒ³åˆ°çš„æƒ…å†µã€‚æ¯”å¦‚åœ¨å®ç° children æ›´æ–°çš„æ—¶å€™ï¼Œç§»é™¤æ—§çš„ fiber å¯¹åº”çš„ DOMï¼Œæœ€ç®€å•ç›´æ¥çš„æ€è·¯å°±æ˜¯è®©å½“å‰çš„<code>fiber.parent.dom</code>åˆ é™¤<code>fiber.dom</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// åŸºç¡€åŠŸèƒ½</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitDeletion</span>(<span class="hljs-params">fiber</span>) &#123;<br>  parentFiber.<span class="hljs-property">dom</span>.<span class="hljs-title function_">removeChild</span>(fiber.<span class="hljs-property">dom</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹äºŒâ€”â€”æ™®é€‚å‡½æ•°çš„è¿›é˜¶è®¾è®¡"><a href="#å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹äºŒâ€”â€”æ™®é€‚å‡½æ•°çš„è¿›é˜¶è®¾è®¡" class="headerlink" title="å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹äºŒâ€”â€”æ™®é€‚å‡½æ•°çš„è¿›é˜¶è®¾è®¡"></a>å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹äºŒâ€”â€”æ™®é€‚å‡½æ•°çš„è¿›é˜¶è®¾è®¡</h2><p>åœ¨åŸºæœ¬åŠŸèƒ½å®ç°çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬æ·±å…¥æ€è€ƒå¾€å¾€ä¼šå‘ç°ï¼ŒåŸºæœ¬åŠŸèƒ½å¾€å¾€ä¼šå’Œå…¶ä»–çš„åŠŸèƒ½äº§ç”Ÿè”ç³»ã€‚</p><p>æ¯”å¦‚ä¸Šé¢å®ç°çš„ children æ›´æ–°ï¼Œè€ƒè™‘åˆ°<strong>function component fiber æ²¡æœ‰ dom</strong>çš„ç‰¹æ€§ï¼Œåœ¨è®¾è®¡é€šç”¨åŠŸèƒ½çš„æ—¶å€™è¿˜éœ€è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>åœ¨ fiber ä¸º FC fiber æ—¶ï¼Œ<code>fiber.dom</code>ä¸ºç©º</li><li>åœ¨ fiber.parent ä¸º FC fiber æ—¶ï¼Œ<code>fiber.parent.dom</code>ä¸ºç©º</li></ol><p>å› æ­¤ï¼Œç¬¬ä¸€æ­¥çš„æ™®é€šå®ç°åº”è¯¥ä»¥è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ä¸ºç›®æ ‡ï¼Œè¿›ä¸€æ­¥è¿­ä»£è®¾è®¡ï¼š</p><ol><li><code>fiber.dom</code>ä¸ä¸ºç©ºæ—¶æ‰æ‰§è¡Œåˆ é™¤</li><li><code>fiber.parent.dom</code>ä¸ºç©ºæ—¶ä¸€ç›´å‘ä¸Šå¯»æ‰¾æœ‰ dom çš„ç¥–å…ˆ</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// è¿›é˜¶è®¾è®¡</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitDeletion</span>(<span class="hljs-params">fiber</span>) &#123;<br>  <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">dom</span>) &#123;<br>    <span class="hljs-comment">// å¦‚æœå½“å‰fiberæ˜¯FC childï¼Œçˆ¶fiberæ²¡æœ‰domï¼Œå°±ä¸€ç›´å‘ä¸Šæ‰¾</span><br>    <span class="hljs-keyword">let</span> parentFiber = fiber.<span class="hljs-property">parent</span>;<br>    <span class="hljs-keyword">while</span> (!parentFiber.<span class="hljs-property">dom</span>) &#123;<br>      parentFiber = parentFiber.<span class="hljs-property">parent</span>;<br>    &#125;<br>    parentFiber.<span class="hljs-property">dom</span>.<span class="hljs-title function_">removeChild</span>(fiber.<span class="hljs-property">dom</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœå½“å‰fiberæ²¡æœ‰domï¼Œè¯´æ˜æ˜¯FCï¼Œåˆ é™¤å®ƒçš„childå³å¯</span><br>    <span class="hljs-title function_">commitDeletion</span>(fiber.<span class="hljs-property">child</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ›´æ™®é€‚çš„æƒ…å†µæ˜¯ï¼Œå‰å fiber é“¾è¡¨ä¸ç­‰é•¿ï¼Œå› æ­¤è¿›é˜¶è®¾è®¡åˆå¯ä»¥è¿›ä¸€æ­¥è¿›é˜¶ï¼Œç›´åˆ°å¯ä»¥ cover æˆ‘ä»¬è®¤ä¸ºçš„æ™®é€‚åœºæ™¯</p><h2 id="å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹ä¸‰â€”â€”è´¯ç©¿å¼€å‘å‘¨æœŸçš„é‡æ„"><a href="#å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹ä¸‰â€”â€”è´¯ç©¿å¼€å‘å‘¨æœŸçš„é‡æ„" class="headerlink" title="å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹ä¸‰â€”â€”è´¯ç©¿å¼€å‘å‘¨æœŸçš„é‡æ„"></a>å¼€å‘ä¸‰é©¾é©¬è½¦ä¹‹ä¸‰â€”â€”è´¯ç©¿å¼€å‘å‘¨æœŸçš„é‡æ„</h2><p>é‡æ„ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>å˜é‡ã€å‡½æ•°çš„é‡å‘½åï¼›</li><li>ä»£ç æ®µçš„æŠ½è±¡å°è£…ï¼Œå‡¡æ˜¯å¯ä»¥ç”¨ä¸€å¥æ˜ç¡®çš„è¯æ€»ç»“çš„æŸä¸€æ®µåŠŸèƒ½ä»£ç ï¼Œéƒ½å¯ä»¥æŠ½ç¦»å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼›</li><li>æ¢³ç†ä»£ç æ‰§è¡Œè¿‡ç¨‹ï¼Œè°ƒæ•´å‡½æ•°çš„æ‰§è¡Œä½ç½®ï¼›</li><li>æ€è€ƒæ™®é€‚åœºæ™¯ä¸­ corner case çš„è§£å†³æ–¹æ³•ã€‚</li></ol><h1 id="æ„Ÿæ‚Ÿ"><a href="#æ„Ÿæ‚Ÿ" class="headerlink" title="æ„Ÿæ‚Ÿ"></a>æ„Ÿæ‚Ÿ</h1><p>å’Œç¾¤é‡Œçš„å°ä¼™ä¼´ä¸€èµ·ä¸€å‘¨é€šå…³ mini-react æ˜¯ä¸€ä»¶å¾ˆæœ‰æ„ä¹‰çš„äº‹æƒ…ï¼Œè‡ªé«˜ä¸­æ¯•ä¸šä»¥æ¥å¾ˆå°‘å†æœ‰è¿™ç§é›†ä½“ç›‘ç£æ‰“å¡ä»»åŠ¡çš„æœºä¼šäº†ã€‚å¯¹äºæˆ‘è‡ªèº«è€Œè¨€ï¼Œæ‰“å¡å’Œé—®é¢˜è®¨è®ºçš„æ„ä¹‰å¹¶ä¸æ˜¯å…¶æœ¬èº«ï¼ˆè‡ªè®¤ä¸ºè‡ªåˆ¶åŠ›å’Œç‹¬ç«‹æ±‚çŸ¥æ¬²è¿˜å¯ä»¥ï¼‰ï¼Œè€Œæ˜¯ä¸€ç¾¤äººä¸ºäº†ä¸€ä¸ªç›®æ ‡è¸å®å¥‹æ–—çš„æ°›å›´å¯ä»¥è®©æˆ‘æ›´æœ‰åŠ¨åŠ›ï¼Œæ¯å¤©çš„â€œè‚‰çœ¼å¯è§â€œçš„æ€»ç»“æ€è€ƒå¯ä»¥è®©æˆ‘çœŸåˆ‡ä½“ä¼šåˆ°è‡ªå·±çš„è¿›æ­¥ã€‚</p><p>ç¾¤é‡Œæœ‰ä¸€äº›å¤§ä½¬çš„æ°´å¹³éå¸¸é«˜ï¼Œæˆ‘è¿™ä¹ˆä¸ªå‰ç«¯å°ç™½çš„æ°´å¹³å®åœ¨æ˜¯ç›¸å½¢è§ç»Œï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½äº§ç”Ÿå¤ªä¸¥é‡çš„ç„¦è™‘æƒ…ç»ªï¼Œè¦ç›¸ä¿¡è‡ªå·±æœªæ¥å¯æœŸï¼Œå¸Œæœ›å¯ä»¥å¿«ç‚¹å®ä¹ æ—©æ—¥æ¯•ä¸šï¼Œåœ¨å®é™…å·¥ä½œä¸­å†ç»ƒè‡ªå·±ï¼ŒæœŸå¾…èƒ½â€œæœ›å…¶é¡¹èƒŒâ€çš„ä¸€å¤©ã€‚</p><p>è°¨ä»¥æ­¤æ–‡ï¼Œæ€»ç»“æˆ‘ä¸€å‘¨æ¥çš„å­¦ä¹ æˆæœå’Œå¿ƒè·¯å†ç¨‹ï¼Œä¸è¯¸å›å…±å‹‰ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>react</category>
      
      <category>mini-react</category>
      
    </categories>
    
    
    <tags>
      
      <tag>react</tag>
      
      <tag>useState</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>useImperativeHandle</title>
    <link href="/2023/06/21/useImperativeHandle/"/>
    <url>/2023/06/21/useImperativeHandle/</url>
    
    <content type="html"><![CDATA[<h3 id="useImperativeHandle-å’Œ-ref-è½¬å‘"><a href="#useImperativeHandle-å’Œ-ref-è½¬å‘" class="headerlink" title="useImperativeHandle å’Œ ref è½¬å‘"></a>useImperativeHandle å’Œ ref è½¬å‘</h3><p><strong>useImperativeHandle å¯ä»¥è®©ä½ åœ¨ä½¿ç”¨ ref æ—¶è‡ªå®šä¹‰æš´éœ²ç»™çˆ¶ç»„ä»¶çš„å®ä¾‹å€¼ï¼Œåº”å½“ä¸ forwardRef ä¸€èµ·ä½¿ç”¨ï¼Œå®ç° ref è½¬å‘</strong></p><p><strong>æˆ‘ä»¬è·å–ç±»ç»„ä»¶å®ä¾‹åï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨å®ä¾‹ä¸Šçš„æ–¹æ³•ï¼</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useEffect, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  submit = <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;è°ƒç”¨äº†å­ç»„ä»¶çš„submitæ–¹æ³•ï¼&quot;</span>);<br>  &#125;;<br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Â  Â  Â  Â  Â  Â ... Â  Â  Â  Â <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> box = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(box.<span class="hljs-property">current</span>); <span class="hljs-comment">//å­ç»„ä»¶çš„å®ä¾‹</span><br>    box.<span class="hljs-property">current</span>.<span class="hljs-title function_">submit</span>();<br>  &#125;, []);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      Â  Â  Â  Â <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;box&#125;</span> /&gt;</span>Â  Â </span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½†æ˜¯ç›´æ¥æŠŠ ref èµ‹å€¼ç»™å‡½æ•°ç»„ä»¶ï¼Œæ˜¯ä¸è¢«å…è®¸çš„ï¼</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Â  Â  Â  Â ... Â  Â <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> box = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(box.<span class="hljs-property">current</span>); <span class="hljs-comment">//null // Warning: Function components cannot be given refs. Attempts to access this ref will fail. Did you mean to use React.forwardRef()?</span><br>  &#125;, []);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      Â  Â  Â  Â <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;box&#125;</span> /&gt;</span>Â  Â </span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥åŸºäº forwardRef å’Œ useImperativeHandle , å°±å¯ä»¥å®ç°çˆ¶ç»„ä»¶è°ƒç”¨å­ç»„ä»¶ä¸­çš„æ–¹æ³•ï¼</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123;<br>  useEffect,<br>  useRef,<br>  useImperativeHandle,<br>  forwardRef,<br>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">props, ref</span>) &#123;<br>  <span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">submit</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;è°ƒç”¨äº†å­ç»„ä»¶çš„submitæ–¹æ³•ï¼&quot;</span>);<br>      &#125;,<br>    &#125;;<br>  &#125;);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Â  Â  Â  Â ... Â  Â <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;);<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> box = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(box.<span class="hljs-property">current</span>);<br>    box.<span class="hljs-property">current</span>.<span class="hljs-title function_">submit</span>();<br>  &#125;, []);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      Â  Â  Â  Â <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;box&#125;</span> /&gt;</span>Â  Â </span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>react</category>
      
      <category>hooks</category>
      
    </categories>
    
    
    <tags>
      
      <tag>react</tag>
      
      <tag>useImperativeHandle</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>useRefæ·±å±‚å‰–æ</title>
    <link href="/2023/06/19/useRef/"/>
    <url>/2023/06/19/useRef/</url>
    
    <content type="html"><![CDATA[<h3 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a>useRef</h3><h4 id="ref-ä½¿ç”¨åœºæ™¯"><a href="#ref-ä½¿ç”¨åœºæ™¯" class="headerlink" title="ref ä½¿ç”¨åœºæ™¯"></a>ref ä½¿ç”¨åœºæ™¯</h4><p><strong>é€šå¸¸ï¼Œå½“ä½ çš„ç»„ä»¶éœ€è¦â€œè·³å‡ºâ€ React å¹¶ä¸å¤–éƒ¨ API é€šä¿¡æ—¶ï¼Œä½ ä¼šç”¨åˆ° ref â€”â€” é€šå¸¸æ˜¯ä¸ä¼šå½±å“ç»„ä»¶å¤–è§‚çš„æµè§ˆå™¨ APIã€‚ä»¥ä¸‹æ˜¯è¿™äº›ç½•è§æƒ…å†µä¸­çš„å‡ ä¸ªï¼š</strong></p><ul><li><strong>å­˜å‚¨ <a href="https://developer.mozilla.org/docs/Web/API/setTimeout">timeout ID</a></strong></li><li><strong>å­˜å‚¨å’Œæ“ä½œ <a href="https://developer.mozilla.org/docs/Web/API/Element">DOM å…ƒç´ </a>ï¼Œæ¶‰åŠéå—æ§ç»„ä»¶ã€‚èµ‹å€¼ç»™æ ‡ç­¾ï¼Œç›®çš„æ˜¯è·å– DOM å…ƒç´ ï¼›èµ‹å€¼ç»™ç±»ç»„ä»¶ï¼Œç›®çš„æ˜¯è·å–ç»„ä»¶çš„å®ä¾‹ï¼›</strong></li><li><strong>å­˜å‚¨ä¸éœ€è¦è¢«ç”¨æ¥è®¡ç®— JSX çš„å…¶ä»–å¯¹è±¡ã€‚</strong></li></ul><p><strong>å¦‚æœä½ çš„ç»„ä»¶éœ€è¦å­˜å‚¨ä¸€äº›å€¼ï¼Œä½†ä¸å½±å“æ¸²æŸ“é€»è¾‘ï¼Œè¯·é€‰æ‹© refã€‚</strong></p><h4 id="ç±»ç»„ä»¶çš„ä¸‰ç§åˆ›å»ºå’Œä½¿ç”¨æ–¹å¼"><a href="#ç±»ç»„ä»¶çš„ä¸‰ç§åˆ›å»ºå’Œä½¿ç”¨æ–¹å¼" class="headerlink" title="ç±»ç»„ä»¶çš„ä¸‰ç§åˆ›å»ºå’Œä½¿ç”¨æ–¹å¼"></a>ç±»ç»„ä»¶çš„ä¸‰ç§åˆ›å»ºå’Œä½¿ç”¨æ–¹å¼</h4><h5 id="æ–¹å¼ä¸€â€”â€”å­—ç¬¦ä¸²å½¢å¼çš„-refï¼ˆè¿‡æ—¶äº†ï¼Œæœªæ¥ç‰ˆæœ¬å¯èƒ½ç§»é™¤ï¼Œå¼€å‘æ—¶ä¸æ¨èä½¿ç”¨ï¼Œæ•ˆç‡ä½ï¼‰"><a href="#æ–¹å¼ä¸€â€”â€”å­—ç¬¦ä¸²å½¢å¼çš„-refï¼ˆè¿‡æ—¶äº†ï¼Œæœªæ¥ç‰ˆæœ¬å¯èƒ½ç§»é™¤ï¼Œå¼€å‘æ—¶ä¸æ¨èä½¿ç”¨ï¼Œæ•ˆç‡ä½ï¼‰" class="headerlink" title="æ–¹å¼ä¸€â€”â€”å­—ç¬¦ä¸²å½¢å¼çš„ refï¼ˆè¿‡æ—¶äº†ï¼Œæœªæ¥ç‰ˆæœ¬å¯èƒ½ç§»é™¤ï¼Œå¼€å‘æ—¶ä¸æ¨èä½¿ç”¨ï¼Œæ•ˆç‡ä½ï¼‰"></a>æ–¹å¼ä¸€â€”â€”å­—ç¬¦ä¸²å½¢å¼çš„ refï¼ˆ<strong>è¿‡æ—¶äº†ï¼Œæœªæ¥ç‰ˆæœ¬å¯èƒ½ç§»é™¤ï¼Œå¼€å‘æ—¶ä¸æ¨èä½¿ç”¨ï¼Œæ•ˆç‡ä½</strong>ï¼‰</h5><p><strong>é€šè¿‡ <code>this.refs</code>è®¿é—®</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;<span class="hljs-keyword">input</span> <span class="hljs-keyword">ref</span>=&quot;input1&quot;/&gt;<br></code></pre></td></tr></table></figure><h5 id="æ–¹å¼äºŒâ€”â€”å›è°ƒå½¢å¼çš„-ref"><a href="#æ–¹å¼äºŒâ€”â€”å›è°ƒå½¢å¼çš„-ref" class="headerlink" title="æ–¹å¼äºŒâ€”â€”å›è°ƒå½¢å¼çš„ ref"></a>æ–¹å¼äºŒâ€”â€”å›è°ƒå½¢å¼çš„ ref</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">Reactå¸®æˆ‘ä»¬è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”å°†å½“å‰çš„DOMèŠ‚ç‚¹ä¼ å…¥å›è°ƒå‡½æ•°<br></code></pre></td></tr></table></figure><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;input<br>  ref=&#123;<span class="hljs-function">(<span class="hljs-params">currentNode</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">input1</span> = currentNode;<br>  &#125;&#125;<br>/&gt;<br><span class="hljs-comment">// currentNodeæ˜¯å½“å‰æ‰€å¤„çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªinput</span><br></code></pre></td></tr></table></figure><p><strong>ä¸èƒ½é€šè¿‡ <code>this.refs</code>è®¿é—®ï¼Œå› ä¸ºè¿™äº› ref éƒ½æˆäº†å®ä¾‹å±æ€§</strong></p><p><strong>React ä¸ä¼šå¸®ä½ æ‰§è¡ŒæœªçŸ¥å±æ€§çš„å›è°ƒå‡½æ•°</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;input<br>  ref=&#123;<span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">input1</span> = c)&#125;<br>  ahh=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);<br>  &#125;&#125;<br>  type=<span class="hljs-string">&quot;text&quot;</span><br>  placeholder=<span class="hljs-string">&quot;ç‚¹å‡»æŒ‰é’®æç¤ºæ•°æ®&quot;</span><br>/&gt;<br></code></pre></td></tr></table></figure><p><strong>å¦‚æœ ref å›è°ƒå‡½æ•°æ˜¯ä»¥**<strong>å†…è”å‡½æ•°çš„å½¢å¼å®šä¹‰çš„ï¼Œåœ¨æ›´æ–°è¿‡ç¨‹ä¸­å®ƒä¼šè¢«æ‰§è¡Œä¸¤æ¬¡</strong>ï¼Œç¬¬ä¸€æ¬¡ä¼ å…¥å‚æ•° nullï¼Œç¬¬äºŒæ¬¡ä¼ å…¥å‚æ•° DOM å…ƒç´ ã€‚è¿™æ˜¯å› ä¸ºåœ¨æ¯æ¬¡æ¸²æŸ“æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œæ‰€ä»¥ React æ¸…ç©ºæ—§çš„ ref å¹¶è®¾ç½®æ–°çš„ã€‚é€šè¿‡</strong>å°† ref çš„å›è°ƒå‡½æ•°å®šä¹‰æˆ class çš„ç»‘å®šå‡½æ•°<strong>çš„æ–¹å¼å¯ä»¥é¿å…ä¸Šè¿°é—®é¢˜ï¼Œä½†æ˜¯</strong>å¤§å¤šæ•°æƒ…å†µä¸‹å®ƒæ˜¯æ— æ•ˆçš„ï¼ˆæ— å…³ç´§è¦ï¼‰**</p><h5 id="æ–¹å¼ä¸‰â€”â€”createRef-åˆ›å»º-ref-å®¹å™¨ï¼ˆæœ€æ¨èï¼‰"><a href="#æ–¹å¼ä¸‰â€”â€”createRef-åˆ›å»º-ref-å®¹å™¨ï¼ˆæœ€æ¨èï¼‰" class="headerlink" title="æ–¹å¼ä¸‰â€”â€”createRef åˆ›å»º ref å®¹å™¨ï¼ˆæœ€æ¨èï¼‰"></a>æ–¹å¼ä¸‰â€”â€”createRef åˆ›å»º ref å®¹å™¨ï¼ˆ<strong>æœ€æ¨è</strong>ï¼‰</h5><p><em>React.createRef è°ƒç”¨åå¯ä»¥è¿”å›ä¸€ä¸ªå®¹å™¨ï¼Œè¯¥å®¹å™¨å¯ä»¥å­˜å‚¨è¢« ref æ‰€æ ‡è¯†çš„èŠ‚ç‚¹,è¯¥å®¹å™¨æ˜¯â€œä¸“äººä¸“ç”¨â€çš„ï¼Œå¤šä¸ª ref çš„å€¼å¯ä»¥ç›¸äº’ç‹¬ç«‹</em></p><p><strong>ref æ˜¯å®ä¾‹çš„å±æ€§ï¼Œä¸èƒ½é€šè¿‡ this.refs è®¿é—®</strong></p><p><strong>this.myRef.current æ˜¯å½“å‰å¼•ç”¨çš„ DOMï¼Œthis.myRef.current.value æ˜¯å½“å‰ DOM çš„å€¼</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">myRef</span> <span class="hljs-operator">=</span> React.createRef()<span class="hljs-comment">;</span><br>&lt;input ref<span class="hljs-operator">=</span>&#123;this.myRef&#125; /&gt;<br></code></pre></td></tr></table></figure><h4 id="hooks-ç»„ä»¶é€šè¿‡-useRef-åˆ›å»º-ref-å¯¹è±¡"><a href="#hooks-ç»„ä»¶é€šè¿‡-useRef-åˆ›å»º-ref-å¯¹è±¡" class="headerlink" title="hooks ç»„ä»¶é€šè¿‡ useRef åˆ›å»º ref å¯¹è±¡"></a>hooks ç»„ä»¶é€šè¿‡ useRef åˆ›å»º ref å¯¹è±¡</h4><p><strong>åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œå¯ä»¥åŸºäº</strong> <code>useRef</code>è·å– DOM å…ƒç´ ï¼ç±»ä¼¼äºç±»ç»„ä»¶ä¸­çš„ ï¼š</p><ul><li><strong>ref&#x3D;{x&#x3D;&gt;thix.box&#x3D;x}</strong></li><li><strong>React.createRef</strong></li></ul><p><strong>å‡½æ•°ç»„ä»¶ä¸­åˆ›å»º ref å¯¹è±¡çš„ä¸¤ç§æ–¹æ³•ï¼š</strong></p><ul><li><code>let box1 = useRef(null)</code></li><li><code>let box2 = React.createRef();</code></li></ul><p><strong>æ³¨æ„ï¼š</strong></p><p><strong>React.createRef ä¹Ÿæ˜¯ ref å¯¹è±¡ï¼Œåœ¨ç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶ä¸­éƒ½å¯ä»¥ä½¿ç”¨</strong></p><p><strong>useRef åªèƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸­ä½¿ç”¨ï¼Œæ‰€æœ‰çš„ hooks å‡½æ•°éƒ½åªèƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸­ä½¿ç”¨ï¼Œåœ¨ç±»ç»„ä»¶ä¸­ä½¿ç”¨ä¼šæŠ¥é”™</strong></p><p><strong>ref åªèƒ½åœ¨ DOM åˆ›å»ºä¹‹åæ‰èƒ½è·å– DOM å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ useLayoutEffect é˜¶æ®µå°±å¯ä»¥ä½¿ç”¨</strong></p><h4 id="createRef-æ€§èƒ½æ¯”-useRef-å·®â€”â€”æ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–°-ref-å¯¹è±¡"><a href="#createRef-æ€§èƒ½æ¯”-useRef-å·®â€”â€”æ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–°-ref-å¯¹è±¡" class="headerlink" title="createRef æ€§èƒ½æ¯” useRef å·®â€”â€”æ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–° ref å¯¹è±¡"></a>createRef æ€§èƒ½æ¯” useRef å·®â€”â€”æ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–° ref å¯¹è±¡</h4><ul><li><strong>createRef æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å¼•ç”¨</strong></li><li><strong>è€Œ useRef æ¯æ¬¡éƒ½ä¼šè¿”å›ç›¸åŒçš„å¼•ç”¨</strong></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState, useEffect, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Button</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./Demo.less&#x27;</span>;<br><br><span class="hljs-keyword">let</span> prev1,<br> Â  Â prev2;<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Demo</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"></span>) &#123;<br> Â  Â <span class="hljs-keyword">let</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// å‡½æ•°ç»„ä»¶ä¸­åˆ›å»ºrefå¯¹è±¡çš„ä¸¤ç§æ–¹æ³•</span><br> Â  Â <span class="hljs-keyword">let</span> box1 = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>),<br> Â  Â  Â  Â box2 = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createRef</span>();<br> Â  Â <span class="hljs-keyword">if</span> (!prev1) &#123;<br> Â  Â  Â  Â <span class="hljs-comment">// ç¬¬ä¸€æ¬¡DEMOæ‰§è¡Œï¼ŒæŠŠç¬¬ä¸€æ¬¡åˆ›å»ºçš„REFå¯¹è±¡èµ‹å€¼ç»™å˜é‡</span><br> Â  Â  Â  Â prev1 = box1;<br> Â  Â  Â  Â prev2 = box2;<br> Â   &#125; <span class="hljs-keyword">else</span> &#123;<br> Â  Â  Â  Â <span class="hljs-comment">// ç¬¬äºŒæ¬¡DEMOæ‰§è¡Œï¼Œæˆ‘ä»¬éªŒè¯ä¸€ä¸‹ï¼Œæ–°åˆ›å»ºçš„REFå¯¹è±¡ï¼Œå’Œä¹‹å‰ç¬¬ä¸€æ¬¡åˆ›å»ºçš„REFå¯¹è±¡ï¼Œæ˜¯å¦ä¸€è‡´ï¼Ÿ</span><br> Â  Â  Â  Â <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(prev1 === box1); <span class="hljs-comment">//true  useRefå†æ¯ä¸€æ¬¡ç»„ä»¶æ›´æ–°çš„æ—¶å€™ï¼ˆå‡½æ•°é‡æ–°æ‰§è¡Œï¼‰ï¼Œå†æ¬¡æ‰§è¡ŒuseRefæ–¹æ³•çš„æ—¶å€™ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„REFå¯¹è±¡äº†ï¼Œè·å–åˆ°çš„è¿˜æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºçš„é‚£ä¸ªREFå¯¹è±¡ï¼ï¼</span><br> Â  Â  Â  Â <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(prev2 === box2); <span class="hljs-comment">//false createRefåœ¨æ¯ä¸€æ¬¡ç»„ä»¶æ›´æ–°çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„REFå¯¹è±¡å‡ºæ¥ï¼Œæ¯”è¾ƒæµªè´¹æ€§èƒ½ï¼ï¼</span><br> Â  Â  Â  Â <span class="hljs-comment">// æ€»ç»“ï¼šåœ¨ç±»ç»„ä»¶ä¸­ï¼Œåˆ›å»ºREFå¯¹è±¡ï¼Œæˆ‘ä»¬åŸºäº React.createRef å¤„ç†ï¼›ä½†æ˜¯åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œä¸ºäº†ä¿è¯æ€§èƒ½ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ä¸“å±çš„ useRef å¤„ç†ï¼ï¼</span><br> Â   &#125;<br><br> Â  Â <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br> Â  Â  Â  Â <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(box1.<span class="hljs-property">current</span>);<br> Â  Â  Â  Â <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(box2.<span class="hljs-property">current</span>);<br> Â   &#125;);<br><br> Â  Â <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;demo&quot;</span>&gt;</span></span><br><span class="language-xml"> Â  Â  Â  Â <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;box1&#125;</span>&gt;</span>&#123;num&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml"> Â  Â  Â  Â <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;box2&#125;</span>&gt;</span>å“ˆå“ˆå“ˆ<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml"> Â  Â  Â  Â <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;small&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml"> Â  Â  Â  Â  Â  Â <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml"> Â  Â  Â  Â  Â  Â  Â  Â setNum(num + 1);</span><br><span class="language-xml"> Â  Â  Â  Â  Â   &#125;&#125;&gt;</span><br><span class="language-xml"> Â  Â  Â  Â  Â   æ–°å¢</span><br><span class="language-xml"> Â  Â  Â  Â <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml"> Â  Â <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æ€»ç»“ï¼šåœ¨ç±»ç»„ä»¶ä¸­ï¼Œåˆ›å»º Ref å¯¹è±¡ï¼ŒåŸºäº React.createRef å¤„ç†ï¼›åœ¨å‡½æ•°ç»„ä»¶ä¸­ä¸ºäº†ä¿è¯æ€§èƒ½ä½¿ç”¨ useRef</strong></p><h4 id="ref-çš„-DOM-ç”¨æ³•æ€»ç»“ã€useRefã€‘"><a href="#ref-çš„-DOM-ç”¨æ³•æ€»ç»“ã€useRefã€‘" class="headerlink" title="ref çš„ DOM ç”¨æ³•æ€»ç»“ã€useRefã€‘"></a>ref çš„ DOM ç”¨æ³•æ€»ç»“ã€useRefã€‘</h4><ul><li><strong>ç»™å…ƒç´ æ ‡ç­¾è®¾ç½® refï¼Œç›®çš„ï¼šè·å–å¯¹åº”çš„ DOM å…ƒç´ </strong></li><li><strong>ç»™ç±»ç»„ä»¶è®¾ç½® refï¼Œç›®çš„ï¼šè·å–å½“å‰è°ƒç”¨ç»„ä»¶åˆ›å»ºçš„å®ä¾‹ï¼ˆåç»­å¯ä»¥æ ¹æ®å®ä¾‹è·å–å­ç»„ä»¶ä¸­çš„ç›¸å…³ä¿¡æ¯ï¼‰</strong><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-comment">// åŸºäºrefè·å–å­ç»„ä»¶çš„å®ä¾‹ï¼Œè¿™æ ·åŸºäºå®ä¾‹ï¼Œå¯ä»¥è°ƒç”¨å­ç»„ä»¶å†…éƒ¨ï¼ŒæŒ‚è½½åˆ°å®ä¾‹ä¸Šçš„ä¸œè¥¿</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>&#123;<br> Â  Â state = &#123; x: <span class="hljs-number">1000</span> &#125;;<br> Â  Â render() &#123;<br> Â  Â  Â  Â <span class="hljs-keyword">return</span> &lt;div className=<span class="hljs-string">&quot;child-box&quot;</span>&gt;<br> Â  Â  Â  Â  Â   &#123;<span class="hljs-keyword">this</span>.state.x&#125;<br> Â  Â  Â  Â &lt;/div&gt;;<br> Â   &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><strong>ç»™å‡½æ•°ç»„ä»¶&#x2F;hooks è®¾ç½® refï¼Œç›´æ¥æŠ¥é”™ï¼šFunction components cannot be given refs. Attempts to access this ref wil failï¼Œä½†æ˜¯å¯ä»¥é…åˆ React.forwardRef å®ç° ref çš„è½¬å‘ã€‚ç›®çš„ï¼šè·å–å‡½æ•°å­ç»„ä»¶å†…çš„æŸä¸ª DOM å…ƒç´ </strong><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// åŸºäºforwardRefå®ç°refè½¬å‘ï¼Œç›®çš„ï¼šè·å–å­ç»„ä»¶å†…éƒ¨çš„æŸä¸ªå…ƒç´ </span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">props, ref</span>) &#123;<br> Â  Â <span class="hljs-comment">// console.log(ref); //åœ¨DEMOä¸­ï¼Œè°ƒç”¨Childçš„æ—¶å€™ï¼Œä¼ é€’çš„refå¯¹è±¡ã€Œxã€</span><br> Â  Â <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;child-box&quot;</span>&gt;</span></span><br><span class="language-xml"> Â  Â  Â  Â <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span>&gt;</span>å“ˆå“ˆå“ˆ<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml"> Â  Â <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;);<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>react</category>
      
      <category>hooks</category>
      
    </categories>
    
    
    <tags>
      
      <tag>react</tag>
      
      <tag>useRef</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>useLayoutEffectæ·±å±‚å‰–æ</title>
    <link href="/2023/06/17/useLayoutEffect/"/>
    <url>/2023/06/17/useLayoutEffect/</url>
    
    <content type="html"><![CDATA[<h2 id="useLayoutEffect"><a href="#useLayoutEffect" class="headerlink" title="useLayoutEffect"></a>useLayoutEffect</h2><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>useLayoutEffect å‡½æ•°ç­¾åä¸ useEffect ç›¸åŒï¼Œä½†å®ƒä¼šåœ¨æ‰€æœ‰çš„ DOM å˜æ›´ä¹‹å<strong>åŒæ­¥</strong>è°ƒç”¨ effectã€‚</p><p>å¯ä»¥ä½¿ç”¨å®ƒæ¥è¯»å– DOM å¸ƒå±€å¹¶åŒæ­¥è§¦å‘é‡æ¸²æŸ“ã€‚</p><p>åœ¨æµè§ˆå™¨æ‰§è¡Œç»˜åˆ¶ä¹‹å‰ï¼ŒuseLayoutEffect å†…éƒ¨çš„æ›´æ–°è®¡åˆ’å°†è¢«åŒæ­¥åˆ·æ–°ã€‚</p><p>å°½å¯èƒ½ä½¿ç”¨æ ‡å‡†çš„ useLayoutEffect ä»¥é¿å…é˜»å¡è§†è§‰æ›´æ–°ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState, useEffect, useLayoutEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-comment">// å†è¯•è¯•useLayoutEffect</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (num === <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">let</span> random = +<span class="hljs-title class_">String</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()).<span class="hljs-title function_">substring</span>(<span class="hljs-number">2</span>);<br>      <span class="hljs-title function_">setNum</span>(random);<br>    &#125;<br>  &#125;, [num]);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">background:</span> &#x27;<span class="hljs-attr">lightblue</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">WebkitUserSelect:</span> &#x27;<span class="hljs-attr">none</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">      &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setNum(0);</span><br><span class="language-xml">      &#125;&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      &#123;num&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="useEffect-å’Œ-useLayoutEffect-åŒºåˆ«"><a href="#useEffect-å’Œ-useLayoutEffect-åŒºåˆ«" class="headerlink" title="useEffect å’Œ useLayoutEffect åŒºåˆ«"></a>useEffect å’Œ useLayoutEffect åŒºåˆ«</h3><p><strong>useLayoutEffect ä¼šé˜»å¡æµè§ˆå™¨æ¸²æŸ“çœŸå® DOMã€çœŸå® DOM å¯¹è±¡å·²ç»åˆ›å»ºäº†ã€‘ï¼Œä¼˜å…ˆæ‰§è¡Œ Effect é“¾è¡¨ä¸­çš„ callbackï¼›</strong></p><p><strong>useEffect ä¸ä¼šé˜»å¡æµè§ˆå™¨æ¸²æŸ“çœŸå® DOMï¼Œåœ¨æ¸²æŸ“çœŸå® DOM çš„åŒæ—¶ï¼Œå»æ‰§è¡Œ Effect é“¾è¡¨ä¸­çš„ callback</strong></p><ul><li>å®ƒä»¬é‡Œé¢çš„å›è°ƒå‡½æ•°<strong>éƒ½æ˜¯æ”¾åœ¨ effect é“¾è¡¨</strong>ä¸­çš„ï¼Œä½†æ˜¯ useLayoutEffect è®¾ç½®çš„ callback è¦<strong>ä¼˜å…ˆ</strong>äº useEffect å»æ‰§è¡Œ</li><li>åœ¨ä¸¤è€…è®¾ç½®çš„ callback ä¸­ï¼Œ<strong>ä¾ç„¶å¯ä»¥è·å– DOM å…ƒç´ </strong>ã€ŒåŸå› ï¼šçœŸå® DOM å¯¹è±¡å·²ç»åˆ›å»ºäº†ï¼ŒåŒºåˆ«åªæ˜¯æµè§ˆå™¨æ˜¯å¦æ¸²æŸ“ã€</li><li>å¦‚æœåœ¨ callback å‡½æ•°ä¸­åˆä¿®æ”¹äº†çŠ¶æ€å€¼ã€Œè§†å›¾åˆè¦æ›´æ–°ã€<ul><li>useEffect:æµè§ˆå™¨è‚¯å®šæ˜¯æŠŠç¬¬ä¸€æ¬¡çš„çœŸå®å·²ç»ç»˜åˆ¶äº†ï¼Œå†å»æ¸²æŸ“ç¬¬äºŒæ¬¡çœŸå® DOMã€é¢‘ç¹åˆ‡æ¢æœ‰é—ªçƒã€‘</li><li>useLayoutEffect:æµè§ˆå™¨æ˜¯æŠŠä¸¤æ¬¡çœŸå® DOM çš„æ¸²æŸ“ï¼Œ<strong>åˆå¹¶åœ¨ä¸€èµ·æ¸²æŸ“</strong>çš„ã€é¢‘ç¹åˆ‡æ¢æ— é—ªçƒã€‘</li></ul></li></ul><h3 id="è§†å›¾æ›´æ–°å‘¨æœŸï¼š"><a href="#è§†å›¾æ›´æ–°å‘¨æœŸï¼š" class="headerlink" title="è§†å›¾æ›´æ–°å‘¨æœŸï¼š"></a>è§†å›¾æ›´æ–°å‘¨æœŸï¼š</h3><p><strong>ç¬¬ä¸€æ­¥ï¼šåŸºäº babel-preset-react-app æŠŠ JSX ç¼–è¯‘ä¸º createElement æ ¼å¼</strong></p><p><strong>ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œ createElement(â€¦)æ–¹æ³•ï¼Œåˆ›å»ºå‡º virtualDOM</strong></p><p><strong>ç¬¬ä¸‰æ­¥ï¼šåŸºäº root.render æ–¹æ³•æŠŠ virtualDOM å˜ä¸ºçœŸå® DOM å¯¹è±¡ã€ŒDOM-DIFFã€</strong></p><p><strong>useLayoutEffect é˜»å¡æµè§ˆå™¨ç»˜åˆ¶ï¼šåœ¨æ•´ä¸ªè§†å›¾æ¸²æŸ“æ›´æ–°å‘¨æœŸä¸­ï¼Œåˆ›å»ºå‡ºçœŸå® DOM ä»¥åç›´æ¥æ‰§è¡Œ useLayoutEffect çš„ effect é“¾è¡¨ä¸­çš„æ–¹æ³•ã€‚å¦‚æœè¯¥æ–¹æ³•æœ‰ setXXX æ“ä½œï¼Œé‚£ä¹ˆä¼šç›´æ¥è¿›å…¥ä¸‹ä¸€æ¬¡æ›´æ–°å‘¨æœŸä¸­ï¼Œè€Œä¸ä¼šæ‰§è¡Œç¬¬å››æ­¥ã€‚å› æ­¤æ— è®ºè§†å›¾æ›´æ–°çš„è¿‡ç¨‹æ‰§è¡Œäº†å¤šå°‘æ¬¡ï¼Œç•Œé¢æ°¸è¿œåªçœ‹åˆ°äº†ä¸€æ¬¡å˜åŒ–ï¼Œå³ã€é¢‘ç¹åˆ‡æ¢æ— é—ªçƒã€‘</strong></p><p><strong>useEffect ä¸é˜»å¡æµè§ˆå™¨ç»˜åˆ¶ï¼šåœ¨ React æ¸²æŸ“å®ŒçœŸå® DOM ä¹‹åã€æµè§ˆå™¨ç»˜åˆ¶å®Œæ¯•ä¹‹å‰ä¼šæ‰§è¡Œ effect é“¾è¡¨ä¸­çš„æ–¹æ³•ï¼ŒåŒæ—¶ç¬¬å››æ­¥ä¹Ÿä¼šå¼‚æ­¥æ‰§è¡Œã€‚å¦‚æœ effect é“¾è¡¨ä¸­çš„æ–¹æ³•æœ‰ setXXX æ“ä½œï¼Œé‚£ä¹ˆä¼šç›´æ¥è¿›å…¥ä¸‹ä¸€æ¬¡æ›´æ–°å‘¨æœŸä¸­ï¼ŒåŒæ—¶ä¸Šä¸€æ¬¡æ›´æ–°å‘¨æœŸä¸­çš„ç¬¬å››æ­¥è¿˜åœ¨æ‰§è¡Œï¼Œæµè§ˆå™¨è¿˜åœ¨é‡ç»˜ã€‚å¦‚æœåœ¨ useEffect ä¸­é¢‘ç¹è§¦å‘æ›´æ–°ï¼Œåå°ä¼šå¼‚æ­¥è¿è¡Œå¤šä¸ªâ€œç¬¬å››æ­¥â€ï¼Œç”±äºæµè§ˆå™¨ç»˜åˆ¶æ˜¯éœ€è¦ä¸€å®šæ—¶é—´çš„ï¼Œå› æ­¤å¯¹äºé€Ÿåº¦è¾ƒæ…¢çš„è®¾å¤‡ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°å¤šæ¬¡é‡ç»˜ä¹‹é—´çš„â€œç™½å±â€ï¼Œå³ã€é¢‘ç¹åˆ‡æ¢æœ‰é—ªçƒã€‘</strong></p><p><strong>ç¬¬å››æ­¥ï¼šæµè§ˆå™¨æ¸²æŸ“å’Œç»˜åˆ¶çœŸå® DOM å¯¹è±¡</strong></p><p><strong>ä»è§†å›¾æ›´æ–°å‘¨æœŸå¯ä»¥çœ‹å‡ºï¼ŒuseLayoutEffect å’Œ useEffect éƒ½æ˜¯å¯ä»¥è·å–çœŸå® DOM çš„æ—¶æœº</strong></p><h3 id="å®˜æ–¹æ–‡æ¡£ç¤ºä¾‹å‚è€ƒ"><a href="#å®˜æ–¹æ–‡æ¡£ç¤ºä¾‹å‚è€ƒ" class="headerlink" title="å®˜æ–¹æ–‡æ¡£ç¤ºä¾‹å‚è€ƒ"></a>å®˜æ–¹æ–‡æ¡£ç¤ºä¾‹å‚è€ƒ</h3><p><a href="https://react.docschina.org/reference/react/useLayoutEffect#usage">https://react.docschina.org/reference/react/useLayoutEffect#usage</a></p>]]></content>
    
    
    <categories>
      
      <category>react</category>
      
      <category>hooks</category>
      
    </categories>
    
    
    <tags>
      
      <tag>react</tag>
      
      <tag>useLayoutEffect</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>useStateæ·±å±‚å‰–æ</title>
    <link href="/2023/06/14/useState/"/>
    <url>/2023/06/14/useState/</url>
    
    <content type="html"><![CDATA[<h2 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h2><p>ä½œç”¨ï¼šåœ¨å‡½æ•°ç»„ä»¶ä¸­ä½¿ç”¨çŠ¶æ€ï¼Œä¿®æ”¹çŠ¶æ€å€¼å¯è®©å‡½æ•°ç»„ä»¶æ›´æ–°ï¼Œç±»ä¼¼äºç±»ç»„ä»¶ä¸­çš„ setState</p><p>è¯­æ³•ï¼š</p><p>const [state, setState] &#x3D; useState(initialState);</p><p>è¿”å›ä¸€ä¸ª stateï¼Œä»¥åŠæ›´æ–° state çš„å‡½æ•°</p><p>seXXX(value)ä¿®æ”¹çŠ¶æ€å€¼ä¸º valueï¼Œå¹¶é€šçŸ¥è§†å›¾æ›´æ–°ã€‚æ³¨æ„ï¼Œä¸åŒäºç±»ç»„ä»¶ setState çš„éƒ¨åˆ†æ›´æ–°è¯­æ³•ï¼Œè€Œæ˜¯ç›´æ¥ä¿®æ”¹æˆ value</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-keyword">let</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">10</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setNum</span>(num + <span class="hljs-number">1</span>);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;num&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handler&#125;</span>&gt;</span>æ–°å¢<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡½æ•°ç»„ä»¶ã€Hooks ç»„ä»¶ã€‘ä¸æ˜¯ç±»ç»„ä»¶ï¼Œæ‰€ä»¥æ²¡æœ‰å®ä¾‹çš„æ¦‚å¿µï¼Œè°ƒç”¨ç»„ä»¶ä¸å†æ˜¯åˆ›å»ºç±»çš„å®ä¾‹ï¼Œè€Œæ˜¯æ‰§è¡Œå‡½æ•°å¹¶äº§ç”Ÿä¸€ä¸ªç§æœ‰ä¸Šä¸‹æ–‡è€Œå·²ï¼Œæ‰€ä»¥åœ¨å‡½æ•°ç»„ä»¶ä¸­ä¸æ¶‰åŠ this çš„å¤„ç†</p><h3 id="è®¾è®¡åŸç†"><a href="#è®¾è®¡åŸç†" class="headerlink" title="è®¾è®¡åŸç†"></a><strong>è®¾è®¡åŸç†</strong></h3><p><strong>ç±»ç»„ä»¶åªåœ¨åˆæ¬¡æ¸²æŸ“æ—¶åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œä¹‹åçš„æ›´æ–°éƒ½æ˜¯æŒ‰ç…§ç”Ÿå‘½æµç¨‹èµ°ï¼Œå¹¶ä¸æ˜¯é‡æ–°åˆ›é€ å®ä¾‹ã€‚</strong></p><p><strong>å‡½æ•°ç»„ä»¶çš„æ¯ä¸€æ¬¡æ¸²æŸ“æˆ–æ›´æ–°æ˜¯è®©å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ useState ä¼šè¢«é‡æ–°æ‰§è¡Œï¼Œäº§ç”Ÿä¸€ä¸ªå…¨æ–°çš„ç§æœ‰ä¸Šä¸‹æ–‡ï¼Œå†…éƒ¨çš„ä»£ç ä¹Ÿé‡æ–°æ‰§è¡Œ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// å‡½æ•°ç»„ä»¶æ¯ä¸€æ¬¡æ¸²æŸ“/æ›´æ–°ï¼Œéƒ½å…·å¤‡ç‹¬ç«‹çš„é—­åŒ…</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-keyword">let</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">10</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setNum</span>(<span class="hljs-number">100</span>);<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">//10</span><br>    &#125;, <span class="hljs-number">1000</span>);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;num&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handler&#125;</span>&gt;</span>æ–°å¢<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><ol><li><p><strong>æ‰§è¡Œ handle æ–¹æ³•æ—¶ï¼Œç”±äºæ‰€ç”¨åˆ°çš„ setNum num éƒ½ä¸æ˜¯å½“å‰ä½œç”¨åŸŸçš„ç§æœ‰å˜é‡ï¼Œæ‰€ä»¥é‡Œé¢ä¼šæ²¿ç€ä½œç”¨åŸŸé“¾æ‰¾åˆ°ä¸Šçº§ä¸Šä¸‹æ–‡é‡Œé¢çš„ num å’Œ setNumï¼ˆé—­åŒ…ï¼‰</strong></p></li><li><p><strong>æ¯æ¬¡æ›´æ–°éƒ½é‡æ–°æ‰§è¡Œä¸€æ¬¡å†…éƒ¨çš„ä»£ç ã€éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„ç§æœ‰ä¸Šä¸‹æ–‡å¦‚ EC(DEMO2)ï¼Œæ¶‰åŠçš„å‡½æ•°éœ€è¦è¿›è¡Œé‡æ–°æ„å»ºã€‚è¿™äº›å‡½æ•°çš„ä½œç”¨åŸŸä¼šæ²¿ç€å‡½æ•°çš„ä½œç”¨åŸŸé“¾å‘ä¸ŠæŸ¥æ‰¾ï¼Œæ‰¾åˆ°æ¯ä¸€æ¬¡æ‰§è¡Œ DEMO äº§ç”Ÿçš„æ–°çš„é—­åŒ…</strong></p></li><li><p><strong>æ¯ä¸€æ¬¡æ‰§è¡Œ DEMO å‡½æ•°ï¼Œä¹Ÿä¼šæŠŠ useState é‡æ–°æ‰§è¡Œã€‚ä½†æ˜¯ï¼š</strong></p><ul><li><strong>è¿”å›çš„çŠ¶æ€ï¼šåªæœ‰ç¬¬ä¸€æ¬¡è®¾ç½®çš„åˆå§‹å€¼ä¼šç”Ÿæ•ˆï¼Œå…¶ä½™ä»¥åå†æ‰§è¡Œï¼Œè·å–çš„çŠ¶æ€éƒ½æ˜¯æœ€æ–°çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯åˆå§‹å€¼ã€‚</strong></li><li><strong>è¿”å›çš„ä¿®æ”¹çŠ¶æ€çš„æ–¹æ³•ï¼šæ¯ä¸€æ¬¡éƒ½æ˜¯æ–°çš„æ–¹æ³•å‡½æ•°</strong></li><li><strong>æ¯æ¬¡è¿è¡Œ useState è¿”å›çš„ç»“æœéƒ½ç”¨æ–°çš„ num å’Œ setNum å˜é‡ä¿å­˜ï¼Œå› æ­¤çŠ¶æ€å’Œä¿®æ”¹çŠ¶æ€çš„æ–¹æ³•çš„åœ°å€å’Œä¹‹å‰çš„éƒ½ä¸åŒï¼Œæ˜¯å…¨æ–°çš„</strong></li></ul></li></ol><p><img src="/img/react/useState/useState%E7%9A%84%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6.jpg"></p><p>é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•ç¡®ä¿æ¯ä¸€æ¬¡è·å–çš„æ˜¯æœ€æ–°çŠ¶æ€å€¼ï¼Œè€Œä¸æ˜¯ä¼ é€’çš„åˆå§‹å€¼å‘¢ï¼Ÿ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// æ ¸å¿ƒåŸç†ï¼šé—­åŒ…</span><br><span class="hljs-keyword">var</span> _state; <span class="hljs-comment">// åˆ›å»ºå…¨å±€stateã€‚</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initialState</span>) &#123;<br>  _state = _state | initialState;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setState</span>(<span class="hljs-params">state</span>) &#123;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(_state, value)) <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">&#x27;function&#x27;</span>)&#123;<br>  _state = <span class="hljs-title function_">value</span>(_state) <span class="hljs-comment">// ç›¸å½“äºä¼ å…¥prevalueåï¼Œreturnç»è¿‡å¤„ç†å¾—åˆ°çš„æ–°value</span><br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>  _state = value<br>  &#125;<br>    <span class="hljs-comment">// é€šçŸ¥è§†å›¾æ›´æ–°</span><br>    <span class="hljs-comment">//...é‡æ–°æ¸²æŸ“ç»„ä»¶</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> [_state, setState]; <span class="hljs-comment">// æ•°ç»„æ˜¯æ–°çš„å˜é‡ï¼Œé‡Œé¢çš„æ¯é¡¹è‡ªç„¶ä¹Ÿæ˜¯æ–°çš„ï¼Œæ ˆåœ°å€ä¹Ÿä¸ç›¸åŒ</span><br>&#125;<br><br><span class="hljs-keyword">let</span> [num1, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//åˆå§‹æ—¶num1=0  setNum=setState 0x001</span><br><span class="hljs-title function_">setNum</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">//=&gt;_state=100 é€šçŸ¥è§†å›¾æ›´æ–°</span><br><span class="hljs-comment">// ---</span><br>å†æ¬¡æ‰§è¡Œæ•´ä¸ªå‡½æ•°ç»„ä»¶ï¼Œåœ¨æ‰§è¡Œåˆ°useStateçš„æ—¶å€™ï¼š<br><span class="hljs-keyword">let</span> [num2, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//ç”±äºåˆæ¬¡æ¸²æŸ“æ—¶ï¼Œå…¨å±€stateè¢«èµ‹å€¼äº†ï¼Œä¸å†ä¸ºundefinedï¼Œæ‰€ä»¥ä¸å†èµ‹å€¼ä¸ºinitialState</span><br>åœ¨å†…éƒ¨åˆäº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„setStateï¼Œåœ°å€å’Œä¹‹å‰ä¸åŒï¼Œä½¿ç”¨è¿™æ¬¡æ–°çš„é—­åŒ…ä½œä¸ºçˆ¶çº§ä¸Šä¸‹æ–‡<br>æœ€åè¿”å›æ–°çš„stateå’Œæ–°çš„setStateå¹¶è¢«å£°æ˜ä¸ºæ–°çš„å˜é‡<br>num2=<span class="hljs-number">100</span>  setNum=setState <span class="hljs-number">0x002</span><br></code></pre></td></tr></table></figure><h3 id="setXXX-æ²¿ç€ä½œç”¨åŸŸæŸ¥æ‰¾é—­åŒ…çš„ç†è§£â€”â€”ä¸åŒæ­¥å¼‚æ­¥æ— å…³"><a href="#setXXX-æ²¿ç€ä½œç”¨åŸŸæŸ¥æ‰¾é—­åŒ…çš„ç†è§£â€”â€”ä¸åŒæ­¥å¼‚æ­¥æ— å…³" class="headerlink" title="setXXX æ²¿ç€ä½œç”¨åŸŸæŸ¥æ‰¾é—­åŒ…çš„ç†è§£â€”â€”ä¸åŒæ­¥å¼‚æ­¥æ— å…³"></a>setXXX æ²¿ç€ä½œç”¨åŸŸæŸ¥æ‰¾é—­åŒ…çš„ç†è§£â€”â€”ä¸åŒæ­¥å¼‚æ­¥æ— å…³</h3><p><img src="/img/react/useState/2.png"></p><p><strong>ç¬¬ä¸€ä¸ª setTimeout æ²¿ç€ä½œç”¨åŸŸé“¾æ‰¾åˆ°çš„é—­åŒ…é‡Œçš„ num æ˜¯åˆå§‹æ¸²æŸ“çš„ numï¼Œå’Œ setNum åäº§ç”Ÿçš„æ–°çš„é—­åŒ…ï¼ˆä½œç”¨åŸŸï¼‰æ— å…³ï¼Œå› æ­¤è¾“å‡º 0</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Demo</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handle</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setNum</span>(<span class="hljs-number">100</span>);<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">// 0</span><br>    &#125;, <span class="hljs-number">2000</span>);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;demo&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span>&gt;</span>&#123;num&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;small&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handle&#125;</span>&gt;</span></span><br><span class="language-xml">        æ–°å¢</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Demo</span>;<br></code></pre></td></tr></table></figure><h3 id="æ›´æ–°å¤šçŠ¶æ€"><a href="#æ›´æ–°å¤šçŠ¶æ€" class="headerlink" title="æ›´æ–°å¤šçŠ¶æ€"></a>æ›´æ–°å¤šçŠ¶æ€</h3><h4 id="æ–¹æ¡ˆä¸€ï¼šç±»ä¼¼äºç±»ç»„ä»¶ä¸­ä¸€æ ·ï¼Œè®©çŠ¶æ€å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆåŒ…å«éœ€è¦çš„å…¨éƒ¨çŠ¶æ€ï¼‰ï¼Œæ¯ä¸€æ¬¡åªä¿®æ”¹å…¶ä¸­çš„ä¸€ä¸ªçŠ¶æ€å€¼â€”â€”setXXX-ä¸æ”¯æŒç±»ç»„ä»¶-setState-çš„-partial-state-change"><a href="#æ–¹æ¡ˆä¸€ï¼šç±»ä¼¼äºç±»ç»„ä»¶ä¸­ä¸€æ ·ï¼Œè®©çŠ¶æ€å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆåŒ…å«éœ€è¦çš„å…¨éƒ¨çŠ¶æ€ï¼‰ï¼Œæ¯ä¸€æ¬¡åªä¿®æ”¹å…¶ä¸­çš„ä¸€ä¸ªçŠ¶æ€å€¼â€”â€”setXXX-ä¸æ”¯æŒç±»ç»„ä»¶-setState-çš„-partial-state-change" class="headerlink" title="æ–¹æ¡ˆä¸€ï¼šç±»ä¼¼äºç±»ç»„ä»¶ä¸­ä¸€æ ·ï¼Œè®©çŠ¶æ€å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆåŒ…å«éœ€è¦çš„å…¨éƒ¨çŠ¶æ€ï¼‰ï¼Œæ¯ä¸€æ¬¡åªä¿®æ”¹å…¶ä¸­çš„ä¸€ä¸ªçŠ¶æ€å€¼â€”â€”setXXX ä¸æ”¯æŒç±»ç»„ä»¶ setState çš„ partial state change"></a>æ–¹æ¡ˆä¸€ï¼šç±»ä¼¼äºç±»ç»„ä»¶ä¸­ä¸€æ ·ï¼Œè®©çŠ¶æ€å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆåŒ…å«éœ€è¦çš„å…¨éƒ¨çŠ¶æ€ï¼‰ï¼Œæ¯ä¸€æ¬¡åªä¿®æ”¹å…¶ä¸­çš„ä¸€ä¸ªçŠ¶æ€å€¼â€”â€”setXXX ä¸æ”¯æŒç±»ç»„ä»¶ setState çš„ partial state change</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-keyword">let</span> [state, setState] = <span class="hljs-title function_">useState</span>(&#123;<br>    <span class="hljs-attr">x</span>: <span class="hljs-number">10</span>,<br>    <span class="hljs-attr">y</span>: <span class="hljs-number">20</span>,<br>  &#125;);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-comment">// setState(&#123; x: 100 &#125;); //state=&#123;x:100&#125;</span><br>    <span class="hljs-title function_">setState</span>(&#123;<br>      ...state,<br>      <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,<br>    &#125;);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;state.x&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;state.y&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handler&#125;</span>&gt;</span>å¤„ç†<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>é—®é¢˜ï¼šä¸èƒ½åƒç±»ç»„ä»¶çš„ setState å‡½æ•°ä¸€æ ·ï¼Œæ”¯æŒéƒ¨åˆ†çŠ¶æ€æ›´æ–°ï¼</p><h4 id="æ–¹æ¡ˆäºŒï¼šæ‰§è¡Œå¤šæ¬¡-useStateï¼ŒæŠŠä¸åŒçŠ¶æ€åˆ†å¼€è¿›è¡Œç®¡ç†ã€Œæ¨èæ–¹æ¡ˆã€â€”â€”è§£è€¦"><a href="#æ–¹æ¡ˆäºŒï¼šæ‰§è¡Œå¤šæ¬¡-useStateï¼ŒæŠŠä¸åŒçŠ¶æ€åˆ†å¼€è¿›è¡Œç®¡ç†ã€Œæ¨èæ–¹æ¡ˆã€â€”â€”è§£è€¦" class="headerlink" title="æ–¹æ¡ˆäºŒï¼šæ‰§è¡Œå¤šæ¬¡ useStateï¼ŒæŠŠä¸åŒçŠ¶æ€åˆ†å¼€è¿›è¡Œç®¡ç†ã€Œæ¨èæ–¹æ¡ˆã€â€”â€”è§£è€¦"></a>æ–¹æ¡ˆäºŒï¼šæ‰§è¡Œå¤šæ¬¡ useStateï¼ŒæŠŠä¸åŒçŠ¶æ€åˆ†å¼€è¿›è¡Œç®¡ç†ã€Œæ¨èæ–¹æ¡ˆã€â€”â€”è§£è€¦</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-keyword">let</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">10</span>),<br>    [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">20</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setX</span>(<span class="hljs-number">100</span>);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;x&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;y&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handler&#125;</span>&gt;</span>å¤„ç†<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ›´æ–°é˜Ÿåˆ—æœºåˆ¶ã€updaterï¼Œå¼‚æ­¥æ‰¹å¤„ç†ã€‘â€”â€”å¼‚æ­¥å’Œé—­åŒ…æ˜¯ä¸¤ç äº‹"><a href="#æ›´æ–°é˜Ÿåˆ—æœºåˆ¶ã€updaterï¼Œå¼‚æ­¥æ‰¹å¤„ç†ã€‘â€”â€”å¼‚æ­¥å’Œé—­åŒ…æ˜¯ä¸¤ç äº‹" class="headerlink" title="æ›´æ–°é˜Ÿåˆ—æœºåˆ¶ã€updaterï¼Œå¼‚æ­¥æ‰¹å¤„ç†ã€‘â€”â€”å¼‚æ­¥å’Œé—­åŒ…æ˜¯ä¸¤ç äº‹"></a>æ›´æ–°é˜Ÿåˆ—æœºåˆ¶ã€updaterï¼Œå¼‚æ­¥æ‰¹å¤„ç†ã€‘â€”â€”å¼‚æ­¥å’Œé—­åŒ…æ˜¯ä¸¤ç äº‹</h3><p>å’Œç±»ç»„ä»¶ä¸­çš„ setState ä¸€æ ·ï¼Œæ¯æ¬¡æ›´æ–°çŠ¶æ€å€¼ï¼Œä¹Ÿä¸æ˜¯ç«‹å³æ›´æ–°ï¼Œè€Œæ˜¯åˆ©ç”¨äº†æ›´æ–°é˜Ÿåˆ— updater æœºåˆ¶æ¥å¤„ç†</p><p>â‘  é‡åˆ° setState ä¼šç«‹å³å°†å…¶æ”¾å…¥åˆ°<strong>æ›´æ–°é˜Ÿåˆ—</strong>ä¸­ï¼Œæ­¤æ—¶çŠ¶æ€å’Œè§†å›¾è¿˜éƒ½æœªæ›´æ–°</p><p>â‘¡<strong>å½“æ‰€æœ‰çš„ä»£ç æ“ä½œç»“æŸ</strong>ï¼Œä¼šåˆ·æ–°é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯é€šçŸ¥æ›´æ–°é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œï¼šæŠŠ<strong>æ‰€æœ‰æ”¾å…¥çš„ setState åˆå¹¶åœ¨ä¸€èµ·æ‰§è¡Œï¼Œåªè§¦å‘ä¸€æ¬¡çŠ¶æ€æ›´æ–°å’Œè§†å›¾æ›´æ–°</strong></p><ul><li><strong>React 18 å…¨éƒ¨é‡‡ç”¨æ‰¹æ›´æ–°</strong></li><li><strong>React 16 ä¸­ä¹Ÿå’Œ this.setState ä¸€æ ·ï¼Œåªåœ¨åˆæˆäº‹ä»¶&#x2F;ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­å¼‚æ­¥ï¼Œåœ¨å®šæ—¶å™¨ã€æ‰‹åŠ¨ DOM äº‹ä»¶ç»‘å®šç­‰æ“ä½œä¸­åŒæ­¥</strong></li><li><strong>å¯ä»¥åŸºäº flushSync åˆ·æ–°æ¸²æŸ“é˜Ÿåˆ—</strong></li></ul><p><img src="/%60/img/react/useState/image-20230616122123869.png%60" alt="img"></p><h4 id="æ£€éªŒæ–¹å¼ä¸€-åœ¨-handler-é‡Œé¢ä¿®æ”¹-state-ä¹‹åç›´æ¥-log-âŒ"><a href="#æ£€éªŒæ–¹å¼ä¸€-åœ¨-handler-é‡Œé¢ä¿®æ”¹-state-ä¹‹åç›´æ¥-log-âŒ" class="headerlink" title="æ£€éªŒæ–¹å¼ä¸€:åœ¨ handler é‡Œé¢ä¿®æ”¹ state ä¹‹åç›´æ¥ log âŒ"></a>æ£€éªŒæ–¹å¼ä¸€:åœ¨ handler é‡Œé¢ä¿®æ”¹ state ä¹‹åç›´æ¥ log âŒ</h4><p><strong>ä¸èƒ½åœ¨ handler é‡Œé¢ä¿®æ”¹ state ä¹‹åç›´æ¥ logï¼Œå› ä¸ºè¿™æ—¶ log çš„å˜é‡ä»ç„¶æ˜¯ä¸Šä¸€æ¬¡é—­åŒ…ä¸­çš„ï¼Œæ— è®ºåŒæ­¥è¿˜æ˜¯å¼‚æ­¥æ›´æ–°ï¼Œéƒ½åªèƒ½æ˜¯ä¸Šä¸€ä¸ªé—­åŒ…ä¸­çš„å€¼</strong></p><p><strong>å› æ­¤ï¼Œæ¯æ¬¡ log çš„ç»“æœéƒ½æ˜¯ä¸Šä¸€æ¬¡çš„ state</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Button</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;antd&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;./Demo.less&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; flushSync &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-dom&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Demo</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">10</span>),<br>    [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">20</span>),<br>    [z, setZ] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">30</span>);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handle</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setX</span>(x + <span class="hljs-number">1</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x);<br>    <span class="hljs-comment">// 1.å¼‚æ­¥æ‰¹å¤„ç†ï¼šæ‰€æœ‰çš„setXXXæ“ä½œæ”¾åˆ°æ›´æ–°é˜Ÿåˆ—é‡Œé¢ï¼Œæ‰§è¡Œå®Œæ‰€æœ‰æ“ä½œä¹‹åæ‰ä¼šä¸€æ¬¡æ¸…ç©ºæ›´æ–°é˜Ÿåˆ—ï¼Œå› æ­¤console.logå…ˆæ‰§è¡Œ</span><br>    <span class="hljs-comment">// 2.é—­åŒ…ï¼šç”±äºhandleå§‹ç»ˆæ‹¿åˆ°çš„æ˜¯çˆ¶çº§ä½œç”¨åŸŸçš„é—­åŒ…ï¼Œä¹Ÿå°±æ˜¯æ›´æ–°å‰çš„é—­åŒ…</span><br>    <span class="hljs-title function_">setY</span>(y + <span class="hljs-number">1</span>);<br>    <span class="hljs-title function_">setZ</span>(z + <span class="hljs-number">1</span>);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;demo&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span>&gt;</span>x:&#123;x&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span>&gt;</span>y:&#123;y&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span>&gt;</span>z:&#123;z&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;small&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handle&#125;</span>&gt;</span></span><br><span class="language-xml">        æ–°å¢</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Demo</span>;<br></code></pre></td></tr></table></figure><h4 id="æ£€éªŒæ–¹å¼äºŒï¼šæ¯”è¾ƒè¾“å‡ºâ€éªŒè¯å€¼çš„æ¬¡æ•°â€œ"><a href="#æ£€éªŒæ–¹å¼äºŒï¼šæ¯”è¾ƒè¾“å‡ºâ€éªŒè¯å€¼çš„æ¬¡æ•°â€œ" class="headerlink" title="æ£€éªŒæ–¹å¼äºŒï¼šæ¯”è¾ƒè¾“å‡ºâ€éªŒè¯å€¼çš„æ¬¡æ•°â€œ"></a>æ£€éªŒæ–¹å¼äºŒï¼šæ¯”è¾ƒè¾“å‡ºâ€éªŒè¯å€¼çš„æ¬¡æ•°â€œ</h4><p>è‹¥åŒæ­¥æ›´æ–°ï¼Œé‚£ä¹ˆä¼šé¡ºåºè¾“å‡ºâ€œrenderâ€ä¸‰æ¬¡</p><p>è‹¥å¼‚æ­¥æ›´æ–°ï¼Œåˆ™åªåœ¨æœ€åæ‰¹å¤„ç†æ›´æ–°ä¸€æ¬¡ï¼Œæ‰€ä»¥åªè¾“å‡ºä¸€æ¬¡</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Button</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;antd&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;./Demo.less&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; flushSync &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-dom&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Demo</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;RENDERæ¸²æŸ“&quot;</span>);<br>  <span class="hljs-keyword">let</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">10</span>),<br>    [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">20</span>),<br>    [z, setZ] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">30</span>);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handle</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setX</span>(x + <span class="hljs-number">1</span>);<br>    <span class="hljs-title function_">setY</span>(y + <span class="hljs-number">1</span>);<br>    <span class="hljs-title function_">setZ</span>(z + <span class="hljs-number">1</span>);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;demo&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span>&gt;</span>x:&#123;x&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span>&gt;</span>y:&#123;y&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span>&gt;</span>z:&#123;z&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;small&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handle&#125;</span>&gt;</span></span><br><span class="language-xml">        æ–°å¢</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Demo</span>;<br></code></pre></td></tr></table></figure><p><strong>åªæ›´æ–°äº†ä¸€æ¬¡ï¼Œè¯´æ˜æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä¸ä½ç½®æ— å…³</strong></p><p><img src="/img/react/useState/3.png"></p><h4 id="æ›´æ–°é˜Ÿåˆ—-flushSync-è®¾ç½®åŒæ­¥æ“ä½œ"><a href="#æ›´æ–°é˜Ÿåˆ—-flushSync-è®¾ç½®åŒæ­¥æ“ä½œ" class="headerlink" title="æ›´æ–°é˜Ÿåˆ— flushSync è®¾ç½®åŒæ­¥æ“ä½œ"></a>æ›´æ–°é˜Ÿåˆ— flushSync è®¾ç½®åŒæ­¥æ“ä½œ</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; flushSync &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-dom&quot;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;OK&quot;</span>);<br>  <span class="hljs-keyword">let</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">10</span>);<br>  <span class="hljs-keyword">let</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">20</span>);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-comment">/* setX(100);</span><br><span class="hljs-comment">        setY(200); */</span><br><br>    <span class="hljs-comment">/* setTimeout(() =&gt; &#123;</span><br><span class="hljs-comment">            setX(100);</span><br><span class="hljs-comment">            setY(200);</span><br><span class="hljs-comment">        &#125;, 1000); */</span><br><br>    <span class="hljs-title function_">flushSync</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">setX</span>(<span class="hljs-number">100</span>);<br>    &#125;);<br>    <span class="hljs-title function_">setY</span>(<span class="hljs-number">200</span>);<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;x&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;y&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handler&#125;</span>&gt;</span>å¤„ç†<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/react/useState/4.png"></p><h4 id="é€šè¿‡-setXXX-ä¼ å…¥-prev-è·³å‡ºé—­åŒ…"><a href="#é€šè¿‡-setXXX-ä¼ å…¥-prev-è·³å‡ºé—­åŒ…" class="headerlink" title="é€šè¿‡ setXXX ä¼ å…¥(prev) &#x3D;&gt;è·³å‡ºé—­åŒ…"></a>é€šè¿‡ setXXX ä¼ å…¥(prev) &#x3D;&gt;è·³å‡ºé—­åŒ…</h4><h4 id="å¼‚æ­¥æ“ä½œä¸é—­åŒ…å‡½æ•°ä½œç”¨åŸŸä¾‹é¢˜"><a href="#å¼‚æ­¥æ“ä½œä¸é—­åŒ…å‡½æ•°ä½œç”¨åŸŸä¾‹é¢˜" class="headerlink" title="å¼‚æ­¥æ“ä½œä¸é—­åŒ…å‡½æ•°ä½œç”¨åŸŸä¾‹é¢˜"></a>å¼‚æ­¥æ“ä½œä¸é—­åŒ…å‡½æ•°ä½œç”¨åŸŸä¾‹é¢˜</h4><p><img src="/img/react/useState/5.png"></p><p>å¼‚æ­¥ï¼šhandle é‡Œé¢çš„ 10 æ¬¡ setX éƒ½ä¼šæ”¾åœ¨æ›´æ–°é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶ååœ¨å…¶ä»–äº‹æƒ…éƒ½åšå®Œä¹‹åï¼Œæ‰¹å¤„ç†ä¸€æ¬¡æ›´æ–°å®Œæ¯•æ‰€æœ‰é˜Ÿåˆ—ä¸­çš„æ•°æ®å’Œè§†å›¾ï¼Œå› æ­¤åªâ€™RENDER æ¸²æŸ“â€™ä¸€æ¬¡</p><p>é—­åŒ…ï¼šx æœ€åçš„çŠ¶æ€å€¼æ˜¯ 11ï¼Œå› ä¸º handle é‡Œé¢çš„æ‰€æœ‰ x éƒ½æ˜¯åœ¨ä¸Šä¸€çº§é—­åŒ…ä¸­æ‹¿åˆ°çš„ï¼Œéƒ½æ˜¯ 10ï¼Œå› æ­¤æ‰¹å¤„ç†ä¸­ 10 ä¸ª setX éƒ½æ˜¯å°† x æ›´æ–°ä¸º 11</p><h3 id="setXXX-çš„ä¸¤ç§ä¼ å‚æ–¹å¼"><a href="#setXXX-çš„ä¸¤ç§ä¼ å‚æ–¹å¼" class="headerlink" title="setXXX çš„ä¸¤ç§ä¼ å‚æ–¹å¼"></a>setXXX çš„ä¸¤ç§ä¼ å‚æ–¹å¼</h3><h4 id="1-ç›´æ¥ä¼ å…¥æ–°å¯¹è±¡ï¼Œä¸æ”¯æŒ-this-setState-çš„éƒ¨åˆ†æ›´æ–°"><a href="#1-ç›´æ¥ä¼ å…¥æ–°å¯¹è±¡ï¼Œä¸æ”¯æŒ-this-setState-çš„éƒ¨åˆ†æ›´æ–°" class="headerlink" title="1.ç›´æ¥ä¼ å…¥æ–°å¯¹è±¡ï¼Œä¸æ”¯æŒ this.setState çš„éƒ¨åˆ†æ›´æ–°"></a>1.ç›´æ¥ä¼ å…¥æ–°å¯¹è±¡ï¼Œä¸æ”¯æŒ this.setState çš„éƒ¨åˆ†æ›´æ–°</h4><h4 id="2-å‡½æ•°å¼æ›´æ–°â€”â€”é…åˆ-for-å¾ªç¯ã€updater-æœºåˆ¶å¯ä»¥å®ç°ç»“æœç´¯è®¡ã€åªæ›´æ–°çŠ¶æ€å’Œè§†å›¾ä¸€æ¬¡-setXXX-prev-ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³-updater-çš„é—­åŒ…é—®é¢˜"><a href="#2-å‡½æ•°å¼æ›´æ–°â€”â€”é…åˆ-for-å¾ªç¯ã€updater-æœºåˆ¶å¯ä»¥å®ç°ç»“æœç´¯è®¡ã€åªæ›´æ–°çŠ¶æ€å’Œè§†å›¾ä¸€æ¬¡-setXXX-prev-ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³-updater-çš„é—­åŒ…é—®é¢˜" class="headerlink" title="2.å‡½æ•°å¼æ›´æ–°â€”â€”é…åˆ for å¾ªç¯ã€updater æœºåˆ¶å¯ä»¥å®ç°ç»“æœç´¯è®¡ã€åªæ›´æ–°çŠ¶æ€å’Œè§†å›¾ä¸€æ¬¡ setXXX(prev &#x3D;&gt;)ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³ updater çš„é—­åŒ…é—®é¢˜"></a>2.å‡½æ•°å¼æ›´æ–°â€”â€”é…åˆ for å¾ªç¯ã€updater æœºåˆ¶å¯ä»¥å®ç°ç»“æœç´¯è®¡ã€åªæ›´æ–°çŠ¶æ€å’Œè§†å›¾ä¸€æ¬¡ setXXX(prev &#x3D;&gt;)ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³ updater çš„é—­åŒ…é—®é¢˜</h4><p>å¦‚æœæ–°çš„ state éœ€è¦é€šè¿‡ä½¿ç”¨å…ˆå‰çš„ state è®¡ç®—å¾—å‡ºï¼Œé‚£ä¹ˆå¯ä»¥å°†å‡½æ•°ä¼ é€’ç»™ setStateï¼›è¯¥å‡½æ•°å°†æ¥æ”¶å…ˆå‰çš„ stateï¼Œå¹¶è¿”å›ä¸€ä¸ªæ›´æ–°åçš„å€¼ï¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">10</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>      <span class="hljs-comment">// å‡½æ•°å¼æ›´æ–°</span><br>      <span class="hljs-title function_">setNum</span>(<span class="hljs-function">(<span class="hljs-params">num</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">return</span> num + <span class="hljs-number">1</span>;<br>      &#125;);<br>    &#125;<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;num&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handler&#125;</span>&gt;</span>å¤„ç†<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// æ ¸å¿ƒåŸç†ï¼šé—­åŒ…</span><br><span class="hljs-keyword">var</span> _state; <span class="hljs-comment">// åˆ›å»ºå…¨å±€stateã€‚</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initialState</span>) &#123;<br>  _state = _state | initialState;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> _state === <span class="hljs-string">&#x27;undefined&#x27;</span>)&#123;<br>      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> initialState === <span class="hljs-string">&#x27;function&#x27;</span>)&#123;<br>          _state = <span class="hljs-title function_">initialState</span>();<br>      &#125;<span class="hljs-keyword">else</span>&#123;<br>          _state = initialState;<br>      &#125;<br>  &#125;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setState</span>(<span class="hljs-params">state</span>) &#123;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(_state, value)) <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">&#x27;function&#x27;</span>)&#123;<br>  _state = <span class="hljs-title function_">value</span>(_state) <span class="hljs-comment">// ç›¸å½“äºä¼ å…¥prevalueåï¼Œreturnç»è¿‡å¤„ç†å¾—åˆ°çš„æ–°value</span><br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>  _state = value<br>  &#125;<br>    <span class="hljs-comment">// é€šçŸ¥è§†å›¾æ›´æ–°</span><br>    <span class="hljs-comment">//...é‡æ–°æ¸²æŸ“ç»„ä»¶</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> [_state, setState]; <span class="hljs-comment">// æ•°ç»„æ˜¯æ–°çš„å˜é‡ï¼Œé‡Œé¢çš„æ¯é¡¹è‡ªç„¶ä¹Ÿæ˜¯æ–°çš„ï¼Œæ ˆåœ°å€ä¹Ÿä¸ç›¸åŒ</span><br>&#125;<br><br><span class="hljs-keyword">let</span> [num1, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//åˆå§‹æ—¶num1=0  setNum=setState 0x001</span><br><span class="hljs-title function_">setNum</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">//=&gt;_state=100 é€šçŸ¥è§†å›¾æ›´æ–°</span><br><span class="hljs-comment">// ---</span><br>å†æ¬¡æ‰§è¡Œæ•´ä¸ªå‡½æ•°ç»„ä»¶ï¼Œåœ¨æ‰§è¡Œåˆ°useStateçš„æ—¶å€™ï¼š<br><span class="hljs-keyword">let</span> [num2, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//ç”±äºåˆæ¬¡æ¸²æŸ“æ—¶ï¼Œå…¨å±€stateè¢«èµ‹å€¼äº†ï¼Œä¸å†ä¸ºundefinedï¼Œæ‰€ä»¥ä¸å†èµ‹å€¼ä¸ºinitialState</span><br>åœ¨å†…éƒ¨åˆäº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„setStateï¼Œåœ°å€å’Œä¹‹å‰ä¸åŒï¼Œä½¿ç”¨è¿™æ¬¡æ–°çš„é—­åŒ…ä½œä¸ºçˆ¶çº§ä¸Šä¸‹æ–‡<br>æœ€åè¿”å›æ–°çš„stateå’Œæ–°çš„setStateå¹¶è¢«å£°æ˜ä¸ºæ–°çš„å˜é‡<br>num2=<span class="hljs-number">100</span>  setNum=setState <span class="hljs-number">0x002</span><br></code></pre></td></tr></table></figure><h3 id="æƒ°æ€§åˆå§‹-stateâ€”â€”å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘åªæ‰§è¡Œä¸€æ¬¡"><a href="#æƒ°æ€§åˆå§‹-stateâ€”â€”å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘åªæ‰§è¡Œä¸€æ¬¡" class="headerlink" title="æƒ°æ€§åˆå§‹ stateâ€”â€”å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘åªæ‰§è¡Œä¸€æ¬¡"></a>æƒ°æ€§åˆå§‹ stateâ€”â€”å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘åªæ‰§è¡Œä¸€æ¬¡</h3><p>å¦‚æœåˆå§‹ state éœ€è¦é€šè¿‡å¤æ‚è®¡ç®—è·å¾—ï¼Œåˆ™å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨å‡½æ•°ä¸­è®¡ç®—å¹¶è¿”å›åˆå§‹çš„ stateï¼Œ<strong>æ­¤å‡½æ•°åªåœ¨åˆå§‹æ¸²æŸ“æ—¶è¢«è°ƒç”¨ï¼Œä¹‹åæ›´æ–°è§†å›¾ä»¥åï¼ŒçŠ¶æ€å€¼ä¸å†æ˜¯ undefinedï¼Œæ‰€ä»¥ä¸ä¼šå†æ‰§è¡Œåˆå§‹çš„æƒ°æ€§å›è°ƒ</strong>ï¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-keyword">let</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> &#123; x, y &#125; = props;<br>    <span class="hljs-keyword">return</span> x + y;<br>  &#125;);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;num&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼šå¦‚æœå°†å›è°ƒé‡Œçš„é€»è¾‘å†™åˆ°å¤–é¢ï¼Œåˆ™ä¸€æ—¦è§†å›¾æ›´æ–°ï¼Œä¸ç®¡æ˜¯ç¬¬ä¸€æ¬¡è¿˜æ˜¯åç»­æ›´æ–°çš„æ—¶å€™ï¼Œè¿™æ®µé€»è¾‘éƒ½ä¼šæ‰§è¡Œã€‚<strong>å³ä½¿åœ¨æ›´æ–°é˜¶æ®µï¼Œnum ä¸å†æ˜¯ undefinedï¼Œåˆå§‹å€¼ä¸å†ç”Ÿæ•ˆï¼Œè¿™æ®µé€»è¾‘ä¾ç„¶ä¼šæ‰§è¡Œï¼Œæµªè´¹èµ„æºæ•ˆç‡ä½ä¸‹</strong></p><img src="/img/react/useState/image-20230616150504612.png" alt="image-20230616150504612" style="zoom:67%;" /><h3 id="useState-æ€§èƒ½ä¼˜åŒ–æœºåˆ¶â€”â€”Object-is-ç±»ä¼¼-PureComponent-çš„æµ…æ¯”è¾ƒ"><a href="#useState-æ€§èƒ½ä¼˜åŒ–æœºåˆ¶â€”â€”Object-is-ç±»ä¼¼-PureComponent-çš„æµ…æ¯”è¾ƒ" class="headerlink" title="useState æ€§èƒ½ä¼˜åŒ–æœºåˆ¶â€”â€”Object.is ç±»ä¼¼ PureComponent çš„æµ…æ¯”è¾ƒ"></a>useState æ€§èƒ½ä¼˜åŒ–æœºåˆ¶â€”â€”Object.is ç±»ä¼¼ PureComponent çš„æµ…æ¯”è¾ƒ</h3><p>useState è‡ªå¸¦äº†æ€§èƒ½ä¼˜åŒ–çš„æœºåˆ¶ï¼š</p><ul><li><strong>æ¯ä¸€æ¬¡ä¿®æ”¹çŠ¶æ€å€¼çš„æ—¶å€™ï¼Œä¼šæ‹¿æœ€æ–°è¦ä¿®æ”¹çš„å€¼å’Œä¹‹å‰çš„çŠ¶æ€å€¼åšæ¯”è¾ƒã€ŒåŸºäº Object.is ä½œæ¯”è¾ƒï¼Œè€Œä¸æ˜¯æ›´ä¸¥æ ¼çš„&#x3D;&#x3D;&#x3D;ã€‚å¦‚æœå‰åçŠ¶æ€éƒ½æ˜¯ NaNï¼ŒObject.is è¿”å› true ä¸æ›´æ–°çŠ¶æ€å’Œè§†å›¾ï¼Œ&#x3D;&#x3D;&#x3D;è¿”å› false æ›´æ–°çŠ¶æ€å’Œè§†å›¾ã€</strong></li><li><strong>å¦‚æœå‘ç°ä¸¤æ¬¡çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œåˆ™ä¸ä¼šä¿®æ”¹çŠ¶æ€ï¼Œä¹Ÿä¸ä¼šè®©è§†å›¾æ›´æ–°ã€Œå¯ä»¥ç†è§£ä¸ºï¼šç±»ä¼¼äº PureComponentï¼Œåœ¨ shouldComponentUpdate ä¸­åšäº†æµ…æ¯”è¾ƒå’Œä¼˜åŒ–ï¼Œæ³¨æ„å‡½æ•°ç»„ä»¶ä¸­ä¸å¯èƒ½æœ‰ PureComponentã€</strong></li></ul><p>è°ƒç”¨ State Hook çš„æ›´æ–°å‡½æ•°ï¼Œå¹¶ä¼ å…¥å½“å‰çš„ state æ—¶ï¼ŒReact å°†è·³è¿‡ç»„ä»¶çš„æ¸²æŸ“ï¼ˆåŸå› ï¼šReact ä½¿ç”¨ Object.is æ¯”è¾ƒç®—æ³•ï¼Œæ¥æ¯”è¾ƒæ–°è€ stateï¼›æ³¨æ„ä¸æ˜¯å› ä¸º DOM-DIFFï¼›ï¼‰ï¼</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;render&quot;</span>);<br>  <span class="hljs-keyword">let</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">10</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;num&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">          setNum(num);</span><br><span class="language-xml">        &#125;&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        å¤„ç†</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// æ ¸å¿ƒåŸç†ï¼šé—­åŒ…</span><br><span class="hljs-keyword">var</span> _state; <span class="hljs-comment">// åˆ›å»ºå…¨å±€stateã€‚</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initialState</span>) &#123;<br>  _state = _state | initialState;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setState</span>(<span class="hljs-params">state</span>) &#123;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(_state, value)) <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">&#x27;function&#x27;</span>)&#123;<br>  _state = <span class="hljs-title function_">value</span>(_state) <span class="hljs-comment">// ç›¸å½“äºä¼ å…¥prevalueåï¼Œreturnç»è¿‡å¤„ç†å¾—åˆ°çš„æ–°value</span><br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>  _state = value<br>  &#125;<br>    <span class="hljs-comment">// é€šçŸ¥è§†å›¾æ›´æ–°</span><br>    <span class="hljs-comment">//...é‡æ–°æ¸²æŸ“ç»„ä»¶</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> [_state, setState]; <span class="hljs-comment">// æ•°ç»„æ˜¯æ–°çš„å˜é‡ï¼Œé‡Œé¢çš„æ¯é¡¹è‡ªç„¶ä¹Ÿæ˜¯æ–°çš„ï¼Œæ ˆåœ°å€ä¹Ÿä¸ç›¸åŒ</span><br>&#125;<br><span class="hljs-keyword">let</span> [num1, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//åˆå§‹æ—¶num1=0  setNum=setState 0x001</span><br><span class="hljs-title function_">setNum</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">//=&gt;_state=100 é€šçŸ¥è§†å›¾æ›´æ–°</span><br><span class="hljs-comment">// ---</span><br>å†æ¬¡æ‰§è¡Œæ•´ä¸ªå‡½æ•°ç»„ä»¶ï¼Œåœ¨æ‰§è¡Œåˆ°useStateçš„æ—¶å€™ï¼š<br><span class="hljs-keyword">let</span> [num2, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//ç”±äºåˆæ¬¡æ¸²æŸ“æ—¶ï¼Œå…¨å±€stateè¢«èµ‹å€¼äº†ï¼Œä¸å†ä¸ºundefinedï¼Œæ‰€ä»¥ä¸å†èµ‹å€¼ä¸ºinitialState</span><br>åœ¨å†…éƒ¨åˆäº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„setStateï¼Œåœ°å€å’Œä¹‹å‰ä¸åŒï¼Œä½¿ç”¨è¿™æ¬¡æ–°çš„é—­åŒ…ä½œä¸ºçˆ¶çº§ä¸Šä¸‹æ–‡<br>æœ€åè¿”å›æ–°çš„stateå’Œæ–°çš„setStateå¹¶è¢«å£°æ˜ä¸ºæ–°çš„å˜é‡<br>num2=<span class="hljs-number">100</span>  setNum=setState <span class="hljs-number">0x002</span><br></code></pre></td></tr></table></figure><h4 id="ä¾‹-1-å‰å-state-æµ…æ¯”è¾ƒ-trueï¼Œä¸æ›´æ–°çŠ¶æ€å’Œè§†å›¾"><a href="#ä¾‹-1-å‰å-state-æµ…æ¯”è¾ƒ-trueï¼Œä¸æ›´æ–°çŠ¶æ€å’Œè§†å›¾" class="headerlink" title="ä¾‹ 1 å‰å state æµ…æ¯”è¾ƒ trueï¼Œä¸æ›´æ–°çŠ¶æ€å’Œè§†å›¾"></a>ä¾‹ 1 å‰å state æµ…æ¯”è¾ƒ trueï¼Œä¸æ›´æ–°çŠ¶æ€å’Œè§†å›¾</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Button</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;antd&quot;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">UseStateDemo</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">UseStateDemo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;RENDER&quot;</span>);<br>  <span class="hljs-keyword">let</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">10</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handle</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setX</span>(<span class="hljs-number">10</span>);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;UseStateDemo&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span>&gt;</span>x:&#123;x&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;small&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handle&#125;</span>&gt;</span></span><br><span class="language-xml">        æ–°å¢</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">UseStateDemo</span>;<br></code></pre></td></tr></table></figure><p>ä¸æ›´æ–°è§†å›¾å’ŒçŠ¶æ€</p><h4 id="ä¾‹-2-æ›´æ–°å¤šæ¬¡ï¼Œæœ€ç»ˆå€¼-11"><a href="#ä¾‹-2-æ›´æ–°å¤šæ¬¡ï¼Œæœ€ç»ˆå€¼-11" class="headerlink" title="ä¾‹ 2 æ›´æ–°å¤šæ¬¡ï¼Œæœ€ç»ˆå€¼ 11"></a>ä¾‹ 2 æ›´æ–°å¤šæ¬¡ï¼Œæœ€ç»ˆå€¼ 11</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Button</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;antd&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; flushSync &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-dom&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">UseStateDemo</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">UseStateDemo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;RENDER&quot;</span>);<br>  <span class="hljs-keyword">let</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">10</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handle</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>      <span class="hljs-title function_">flushSync</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">setX</span>(x + <span class="hljs-number">1</span>);<br>      &#125;);<br>    &#125;<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;UseStateDemo&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;num&quot;</span>&gt;</span>x:&#123;x&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;small&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handle&#125;</span>&gt;</span></span><br><span class="language-xml">        æ–°å¢</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">UseStateDemo</span>;<br></code></pre></td></tr></table></figure><p>render ä¸¤æ¬¡ï¼ˆç†è®ºä¸Šæ˜¯ä¸€æ¬¡ï¼Œè¿™é‡Œæ˜¯å› ä¸ºè¿™äº›æ“ä½œä½œç”¨çš„éƒ½æ˜¯ä¸€ä¸ªé—­åŒ…ä¸­çš„åŒä¸€ä¸ªçŠ¶æ€å€¼ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ”¹çŠ¶æ€è¿˜æ²¡æ”¹æˆåŠŸä¹‹å‰ï¼Œå…¶ä»–æ¬¡æ“ä½œè®¿é—®çš„çŠ¶æ€å€¼ä»æ—§æ˜¯è¿˜æ²¡æ”¹çš„ 10ï¼Œç›´åˆ°ç¬¬ä¸€æ¬¡æ”¹çŠ¶æ€æˆåŠŸï¼Œå‰©ä½™æ¬¡æ“ä½œä¸ä¼šå†é€šè¿‡ Object.is çš„æµ‹è¯•ã€‚è¿™é‡Œ render æ¬¡æ•°å’Œæµè§ˆå™¨çš„æ•ˆç‡æœ‰å…³ï¼Œä¸è¿‡ç»å¯¹ä¸æ˜¯ 10 æ¬¡ ï¼‰ï¼Œæœ€åçŠ¶æ€å€¼æ˜¯ 11</p><p><img src="/img/react/useState/6.png"></p><p>åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶åˆ›é€ å‡ºæ¥é¡¶çº§çš„å‡½æ•°ä½œç”¨åŸŸï¼Œ_state ç§æœ‰å±æ€§å°±æ˜¯åœ¨è¿™ä¸ªé¡¶çº§ä½œç”¨åŸŸé‡Œé¢çš„</p><p>ç‚¹å‡» handle ä¹‹åä¼šæ‰§è¡Œ 10 æ¬¡åŒæ­¥æ¸…ç©ºæ›´æ–°é˜Ÿåˆ—çš„æ“ä½œ</p><p>åœ¨ç¬¬ä¸€æ¬¡ flushSyncï¼Œæ›´æ–°é˜Ÿåˆ—é‡Œåªæœ‰ä¸€ä¸ª setXï¼Œç«‹å³åŒæ­¥æ‰§è¡Œï¼Œä½¿ç”¨çš„æ˜¯ç¬¬ä¸€æ¬¡ Demo åˆ›å»ºå‡ºæ¥çš„ EC çš„é—­åŒ…ä¸­çš„ stateï¼Œä¹Ÿå°±æ˜¯ 10ã€‚è¿›å…¥ setXï¼Œé€šè¿‡äº† Object.is çš„æ¯”è¾ƒï¼Œæ›´æ–°çŠ¶æ€å’Œè§†å›¾ï¼Œæ­¤æ—¶æœ€å¤–éƒ¨çš„_state ä¹Ÿè¢«æ›´æ–°ä¸º 11</p><p>ç¬¬äºŒæ¬¡ flushSyncï¼Œæ›´æ–°é˜Ÿåˆ—é‡Œåªæœ‰ä¸€ä¸ª setXï¼Œç«‹å³åŒæ­¥æ‰§è¡Œï¼Œä½¿ç”¨çš„ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡ Demo åˆ›å»ºå‡ºæ¥çš„ EC çš„é—­åŒ…ä¸­çš„ stateï¼ˆå› ä¸ºè¿™äº› flushSync æ–¹æ³•éƒ½å­˜åœ¨äºç¬¬ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼‰ï¼Œä¹Ÿå°±æ˜¯ 10ã€‚è¿›å…¥ setXï¼Œæœªé€šè¿‡äº† Object.is çš„æ¯”è¾ƒï¼Œå› æ­¤ä¸æ›´æ–°çŠ¶æ€å’Œè§†å›¾</p><p>ç¬¬ä¸‰ã€‚ã€‚ã€‚åè½®åŒæ ·ä¸æ›´æ–°</p><h4 id="ä¾‹-3-æ›´æ–°-1-æ¬¡ï¼Œæœ€ç»ˆå€¼-20-â€”â€”å‡½æ•°å¼æ›´æ–°"><a href="#ä¾‹-3-æ›´æ–°-1-æ¬¡ï¼Œæœ€ç»ˆå€¼-20-â€”â€”å‡½æ•°å¼æ›´æ–°" class="headerlink" title="ä¾‹ 3 æ›´æ–° 1 æ¬¡ï¼Œæœ€ç»ˆå€¼ 20 â€”â€”å‡½æ•°å¼æ›´æ–°"></a>ä¾‹ 3 æ›´æ–° 1 æ¬¡ï¼Œæœ€ç»ˆå€¼ 20 â€”â€”å‡½æ•°å¼æ›´æ–°</h4><p><img src="/img/react/useState/7.png"></p>]]></content>
    
    
    <categories>
      
      <category>react</category>
      
      <category>hooks</category>
      
    </categories>
    
    
    <tags>
      
      <tag>react</tag>
      
      <tag>useState</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react hooksç®€ä»‹</title>
    <link href="/2023/06/01/Hooks%E7%BB%84%E4%BB%B6%E7%AE%80%E4%BB%8B/"/>
    <url>/2023/06/01/Hooks%E7%BB%84%E4%BB%B6%E7%AE%80%E4%BB%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="React-ç»„ä»¶å›é¡¾"><a href="#React-ç»„ä»¶å›é¡¾" class="headerlink" title="React ç»„ä»¶å›é¡¾"></a>React ç»„ä»¶å›é¡¾</h2><h3 id="å‡½æ•°ç»„ä»¶ç‰¹ç‚¹"><a href="#å‡½æ•°ç»„ä»¶ç‰¹ç‚¹" class="headerlink" title="å‡½æ•°ç»„ä»¶ç‰¹ç‚¹"></a>å‡½æ•°ç»„ä»¶ç‰¹ç‚¹</h3><ul><li>ä¸å…·å¤‡â€œçŠ¶æ€ã€refã€å‘¨æœŸå‡½æ•°â€ç­‰å†…å®¹ï¼Œç¬¬ä¸€æ¬¡æ¸²æŸ“å®Œæ¯•åï¼Œæ— æ³•åŸºäºç»„ä»¶å†…éƒ¨çš„æ“ä½œæ¥æ§åˆ¶å…¶æ›´æ–°ï¼Œå› æ­¤ç§°ä¹‹ä¸ºé™æ€ç»„ä»¶ï¼</li><li>ä½†æ˜¯å…·å¤‡å±æ€§åŠæ’æ§½ï¼Œçˆ¶ç»„ä»¶å¯ä»¥æ§åˆ¶å…¶é‡æ–°æ¸²æŸ“ï¼</li><li>æ¸²æŸ“æµç¨‹ç®€å•ï¼Œæ¸²æŸ“é€Ÿåº¦è¾ƒå¿«ï¼</li><li>åŸºäº FPï¼ˆå‡½æ•°å¼ç¼–ç¨‹ï¼‰æ€æƒ³è®¾è®¡ï¼Œæä¾›æ›´ç»†ç²’åº¦çš„é€»è¾‘ç»„ç»‡å’Œå¤ç”¨ï¼</li><li><strong>çº¯å‡½æ•°ç»„ä»¶ï¼Œæ— æ³•æ”¹çŠ¶æ€</strong></li></ul><h3 id="ç±»ç»„ä»¶ç‰¹ç‚¹"><a href="#ç±»ç»„ä»¶ç‰¹ç‚¹" class="headerlink" title="ç±»ç»„ä»¶ç‰¹ç‚¹"></a>ç±»ç»„ä»¶ç‰¹ç‚¹</h3><ul><li>å…·å¤‡â€œçŠ¶æ€ã€refã€å‘¨æœŸå‡½æ•°ã€å±æ€§ã€æ’æ§½â€ç­‰å†…å®¹ï¼Œå¯ä»¥çµæ´»çš„æ§åˆ¶ç»„ä»¶æ›´æ–°ï¼ŒåŸºäºé’©å­å‡½æ•°ä¹Ÿå¯çµæ´»æŒæ§ä¸åŒé˜¶æ®µå¤„ç†ä¸åŒçš„äº‹æƒ…ï¼</li><li>æ¸²æŸ“æµç¨‹ç¹çï¼Œæ¸²æŸ“é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼</li><li>åŸºäº OOPï¼ˆé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰æ€æƒ³è®¾è®¡ï¼Œæ›´æ–¹ä¾¿å®ç°ç»§æ‰¿ç­‰ï¼</li></ul><h3 id="React-Hooks-ç»„ä»¶"><a href="#React-Hooks-ç»„ä»¶" class="headerlink" title="React Hooks ç»„ä»¶"></a>React Hooks ç»„ä»¶</h3><p>å°±æ˜¯åŸºäº React ä¸­æ–°æä¾›çš„ Hook å‡½æ•°ï¼Œå¯ä»¥ <code>è®©å‡½æ•°ç»„ä»¶åŠ¨æ€åŒ–</code>!</p><h2 id="Hook-å‡½æ•°æ¦‚è§ˆ"><a href="#Hook-å‡½æ•°æ¦‚è§ˆ" class="headerlink" title="Hook å‡½æ•°æ¦‚è§ˆ"></a>Hook å‡½æ•°æ¦‚è§ˆ</h2><p>Hook æ˜¯ React 16.8 çš„æ–°å¢ç‰¹æ€§ï¼å¹¶ä¸”åªèƒ½è¿ç”¨åˆ°å‡½æ•°ç»„ä»¶ä¸­ï¼<br><a href="https://zh-hans.reactjs.org/docs/hooks-reference.html">https://zh-hans.reactjs.org/docs/hooks-reference.html</a></p><ul><li>åŸºç¡€ Hook<ul><li><code>useState</code> ä½¿ç”¨çŠ¶æ€ç®¡ç†</li><li><code>useEffect</code> ä½¿ç”¨å‘¨æœŸå‡½æ•°</li><li><code>useContext</code> ä½¿ç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯</li></ul></li><li>é¢å¤–çš„ Hook<ul><li><code>useReducer</code> useState çš„æ›¿ä»£æ–¹æ¡ˆï¼Œå€Ÿé‰´ redux å¤„ç†æ€æƒ³ï¼Œç®¡ç†æ›´å¤æ‚çš„çŠ¶æ€å’Œé€»è¾‘</li><li><code>useCallback</code> æ„å»ºç¼“å­˜ä¼˜åŒ–æ–¹æ¡ˆ</li><li><code>useMemo</code> æ„å»ºç¼“å­˜ä¼˜åŒ–æ–¹æ¡ˆ</li><li><code>useRef</code> ä½¿ç”¨ ref è·å– DOM</li><li><code>useImperativeHandle</code> é…åˆ forwardRefï¼ˆref è½¬å‘ï¼‰ä¸€èµ·ä½¿ç”¨</li><li><code>useLayoutEffect</code> ä¸ useEffect ç›¸åŒï¼Œä½†ä¼šåœ¨æ‰€æœ‰çš„ DOM å˜æ›´ä¹‹ååŒæ­¥è°ƒç”¨ effect</li><li>â€¦</li></ul></li><li>è‡ªå®šä¹‰ Hook</li><li>â€¦â€¦</li></ul>]]></content>
    
    
    <categories>
      
      <category>react</category>
      
      <category>hooks</category>
      
    </categories>
    
    
    <tags>
      
      <tag>react</tag>
      
      <tag>hooks</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
